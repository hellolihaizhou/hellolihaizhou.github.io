<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>ææµ·æ´²çš„æ²‰æ·€ä¹‹è·¯</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://lihaizhou.top/"/>
  <updated>2020-08-27T03:27:03.183Z</updated>
  <id>http://lihaizhou.top/</id>
  
  <author>
    <name>Steven Lee</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>BBRè®ºæ–‡ä¹‹è¯»åæ„Ÿ(äºŒ)</title>
    <link href="http://lihaizhou.top/2020/08/27/BBR%E8%AE%BA%E6%96%87%E4%B9%8B%E8%AF%BB%E5%90%8E%E6%84%9F-%E4%BA%8C/"/>
    <id>http://lihaizhou.top/2020/08/27/BBRè®ºæ–‡ä¹‹è¯»åæ„Ÿ-äºŒ/</id>
    <published>2020-08-27T02:50:37.000Z</published>
    <updated>2020-08-27T03:27:03.183Z</updated>
    
    <content type="html"><![CDATA[<p>Characterizing the Bottleneck</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A connection runs <span class="keyword">with</span> the highest throughput and lowest delay when (rate balance) the bottleneck packet arrival rate equals BtlBw and (full pipe) the total data <span class="keyword">in</span> flight is equal to the BDP (= BtlBw Ã— RTprop).</span><br><span class="line"></span><br><span class="line">The first condition guarantees that the bottleneck can run at <span class="number">100</span> percent utilization. The second guarantees there is enough data to prevent bottleneck starvation but not overfill the pipe. The rate balance condition alone does not ensure there is no queue, only that it can<span class="string">'t change size (e.g., if a connection starts by sending its 10-packet Initial Window into a five-packet BDP, then runs at exactly the bottleneck rate, five of the 10 initial packets fill the pipe so the excess forms a standing queue at the bottleneck that cannot dissipate).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Similarly, the full pipe condition does not guarantee there is no queue (e.g., a connection sending a BDP in BDP/2 bursts gets full bottleneck utilization, but with an average queue of BDP/4). The only way to minimize the queue at the bottleneck and all along the path is to meet both conditions simultaneously.</span></span><br></pre></td></tr></table></figure><p><strong>ç¿»è¯‘ï¼š</strong></p><p>å½“ä¸€ä¸ªè¿æ¥æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ—¶ï¼Œå®ƒå¯ä»¥åœ¨è¾¾åˆ°æœ€é«˜çš„ååé‡çš„åŒæ—¶ä¿æŒæœ€ä½æ—¶å»¶ï¼š</p><ol><li><p>é€Ÿç‡å¹³è¡¡ï¼šç“¶é¢ˆå¸¦å®½çš„æ•°æ®åˆ°è¾¾é€Ÿç‡ä¸BtlBwç›¸ç­‰ï¼›</p></li><li><p>å¡«æ»¡ç®¡é“ï¼šæ‰€æœ‰çš„åœ¨å¤–æ•°æ®ï¼ˆinflight dataï¼‰ä¸BDPï¼ˆå¸¦å®½ä¸æ—¶å»¶çš„ä¹˜ç§¯ï¼‰ç›¸ç­‰</p></li></ol><p>å…¶ä¸­ç¬¬ä¸€ä¸ªçº¦æŸä¿è¯äº†ç“¶é¢ˆå¸¦å®½å¯ä»¥å¾—åˆ°100%åˆ©ç”¨ã€‚è€Œç¬¬äºŒä¸ªçº¦æŸä¿è¯äº†æµæœ‰è¶³å¤Ÿçš„æ•°æ®æ¥å¡«æ»¡ç“¶é¢ˆé“¾è·¯è€Œä¸”åŒæ—¶ä¸ä¼šæº¢å‡ºï¼ˆæ’é˜Ÿï¼‰ã€‚</p><p>ç¬¬ä¸€ä¸ªæ¡ä»¶æœ¬èº«å¹¶æ— æ³•ä¿è¯è·¯å¾„ä¸­ä¸å­˜åœ¨é˜Ÿåˆ—ï¼Œå®ƒåªèƒ½ä¿è¯æµçš„é€Ÿç‡ä¸å‘ç”Ÿæ”¹å˜ï¼ˆä¾‹å¦‚ï¼Œè€ƒè™‘ä¸€ä¸ªè¿æ¥åœ¨ä¸€å¼€å§‹å°±å‘é€äº†10ä¸ªæŠ¥æ–‡åˆ°ä¸€ä¸ªBDPåªæœ‰5ä¸ªç½‘ç»œä¸­ï¼Œå¹¶ä¸”æ¥ä¸‹æ¥ä¸€ç›´ä¿æŒç“¶é¢ˆé€Ÿç‡å‘é€ã€‚è¿™æ ·å­ä¼šå¯¼è‡´åœ¨ä¸€å¼€å§‹å°±å¡«æ»¡äº†ç®¡é“ï¼Œå¹¶ä¸”åˆ¶é€ äº†5ä¸ªæŠ¥æ–‡çš„é˜Ÿåˆ—ï¼Œå¹¶ä¸”è¿™ä¸ªé˜Ÿåˆ—æ°¸è¿œä¸ä¼šè¢«æ¶ˆç­ï¼‰ã€‚</p><p>ç›¸ä¼¼åœ°ï¼Œç¬¬äºŒä¸ªæ¡ä»¶ä¹Ÿä¸èƒ½ä¿è¯é“¾è·¯ä¸­æ²¡æœ‰é˜Ÿåˆ—ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªè¿æ¥å¯ä»¥ä»¥burstæ–¹å¼å‘é€BDPæ•°é‡çš„æŠ¥æ–‡ï¼Œè‹¥è¯¥è¿æ¥æ¯æ¬¡å‘äºŒåˆ†ä¹‹ä¸€BDPæ¥è¾¾åˆ°ç“¶é¢ˆå¸¦å®½ï¼Œå¹¶ä¸”å‘ä¸¤æ¬¡ï¼Œæ­¤æ—¶full pipeæ¡ä»¶å¾—åˆ°æ»¡è¶³äº†ï¼Œç„¶è€Œç½‘ç»œä¸­çš„å¹³å‡é˜Ÿåˆ—é•¿åº¦æ˜¯BDP/4ã€‚ä¸ºäº†æœ€å°åŒ–ç½‘ç»œä¸­çš„é˜Ÿåˆ—é•¿åº¦ï¼Œå”¯ä¸€çš„æ–¹å¼æ˜¯åŒæ—¶æ»¡è¶³ä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶ã€‚</p><p><strong>é¢å¤–æ·»åŠ ï¼š</strong></p><p>ä¸¤ä¸ªæ¡ä»¶ç¼ºä¸€ä¸å¯ï¼Œå¦‚æœåªæ»¡è¶³ç¬¬ä¸€ä¸ªæ¡ä»¶ï¼Œå¯èƒ½ä¼šå‡ºç°å®é™…å‘é€æ•°æ®è¶…è¿‡BDPçš„æƒ…å†µï¼Œè¿™æ ·å°±ä¼šå‡ºç°æ’é˜Ÿï¼Œå¦‚æœåªæ»¡è¶³ç¬¬äºŒç‚¹çš„è¯ï¼Œå¯èƒ½ä¼šå­˜åœ¨æ•°æ®åŒ…çªå‘çš„æƒ…å†µï¼Œå¯ä»¥ç†è§£ä¸ºä¸­é—´ç½‘ç»œè®¾å¤‡è½¬å‘å¤„ç†é€Ÿåº¦èµ¶ä¸ä¸Šå‘é€ç«¯å‘é€çš„é€Ÿåº¦äº†ï¼Œè¿™æ ·ä¹Ÿä¼šæœ‰æ’é˜Ÿã€‚<br>æ‰€ä»¥è¦æƒ³è¾¾åˆ°æœ€ä¼˜çš„æƒ…å†µï¼Œå°±æ˜¯åŒæ—¶æ»¡è¶³ä»¥ä¸Šä¸¤ä¸ªæ¡ä»¶ï¼Œå¤šä¹ˆç†æƒ³çš„æƒ³æ³•ï¼</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">BtlBw and RTprop vary over the life <span class="keyword">of</span> a connection, so they must be continuously estimated. TCP currently tracks RTT (the time interval <span class="keyword">from</span> sending a data packet until it is acknowledged) since it<span class="string">'s required for loss detection. At any time t,</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">![](https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/BBRpart2-1.png.png )</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">where ğ›ˆ â‰¥ 0 represents the "noise" introduced by queues along the path, the receiver'</span>s delayed ack strategy, ack aggregation, etc. RTprop is a physical property <span class="keyword">of</span> the connection<span class="string">'s path and changes only when the path changes. Since path changes happen on time scales Â» RTprop, an unbiased, efficient estimator at time T is</span></span><br><span class="line"><span class="string">![](https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/BBRpart2-2.png.png)</span></span><br><span class="line"><span class="string">(i.e., a running min over time window WR (which is typically tens of seconds to minutes)</span></span><br></pre></td></tr></table></figure><p><strong>ç¿»è¯‘ï¼š</strong></p><p>ç„¶è€Œï¼ŒBtlBwå’ŒRTpropåœ¨æ•´ä¸ªè¿æ¥çš„ç”Ÿå‘½å‘¨æœŸä¸­å¯èƒ½æ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å®æ—¶åœ°å¯¹å®ƒä»¬è¿›è¡Œä¼°è®¡ã€‚<br>ç›®å‰TCPä¸ºäº†æ£€æµ‹ä¸¢åŒ…ï¼Œå¿…é¡»å®æ—¶åœ°è·Ÿè¸ªRTTçš„å¤§å°ï¼ˆå‘é€æ•°æ®åˆ°æ”¶åˆ°è¿™ä¸ªåŒ…çš„ackçš„æ—¶é—´ï¼‰ï¼Œåœ¨ä»»æ„çš„æ—¶é—´t</p><p>å…¶ä¸­ï¼Œæœ€åä¸€é¡¹è¡¨ç¤ºâ€œå™ªå£°â€ã€‚é€ æˆå™ªå£°çš„å› ç´ ä¸»è¦æœ‰ï¼šé“¾è·¯é˜Ÿåˆ—ï¼Œæ¥æ”¶æ–¹çš„æ—¶å»¶ACKé…ç½®ï¼ŒACKèšåˆç­‰å› ç´ ç­‰å¾…ã€‚</p><p>RTpropæ˜¯è·¯å¾„çš„ç‰©ç†ç‰¹æ€§ï¼Œå¹¶ä¸”åªæœ‰è·¯å¾„å˜åŒ–æ‰ä¼šæ”¹å˜ã€‚ç”±äºä¸€èˆ¬æ¥è¯´è·¯å¾„å˜åŒ–çš„æ—¶é—´å°ºåº¦è¿œè¿œå¤§äºRTpropï¼ˆè¿™è¯´çš„æ˜¯å•¥ç©æ„ï¼Œå¾…ç†è§£ï¼‰<br>æ‰€ä»¥RTpropå¯ä»¥ç”±ä»¥ä¸‹å…¬å¼è¿›è¡Œä¼°è®¡ï¼šå³ï¼Œåœ¨ä¸€ä¸ªæ—¶é—´çª—å£ä¸­å¯¹RTTå–æœ€å°å€¼ã€‚ä¸€èˆ¬å°†è¯¥çª—å£å¤§å°è®¾ç½®ä¸ºå‡ åç§’è‡³å‡ åˆ†é’Ÿ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Unlike RTT, nothing <span class="keyword">in</span> the TCP spec requires implementations to track bottleneck bandwidth, but a good estimate results <span class="keyword">from</span> tracking delivery rate. When the ack <span class="keyword">for</span> some packet arrives back at the sender, it conveys that packet<span class="string">'s RTT and announces the delivery of data inflight when that packet departed. Average delivery rate between send and ack is the ratio of data delivered to time elapsed: deliveryRate = Î”delivered/Î”t. This rate must be â‰¤ the bottleneck rate (the arrival amount is known exactly so all the uncertainty is in the Î”t, which must be â‰¥ the true arrival interval; thus, the ratio must be â‰¤ the true delivery rate, which is, in turn, upper-bounded by the bottleneck capacity). Therefore, a windowed-max of delivery rate is an efficient, unbiased estimator of BtlBw:</span></span><br><span class="line"><span class="string">![](https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/BBRpart2-3.png.png)</span></span><br><span class="line"><span class="string">where the time window WB is typically six to ten RTTs.</span></span><br></pre></td></tr></table></figure><p><strong>ç¿»è¯‘ï¼š</strong></p><p>ç„¶è€Œï¼Œbottleneck bandwidthçš„ä¼°è®¡ä¸åƒRTTé‚£æ ·æ–¹ä¾¿ï¼Œæ²¡æœ‰ä¸€ç§TCP specè¦æ±‚å®ç°ç®—æ³•æ¥è·Ÿè¸ªä¼°è®¡bottleneckå¸¦å®½ï¼Œä½†æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è·Ÿè¸ªå‘é€é€Ÿç‡æ¥ä¼°è®¡bottleneckå¸¦å®½ã€‚<br>å½“å‘é€æ–¹æ”¶åˆ°ä¸€ä¸ªACKæŠ¥æ–‡æ—¶ï¼Œå®ƒå¯ä»¥è®¡ç®—å‡ºè¯¥æŠ¥æ–‡çš„RTTï¼Œå¹¶ä¸”ä»å‘å‡ºæŠ¥æ–‡åˆ°æ”¶åˆ°ackæŠ¥æ–‡è¿™æ®µæ—¶é—´çš„data Inflightã€‚è¿™æ®µæ—¶é—´å†…çš„å¹³å‡å‘é€é€Ÿç‡å°±å¯ä»¥ä»¥æ­¤è®¡ç®—å‡ºæ¥ï¼šdeliveryRate = delta delivered/ delta tã€‚è¿™ä¸ªè®¡ç®—å‡ºçš„é€Ÿç‡å¿…å®šå°äºbottlenecké€Ÿç‡ï¼ˆå› ä¸ºdelta deliveredæ˜¯ç¡®å®šçš„ï¼Œä½†æ˜¯delta tä¼šè¾ƒå¤§ï¼‰ã€‚å› æ­¤ï¼ŒBtwBwå¯ä»¥æ ¹æ®ä»¥ä¸‹å…¬å¼è¿›è¡Œä¼°è®¡</p><p>å…¶ä¸­ï¼Œæ—¶é—´çª—å£å¤§å°çš„å€¼ä¸€èˆ¬ä¸º6~10ä¸ªRTTã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TCP must record the departure time <span class="keyword">of</span> each packet to compute RTT. BBR augments that record <span class="keyword">with</span> the total data delivered so each ack arrival yields both an RTT and a delivery rate measurement that the filters convert to RTprop and BtlBw estimates.</span><br><span class="line"></span><br><span class="line">Note that these values are completely independent: RTprop can change (<span class="keyword">for</span> example, on a route change) but still have the same bottleneck, or BtlBw can change (<span class="keyword">for</span> example, when a wireless link changes rate) without the path changing. (This independence is why both constraints have to be known to match sending behavior to delivery path.) Since RTprop is visible only to the left <span class="keyword">of</span> BDP and BtlBw only to the right <span class="keyword">in</span> figure <span class="number">1</span>, they obey an uncertainty principle: whenever one can be measured, the other cannot. Intuitively, <span class="keyword">this</span> is because the pipe has to be overfilled to find its capacity, which creates a queue that obscures the length <span class="keyword">of</span> the pipe. For example, an application running a request/response protocol might never send enough data to fill the pipe and observe BtlBw.</span><br><span class="line"></span><br><span class="line">A multi-hour bulk data transfer might spend its entire lifetime <span class="keyword">in</span> the bandwidth-limited region and have only a single sample <span class="keyword">of</span> RTprop <span class="keyword">from</span> the first packet<span class="string">'s RTT. This intrinsic uncertainty means that in addition to estimators to recover the two path parameters, there must be states that track both what can be learned at the current operating point and, as information becomes stale, how to get to an operating point where it can be relearned.</span></span><br></pre></td></tr></table></figure><p><strong>ç¿»è¯‘ï¼š</strong></p><p>TCPå¿…é¡»è®°å½•æ¯ä¸ªæŠ¥æ–‡çš„ç¦»å¼€æ—¶é—´ä»è€Œè®¡ç®—RTTã€‚BBRå¿…é¡»é¢å¤–è®°å½•å·²ç»å‘é€çš„æ•°æ®å¤§å°ï¼Œä½¿å¾—åœ¨æ”¶åˆ°æ¯ä¸€ä¸ªACKä¹‹åï¼Œè®¡ç®—RTTåŠå‘é€é€Ÿç‡çš„å€¼ï¼Œæœ€åå¾—åˆ°RTpropå’ŒBtlBwçš„ä¼°è®¡å€¼ã€‚</p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸¤ä¸ªå€¼æ˜¯å®Œå…¨ç‹¬ç«‹çš„ï¼šRTpropå¯ä»¥å‘ç”Ÿå˜åŒ–ç„¶è€Œä¿æŒbottleneckä¸å˜ï¼ˆæ¯”å¦‚å‘ç”Ÿè·¯ç”±å˜åŒ–ï¼‰ï¼Œæˆ–è€…BtlBwå¯ä»¥å˜åŒ–è€Œè·¯å¾„ä¸å˜ï¼ˆæ¯”å¦‚æ— çº¿é“¾è·¯é€Ÿç‡å‘ç”Ÿå˜åŒ–ï¼‰ã€‚ï¼ˆThis independence is why both constraints have tobe known to match sending behavior to delivery path.ï¼‰</p><p>å¦‚å›¾1æ‰€ç¤ºï¼Œåªæœ‰åœ¨BDPçš„å·¦è¾¹ï¼Œæ‰èƒ½è§‚æµ‹åˆ°RTpropï¼Œå¹¶ä¸”åªæœ‰åœ¨BDPçš„å³è¾¹æ‰èƒ½è§‚æµ‹åˆ°BtlBwï¼Œä»–ä»¬éµå¾ªäº†ä¸€ä¸ªä¸ç¡®å®šæ€§åŸåˆ™ï¼šå½“å…¶ä¸­ä¸€ä¸ªå¯ä»¥è¢«è§‚æµ‹çš„æ—¶å€™ï¼Œå¦å¤–ä¸€ä¸ªå¹¶ä¸èƒ½ã€‚ç›´è§‰åœ°ï¼Œè¿™æ˜¯å› ä¸ºä¸ºäº†è§‚æµ‹å‡ºç®¡é“çš„å®¹é‡ï¼Œå¿…é¡»å¡«æ»¡ç®¡é“ï¼Œè€Œè¿™ä¼šåˆ›é€ å‡ºä¸€ä¸ªé˜Ÿåˆ—ä»è€Œæ— æ³•è§‚æµ‹åˆ°ç®¡é“çš„é•¿åº¦ã€‚</p><p>ä¾‹å¦‚ï¼Œä¸€ä¸ªä½¿ç”¨request/responseåè®®çš„åº”ç”¨å¯èƒ½æ°¸è¿œä¸ä¼šå‘é€è¶³å¤Ÿçš„æ•°æ®æ¥å¡«æ»¡ç®¡é“ï¼Œå¹¶ä¸”è§‚æµ‹åˆ°BtlBwã€‚ä¸€ä¸ªæŒç»­å‡ ä¸ªå°æ—¶çš„å¤§æ–‡ä»¶ä¼ è¾“åº”ç”¨å¯èƒ½æ°¸è¿œå¤„åœ¨bandwidth-limitedåŒºåŸŸï¼Œè€Œä»…ä»…åœ¨ç¬¬ä¸€ä¸ªæŠ¥æ–‡ä¸­çš„RTTé‡‡é›†åˆ°RTpropã€‚è¿™ç§ä¸ç¡®å®šæ€§æœºåˆ¶æ„å‘³ç€ï¼Œåœ¨ä¿¡æ¯å˜å¾—ä¸æ˜ç¡®çš„æ—¶å€™ï¼Œå¿…é¡»è¦æœ‰æœºåˆ¶æ¥ä»å½“å‰çš„å·¥ä½œçŠ¶æ€ä¸­å­¦ä¹ åˆ°è¿™ä¸¤ä¸ªå€¼çš„å…¶ä¸­ä¸€ä¸ªï¼Œå¹¶ä¸”è¿›å…¥å¯¹åº”çš„å·¥ä½œåŒºæ¥é‡æ–°å­¦ä¹ è¿™ä¸¤ä¸ªå€¼ã€‚</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Characterizing the Bottleneck&lt;/p&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;
      
    
    </summary>
    
      <category term="ç½‘ç»œ" scheme="http://lihaizhou.top/categories/%E7%BD%91%E7%BB%9C/"/>
    
    
  </entry>
  
  <entry>
    <title>BBRè®ºæ–‡ä¹‹è¯»åæ„Ÿ(ä¸€)</title>
    <link href="http://lihaizhou.top/2020/08/27/BBR%E8%AE%BA%E6%96%87%E4%B9%8B%E8%AF%BB%E5%90%8E%E6%84%9F-%E4%B8%80/"/>
    <id>http://lihaizhou.top/2020/08/27/BBRè®ºæ–‡ä¹‹è¯»åæ„Ÿ-ä¸€/</id>
    <published>2020-08-27T02:19:27.000Z</published>
    <updated>2020-08-27T02:45:44.891Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æ‹¥å¡æ§åˆ¶æœ¬èº«æ˜¯ä¸ªæ¯”è¾ƒå‘æ•£çš„è¯é¢˜ï¼Œé¦–å…ˆéœ€è¦è¯´æ˜ä¸€ç‚¹æˆ‘å¯¹è¿™æ–¹é¢å…¶å®ä¸€çªä¸é€šï¼Œä¸ºäº†æ‰¾èµ„æ–™åœ¨ç½‘ä¸Šä¹Ÿçœ‹äº†ä¸å°‘æ–‡ç« ï¼Œä½†æ˜¯å¾ˆå¤šæ–‡ç« éƒ½æ˜¯å¹³é“ºç›´å™çš„è®²è¿°ï¼Œæ‰€ä»¥å¾ˆå¤šæ²¡çœ‹å®Œå°±æ”¾å¼ƒäº†ã€‚<br>äºæ˜¯æ‰“ç®—çœ‹ä¸‹è®ºæ–‡ã€ŠBBR: Congestion-Based Congestion Controlã€‹ï¼Œè¿™ç¯‡æ–‡ç« è¿˜æ˜¯æ¯”è¾ƒæœ‰æ„æ€ï¼Œçœ‹å®Œå¤šå°‘çŸ¥é“äº†ä¸€ç‚¹BBRçš„çš®æ¯›ã€‚</p><p>å› æ•´ç¯‡è®ºæ–‡å†…å®¹è¾ƒå¤šï¼Œå°†åˆ†ä¸ºå…­ç¯‡è¯»åæ„Ÿ</p><h1 id="BBRè®ºæ–‡éƒ¨åˆ†-1-6"><a href="#BBRè®ºæ–‡éƒ¨åˆ†-1-6" class="headerlink" title="BBRè®ºæ–‡éƒ¨åˆ†(1/6)"></a>BBRè®ºæ–‡éƒ¨åˆ†(1/6)</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Measuring bottleneck bandwidth and round-trip propagation time</span><br><span class="line">Neal Cardwell, Yuchung Cheng, C. Stephen Gunn, Soheil Hassas Yeganeh, Van Jacobson</span><br><span class="line"></span><br><span class="line">By all accounts, today<span class="string">'s Internet is not moving data as well as it should. Most of the world'</span>s cellular users experience delays <span class="keyword">of</span> seconds to minutes; public Wi-Fi <span class="keyword">in</span> airports and conference venues is often worse. Physics and climate researchers need to exchange petabytes <span class="keyword">of</span> data <span class="keyword">with</span> global collaborators but find their carefully engineered multi-Gbps infrastructure often delivers at only a few Mbps over intercontinental distances<span class="number">.6</span></span><br><span class="line"></span><br><span class="line">These problems result <span class="keyword">from</span> a design choice made when TCP congestion control was created <span class="keyword">in</span> the <span class="number">1980</span>sâ€”interpreting packet loss <span class="keyword">as</span> <span class="string">"congestion."</span><span class="number">13</span> This equivalence was <span class="literal">true</span> at the time but was because <span class="keyword">of</span> technology limitations, not first principles. As NICs (network interface controllers) evolved <span class="keyword">from</span> Mbps to Gbps and memory chips <span class="keyword">from</span> KB to GB, the relationship between packet loss and congestion became more tenuous.</span><br><span class="line"></span><br><span class="line">Today TCP<span class="string">'s loss-based congestion controlâ€”even with the current best of breed, CUBIC11â€”is the primary cause of these problems. When bottleneck buffers are large, loss-based congestion control keeps them full, causing bufferbloat. When bottleneck buffers are small, loss-based congestion control misinterprets loss as a signal of congestion, leading to low throughput. Fixing these problems requires an alternative to loss-based congestion control. Finding this alternative requires an understanding of where and how network congestion originates.</span></span><br></pre></td></tr></table></figure><p><strong>ç¿»è¯‘</strong></p><p>å› ä¸ºå„ç§åŸå› ï¼Œä»Šå¤©çš„äº’è”ç½‘å¹¶ä¸èƒ½åƒæˆ‘ä»¬æ‰€æœŸæœ›çš„é‚£æ ·å¾ˆå¥½åœ°ä¼ è¾“æ•°æ®ã€‚ä¸–ç•Œä¸Šå¤§éƒ¨åˆ†èœ‚çªç½‘ç»œç”¨æˆ·éƒ½ä¼šç»å†å‡ ç§’ä¹ƒè‡³å‡ åˆ†é’Ÿçš„æ—¶å»¶ï¼›åœ¨å…¬å…±å±€åŸŸå¦‚æœºåœºå’Œä¼šè®®å…ç­‰ï¼ŒWIFIè´¨é‡ç»å¸¸æ˜¯éå¸¸å·®çš„ã€‚ç‰©ç†å’Œæ°”å€™å­¦è€…æƒ³è¦ä¸å…¨çƒèŒƒå›´å†…çš„åˆä½œè€…ä¼ è¾“åƒå…†å­—èŠ‚çº§åˆ«çš„æ•°æ®ï¼Œä½†å¯èƒ½ä¼šå‘ç°ä»–ä»¬ç²¾å¿ƒå‡†å¤‡çš„Gbpsçº§åˆ«çš„åº•å±‚ç½‘ç»œåœ¨æ´²é™…ä¼ è¾“ä¸­åªèƒ½è¾¾åˆ°Mbpsçº§åˆ«ã€‚è¿™äº›é—®é¢˜ä¹‹æ‰€ä»¥ä¼šå‘ç”Ÿï¼Œæ˜¯å› ä¸ºåœ¨80å¹´ä»£è®¾è®¡TCPæ‹¥å¡æ§åˆ¶çš„æ—¶å€™ï¼ŒTCPå°†ä¸¢åŒ…ä½œä¸ºâ€œæ‹¥å¡â€çš„ä¿¡å·ã€‚åœ¨é‚£ä¸ªå¹´ä»£ï¼Œè¿™ä¸ªå‡è®¾ç¡®å®æ˜¯æ­£ç¡®çš„ï¼Œä½†è¿™æ˜¯å› ä¸ºå—é™äºæŠ€æœ¯åŸå› ã€‚è€Œå½“ç½‘å¡çš„é€Ÿç‡ä»Mbpsçº§åˆ«è¿›åŒ–ä¸ºGbpsçº§åˆ«ï¼Œå†…å­˜ä»KBçº§åˆ«è¿›åŒ–åˆ°GBçº§åˆ«ä¹‹åï¼Œä¸¢åŒ…ä¸æ‹¥å¡çš„å…³ç³»å˜å¾—ä¸é‚£ä¹ˆç´§å¯†äº†ã€‚</p><p>ä»Šå¤©çš„è¿™äº›TCPæ‹¥å¡æ§åˆ¶ç®—æ³•ï¼ŒåŒ…æ‹¬è‡³ä»Šä¸ºæ­¢æœ€å¥½çš„ç®—æ³•CUBICï¼Œéƒ½æ˜¯åŸºäºä¸¢åŒ…çš„ã€‚ä»–ä»¬æ˜¯é€ æˆè¿™äº›é—®é¢˜çš„ä¸»è¦å…ƒå‡¶ã€‚å½“ç“¶é¢ˆé“¾è·¯çš„ç¼“å­˜è¾ƒå¤§æ—¶ï¼Œè¿™äº›åŸºäºä¸¢åŒ…çš„æ‹¥å¡æ§åˆ¶ç®—æ³•æµå¡«æ»¡äº†ç¼“å­˜ï¼Œé€ æˆäº†bufferbloatã€‚å½“ç“¶é¢ˆé“¾è·¯çš„ç¼“å­˜è¾ƒå°æ—¶ï¼Œè¿™äº›ç®—æ³•ä¼šåˆå°†ä¸¢åŒ…ä½œä¸ºå‘ç”Ÿæ‹¥å¡çš„ä¿¡å·ï¼Œä»è€Œé™ä½é€Ÿç‡å¯¼è‡´äº†è¾ƒä½çš„ååé‡ã€‚</p><p>ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œå¿…é¡»æå‡ºä¸€ç§ä¸æ˜¯åŸºäºä¸¢åŒ…çš„æ‹¥å¡æ§åˆ¶ç®—æ³•ï¼Œè¿™éœ€è¦è®¾è®¡è€…å¯¹ç½‘ç»œæ‹¥å¡æ˜¯å¦‚ä½•å¹¶ä¸”åœ¨å“ªé‡Œäº§ç”Ÿçš„æœ‰éå¸¸æ·±åˆ»çš„ç†è§£</p><p><strong>é¢å¤–æ·»åŠ </strong></p><p>ç»ˆç«¯è®¾å¤‡å‘çš„è¶Šæ¥è¶Šå¿«ï¼Œä¸­é—´ç½‘ç»œè®¾å¤‡çš„ç¼“å†²åŒºè¶Šæ¥è¶Šå¤§ï¼Œä¾é ä¸¢åŒ…çš„ç®—æ³•ä¸æ˜¯é‚£ä¹ˆæ˜æ™ºäº†ï¼Œæ‰€ä»¥éœ€è¦ä¸€ç§æ–°çš„æ‹¥å¡æ§åˆ¶ç®—æ³•ï¼Œå°±æ˜¯åé¢ä¼šæåˆ°çš„BBR</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Congestion and Bottlenecks</span><br><span class="line"></span><br><span class="line">At any time, a (full-duplex) TCP connection has exactly one slowest link or bottleneck <span class="keyword">in</span> each direction. The bottleneck is important because:</span><br><span class="line"></span><br><span class="line">â€¢ It determines the connection<span class="string">'s maximum data-delivery rate. This is a general property of incompressible flow (e.g., picture a six-lane freeway at rush hour where an accident has reduced one short section to a single lane. The traffic upstream of the accident moves no faster than the traffic through that lane).</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">â€¢ It'</span>s where persistent queues form. Queues shrink only when a link<span class="string">'s departure rate exceeds its arrival rate. For a connection running at maximum delivery rate, all links upstream of the bottleneck have a faster departure rate so their queues migrate to the bottleneck.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Regardless of how many links a connection traverses or what their individual speeds are, from TCP'</span>s viewpoint an arbitrarily complex path behaves <span class="keyword">as</span> a single link <span class="keyword">with</span> the same RTT (round-trip time) and bottleneck rate. Two physical constraints, RTprop (round-trip propagation time) and BtlBw (bottleneck bandwidth), bound transport performance. (If the network path were a physical pipe, RTprop would be its length and BtlBw its minimum diameter.)</span><br><span class="line"></span><br><span class="line">Figure <span class="number">1</span> shows RTT and delivery rate variation <span class="keyword">with</span> the amount <span class="keyword">of</span> data <span class="keyword">in</span> flight (data sent but not yet acknowledged). Blue lines show the RTprop constraint, green lines the BtlBw constraint, and red lines the bottleneck buffer. Operation <span class="keyword">in</span> the shaded regions isn<span class="string">'t possible since it would violate at least one constraint. Transitions between constraints result in three different regions (app-limited, bandwidth-limited, and buffer-limited) with qualitatively different behavior.</span></span><br></pre></td></tr></table></figure><p><strong>ç¿»è¯‘</strong></p><p>åœ¨ä¸€ä¸ªTCPè¿æ¥ä¸­ï¼Œæ¯ä¸ªä¼ è¾“æ–¹å‘éƒ½å­˜åœ¨ä¸€ä¸ªæœ€æ…¢çš„é“¾è·¯ï¼Œæˆ–è€…è¯´ç“¶é¢ˆé“¾è·¯ï¼ˆbottleneckï¼‰ã€‚Bottleneckå¾ˆé‡è¦ï¼è¿™æ˜¯å› ä¸ºï¼š</p><ol><li><p>å®ƒå†³å®šäº†è¯¥è¿æ¥çš„æœ€å¤§ä¼ è¾“é€Ÿç‡ï¼ˆä¸¾ä¸ªä¾‹å­ï¼šå¦‚æœé«˜é€Ÿå…¬è·¯ä¸Šçš„æŸä¸€æ®µè·¯å‘ç”Ÿäº†è½¦ç¥¸ï¼Œå°†ä¼šå¯¼è‡´è¯¥é“ä¸Šçš„è½¦é€Ÿé™ä½è‡³é‚£ä¸€æ®µè·¯çš„è½¦é€Ÿï¼‰ã€‚</p></li><li><p>å®ƒæ˜¯é€ æˆé˜Ÿåˆ—çš„å…ƒå‡¶ï¼å› ä¸ºåªæœ‰ä¸€ä¸ªé“¾è·¯çš„ç¦»å¼€é€Ÿç‡å¤§äºå®ƒçš„åˆ°è¾¾é€Ÿç‡ï¼Œé˜Ÿåˆ—æ‰ä¼šç¼©çŸ­ã€‚å¯¹äºä¸€ä¸ªå°½åŠ›ä¼ è¾“æœ€å¤§é€Ÿç‡çš„è¿æ¥æ¥è¯´ï¼Œå› ä¸ºå…¶ä»–çš„é“¾è·¯é€Ÿç‡éƒ½æ¯”bottleneckå¤§ï¼Œæ‰€ä»¥æœ€åä¼šé€ æˆbottleneckçš„é˜Ÿåˆ—ã€‚</p></li></ol><p>æ— è®ºä¸€ä¸ªTCPè¿æ¥éœ€è¦ç©¿è¶Šå¤šå°‘é“¾è·¯ï¼Œä¹Ÿæ— è®ºè¿™äº›é“¾è·¯çš„é€Ÿç‡å„è‡ªæ˜¯å¤šå°‘ï¼Œä»TCPçš„è§’åº¦æ¥è¯´ï¼Œä¸€ä¸ªæå…¶å¤æ‚è·¯å¾„çš„è¡Œä¸ºè·Ÿä¸€æ¡ä¸å®ƒæ‹¥æœ‰ç›¸åŒRTTå’Œbottlenecké€Ÿç‡çš„ç®€å•é“¾è·¯ä¸€æ ·ï¼ˆè¿™å¥è¯ä¸å¤ªå¥½ç¿»è¯‘ï¼Œæ„æ€å°±æ˜¯ä¸ç®¡è¿™æ¡é“¾è·¯å¤šä¹ˆå¤æ‚ï¼Œåœ¨tcpçœ¼é‡Œå’Œä¸€æ¡ä¸è¿™æ¡å¤æ‚é“¾è·¯åŒæ ·çš„RTTåŠbottleneckçš„ç®€å•é“¾è·¯æ˜¯ä¸€æ ·çš„ï¼‰</p><p>è¿™ä¸¤ä¸ªå‚æ•°ï¼ŒRTpropï¼ˆRound-trippropagation timeï¼‰å’ŒBtlBwï¼ˆbottleneck bandwidthï¼‰ï¼Œå†³å®šäº†ä¼ è¾“çš„æ€§èƒ½ã€‚</p><p>ï¼ˆæ‰“ä¸ªæ¯”æ–¹ï¼Œå¦‚æœå°†ä¸€æ¡ç½‘ç»œè·¯å¾„ç±»æ¯”ä¸ºä¸€ä¸ªç®¡é“ï¼ŒRTpropå°±æ˜¯ç®¡é“çš„é•¿åº¦ï¼ŒBtlBwå°±æ˜¯ç®¡é“ä¸­æœ€çŸ­çš„åŠå¾„ã€‚ï¼‰</p><p>å›¾1å±•ç¤ºäº†RTTå’Œå‘é€é€Ÿç‡ä¸å‘é€æ•°æ®å¤§å°çš„å…³ç³»ã€‚</p><p>å›¾ä¸­çš„è“çº¿å—åˆ°äº†RTpropçš„çº¦æŸï¼Œç»¿çº¿å—åˆ°BtlBwçº¦æŸï¼Œçº¢çº¿å—åˆ°ç“¶é¢ˆé“¾è·¯çš„ç¼“å­˜çº¦æŸã€‚æ³¨æ„é˜´å½±åŒºåŸŸçš„éƒ¨åˆ†æ˜¯ä¸å¯è¾¾çš„ï¼Œå› ä¸ºè¿™ä¼šè‡³å°‘è¿åä¸€é¡¹çº¦æŸã€‚è¿™ä¸‰ç§çº¦æŸå½¢æˆäº†3ä¸åŒçš„åŒºåŸŸï¼Œåˆ†åˆ«ä¸ºapp-limitedï¼Œbandwidth-limitedï¼Œbuffer-limitedã€‚åœ¨ä¸‰ç§åŒºåŸŸï¼Œæµçš„è¡Œä¸ºæ˜¯å®Œå…¨ä¸åŒçš„</p><p><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/BBRpart1-1.png" alt=""></p><p><strong>é¢å¤–æ·»åŠ </strong></p><p>è¿™é‡Œé‡ç‚¹æåˆ°äº†bottleneckï¼Œå…¶å®æˆ‘ä»¬å¾ˆå®¹æ˜“æƒ³åˆ°å¦‚æœè¿™æ¡é“¾è·¯ä¸Šå¦‚æœä¼ è¾“é€Ÿç‡å’Œç“¶é¢ˆé€Ÿåº¦ç›¸è¿‘ï¼Œæ˜¯å¦ä¼šé™ä½bottlebloatçš„æ¦‚ç‡å‘¢ï¼Ÿå…¶å®è¿™åªæ˜¯å…¶ä¸­ä¸€ä¸ªæ¡ä»¶ï¼Œåé¢ä¼šæåˆ°ã€‚è¿™é‡Œæåˆ°çš„ä¸¤ä¸ªå‚æ•°åé¢ä¼šè´¯ç©¿æ•´ç¯‡è®ºæ–‡ï¼šRTpropï¼ˆRound-trippropagation timeï¼‰å’ŒBtlBwï¼ˆbottleneck bandwidthï¼‰</p><p>RTpropï¼šå…‰ä¿¡å·ä»Aç«¯åˆ°Bç«¯çš„æœ€å°æ—¶å»¶ï¼ˆå› ä¸ºæ˜¯ä¸€ä¸ªæ¥å›å…¶å®æ˜¯2å€æ—¶å»¶ï¼‰ï¼Œè¿™å–å†³äºç‰©ç†è·ç¦»<br>BtlBwï¼šåœ¨Aåˆ°Bçš„é“¾è·¯ä¸­ï¼Œå®ƒçš„å¸¦å®½å–å†³äºæœ€æ…¢çš„é‚£æ®µé“¾è·¯çš„å¸¦å®½ï¼Œç§°ä¸ºç“¶é¢ˆå¸¦å®½ï¼Œå¯ä»¥æƒ³è±¡ä¸ºå…‰çº¤çš„ç²—ç»†</p><p>ä¸Šé¢çš„å›¾ä¸­è½¬æŠ˜ç‚¹æœ‰ä¸ªè¯BDPï¼Œåé¢ä¼šé¢‘ç¹æåŠåˆ°ï¼š</p><p>BDP Bandwidth and Delay Product (æ•´æ¡ç‰©ç†é“¾è·¯ï¼ˆä¸å«è·¯ç”±å™¨ç¼“å­˜ï¼‰æ‰€èƒ½å‚¨è—çš„æ¯”ç‰¹æ•°æ®ä¹‹å’Œï¼ŒBDP = BtlBw * RTprop)ï¼Œæˆ–è€…å¯ä»¥è¿™æ ·ç†è§£ï¼šSource å’Œ Destination ä¹‹é—´å…è®¸å¤„åœ¨ Flying çŠ¶æ€çš„æœ€å¤§æ•°æ®é‡ã€‚Flying ä¹Ÿå« Inflightsï¼Œå°±æ˜¯å‘é€äº†ä½†è¿˜æœªæ”¶åˆ°çš„ Ack çš„æ•°æ®ã€‚</p><p>å…¶å®æ ¹æ®è¿™ä¸ªå®šä¹‰ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“æƒ³åˆ°ï¼šå¦‚æœå½“å‰çš„å®é™…å‘é€é€Ÿç‡ä¹˜ä»¥å»¶è¿Ÿå¾—åˆ°çš„å€¼è¶Šæ¥è¿‘ BDP è¯´æ˜ç®—æ³•çš„æ•ˆç‡è¶Šé«˜ã€‚</p><p>å†æ¥çœ‹ä¸‹ä¸Šé¢çš„å›¾ï¼Œä¸‹é¢ä»¥ä¸ŠåŠå›¾å’Œä¸‹åŠå›¾æ¥ç§°å‘¼</p><p>ä¸ŠåŠå›¾</p><pre><code>å½“é“¾è·¯ä¸Šæ­£åœ¨ä¼ è¾“çš„æ¯”ç‰¹æ•°æ®æœªè¶…è¿‡æ•´æ¡é“¾è·¯çš„ç‰©ç†å®¹é‡ï¼ˆBDPï¼‰ä¹‹å‰ï¼Œä¼ è¾“æ—¶å»¶çš„æé™å°±æ˜¯RTpropï¼Œå¯¹åº”ä¸ŠåŠå›¾ä¸­è“è‰²çš„æ¨ªçº¿å½“æ•°æ®å¡æ»¡äº†æ•´æ¡é“¾è·¯çš„ç‰©ç†å®¹é‡åï¼Œè·¯ç”±å™¨å¼€å§‹å¯ç”¨ç¼“å­˜æ¥å­˜å‚¨æ¯”ç‰¹æ•°æ®ï¼Œè¿™ç›¸å½“äºæ‹‰é•¿äº†æ•´ä¸ªé“¾è·¯ï¼Œé€ æˆä¼ è¾“æ—¶å»¶å¼€å§‹å˜å¤§ï¼Œåç¦»äº†ç‰©ç†æé™RTpropï¼Œäºæ˜¯æœ‰äº†slope = 1/BtlBwé‚£æ¡ç»¿è‰²æ–œçº¿å½“è·¯ç”±å™¨çš„ç¼“å­˜å¡«æ»¡åï¼ˆBDP+BtlBufSizeï¼‰ï¼Œæ•´æ¡é“¾è·¯å¼€å§‹ä¸¢æ•°æ®ï¼Œ1/BtlBwæ–œçº¿æ¶ˆå¤±ï¼Œå¯¹åº”äºä¸ŠåŠå›¾ä¸­çº¢ç‚¹è™šçº¿</code></pre><p>ä¸‹åŠå›¾<br>è¿™é‡Œå…ˆè¯´æ˜ä¸‹æœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼Œå°±æ˜¯ä¸‹åŠå›¾çš„çºµåæ ‡delivery rateï¼Œè¿™é‡Œæ˜¯BBRä¸­å®šä¹‰çš„å¸¦å®½ï¼Œå’Œæˆ‘ä»¬å¹³æ—¶ç†è§£çš„å¸¦å®½å¯èƒ½è¿˜ä¸å¤ªä¸€æ ·ï¼Œæˆ‘ä»¬å¹³æ—¶ç›´è§‚ä¸Šç†è§£æ˜¯æ•°æ®åœ¨ç½‘çº¿ä¸­çš„ä¼ è¾“é€Ÿç‡ï¼Œè¿™é‡ŒæŒ‡çš„æ˜¯ï¼šæ•°æ®é‡/ä»å‘é€å‡ºå»è‡³æ”¶åˆ°ACKçš„æ—¶é•¿</p><pre><code>å½“é“¾è·¯ä¸Šæ­£åœ¨ä¼ è¾“çš„æ¯”ç‰¹æ•°æ®æœªè¶…è¿‡æ•´æ¡é“¾è·¯çš„ç‰©ç†å®¹é‡ï¼ˆBDPï¼‰ä¹‹å‰ï¼Œåœ¨Bç«¯è§‚å¯Ÿåˆ°çš„æ•°æ®å¸¦å®½æ˜¯é€æ¸å¾€ä¸Šæ¶¨çš„ï¼Œå¯¹åº”ä¸‹åŠå›¾ä¸­è“è‰²æ–œçº¿å½“æ•°æ®å¡æ»¡äº†æ•´æ¡é“¾è·¯çš„ç‰©ç†å®¹é‡åï¼Œè·¯ç”±å™¨å¼€å§‹å¯ç”¨ç¼“å­˜æ¥å­˜å‚¨æ¯”ç‰¹æ•°æ®ï¼Œä½†ä¸å½±å“Bç«¯è§‚å¯Ÿåˆ°çš„å¸¦å®½ï¼Œè¿™ä¸ªå¸¦å®½çš„æé™å°±æ˜¯BtlBwï¼Œå¯¹åº”äºå›¾ä¸­é‚£æ¡ç»¿è‰²çš„BtlBwæ¨ªçº¿å½“è·¯ç”±å™¨çš„ç¼“å­˜å¡«æ»¡åï¼ˆBDP+BtlBufSizeï¼‰ï¼Œæ•´æ¡é“¾è·¯å¼€å§‹ä¸¢æ•°æ®ï¼Œä½†Bç«¯è§‚å¯Ÿåˆ°çš„å¸¦å®½æé™è¿˜æ˜¯BtlBwï¼Œå¯¹åº”äºä¸‹åŠå›¾ä¸­çº¢ç‚¹è™šçº¿</code></pre><p>ä¸ŠåŠå›¾å’Œä¸‹åŠå›¾çš„æ–œç‡æ˜¯æ€ä¹ˆæ¥çš„å‘¢ï¼Œæˆ‘æ˜¯è¿™ä¹ˆç†è§£çš„ï¼š<br>æ¨ªåæ ‡å®é™…å‘é€æ•°æ®å¤§å°è®¾ä¸ºSï¼Œå®é™…å¸¦å®½è¿™é‡Œè®¾ä¸ºRå¿…å®šæ˜¯å°äºç­‰äº<code>BtlBw</code>ï¼Œå®é™…æ—¶å»¶è¿™é‡Œè®¾ä¸ºTè‚¯å®šæ˜¯å¤§äºç­‰äºRTprop<br><code>S=T*R</code> æ‰€ä»¥è¿™é‡Œ<code>T/S=1/R&gt;=1/BtlBw</code>,æ‰€ä»¥å®é™…æƒ…å†µä¸‹æ–œç‡å¾€å¾€æ˜¯æ¯”ä¸ŠåŠå›¾ä¸­çš„æ›´é™¡å³­<br>åŒç†ä¸‹åŠå›¾çš„æ–œç‡ <code>R/S=1/T&lt;=1/RTprop</code>,æ‰€ä»¥å®é™…æƒ…å†µä¸‹ä¸‹åŠå›¾çš„æ–œç‡å¾€å¾€ä¼šæ›´å¹³ç¼“äº›<br>ä¸Šä¸‹åŠå›¾çš„é˜´å½±éƒ¨åˆ†æ˜¯ä¸å¯è¾¾ï¼Œè¿™ä¸ªå›¾ç”»çš„çœŸçš„æ˜¯å¤ªæ£’äº†ï¼Œä¸€å›¾èƒœåƒå¥ï¼</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">When there isn<span class="string">'t enough data in flight to fill the pipe, RTprop determines behavior; otherwise, BtlBw dominates. Constraint lines intersect at inflight = BtlBw Ã— RTprop, a.k.a. the pipe'</span>s BDP (bandwidth-delay product). Since the pipe is full past <span class="keyword">this</span> point, the inflight - BDP excess creates a queue at the bottleneck, which results <span class="keyword">in</span> the linear dependence <span class="keyword">of</span> RTT on inflight data shown <span class="keyword">in</span> the upper graph. Packets are dropped when the excess exceeds the buffer capacity. Congestion is just sustained operation to the right <span class="keyword">of</span> the BDP line, and congestion control is some scheme to bound how far to the right a connection operates on average.</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><strong>ç¿»è¯‘</strong></p><p>å½“æ²¡æœ‰è¶³å¤Ÿçš„æ•°æ®æ¥å¡«æ»¡ç®¡é“æ—¶ï¼ŒRTpropå†³å®šäº†æµçš„è¡Œä¸ºï¼ˆè¯´çš„å•¥ç©æ„æ²¡çœ‹æ‡‚ï¼‰ï¼›<br>å½“æœ‰è¶³å¤Ÿçš„æ•°æ®å¡«æ»¡æ—¶ï¼Œé‚£å°±å˜æˆäº†BtlBwæ¥å†³å®šã€‚è¿™ä¸¤æ¡çº¦æŸäº¤æ±‡åœ¨ç‚¹inflight=BtlBw*RTpropï¼Œä¹Ÿå°±æ˜¯ç®¡é“çš„BDPï¼ˆå¸¦å®½ä¸æ—¶å»¶çš„ä¹˜ç§¯ï¼‰ã€‚</p><p>å½“ç®¡é“è¢«å¡«æ»¡æ—¶ï¼Œé‚£äº›è¶…è¿‡çš„éƒ¨åˆ†ï¼ˆinflight-BDPï¼‰å°±ä¼šåœ¨ç“¶é¢ˆé“¾è·¯ä¸­åˆ¶é€ äº†ä¸€ä¸ªé˜Ÿåˆ—ï¼Œä»è€Œå¯¼è‡´äº†RTTçš„å¢å¤§ï¼Œå¦‚ä¸Šé¢é‚£ä¸ªå›¾æ‰€ç¤ºï¼Œå½“æ•°æ®ç»§ç»­å¢åŠ ç›´åˆ°å¡«æ»¡äº†ç¼“å­˜æ—¶ï¼Œå¤šä½™çš„æŠ¥æ–‡å°±ä¼šè¢«ä¸¢å¼ƒäº†ã€‚æ‹¥å¡å°±æ˜¯å‘ç”Ÿåœ¨BDPç‚¹çš„å³è¾¹ï¼Œè€Œæ‹¥å¡æ§åˆ¶ç®—æ³•å°±æ˜¯æ¥æ§åˆ¶æµçš„å¹³å‡å·¥ä½œç‚¹ç¦»BDPç‚¹æœ‰å¤šè¿œã€‚</p><p><strong>é¢å¤–æ·»åŠ </strong><br>å¸¦å®½ä¸æ—¶å»¶çš„ä¹˜ç§¯-&gt;è¿™é‡Œå¦‚æœè¯´æ˜¯ç“¶é¢ˆå¸¦å®½ä¹˜ä¸Šæœ€å°æ—¶å»¶ä¼šä¸ä¼šæ›´å¥½ç‚¹ï¼Ÿ<br>è¿™é‡Œçš„è¯´çš„å¤šä½™çš„æŠ¥æ–‡å°±ä¼šè¢«ä¸¢å¼ƒäº†å°±æ˜¯æˆ‘ä»¬ç»å¸¸è¯´çš„ç¼“å†²åŒºè‚¿èƒ€åˆ°ä¸€å®šç¨‹åº¦ï¼Œè¶…è¿‡äº†ç¼“å†²åŒºå¤§å°çš„æŠ¥æ–‡è¢«ä¸¢å¼ƒ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Loss-based congestion control operates at the right edge <span class="keyword">of</span> the bandwidth-limited region, delivering full bottleneck bandwidth at the cost <span class="keyword">of</span> high delay and frequent packet loss. When memory was expensive buffer sizes were only slightly larger than the BDP, which minimized loss-based congestion control<span class="string">'s excess delay. Subsequent memory price decreases resulted in buffers orders of magnitude larger than ISP link BDPs, and the resulting bufferbloat yielded RTTs of seconds instead of milliseconds.9</span></span><br></pre></td></tr></table></figure><p><strong>ç¿»è¯‘</strong></p><p>åŸºäºä¸¢åŒ…çš„æ‹¥å¡æ§åˆ¶ç®—æ³•å·¥ä½œåœ¨bandwidth-limitedåŒºåŸŸçš„å³è¾¹ç•ŒåŒºåŸŸï¼Œå°½ç®¡è¿™ç§ç®—æ³•å¯ä»¥è¾¾åˆ°æœ€å¤§çš„ä¼ è¾“é€Ÿç‡ï¼Œä½†æ˜¯å®ƒæ˜¯ä»¥é«˜å»¶è¿Ÿå’Œé«˜ä¸¢åŒ…ç‡ä½œä¸ºä»£ä»·çš„ã€‚åœ¨å­˜å‚¨ä»‹è´¨è¾ƒä¸ºæ˜‚è´µçš„æ—¶å€™ï¼Œç¼“å­˜å¤§å°åªæ¯”BDPå¤§ä¸€ç‚¹ï¼Œæ­¤æ—¶è¿™ç§ç®—æ³•çš„æ—¶å»¶å¹¶ä¸ä¼šå¾ˆé«˜ã€‚ç„¶è€Œï¼Œå½“å­˜å‚¨ä»‹è´¨å˜å¾—ä¾¿å®œä¹‹åï¼Œäº¤æ¢æœºçš„ç¼“å­˜å¤§å°å·²ç»æ˜¯ISPé“¾è·¯BDPçš„å¾ˆå¤šå¾ˆå¤šå€äº†ï¼Œè¿™å¯¼è‡´äº†bufferbloatï¼Œä»è€Œå¯¼è‡´äº†RTTä»æ¯«ç§’çº§å‡åˆ°äº†ç§’çº§</p><p><strong>é¢å¤–æ·»åŠ </strong></p><p>bandwidth-limitedåŒºåŸŸå°±æ˜¯å¼€å§‹ç¼“å­˜äº†æ’é˜Ÿäº†ï¼Œä½†æ˜¯è¿˜æ²¡è¶…è¿‡æœ€å¤§ç¼“å­˜ä¹Ÿå°±æ˜¯è¿˜æ²¡ä¸¢ç™½<br>å®ƒçš„å³è¾¹åŒºåŸŸè¯´çš„å°±æ˜¯å¡«æ»¡ç¼“å†²åŒºä¹‹åçš„ç‰‡æ®µï¼Œå¯¹åº”ç€é«˜å»¶è¿Ÿå’Œé«˜ä¸¢åŒ…ç‡<br>è¿™é‡Œè¯´çš„ï¼šå½“å­˜å‚¨ä»‹è´¨å˜å¾—ä¾¿å®œä¹‹åï¼Œäº¤æ¢æœºçš„ç¼“å­˜å¤§å°å·²ç»æ˜¯ISPé“¾è·¯BDPçš„å¾ˆå¤šå¾ˆå¤šå€äº†ï¼Œè¿™å¯¼è‡´äº†bufferbloat<br>ä¸ªäººæ„Ÿè§‰è¯´çš„ä¸å¤ªå¥½ï¼Œå€’ä¸æ˜¯è¯´æœ‰é”™è¯¯ï¼Œå­˜å‚¨ä¾¿å®œæ‰€ä»¥ç¼“å­˜æå¾—å¤§ç‚¹åªæ˜¯ä¸€æ–¹é¢åŸå› ï¼Œè¿˜æœ‰æ›´é‡è¦çš„ä¸€æ–¹é¢åŸå› æ˜¯</p><p>ç°åœ¨çš„ç»ˆç«¯è®¾å¤‡æ¯”å¦‚è®¡ç®—æœºçš„æ€§èƒ½å·²ç»ä»Šéæ˜”æ¯”ï¼Œå’Œä¸­é—´ç½‘ç»œè®¾å¤‡çš„å·®è·è¶Šæ¥è¶Šå°ï¼Œå¯ä»¥è¿™æ ·ç†è§£ï¼Œç»ˆç«¯è®¾å¤‡å‘çš„è¶Šæ¥è¶Šå¿«ï¼Œä¸­é—´ç½‘ç»œè®¾å¤‡æ¯”å¦‚è·¯ç”±å™¨è½¬å‘çš„é€Ÿåº¦é€æ¸å¿«è¢«ç»ˆç«¯è®¾å¤‡èµ¶ä¸Šæ¥äº†ï¼Œè¿™ä¸ªæ—¶å€™é€¼ä¸å¾—å·²å°±å¾—åŠ å¤§ç¼“å­˜äº†ï¼Œä¸ç„¶è½¬å‘ä¸è¿‡æ¥äº†å°±å¾—ä¸¢åŒ…ï¼Œå®åˆ™æ— å¥ˆä¹‹ä¸¾</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The left edge <span class="keyword">of</span> the bandwidth-limited region is a better operating point than the right. In <span class="number">1979</span> Leonard Kleinrock16 showed <span class="keyword">this</span> operating point was optimal, maximizing delivered bandwidth <span class="keyword">while</span> minimizing delay and loss, both <span class="keyword">for</span> individual connections and <span class="keyword">for</span> the network <span class="keyword">as</span> a whole8. Unfortunately, around the same time Jeffrey M. Jaffe14 proved it was impossible to create a distributed algorithm that converged to <span class="keyword">this</span> operating point. This result changed the direction <span class="keyword">of</span> research <span class="keyword">from</span> finding a distributed algorithm that achieved Kleinrock<span class="string">'s optimal operating point to investigating different approaches to congestion control.</span></span><br></pre></td></tr></table></figure><p><strong>ç¿»è¯‘</strong></p><p>å·¥ä½œåœ¨bandwidth-limitedåŒºåŸŸçš„å·¦è¾¹ç•Œæ¯”å·¥ä½œåœ¨å³è¾¹ç•Œå¥½ã€‚åœ¨1979å¹´Leonard Kleinrockå°±å±•ç¤ºäº†ï¼Œæ— è®ºæ˜¯å¯¹æµè‡ªèº«è€Œè¨€ï¼Œæˆ–æ˜¯å¯¹æ•´ä¸ªç½‘ç»œæ¥è¯´ï¼Œå·¥ä½œåœ¨å·¦è¾¹ç•Œæ˜¯æœ€ä¼˜ç‚¹ï¼Œè¿™ä¸ªç‚¹åœ¨å®ç°æœ€å¤§ä¼ è¾“é€Ÿç‡çš„åŒæ—¶ï¼Œä¿æŒäº†ä½æ—¶å»¶å’Œä½ä¸¢åŒ…ã€‚ä¸å¹¸çš„æ˜¯ï¼Œå½“æ—¶Jeffrey M.Jaffeä¹ŸåŒæ—¶è¯æ˜äº†ä¸å¯èƒ½å­˜åœ¨ä¸€ä¸ªåˆ†å¸ƒå¼ç®—æ³•å¯ä»¥æ”¶æ•›åˆ°è¿™ä¸ªè¾¹ç•Œç‚¹ï¼Œè¿™ä½¿å¾—å­¦æœ¯ç ”ç©¶ä¸å†å°è¯•å»è®¾è®¡å¯ä»¥å·¥ä½œåœ¨è¯¥è¾¹ç•Œç‚¹çš„åˆ†å¸ƒå¼ç®—æ³•</p><p><strong>é¢å¤–æ·»åŠ </strong><br>bandwidth-limitedåŒºåŸŸçš„å·¦è¾¹ç•Œä¸´ç•Œç‚¹æ˜¯æœ€ä½³çš„ï¼Œè¿™ä¸ªçœ‹å›¾å¾ˆç›´è§‚ï¼Œæ­¤æ—¶æ•°æ®é‡åˆšå¥½æ˜¯BDP</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Our group at Google spends hours each day examining TCP packet header captures <span class="keyword">from</span> all over the world, making sense <span class="keyword">of</span> behavior anomalies and pathologies. Our usual first step is finding the essential path characteristics, RTprop and BtlBw. That these can be inferred <span class="keyword">from</span> traces suggests that Jaffe<span class="string">'s result might not be as limiting as it once appeared. His result rests on fundamental measurement ambiguities (e.g., whether a measured RTT increase is caused by a path-length change, bottleneck bandwidth decrease, or queuing delay increase from another connection'</span>s traffic). Although it is impossible to disambiguate any single measurement, a connection<span class="string">'s behavior over time tells a clearer story, suggesting the possibility of measurement strategies designed to resolve ambiguity.</span></span><br><span class="line"><span class="string">&#125;);</span></span><br></pre></td></tr></table></figure><p><strong>ç¿»è¯‘</strong></p><p>æˆ‘ä»¬è°·æ­Œå·¥ä½œç»„æ¯å¤©èŠ±äº†å¤§é‡çš„æ—¶é—´æ¥æŸ¥çœ‹ä»ä¸–ç•Œå„åœ°å‘æ¥çš„TCPæŠ¥æ–‡å¤´éƒ¨ï¼Œä»è€Œå¯¹æµçš„å¼‚å¸¸è¡Œä¸ºæœ‰äº†å¾ˆæ·±çš„äº†è§£ã€‚<br>æˆ‘ä»¬é€šå¸¸é¦–å…ˆè®¡ç®—å‡ºæµæœ€é‡è¦çš„ä¸¤ä¸ªå‚æ•°ï¼šRTpropå’ŒBtlBwï¼Œè¿™ä¸¤ä¸ªå‚æ•°éƒ½å¯ä»¥ä»traceä¸­æ¨æ–­å‡ºæ¥ã€‚è¿™è¡¨æ˜Jaffeçš„ç»“è®ºå¯èƒ½ä¸å†é€‚ç”¨ã€‚ä»–å½“æ—¶åšå‡ºè¿™ä¸ªç»“è®ºæ˜¯å› ä¸ºæµ‹é‡å…·æœ‰æ¨¡ç³Šæ€§ï¼ˆä¾‹å¦‚ï¼ŒRTTçš„å¢åŠ æœ‰å¯èƒ½æ˜¯å› ä¸ºæµçš„è·¯å¾„æ”¹å˜äº†ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ç“¶é¢ˆé“¾è·¯çš„å¸¦å®½å‡å°‘äº†ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯å› ä¸ºåˆ«çš„æµç«äº‰è€Œå¯¼è‡´é˜Ÿåˆ—ç­‰ç­‰ï¼‰ã€‚å°½ç®¡ä¸å¯èƒ½åœ¨å•æ¬¡æµ‹é‡ä¸­å¾—åˆ°éå¸¸å¯é çš„å€¼ï¼Œä½†æ˜¯ä¸€ä¸ªæŒç»­æ—¶é—´è¾ƒé•¿çš„è¿æ¥ä¼šå‘Šè¯‰ä½ å¾ˆå¤šä¿¡æ¯ï¼Œä»ä¸­æˆ–è®¸å¯ä»¥è®¾æ³•æ¥ä¼°è®¡å¾—åˆ°ä¸€ä¸ªå¯é çš„å€¼</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Combining these measurements <span class="keyword">with</span> a robust servo loop using recent control systems advances12 could result <span class="keyword">in</span> a distributed congestion-control protocol that reacts to actual congestion, not packet loss or transient queue delay, and converges <span class="keyword">with</span> high probability to Kleinrock<span class="string">'s optimal operating point. Thus began our three-year quest to create a congestion control based on measuring the two parameters that characterize a path: bottleneck bandwidth and round-trip propagation time, or BBR.</span></span><br></pre></td></tr></table></figure><p><strong>ç¿»è¯‘</strong></p><p>ä½¿ç”¨æœ€è¿‘åœ¨æ§åˆ¶é¢†åŸŸä¸­æå‡ºçš„é²æ£’ä¼ºæœç¯æ¥å¯¹è¿™äº›è§‚æµ‹ç»“æœè¿›è¡Œå¤„ç†(è¿™å¥è¯ä¸çŸ¥é“å’‹ç¿»è¯‘)ï¼Œå¯ä»¥è®¾è®¡å‡ºä¸€ç§åˆ†å¸ƒå¼æ‹¥å¡æ§åˆ¶åè®®ã€‚è¯¥åè®®å¯ä»¥é’ˆå¯¹çœŸå®çš„æ‹¥å¡è¿›è¡Œååº”ï¼Œè€Œä¸æ˜¯åŸºäºä¸¢åŒ…æˆ–è€…çŸ­æš‚çš„é˜Ÿåˆ—æ—¶å»¶çš„ï¼Œå®ƒå¯ä»¥å¤§æ¦‚ç‡æ”¶æ•›åˆ°Kleinrockçš„æœ€ä¼˜è¾¹ç•Œç‚¹ã€‚</p><p>å› æ­¤è¿™æ¨åŠ¨äº†æˆ‘ä»¬è¿‘ä¸‰å¹´çš„ç ”ç©¶â€”â€”å¦‚ä½•åŸºäºè¿™ä¸¤ä¸ªè§‚æµ‹å‚æ•°bottleneckå¸¦å®½åŠRTTï¼ˆè¿™å°±æ˜¯BBRç¼©å†™çš„æ¥æºï¼Œbottleneck bandwidth and round-trip propagation timeï¼‰æ¥è®¾è®¡æ‹¥å¡æ§åˆ¶ç®—æ³•ã€‚</p><p><strong>é¢å¤–æ·»åŠ </strong></p><p>å› ä¸ºåŸºäºä¸¢åŒ…æ¢æµ‹çš„ç®—æ³•æ€»ä¼šä½¿inflightçš„æ•°æ®é‡è¾¾åˆ°BDP+BtlBufSizeè¿™ä¸ªçŠ¶æ€ï¼Œåœ¨ç°ä»£çš„è·¯ç”±å™¨ä¸­ç”±äºç¼“å­˜å¾ˆå¤§ï¼Œç›¸å½“äºæŠŠç‰©ç†é“¾è·¯äººä¸ºçš„æ‹‰é•¿äº†ï¼Œä½¿æ•°æ®ä¼ è¾“çš„å»¶æ—¶å˜å¤§ï¼Œå³RTTå˜å¤§ã€‚</p><p>ä¸‹ä¸€ç¯‡å°†è¿›å…¥ä»Šå¤©è®¨è®ºçš„ä¸»é¢˜BBR</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;æ‹¥å¡æ§åˆ¶æœ¬èº«æ˜¯ä¸ªæ¯”è¾ƒå‘æ•£çš„è¯é¢˜ï¼Œé¦–å…ˆéœ€è¦è¯´æ˜ä¸€ç‚¹æˆ‘å¯¹è¿™æ–¹é¢å…¶å®ä¸€çªä¸é€šï¼Œä¸ºäº†æ‰¾èµ„æ–™åœ¨ç½‘ä¸Šä¹Ÿçœ‹äº†ä¸å°‘æ–‡ç« ï¼Œä½†æ˜¯å¾ˆå¤šæ–‡ç« éƒ½æ˜¯å¹³é“ºç›´å™çš„è®²è¿°ï¼Œæ‰€ä»¥
      
    
    </summary>
    
      <category term="ç½‘ç»œ" scheme="http://lihaizhou.top/categories/%E7%BD%91%E7%BB%9C/"/>
    
    
  </entry>
  
  <entry>
    <title>ç½‘ç»œç³»åˆ—ä¹‹ä¸‰æ¬¡æ¡æ‰‹</title>
    <link href="http://lihaizhou.top/2020/08/09/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE%E7%B3%BB%E5%88%97%E4%B9%8B%E8%81%8A%E8%81%8A%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B/"/>
    <id>http://lihaizhou.top/2020/08/09/ç½‘ç»œåè®®ç³»åˆ—ä¹‹èŠèŠä¸‰æ¬¡æ¡æ‰‹/</id>
    <published>2020-08-09T09:31:07.000Z</published>
    <updated>2020-08-10T04:44:55.730Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ä¸‰æ¬¡æ¡æ‰‹è¿™ä¸ªè¯é¢˜ææ€•æ˜¯ç½‘ç»œé—®ç­”ä¸­æœ€å¸¸è§çš„é—®é¢˜äº†ï¼ŒåŸºæœ¬ä¸Šéƒ½èƒ½è¯´ä¸ªå¤§æ¦‚ï¼Œä½†æ˜¯å†å¾€ä¸‹æ·±ç©¶ï¼Œæœ‰äº›é—®é¢˜å¯èƒ½å›ç­”çš„å°±ä¸æ˜¯é‚£ä¹ˆé¡ºç•…äº†<br>æ‰€ä»¥æƒ³ç€å†æ¢³ç†ä¸‹è¿™ä¸ªâ€ç®€å•â€çš„æ¦‚å¿µ</p><h1 id="ä¸ºä»€ä¹ˆè¦ä¸‰æ¬¡æ¡æ‰‹"><a href="#ä¸ºä»€ä¹ˆè¦ä¸‰æ¬¡æ¡æ‰‹" class="headerlink" title="ä¸ºä»€ä¹ˆè¦ä¸‰æ¬¡æ¡æ‰‹"></a>ä¸ºä»€ä¹ˆè¦ä¸‰æ¬¡æ¡æ‰‹</h1><p>é¦–å…ˆå…ˆäº†è§£ä¸‹TCPè¿™ä¸ªæ¦‚å¿µ:<br>TCP æ˜¯é è°±çš„åè®®ï¼Œä½†æ˜¯è¿™ä¸èƒ½è¯´æ˜å®ƒé¢ä¸´çš„ç½‘ç»œç¯å¢ƒå¥½ï¼Œä»IPå±‚é¢æ¥è®²ï¼Œå¦‚æœç½‘ç»œçŠ¶å†µçš„ç¡®æ¯”è¾ƒå·®çš„è¯ï¼Œæ˜¯æ²¡æœ‰ä»»ä½•å¯é æ€§ä¿è¯çš„ï¼Œè€Œä½œä¸ºIPçš„ä¸Šä¸€å±‚TCPä¹Ÿæ— èƒ½ä¸ºåŠ›ï¼Œ<br>å”¯ä¸€èƒ½åšçš„å°±æ˜¯æ›´åŠ åŠªåŠ›ï¼Œä¸æ–­é‡ä¼ ï¼Œé€šè¿‡å„ç§ç®—æ³•ä¿è¯ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äº TCP æ¥è®²ï¼ŒIP å±‚ä½ ä¸¢ä¸ä¸¢åŒ…ï¼Œæˆ‘ç®¡ä¸ç€ï¼Œä½†æ˜¯æˆ‘åœ¨æˆ‘çš„å±‚é¢ä¸Šï¼Œä¼šåŠªåŠ›ä¿è¯å¯é æ€§</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ç€è®¨è®ºä¸ºä½•éœ€è¦è¿™ä¸‰æ¬¡æ¡æ‰‹å‘¢ï¼Ÿç±»ä¼¼å¦‚ä¸‹çš„æè¿°æ˜¯ç½‘ä¸Šæ¯”è¾ƒå¸¸è§çš„å›ç­”<br>ä¸‰æ¬¡æ¡æ‰‹çš„ç›®çš„æ˜¯å»ºç«‹å¯é çš„é€šä¿¡ä¿¡é“ï¼Œè¯´åˆ°é€šè®¯ï¼Œç®€å•æ¥è¯´å°±æ˜¯æ•°æ®çš„å‘é€ä¸æ¥æ”¶ï¼Œè€Œä¸‰æ¬¡æ¡æ‰‹æœ€ä¸»è¦çš„ç›®çš„å°±æ˜¯:åŒæ–¹ç¡®è®¤è‡ªå·±ä¸å¯¹æ–¹çš„å‘é€ä¸æ¥æ”¶æ˜¯æ­£å¸¸çš„</p><ol><li>ç¬¬ä¸€æ¬¡æ¡æ‰‹ï¼šClient ä»€ä¹ˆéƒ½ä¸èƒ½ç¡®è®¤ï¼›Server ç¡®è®¤äº†å¯¹æ–¹å‘é€æ­£å¸¸</li><li>ç¬¬äºŒæ¬¡æ¡æ‰‹ï¼šClient ç¡®è®¤äº†ï¼šè‡ªå·±å‘é€ã€æ¥æ”¶æ­£å¸¸ï¼Œå¯¹æ–¹å‘é€ã€æ¥æ”¶æ­£å¸¸ï¼›Server ç¡®è®¤äº†ï¼šè‡ªå·±æ¥æ”¶æ­£å¸¸ï¼Œå¯¹æ–¹å‘é€æ­£å¸¸</li><li>ç¬¬ä¸‰æ¬¡æ¡æ‰‹ï¼šClient ç¡®è®¤äº†ï¼šè‡ªå·±å‘é€ã€æ¥æ”¶æ­£å¸¸ï¼Œå¯¹æ–¹å‘é€ã€æ¥æ”¶æ­£å¸¸ï¼›Server ç¡®è®¤äº†ï¼šè‡ªå·±å‘é€ã€æ¥æ”¶æ­£å¸¸ï¼Œå¯¹æ–¹å‘é€æ¥æ”¶æ­£å¸¸</li></ol><p>æ‰€ä»¥ä¸‰æ¬¡æ¡æ‰‹å°±èƒ½ç¡®è®¤åŒå‘æ”¶å‘åŠŸèƒ½éƒ½æ­£å¸¸ï¼Œç¼ºä¸€ä¸å¯ã€‚</p><p>è¿™ä¸ªå¬èµ·æ¥æ²¡æœ‰é—®é¢˜ï¼Œå¦‚æœæˆ‘ä»¬è¯•ç€ç”¨é¦™å†œçš„ä¿¡æ¯è®ºæ¥ç†è§£ä¸‹æˆ–è®¸æ›´å¥½ç†è§£ï¼š<br><code>ä¿¡æ¯è®ºä¸­ï¼Œæœ‰ä¸ªå¾ˆé‡è¦çš„æ€æƒ³ï¼šè¦æƒ³æ¶ˆé™¤ä¿¡æ¯çš„ä¸ç¡®å®šæ€§ï¼Œå°±å¾—å¼•å…¥ä¿¡æ¯</code><br>å°†è¿™ä¸ªæ€æƒ³åº”ç”¨åˆ°TCPä¸­ï¼Œå¾ˆå®¹æ˜“ç†è§£TCPçš„ä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹çš„å¿…è¦æ€§ï¼šå®ƒä»¬çš„å­˜åœ¨ä»¥åŠå¤æ‚åº¦ï¼Œå°±æ˜¯ä¸ºäº†æ¶ˆé™¤ä¸ç¡®å®šæ€§ï¼Œè¿™é‡Œæˆ‘ä»¬å«ã€Œä¸å¯é æ€§ã€ã€‚<br>æ‹¿ä¸‰æ¬¡æ¡æ‰‹ä¸¾ä¾‹ï¼Œè¿™é‡Œä¸ºäº†æè¿°æ–¹ä¾¿ï¼Œå°†é€šä¿¡çš„ä¸¤ç«¯ç”¨å­—æ¯Aå’ŒBæ›¿ä»£</p><p>Aè¦å¾€Bå‘æ•°æ®ï¼ŒAè¦ç¡®å®šä¸¤ä»¶äº‹ï¼š</p><ol><li>Båœ¨â€œé‚£å„¿â€ï¼Œå¹¶ä¸”èƒ½æ¥å—æ•°æ® â€”â€” Bç¡®å®å­˜åœ¨ï¼Œå¹¶ä¸”æ˜¯æ´»çš„ï¼Œèƒ½å¬å¾—è§</li><li>Bèƒ½å›åº” â€”â€” Bèƒ½å‘æ•°æ®ï¼Œèƒ½è¯´è¯<br>ä¸ºäº†æ¶ˆé™¤è¿™ä¸¤ä¸ªä¸ç¡®å®šæ€§ï¼Œæ‰€ä»¥å¿…é¡»æœ‰å‰ä¸¤æ¬¡æ¡æ‰‹ï¼Œå³Aå‘é€äº†æ•°æ®ï¼ŒBæ”¶åˆ°äº†ï¼Œå¹¶ä¸”èƒ½å›åº”â€”â€”â€œACKâ€<br>åŒæ ·çš„ï¼Œå¯¹äºBæ¥è¯´ï¼Œå®ƒä¹Ÿè¦æ¶ˆé™¤ä»¥ä¸Šä¸¤ä¸ªä¸ç¡®å®šæ€§ï¼Œé€šè¿‡å‰ä¸¤æ¬¡æ¡æ‰‹ï¼ŒBçŸ¥é“äº†Aèƒ½è¯´ï¼Œä½†æ˜¯ä¸èƒ½ç¡®å®šAèƒ½å¬ï¼Œè¿™å°±æ˜¯ç¬¬ä¸‰æ¬¡æ¡æ‰‹çš„å¿…è¦æ€§ã€‚</li></ol><h1 id="å…³äºæ¡æ‰‹çš„ä¸€ç‚¹é—®é¢˜"><a href="#å…³äºæ¡æ‰‹çš„ä¸€ç‚¹é—®é¢˜" class="headerlink" title="å…³äºæ¡æ‰‹çš„ä¸€ç‚¹é—®é¢˜"></a>å…³äºæ¡æ‰‹çš„ä¸€ç‚¹é—®é¢˜</h1><p>æˆ‘ä»¬éƒ½çŸ¥é“TCPè¿æ¥å°±æ˜¯ä¸¤ç«¯çš„çŠ¶æ€ç»´æŠ¤ï¼Œä¸­é—´è¿‡ç¨‹æ²¡æœ‰æ‰€è°“çš„è¿æ¥ï¼Œä¸€æ—¦ä¼ è¾“å¤±è´¥ï¼Œä¸€ç«¯æ”¶åˆ°æ¶ˆæ¯ï¼Œæ‰çŸ¥é“çŠ¶æ€çš„å˜åŒ–</p><p><strong>å®¢æˆ·ç«¯ä»€ä¹ˆæ—¶å€™å»ºç«‹è¿æ¥</strong><br>åˆå­¦æ—¶ä»¥ä¸ºæ˜¯â€œä¸‰æ¬¡æ¡æ‰‹â€åï¼ŒåŒæ–¹åŒæ—¶å»ºç«‹è¿æ¥ã€‚æ˜¾ç„¶æ˜¯åšä¸åˆ°çš„ï¼Œå®¢æˆ·ç«¯ä¸çŸ¥é“â€œåº”ç­”çš„åº”ç­”â€æœ‰æ²¡æœ‰åˆ°è¾¾ï¼Œä»¥åŠä»€ä¹ˆæ—¶å€™åˆ°è¾¾ã€‚<br>åŒæ ·çš„é—®é¢˜å®¢æˆ·ç«¯ä»€ä¹ˆæ—¶å€™æ–­å¼€è¿æ¥ï¼Ÿè‡ªç„¶ä¹Ÿä¸èƒ½è¯´æ˜¯å››æ¬¡æŒ¥æ‰‹ä¹‹åï¼Œäº‹å®ä¸Šï¼Œå®¢æˆ·ç«¯å‘å‡ºæœ€åçš„åº”ç­”(ç¬¬å››æ¬¡â€œæŒ¥æ‰‹â€)åï¼Œæ°¸è¿œæ— æ³•çŸ¥é“æœ‰æ²¡æœ‰åˆ°è¾¾ã€‚äº<br>æ˜¯æœ‰äº†2MSLçš„ç­‰å¾…ï¼Œåœ¨ä¸ç¡®å®šçš„ç½‘ç»œä¸­ï¼ŒæŠŠé—®é¢˜æœ€å¤§ç¨‹åº¦åœ°è§£å†³ã€‚</p><p><strong>å…³äºä¸‰æ¬¡æ¡æ‰‹ä¸­å¦‚æœæœ€åä¸€æ¬¡ä¸¢å¤±äº†æ²¡æœ‰ä¼ é€’åˆ°æœåŠ¡ç«¯ä¼šæ€ä¹ˆæ ·ï¼Ÿ</strong><br>å›ç­”è¿™ä¸ªé—®é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹æ­£å¸¸çš„æ“ä½œæµç¨‹æ˜¯ä»€ä¹ˆæ ·çš„</p><p>æˆ‘ä»¬å…ˆæ¥è§£é‡Šä¸€ä¸‹è¿™å¼ å›¾ï¼š</p><ol><li>åœ¨åˆå§‹æ—¶ï¼ŒåŒç«¯å¤„äº CLOSE çŠ¶æ€ï¼ŒæœåŠ¡ç«¯ä¸ºäº†æä¾›æœåŠ¡ï¼Œä¼šä¸»åŠ¨ç›‘å¬æŸä¸ªç«¯å£ï¼Œè¿›å…¥ LISTEN çŠ¶æ€</li><li>å®¢æˆ·ç«¯ä¸»åŠ¨å‘é€è¿æ¥çš„ã€ŒSYNã€åŒ…ï¼Œä¹‹åè¿›å…¥ SYN-SENT çŠ¶æ€ï¼ŒæœåŠ¡ç«¯åœ¨æ”¶åˆ°å®¢æˆ·ç«¯å‘æ¥çš„ã€ŒSYNã€åŒ…åï¼Œå›å¤ã€ŒSYN,ACKã€åŒ…ï¼Œä¹‹åè¿›å…¥ SYN-RCVD çŠ¶æ€</li><li>å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡ç«¯å‘æ¥çš„ã€ŒSYN,ACKã€åŒ…åï¼Œå¯ä»¥ç¡®è®¤å¯¹æ–¹å­˜åœ¨ï¼Œæ­¤æ—¶å›å¤ã€ŒACKã€åŒ…ï¼Œå¹¶è¿›å…¥ ESTABLISHED çŠ¶æ€</li><li>æœåŠ¡ç«¯æ”¶åˆ°æœ€åä¸€ä¸ªã€ŒACKã€åŒ…åï¼Œä¹Ÿè¿›å…¥ ESTABLISHED çŠ¶æ€</li></ol><p>è¿™æ˜¯æ­£å¸¸çš„ TCP ä¸‰æ¬¡æ¡æ‰‹ï¼Œæ¡æ‰‹å®ŒæˆååŒç«¯éƒ½è¿›å…¥ ESTABLISHED çŠ¶æ€ï¼Œåœ¨æ­¤ä¹‹åï¼Œå°±æ˜¯æ­£å¸¸çš„æ•°æ®ä¼ è¾“è¿‡ç¨‹ã€‚</p><p>å†å›åˆ°ä¸‰æ¬¡æ¡æ‰‹ä¸­å¦‚æœå‡ºç°å¼‚å¸¸æƒ…å†µä¼šæ˜¯ä»€ä¹ˆæ ·çš„ï¼Œå°±ä»¥æœ€åä¸€æ¬¡æŠ¥æ–‡ä¸¢å¤±ä¸ºä¾‹<br>è¿™ä¸ªé—®é¢˜æŸ¥é˜…äº†ä¸€äº›è¿‡ç¨‹ä¸­ï¼Œå‘ç°æ˜¯æ¯”è¾ƒæœ‰äº‰è®®çš„ï¼Œæ‰€ä»¥è¿˜æ˜¯ä»¥å®è·µå‡ºçœŸçŸ¥ä¸ºå‡†<br>å…·ä½“å®è·µä¾‹å­ï¼Œå¯ä»¥å‚è§ï¼š<a href="https://blog.csdn.net/zerooffdate/article/details/79359726" target="_blank" rel="noopener">TCPä¸‰æ¬¡æ¡æ‰‹çš„ç¬¬ä¸‰ä¸ªackä¸¢äº†ä¼šæ€æ ·</a><br>æ‰€ä»¥æœ‰äº›èµ„æ–™é‡Œå†™çš„å½“æœåŠ¡ç«¯å¤„äº SYN-RCVD çŠ¶æ€ä¸‹ï¼Œæ”¶åˆ°å®¢æˆ·ç«¯çš„æ•°æ®åŒ…åï¼Œä¼šç›´æ¥å›å¤ RTS åŒ…å“åº”ï¼Œè¡¨ç¤ºæœåŠ¡ç«¯é”™è¯¯ï¼Œå¹¶è¿›å…¥ CLOSE çŠ¶æ€ã€‚æ˜¯ä¸å¯¹çš„<br>è¯•æƒ³ä¸€ä¸‹ï¼ŒæœåŠ¡ç«¯è¿˜åœ¨é€šè¿‡ä¸‰æ¬¡æ¡æ‰‹é˜¶æ®µç¡®å®šå¯¹æ–¹æ˜¯å¦çœŸå®å­˜åœ¨ï¼Œæ­¤æ—¶å¯¹æ–¹çš„æ•°æ®å·²ç»å‘æ¥äº†ï¼Œé‚£è‚¯å®šæ˜¯å­˜åœ¨çš„ã€‚<br>æ‰€ä»¥å½“æœåŠ¡ç«¯å¤„äº SYN-RCVD çŠ¶æ€ä¸‹æ—¶ï¼Œæ¥æ”¶åˆ°å®¢æˆ·ç«¯çœŸå®å‘é€æ¥çš„æ•°æ®åŒ…æ—¶ï¼Œä¼šè®¤ä¸ºè¿æ¥å·²å»ºç«‹ï¼Œå¹¶è¿›å…¥ ESTABLISHED çŠ¶æ€ã€‚</p><p>å¦å¤–è¿™ä¸ªé—®é¢˜åœ¨stackoverflowåŒæ ·æ‰¾åˆ°äº†ä¸€ä¸ªæ¯”è¾ƒä¸é”™çš„å›ç­”<br><a href="https://stackoverflow.com/questions/16259774/what-if-a-tcp-handshake-segment-is-lost" target="_blank" rel="noopener">What if a TCP handshake segment is lost?</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">TCP has a sequence number in all packets. Hence it<span class="string">'s easy to know if a packet was lost or not. If a host doesn'</span>t get an ACK on a packet he just resends it.</span><br><span class="line"></span><br><span class="line">In most cases though, even <span class="keyword">if</span> that ACK was lost, there will be no resending <span class="keyword">for</span> a very simple reason. Directly after the ACK, the host that opened the TCP protocol is likely to start sending data. That data will, as all TCP packets, have an ACK number, so the recipient would get an ACK that way. Hence, the sender of the SYN-ACK should reasonably not care that it didn<span class="string">'t get the ACK, because it gets an "implicit" ACK in the following package.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The re-send of the SYN-ACK is only necessary of there no data is received at all.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Update: I found the place in the RFC that specified exactly this:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    If our SYN has been acknowledged (perhaps in this incoming segment) the precedence level of the incoming segment must match the local precedence level exactly, if it does not a reset must be sent.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">In other words, if the ACK is dropped but the next packet is not dropped, then everything is fine. Otherwise, the connection must be reset. Which makes perfect sense</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå…¶å®å°±æ˜¯tcpçš„ç´¯è®¡ackï¼Œæˆ‘ä»¬åé¢çš„ç³»åˆ—è°ˆtcpæ—¶ä¼šç»†è°ˆ</p><p>åœ¨æŸ¥æ‰¾èµ„æ–™çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°ç½‘ä¸Šæœ‰æ¯”è¾ƒå¸¸è§çš„ä¸€ç§è¯´æ³•<br>å½“Clientç«¯æ”¶åˆ°Serverçš„SYN+ACKåº”ç­”åï¼Œå…¶çŠ¶æ€å˜ä¸ºESTABLISHEDï¼Œå¹¶å‘é€ACKåŒ…ç»™Serverï¼›<br>å¦‚æœæ­¤æ—¶ACKåœ¨ç½‘ç»œä¸­ä¸¢å¤±ï¼Œé‚£ä¹ˆServerç«¯è¯¥TCPè¿æ¥çš„çŠ¶æ€ä¸ºSYN_RECVï¼Œå¹¶ä¸”ä¾æ¬¡ç­‰å¾…3ç§’ã€6ç§’ã€12ç§’åé‡æ–°å‘é€SYN+ACKåŒ…ï¼Œä»¥ä¾¿Clienté‡æ–°å‘é€ACKåŒ…ï¼Œ<br>ä»¥ä¾¿Clienté‡æ–°å‘é€ACKåŒ…ã€‚Serveré‡å‘SYN+ACKåŒ…çš„æ¬¡æ•°ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®<code>/proc/sys/net/ipv4/tcp_synack_retries</code>ä¿®æ”¹ï¼Œé»˜è®¤å€¼ä¸º5ã€‚å¦‚æœé‡å‘æŒ‡å®šæ¬¡æ•°åï¼Œ<br>ä»ç„¶æœªæ”¶åˆ°ACKåº”ç­”ï¼Œé‚£ä¹ˆä¸€æ®µæ—¶é—´åï¼ŒServerè‡ªåŠ¨å…³é—­è¿™ä¸ªè¿æ¥ã€‚<br>ä½†æ˜¯Clientè®¤ä¸ºè¿™ä¸ªè¿æ¥å·²ç»å»ºç«‹ï¼Œå¦‚æœClientç«¯å‘Serverå†™æ•°æ®ï¼ŒServerç«¯å°†ä»¥RSTåŒ…å“åº”ï¼Œæ–¹èƒ½æ„ŸçŸ¥åˆ°Serverçš„é”™è¯¯ã€‚</p><p>è¿™é‡Œçš„æœ€åä¸€å¥å…¶å®æ˜¯æœ‰å¯èƒ½æ˜¯æœ‰é—®é¢˜çš„ï¼Œä¸åŒçš„tcpå®ç°å¯èƒ½ä¸åŒï¼Œä¸ä¸€å®šä¼šç›´æ¥å›å¤rstï¼ŒçœŸå®çš„æƒ…å†µå¾ˆå¯èƒ½æ˜¯å¦‚ä¸‹è¿™æ ·çš„<br>å½“å®¢æˆ·ç«¯åœ¨ ESTABLISHED çŠ¶æ€ä¸‹ï¼Œå¼€å§‹å‘é€æ•°æ®åŒ…æ—¶ï¼Œä¼šæºå¸¦ä¸Šä¸€ä¸ªã€ŒACKã€çš„ç¡®è®¤åºå·ï¼Œæ‰€ä»¥å“ªæ€•å®¢æˆ·ç«¯å“åº”çš„ã€ŒACKã€åŒ…ä¸¢äº†ï¼ŒæœåŠ¡ç«¯åœ¨æ”¶åˆ°è¿™ä¸ªæ•°æ®åŒ…æ—¶ï¼Œ<br>èƒ½å¤Ÿé€šè¿‡åŒ…å†… ACK çš„ç¡®è®¤åºå·ï¼Œæ­£å¸¸è¿›å…¥ ESTABLISHED çŠ¶æ€ã€‚</p><p>è¿˜æœ‰ä¸€ç§å®‰å…¨èŒƒç•´çš„éæ­£å¸¸æƒ…å†µ<br>å‰é¢ä¸€ç›´åœ¨è¯´æ­£å¸¸çš„å¼‚å¸¸é€»è¾‘ï¼ŒåŒæ–¹éƒ½è¿˜ç®—å‹å–„ï¼ŒæŒ‰è§„çŸ©åšäº‹ï¼Œå‡ºç°å¼‚å¸¸ä¸»è¦ä¹Ÿæ˜¯å› ä¸ºç½‘ç»œç­‰å®¢è§‚é—®é¢˜ï¼Œæ¥ä¸‹æ¥è¯´ä¸€ä¸ªæ¶æ„çš„æƒ…å†µã€‚<br>å¦‚æœå®¢æˆ·ç«¯æ˜¯æ¶æ„çš„ï¼Œåœ¨å‘é€ã€ŒSYNã€åŒ…åï¼Œå¹¶æ”¶åˆ°ã€ŒSYN,ACKã€åå°±ä¸å›å¤äº†ï¼Œé‚£ä¹ˆæœåŠ¡ç«¯æ­¤æ—¶å¤„äºä¸€ç§åŠè¿æ¥çš„çŠ¶æ€ï¼Œ<br>è™½ç„¶æœåŠ¡ç«¯ä¼šé€šè¿‡ tcp_synack_retries é…ç½®é‡è¯•çš„æ¬¡æ•°ï¼Œä¸ä¼šæ— é™ç­‰å¾…ä¸‹å»ï¼Œä½†æ˜¯è¿™ä¹Ÿæ˜¯æœ‰ä¸€ä¸ªæ—¶é—´å‘¨æœŸçš„ã€‚<br>å¦‚æœçŸ­æ—¶é—´å†…å­˜åœ¨å¤§é‡çš„è¿™ç§æ¶æ„è¿æ¥ï¼Œå¯¹æœåŠ¡ç«¯æ¥è¯´å‹åŠ›å°±ä¼šå¾ˆå¤§ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„ SYN FLOOD æ”»å‡»ã€‚</p><p>æˆ‘ä»¬ä¸Šé¢è®¨è®ºçš„éƒ½æ˜¯ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼Œå››æ¬¡æŒ¥æ‰‹è¿‡ç¨‹ï¼Œæœ‰å…´è¶£å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼Œå†™çš„ä¸é”™<br><a href="https://www.jianshu.com/p/723365a47c6e" target="_blank" rel="noopener">TCPä¸‰æ¬¡æ¡æ‰‹ã€å››æ¬¡æŒ¥æ‰‹å‡ºç°æ„å¤–æƒ…å†µæ—¶ï¼Œä¸ºä¿è¯ç¨³å®šï¼Œæ˜¯å¦‚ä½•å¤„ç†çš„ï¼Ÿ</a> </p><h1 id="wiresharkçœ‹ä¸‰æ¬¡æ¡æ‰‹"><a href="#wiresharkçœ‹ä¸‰æ¬¡æ¡æ‰‹" class="headerlink" title="wiresharkçœ‹ä¸‰æ¬¡æ¡æ‰‹"></a>wiresharkçœ‹ä¸‰æ¬¡æ¡æ‰‹</h1><p>æŠ“äº†ä¸€ä¸ªæŠ•å±çš„tcpdumpï¼Œå¯ä»¥çœ‹ä¸‹ä¸‰æ¬¡æ¡æ‰‹çš„è¿‡ç¨‹<br><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/TCP%E7%B3%BB%E5%88%97%E4%B9%8B%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B1.png" alt=""></p><p><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/TCP%E7%B3%BB%E5%88%97%E4%B9%8B%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B2.png" alt=""></p><p><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/TCP%E7%B3%BB%E5%88%97%E4%B9%8B%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B3.png" alt=""></p><p>å‚è€ƒæ–‡ç« ï¼š<br><a href="https://www.jianshu.com/p/723365a47c6e" target="_blank" rel="noopener">TCPä¸‰æ¬¡æ¡æ‰‹ã€å››æ¬¡æŒ¥æ‰‹å‡ºç°æ„å¤–æƒ…å†µæ—¶ï¼Œä¸ºä¿è¯ç¨³å®šï¼Œæ˜¯å¦‚ä½•å¤„ç†çš„ï¼Ÿ</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;å‰è¨€&quot;&gt;&lt;a href=&quot;#å‰è¨€&quot; class=&quot;headerlink&quot; title=&quot;å‰è¨€&quot;&gt;&lt;/a&gt;å‰è¨€&lt;/h1&gt;&lt;p&gt;ä¸‰æ¬¡æ¡æ‰‹è¿™ä¸ªè¯é¢˜ææ€•æ˜¯ç½‘ç»œé—®ç­”ä¸­æœ€å¸¸è§çš„é—®é¢˜äº†ï¼ŒåŸºæœ¬ä¸Šéƒ½èƒ½è¯´ä¸ªå¤§æ¦‚ï¼Œä½†æ˜¯å†å¾€ä¸‹æ·±ç©¶ï¼Œæœ‰äº›é—®é¢˜å¯èƒ½å›ç­”çš„å°±ä¸æ˜¯é‚£ä¹ˆé¡ºç•…äº†&lt;br&gt;æ‰€ä»¥æƒ³ç€å†æ¢³ç†
      
    
    </summary>
    
      <category term="ç½‘ç»œ" scheme="http://lihaizhou.top/categories/%E7%BD%91%E7%BB%9C/"/>
    
    
  </entry>
  
  <entry>
    <title>å†…å­˜å±éšœ</title>
    <link href="http://lihaizhou.top/2020/06/20/Memory-Barrier%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    <id>http://lihaizhou.top/2020/06/20/Memory-Barrierè¯»ä¹¦ç¬”è®°/</id>
    <published>2020-06-20T07:56:03.000Z</published>
    <updated>2020-06-21T08:22:31.360Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬ç¯‡æ–‡ç« å¼€å§‹ä¹‹å‰éœ€è¦äº†è§£ä¸€äº›èƒŒæ™¯çŸ¥è¯†</p><h1 id="Cache-Memory"><a href="#Cache-Memory" class="headerlink" title="Cache Memory"></a>Cache Memory</h1><p>æˆ‘ä»¬éƒ½çŸ¥é“ç¨‹åºæ˜¯è¿è¡Œåœ¨ RAMä¹‹ä¸­ï¼ŒRAM å°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„DDRï¼ˆä¾‹å¦‚ DDR3ã€DDR4ç­‰ï¼‰ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºmain memoryï¼ˆä¸»å­˜ï¼‰å½“æˆ‘ä»¬éœ€è¦è¿è¡Œä¸€ä¸ªè¿›ç¨‹çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šä»Flashè®¾å¤‡ï¼ˆä¾‹å¦‚ï¼ŒeMMCã€UFSç­‰ï¼‰ä¸­å°†å¯æ‰§è¡Œç¨‹åºloadåˆ°main memoryä¸­ï¼Œç„¶åå¼€å§‹æ‰§è¡Œã€‚</p><p>åœ¨CPUå†…éƒ¨å­˜åœ¨ä¸€å †çš„é€šç”¨å¯„å­˜å™¨ï¼ˆregisterï¼‰ï¼Œå¦‚æœCPUéœ€è¦å°†ä¸€ä¸ªå˜é‡ï¼ˆå‡è®¾åœ°å€æ˜¯Aï¼‰åŠ 1ï¼Œä¸€èˆ¬åˆ†ä¸ºä»¥ä¸‹3ä¸ªæ­¥éª¤</p><ol><li>CPU ä»ä¸»å­˜ä¸­è¯»å–åœ°å€Açš„æ•°æ®åˆ°å†…éƒ¨é€šç”¨å¯„å­˜å™¨ x0ï¼ˆARM64æ¶æ„çš„é€šç”¨å¯„å­˜å™¨ä¹‹ä¸€ï¼‰</li><li>é€šç”¨å¯„å­˜å™¨ x0 åŠ 1</li><li>CPU å°†é€šç”¨å¯„å­˜å™¨ x0 çš„å€¼å†™å…¥ä¸»å­˜</li></ol><p>ä½†æ˜¯å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼ŒCPUé€šç”¨å¯„å­˜å™¨çš„é€Ÿåº¦å’Œä¸»å­˜ä¹‹é—´å­˜åœ¨ç€å¤ªå¤§çš„å·®å¼‚<br>ä»è¿™ä¸ªç½‘å€<a href="https://gist.github.com/jboner/2841832" target="_blank" rel="noopener">https://gist.github.com/jboner/2841832</a> æ‘˜äº†ä¸€æ®µæ•°æ®<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Latency Comparison <span class="title">Numbers</span> <span class="params">(~<span class="number">2012</span>)</span></span></span><br><span class="line"><span class="function">----------------------------------</span></span><br><span class="line"><span class="function">L1 cache reference                           0.5 ns</span></span><br><span class="line"><span class="function">Branch mispredict                            5   ns</span></span><br><span class="line"><span class="function">L2 cache reference                           7   ns                      14x L1 cache</span></span><br><span class="line"><span class="function">Mutex lock/unlock                           25   ns</span></span><br><span class="line"><span class="function">Main memory reference                      100   ns                      20x L2 cache, 200x L1 cache</span></span><br><span class="line"><span class="function">Compress 1K bytes with Zippy             3,000   ns        3 us</span></span><br><span class="line"><span class="function">Send 1K bytes over 1 Gbps network       10,000   ns       10 us</span></span><br><span class="line"><span class="function">Read 4K randomly from SSD*             150,000   ns      150 us          ~1GB/sec SSD</span></span><br><span class="line"><span class="function">Read 1 MB sequentially from memory     250,000   ns      250 us</span></span><br><span class="line"><span class="function">Round trip within same datacenter      500,000   ns      500 us</span></span><br><span class="line"><span class="function">Read 1 MB sequentially from SSD*     1,000,000   ns    1,000 us    1 ms  ~1GB/sec SSD, 4X memory</span></span><br><span class="line"><span class="function">Disk seek                           10,000,000   ns   10,000 us   10 ms  20x datacenter roundtrip</span></span><br><span class="line"><span class="function">Read 1 MB sequentially from disk    20,000,000   ns   20,000 us   20 ms  80x memory, 20X SSD</span></span><br><span class="line"><span class="function">Send packet CA-&gt;Netherlands-&gt;CA    150,000,000   ns  150,000 us  150 ms</span></span><br></pre></td></tr></table></figure></p><p>è¿™é‡Œæ²¡æœ‰åˆ—å‡ºå¯„å­˜å™¨é€Ÿåº¦ï¼Œçœ‹åˆ°L1 cacheæ˜¯0.5nsï¼Œå¯ä»¥è‚¯å®šçš„æ˜¯å¯„å­˜å™¨ä¸€å®šæ˜¯ä½äº1nsï¼ŒMain memoryæ˜¯100nsï¼Œè¿™é‡Œçš„æ•°æ®ä»…ä¾›å‚è€ƒ<br>æ‰€ä»¥ä¸Šé¢çš„ä»ä¸»å­˜è¯»å–æ•°å€¼ä¸‰ä¸ªæ­¥éª¤ä¸­çš„ç¬¬ä¸€å’Œç¬¬ä¸‰æ­¥å®é™…ä¸Šé€Ÿåº¦å¾ˆæ…¢ç›¸å¯¹äºå¯„å­˜å™¨è€Œè¨€</p><p>å½“CPUè¯•å›¾ä»ä¸»å­˜ä¸­load/store æ“ä½œæ—¶ï¼Œç”±äºä¸»å­˜çš„é€Ÿåº¦é™åˆ¶ï¼ŒCPUä¸å¾—ä¸ç­‰å¾…è¿™æ¼«é•¿çš„65nsæ—¶é—´ã€‚å¦‚æœæˆ‘ä»¬å¯ä»¥æå‡ä¸»å­˜çš„é€Ÿåº¦ï¼Œé‚£ä¹ˆç³»ç»Ÿå°†ä¼šè·å¾—å¾ˆå¤§çš„æ€§èƒ½æå‡ã€‚å¦‚ä»Šçš„DDRå­˜å‚¨è®¾å¤‡ï¼ŒåŠ¨ä¸åŠ¨å°±æ˜¯å‡ ä¸ªGBï¼Œå®¹é‡å¾ˆå¤§ã€‚å¦‚æœæˆ‘ä»¬é‡‡ç”¨æ›´å¿«ææ–™åˆ¶ä½œæ›´å¿«é€Ÿåº¦çš„ä¸»å­˜ï¼Œå¹¶ä¸”æ‹¥æœ‰å‡ ä¹å·®ä¸å¤šçš„å®¹é‡ã€‚å…¶æˆæœ¬å°†ä¼šå¤§å¹…åº¦ä¸Šå‡ã€‚<br>æˆ‘ä»¬è¯•å›¾æå‡ä¸»å­˜çš„é€Ÿåº¦å’Œå®¹é‡ï¼ŒåˆæœŸæœ›å…¶æˆæœ¬å¾ˆä½ï¼Œè¿™å°±æœ‰ç‚¹éš¾ä¸ºäººäº†ã€‚å› æ­¤ï¼Œæˆ‘ä»¬æœ‰ä¸€ç§æŠ˜ä¸­çš„æ–¹æ³•ï¼Œé‚£å°±æ˜¯åˆ¶ä½œä¸€å—é€Ÿåº¦æå¿«ä½†æ˜¯å®¹é‡æå°çš„å­˜å‚¨è®¾å¤‡ã€‚é‚£ä¹ˆå…¶æˆæœ¬ä¹Ÿä¸ä¼šå¤ªé«˜ã€‚è¿™å—å­˜å‚¨è®¾å¤‡æˆ‘ä»¬ç§°ä¹‹ä¸ºcache memoryã€‚åœ¨ç¡¬ä»¶ä¸Šï¼Œæˆ‘ä»¬å°†cacheæ”¾ç½®åœ¨CPUå’Œä¸»å­˜ä¹‹é—´ï¼Œä½œä¸ºä¸»å­˜æ•°æ®çš„ç¼“å­˜ã€‚å½“CPUè¯•å›¾ä»ä¸»å­˜ä¸­load/storeæ•°æ®çš„æ—¶å€™ï¼Œ CPUä¼šé¦–å…ˆä»cacheä¸­æŸ¥æ‰¾å¯¹åº”åœ°å€çš„æ•°æ®æ˜¯å¦ç¼“å­˜åœ¨cache ä¸­ã€‚å¦‚æœå…¶æ•°æ®ç¼“å­˜åœ¨cacheä¸­ï¼Œç›´æ¥ä»cacheä¸­æ‹¿åˆ°æ•°æ®å¹¶è¿”å›ç»™CPUã€‚<br><strong>CPUå’Œä¸»å­˜ä¹‹é—´ç›´æ¥æ•°æ®ä¼ è¾“çš„æ–¹å¼è½¬å˜æˆCPUå’Œcacheä¹‹é—´ç›´æ¥æ•°æ®ä¼ è¾“ã€‚cacheè´Ÿè´£å’Œä¸»å­˜ä¹‹é—´æ•°æ®ä¼ è¾“ã€‚</strong></p><p>å½“å­˜åœ¨cacheçš„æ—¶å€™ï¼Œä»¥ä¸Šç¨‹åºå¦‚ä½•è¿è¡Œçš„ä¾‹å­çš„æµç¨‹å°†ä¼šå˜æˆå¦‚ä¸‹ï¼š<br><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/memory-barrier01.png" alt=""></p><p>caheçš„é€Ÿåº¦åœ¨ä¸€å®šç¨‹åº¦ä¸ŠåŒæ ·å½±å“ç€ç³»ç»Ÿçš„æ€§èƒ½ã€‚ä¸€èˆ¬æƒ…å†µcacheçš„é€Ÿåº¦å¯ä»¥è¾¾åˆ°1nsï¼Œå‡ ä¹å¯ä»¥å’ŒCPUå¯„å­˜å™¨é€Ÿåº¦åª²ç¾ã€‚ä½†æ˜¯ï¼Œè¿™å°±æ»¡è¶³äººä»¬å¯¹æ€§èƒ½çš„è¿½æ±‚äº†å—ï¼Ÿå¹¶æ²¡æœ‰ã€‚å½“cacheä¸­æ²¡æœ‰ç¼“å­˜æˆ‘ä»¬æƒ³è¦çš„æ•°æ®çš„æ—¶å€™ï¼Œä¾ç„¶éœ€è¦æ¼«é•¿çš„ç­‰å¾…ä»ä¸»å­˜ä¸­loadæ•°æ®ã€‚ä¸ºäº†è¿›ä¸€æ­¥æå‡æ€§èƒ½ï¼Œå¼•å…¥å¤šçº§cacheã€‚å‰é¢æåˆ°çš„cacheï¼Œç§°ä¹‹ä¸ºL1 cacheï¼ˆç¬¬ä¸€çº§cacheï¼‰ã€‚<br>æˆ‘ä»¬åœ¨L1 cache åé¢è¿æ¥L2 cacheï¼Œåœ¨L2 cache å’Œä¸»å­˜ä¹‹é—´è¿æ¥L3 cacheã€‚ç­‰çº§è¶Šé«˜ï¼Œé€Ÿåº¦è¶Šæ…¢ï¼Œå®¹é‡è¶Šå¤§ã€‚ä½†æ˜¯é€Ÿåº¦ç›¸æ¯”è¾ƒä¸»å­˜è€Œè¨€ï¼Œä¾ç„¶å¾ˆå¿«</p><p>å¤šçº§cacheä¸æ˜¯æœ¬æ–‡é‡ç‚¹ï¼Œè¯¦ç»†å¯å‚è€ƒå¦‚ä¸‹ä¸¤ç¯‡æ–‡ç« ï¼Œå†™çš„æ¯”è¾ƒè¯¦ç»†<br><a href="http://www.wowotech.net/memory_management/458.html" target="_blank" rel="noopener">æµ…è°ˆCache Memory</a><br><a href="https://zhuanlan.zhihu.com/cpu-cache" target="_blank" rel="noopener">é«˜é€Ÿç¼“å­˜ä¸ä¸€è‡´æ€§</a></p><h2 id="Cacheline"><a href="#Cacheline" class="headerlink" title="Cacheline"></a>Cacheline</h2><p>æœ¬æ–‡åç»­ä¼šæ¶‰åŠåˆ°ä¸€ä¸ªåè¯Cachelineï¼Œcacheçš„å¤§å°ç§°ä¹‹ä¸ºcahe sizeï¼Œä»£è¡¨cacheå¯ä»¥ç¼“å­˜æœ€å¤§æ•°æ®çš„å¤§å°ã€‚<br>æˆ‘ä»¬å°†cacheå¹³å‡åˆ†æˆç›¸ç­‰çš„å¾ˆå¤šå—ï¼Œæ¯ä¸€ä¸ªå—å¤§å°ç§°ä¹‹ä¸ºcache lineï¼Œå…¶å¤§å°æ˜¯cache line sizeã€‚ä¾‹å¦‚ä¸€ä¸ª64 Byteså¤§å°çš„cache<br>å¦‚æœæˆ‘ä»¬å°†64 Byteså¹³å‡åˆ†æˆ64å—ï¼Œé‚£ä¹ˆcache lineå°±æ˜¯1å­—èŠ‚ï¼Œæ€»å…±64è¡Œcache lineã€‚å¦‚æœæˆ‘ä»¬å°†64 Byteså¹³å‡åˆ†æˆ8å—ï¼Œé‚£ä¹ˆcache lineå°±æ˜¯8å­—èŠ‚ï¼Œæ€»å…±8è¡Œcache line<br>æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œcache lineæ˜¯cacheå’Œä¸»å­˜ä¹‹é—´æ•°æ®ä¼ è¾“çš„æœ€å°å•ä½ã€‚ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå½“CPUè¯•å›¾loadä¸€ä¸ªå­—èŠ‚æ•°æ®çš„æ—¶å€™ï¼Œå¦‚æœcacheç¼ºå¤±ï¼Œé‚£ä¹ˆcacheæ§åˆ¶å™¨ä¼šä»ä¸»å­˜ä¸­ä¸€æ¬¡æ€§çš„load cache lineå¤§å°çš„æ•°æ®åˆ°cacheä¸­ã€‚</p><p>ä¾‹å¦‚ï¼Œcache lineå¤§å°æ˜¯8å­—èŠ‚ã€‚CPUå³ä½¿è¯»å–ä¸€ä¸ªbyteï¼Œåœ¨cacheç¼ºå¤±åï¼Œcacheä¼šä»ä¸»å­˜ä¸­load 8å­—èŠ‚å¡«å……æ•´ä¸ªcache lineï¼Œè‡³äºåŸå› å¯ä»¥å‚è§è¿™ç¯‡æ–‡ç« :<br><a href="http://www.wowotech.net/memory_management/458.html" target="_blank" rel="noopener">æµ…è°ˆCache Memory</a></p><p>æœ‰äº†å‰é¢çš„åŸºç¡€çŸ¥è¯†çš„è®¤çŸ¥ï¼Œä¸éš¾ç†è§£ä¸‹é¢è¿™ä¸ªæç®€çš„æŠ½è±¡CPUæ¶æ„å›¾<br><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/memory-barrier02.gif" alt=""></p><h1 id="ç¼“å­˜ä¸€è‡´æ€§"><a href="#ç¼“å­˜ä¸€è‡´æ€§" class="headerlink" title="ç¼“å­˜ä¸€è‡´æ€§"></a>ç¼“å­˜ä¸€è‡´æ€§</h1><p>è€ƒè™‘åˆ°å¤šçº¿ç¨‹è¯»å†™ç¯å¢ƒä¸­ï¼Œä¸å…ä¼šæœ‰ä¸ªç–‘é—®ï¼Œå¦‚æœä¸€ä¸ªæ•°æ®æ˜¯å¤šä¸ªcpuéƒ½å…±äº«ï¼Œå…¶ä¸­ä¸€ä¸ªä¿®æ”¹äº†æ˜¯ä¸æ˜¯è¦æƒ³åŠæ³•ä½¿å¾—å…¶ä»–cpuä¹Ÿèƒ½æ›´æ–°<br>ä¸€ä¸ªcpuå»è¯»å–ä¸€ä¸ªæ•°å€¼æ—¶ï¼Œæ€ä¹ˆç¡®å®šæ˜¯æœ€æ–°çš„å‘¢ï¼Ÿè¯´åˆ°åº•å°±æ˜¯è¦ä¿è¯åœ¨ä½¿ç”¨cacheåå¦‚ä½•ç¡®ä¿å„ CPU çœ‹åˆ°çš„æ•°æ®æ˜¯ä¸€è‡´çš„<br>è¿™ä¸ªå°±å¼•å‡ºå¦å¤–ä¸€ä¸ªåè¯â€œcache-coherence protocolâ€å³ç¼“å­˜ä¸€è‡´æ€§åè®®<br>å…¶ä¸­ï¼ŒMESI protocol æ˜¯ä¸€ä¸ªåŸºæœ¬ç‰ˆï¼Œä» MESI protocol å¯ä»¥äº†è§£ CPU ä¹‹é—´å¦‚ä½•ç»´æŒçœ‹åˆ°ä¸€è‡´çš„èµ„æ–™ï¼Œå¯ä»¥å‚è§MESIçš„ç»´åŸºå®šä¹‰:   <a href="https://zh.wikipedia.org/wiki/MESI%E5%8D%8F%E8%AE%AE" target="_blank" rel="noopener">MESIåè®®</a></p><p>è¿™é‡Œæ‘˜å–è‹±æ–‡æ–‡æ¡£ä¸­çš„å¯¹äºMESIæ‹†è§£å¼€æ¥çš„å››ç§çŠ¶æ€çš„è§£é‡Š<br><code>A line in the â€œmodifiedâ€ state has been subject to a recent memory store from the corresponding CPU, and the corresponding memory is guaranteed not to appear in any other CPUâ€™s cache. Cache lines in the â€œmodifiedâ€state can thus be said to be â€œownedâ€ by the CPU. Because this cache holds the only up-to-date copy of the data, thiscache is ultimately responsible for either writing it back to memory or handing it off to some other cache, and must do so before reusing this line to hold other data.</code><br>å¤„äºmodifiedçŠ¶æ€çš„cachelineè¯´æ˜è¿‘æœŸæœ‰è¿‡æ¥è‡ªå¯¹åº”cpuçš„å†™æ“ä½œï¼ŒåŒæ—¶ä¹Ÿè¯´æ˜è¯¥è¯¥æ•°æ®ä¸ä¼šå­˜åœ¨å…¶ä»–cpuå¯¹åº”çš„cacheä¸­ã€‚å› æ­¤ï¼Œå¤„äºmodifiedçŠ¶æ€çš„cachelineä¹Ÿå¯ä»¥è¯´æ˜¯è¢«è¯¥CPUç‹¬å ã€‚è€Œåˆå› ä¸ºåªæœ‰è¯¥CPUçš„cacheä¿å­˜äº†æœ€æ–°çš„æ•°æ®ï¼ˆæœ€ç»ˆçš„memoryä¸­éƒ½æ²¡æœ‰æ›´æ–°ï¼‰ï¼Œæ‰€ä»¥ï¼Œè¯¥cacheéœ€è¦å¯¹è¯¥æ•°æ®è´Ÿè´£åˆ°åº•ã€‚ä¾‹å¦‚æ ¹æ®è¯·æ±‚ï¼Œè¯¥cacheå°†æ•°æ®åŠå…¶æ§åˆ¶æƒä¼ é€’åˆ°å…¶ä»–cacheä¸­ï¼Œæˆ–è€…cacheéœ€è¦è´Ÿè´£å°†æ•°æ®å†™å›åˆ°memoryä¸­ï¼Œè€Œè¿™äº›æ“ä½œéƒ½éœ€è¦åœ¨reuseè¯¥cache lineä¹‹å‰å®Œæˆã€‚<br><code>The â€œexclusiveâ€ state is very similar to the â€œmodifiedâ€state, the single exception being that the cache line has not yet been modified by the corresponding CPU, which in turn means that the copy of the cache lineâ€™s data that resides in memory is up-to-date. However, since the CPU can store to this line at any time, without consulting other CPUs, a line in the â€œexclusiveâ€ state can still be said to be owned by the corresponding CPU. That said, because the corresponding value in memory is up to date, this cache can discard this data without writing it back to memory or handing it off to some other CPU.</code><br>exclusiveçŠ¶æ€å’ŒmodifiedçŠ¶æ€éå¸¸ç±»ä¼¼ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯å¯¹åº”CPUè¿˜æ²¡æœ‰ä¿®æ”¹cachelineä¸­çš„æ•°æ®ï¼Œä¹Ÿæ­£å› ä¸ºè¿˜æ²¡æœ‰ä¿®æ”¹æ•°æ®ï¼Œå› æ­¤memoryä¸­å¯¹åº”çš„dataä¹Ÿæ˜¯æœ€æ–°çš„ã€‚åœ¨exclusiveçŠ¶æ€ä¸‹ï¼Œcpuä¹Ÿå¯ä»¥ä¸é€šçŸ¥å…¶ä»–CPU cacheè€Œç›´æ¥å¯¹cachelineè¿›è¡Œæ“ä½œï¼Œå› æ­¤ï¼ŒexclusiveçŠ¶æ€ä¹Ÿå¯ä»¥è¢«è®¤ä¸ºæ˜¯è¢«è¯¥CPUç‹¬å ã€‚ç”±äºmemoryä¸­çš„æ•°æ®å’Œcachelineä¸­çš„æ•°æ®éƒ½æ˜¯æœ€æ–°çš„ï¼Œå› æ­¤ï¼Œcpuä¸éœ€å¯¹exclusiveçŠ¶æ€çš„cachelineæ‰§è¡Œå†™å›çš„æ“ä½œæˆ–è€…å°†æ•°æ®ä»¥åŠå½’å±æƒè½¬äº¤å…¶ä»–cpu cacheï¼Œè€Œç›´æ¥reuseè¯¥cachelineï¼ˆå°†cacheineä¸­çš„æ•°æ®ä¸¢å¼ƒï¼Œç”¨ä½œä»–ç”¨ï¼‰<br><code>A line in the â€œsharedâ€ state might be replicated in at least one other CPUâ€™s cache, so that this CPU is not permitted to store to the line without first consulting with other CPUs. As with the â€œexclusiveâ€ state, because thecorresponding value in memory is up to date, this cache can discard this data without writing it back to memory or handing it off to some other CPU.</code><br>å¤„äºshareçŠ¶æ€çš„cachelineï¼Œå…¶æ•°æ®å¯èƒ½åœ¨ä¸€ä¸ªæˆ–è€…å¤šä¸ªCPU cacheä¸­ï¼Œå› æ­¤ï¼Œå¤„äºè¿™ç§çŠ¶æ€çš„cache lineï¼ŒCPUä¸èƒ½ç›´æ¥ä¿®æ”¹cachelineçš„æ•°æ®ï¼Œè€Œæ˜¯éœ€è¦é¦–å…ˆå’Œå…¶ä»–CPU cacheè¿›è¡Œæ²Ÿé€šã€‚å’ŒexclusiveçŠ¶æ€ç±»ä¼¼ï¼Œå¤„äºshareçŠ¶æ€çš„cachelineå¯¹åº”çš„memoryä¸­çš„æ•°æ®ä¹Ÿæ˜¯æœ€æ–°çš„ï¼Œå› æ­¤ï¼Œcpuä¹Ÿå¯ä»¥ç›´æ¥ä¸¢å¼ƒcachelineä¸­çš„æ•°æ®è€Œä¸å¿…å°†å…¶è½¬äº¤ç»™å…¶ä»–CPU cacheæˆ–è€…å†™å›åˆ°memoryä¸­ã€‚<br><code>A line in the â€œinvalidâ€ state is empty, in other words, it holds no data. When new data enters the cache, it is placed into a cache line that was in the â€œinvalidâ€ state if possible. This approach is preferred because replacing a line in any other state could result in an expensive cache miss should the replaced line be referenced in the future.</code><br>å¤„äºinvalidçŠ¶æ€çš„cachelineæ˜¯ç©ºçš„ï¼Œæ²¡æœ‰æ•°æ®ã€‚å½“æ–°çš„æ•°æ®è¦è¿›å…¥cacheçš„æ—¶å€™ï¼Œä¼˜é€‰çŠ¶æ€æ˜¯invalidçš„cachelineï¼Œä¹‹æ‰€ä»¥å¦‚æ­¤æ˜¯å› ä¸ºå¦‚æœé€‰ä¸­å…¶ä»–çŠ¶æ€çš„cachelineï¼Œåˆ™è¯´æ˜éœ€è¦æ›¿æ¢cachelineæ•°æ®ï¼Œè€Œæœªæ¥å¦‚æœå†æ¬¡è®¿é—®è¿™ä¸ªè¢«æ›¿æ¢æ‰çš„cachelineæ•°æ®çš„æ—¶å€™å°†é‡åˆ°å¼€é”€éå¸¸å¤§çš„cache miss  </p><font color="red"> ä¸ªäººç†è§£:<br>1. å¯¹äºmodifiedçŠ¶æ€çš„cachelineï¼Œåˆ«çš„cpuå¦‚æœéœ€è¦å…¶ä¸­çš„æ•°æ®ï¼Œå¿…é¡»è¦å†™å›åˆ°memoryæˆ–è€…è½¬ç§»<br>2. exclusiveå¯ä»¥ç†è§£ä¸ºæ˜¯modifiedçš„è½»é‡ç‰ˆï¼ŒexclusiveçŠ¶æ€çš„cachelineæ•°æ®æ­¤æ—¶è¿˜æ²¡æœ‰è¢«cpuä¿®æ”¹ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒçš„æ•°æ®å’Œmemoryä¸­æ˜¯ä¸€è‡´çš„ï¼Œå½“åˆ«çš„cpuéœ€è¦çŠ¶æ€æ˜¯exclusiveçš„cachelineæ•°æ®æ—¶ï¼Œå¯ä»¥ç›´æ¥æä¾›æ•°æ®ä¸éœ€è¦å†™å›åˆ°memory<br>3. shareçŠ¶æ€çš„cachelineä¸èƒ½ç›´æ¥è¢«ä¿®æ”¹ï¼Œå¦‚æœä¸€ä¸ªcpuéœ€è¦å¯¹è¿™ä¸ªcachelineè¿›è¡Œä¿®æ”¹äº†ï¼Œéœ€è¦å…ˆé€šçŸ¥å…¶ä»–cpuè®©ä»–ä»¬å°†å„è‡ªå¯¹åº”çš„cachelineç½®ä¸ºinvalidï¼Œç„¶åå†åˆ‡æ¢cachelineçš„çŠ¶æ€åˆ°exclusiveï¼Œå†ç„¶åå°±æ˜¯MçŠ¶æ€<br>4. invalidçŠ¶æ€çš„cachelineä¹‹å‰å¯èƒ½æ˜¯æœ‰æ•°æ®çš„ï¼Œæ¯”å¦‚ä¹‹å‰æ˜¯sharedçŠ¶æ€ï¼Œåæ¥å…¶ä»–cpuè¦ä¿®æ”¹è¿™ä¸ªcachelineäº†ï¼Œå°±å‘é€šçŸ¥è¿‡æ¥äº†è¦æ±‚ç½®ä¸ºinvalidçš„ï¼Œä¸ç„¶è¯»å–å‡ºæ¥çš„å°±æ˜¯é”™è¯¯çš„<br><br> </font><p>æœ‰ä¸€ä¸ªMESIåŠ¨ç”»çš„ç½‘å€ï¼Œå¯ä»¥æ¨¡æ‹Ÿå„ä¸ªcachelineçš„çŠ¶æ€åˆ‡æ¢ï¼Œæ¯”èµ·æ–‡å­—æè¿°æ¥è®²æ›´å¥½ç†è§£ï¼Œå¯ä»¥ä¸æ–­çš„æ¨¡æ‹Ÿæµ‹è¯•ï¼Œå¯¹ç†è§£MESIå¾ˆæœ‰å¸®åŠ©<br><a href="https://www.scss.tcd.ie/Jeremy.Jones/VivioJS/caches/MESIHelp.htm" target="_blank" rel="noopener">VivioJS - Interactive Reversible E-Learning Animations for the WWW</a></p><p>æ¯”å¦‚å½“å‰çŠ¶æ€<br><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/memory-barrier03.png" alt=""></p><font color="red"><br>ä¸ªäººç†è§£æ·»åŠ <br>æ­¤æ—¶CPU0ä¸Ša1æ•°æ®å¯¹åº”çš„cachelineæ­¤æ—¶çš„çŠ¶æ€æ˜¯MçŠ¶æ€ï¼Œå¯ä»¥çœ‹åˆ°æ­¤æ—¶çš„æ•°å€¼æ˜¯11ï¼Œæ¯”memoryè¦æ–°ï¼Œå…¶ä»–ä¸¤ä¸ªcpu1ï¼Œcpu2ä¸Šçš„a1å¯¹åº”çš„cachelineæ˜¯invalidçŠ¶æ€ã€‚å¦‚æœæ­¤æ—¶cpu2ä¸Šå¯¹a1è¿›è¡Œå†™å€¼åŠ 1ï¼Œä¼šæ˜¯ä»€ä¹ˆæ ·å­çš„å‘¢ï¼Ÿ<br>æ ¹æ®ä¸Šé¢çš„ç†è®ºçŸ¥è¯†ï¼Œæ­¤æ—¶åº”è¯¥ä¼šé€šè¿‡æ€»çº¿é€šçŸ¥cpu0è®©å…¶å†™å…¥åˆ°memoryä¸­ï¼Œç„¶åcpu2æ‰èƒ½è¯»å–åˆ°æœ€æ–°çš„å€¼æ­¤æ—¶å†è¿›è¡Œä¿®æ”¹æ­¤æ—¶æ•°å€¼åº”è¯¥æ˜¯12å¹¶å°†çŠ¶æ€ç½®ä¸ºEå¹¶ä¸”å†™å›memoryï¼Œæ­¤æ—¶CPU0ä¸Šçš„a1å¯¹åº”cachelineçŠ¶æ€ç†è®ºä¸Šåº”è¯¥æ˜¯invalidã€‚<br></font><br>å®é™…çš„cpu2å¯¹a1åŠ 1åæ•ˆæœå›¾å¦‚ä¸‹ï¼š<br><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/memory-barrier04.png" alt=""><br><font color="red"> ä¸ªäººç†è§£æ·»åŠ <br>æ­¤æ—¶å¦‚æœå¯¹cpu2çš„cachelineè¿›è¡Œå†™åŠ 1ï¼ŒcachelineçŠ¶æ€ä¼šåˆ‡æ¢åˆ°MçŠ¶æ€ï¼Œå¦‚æœä¸€ç›´å†™ï¼Œæ•°å€¼ä¸€ç›´å¢åŠ ä¸€ç›´æ˜¯MçŠ¶æ€ï¼Œå…¶ä»–cpuæ— å˜åŒ–ã€‚å› ä¸ºæ­¤æ—¶Mæ˜¯æœ€æ–°çš„ï¼Œåªæœ‰å…¶ä»–cpuæ¯”å¦‚æ­¤æ—¶cpu1éœ€è¦è¯»å–a1çš„å€¼ï¼Œè¿™ä¸ªæ—¶å€™cpu2ä¼šå°†è¿™ä¸ªå€¼å†™å›åˆ°memoryå¹¶ä¸”æ­¤æ—¶cpu1å’Œcpu2ä¸Ša1å¯¹åº”çš„cachelineçŠ¶æ€éƒ½æ˜¯Sã€‚<br>å¦‚æœè¿™ä¸ªæ—¶å€™ï¼Œå¯¹cpu2çš„a1è¿›è¡Œå†™æ“ä½œå‘¢ï¼Ÿå…¶çŠ¶æ€ä¼šåˆ‡æ¢åˆ°Eï¼Œå…¶ä»–cpuå¯¹åº”çš„a1-cachelineéƒ½åˆ‡åˆ°invalid<br>ä»‹ç»å®ŒMESIåï¼Œæˆ‘ä»¬çŸ¥é“æœ‰äº†MESI protocolï¼Œä»»ä½•ä¸€ä¸ªCPU è¦å†™å…¥èµ„æ–™å‰ï¼Œéƒ½è¦å…ˆç¡®ä¿å…¶å®ƒCPU å·²invalid åŒä¸€ä½ç½®çš„cache å(å¸Œæœ›å†™å…¥çš„CPU å¹¿æ’­invalidateï¼Œå…¶å®ƒCPU å›invalidate ack)ï¼Œ æ‰èƒ½å†™èµ„æ–™åˆ°è‡ªå·±çš„cacheï¼Œå¹¶åœ¨ç¨åè¡¥å†™å›memoryã€‚<br></font><br>è¿™ä¸ªè®¾è®¡ç¡®ä¿èµ„æ–™çš„ä¸€è‡´æ€§ï¼Œä¸ç”¨æ‹…å¿ƒåŒä¸€æ—¶é—´åŒä¸€ä¸ªä½ç½®çš„èµ„æ–™ä¼šæœ‰ä¸åŒçš„å€¼ï¼Œä½†æ˜¯ä»£ä»·æ˜¯å†™å…¥ cache çš„é€Ÿåº¦ä¼šæœ‰ç‚¹æ…¢ï¼Œè®© CPU é—²ç½®ï¼Œä¸‹å›¾ä¸­çš„stallå°±æ˜¯cpuç­‰å¾…çš„æ—¶é•¿<br><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/memory-barrier05.png" alt=""><br><br><font color="red">  ä¸ªäººç†è§£æ·»åŠ <br>æƒ³è±¡ä¸€ä¸‹è¿™ä¸ªåœºæ™¯ï¼š<br><em> CPU 0 æ‰“ç®—å†™å…¥å€¼åˆ°ä½ç½® Xï¼ŒCPU 1 çš„ cache æœ‰ X çš„å€¼ã€‚å› ä¸ºç¼“å­˜ä¸€è‡´æ€§çš„ç¼˜æ•…ï¼Œè¿™ä¸ªæ—¶å€™CPU0ç»™CPU1å‘é€ä¸€ä¸ªinvalidçš„å¹¿æ’­å‘ŠçŸ¥å…¶éœ€è¦å°†å…¶å¯¹åº”æ•°å€¼ç½®äºæ— æ•ˆ</em> è¿™ä¸ªæ—¶å€™å‘¢cpu0å°±å¼€å§‹å‚»ä¹ä¹çš„ç­‰ CPU 1 å› invalidate ackï¼Œä½†æ˜¯æ­¤æ—¶CPU 1 çš„ cache å¯èƒ½å¤ªå¿™è€Œæ‹–æ…¢äº†å›è¦†æ—¶é—´ (æ¯”æ–¹åŒæ—¶ä» cache å¤§é‡çš„è¯»å†™èµ„æ–™ï¼Œæˆ–æ˜¯çŸ­æ—¶é—´æ”¶åˆ°å¤§é‡ invalidate ack)ã€‚<br>è¿™æ ·å°±å¯¼è‡´äº†CPU0ç™½ç™½è€—è´¹æ—¶é—´åœ¨ç­‰å¾…ä¸Šï¼Œè¿™å¯¹äºå®è´µçš„cpuèµ„æºæ˜¯ä¸€ç§å¾ˆå¤§çš„æµªè´¹ï¼Œå…¶å®æ²¡å¿…è¦ç­‰å¾…è¿™ä¹ˆé•¿çš„æ—¶é—´ï¼Œæ¯•ç«Ÿç‰©ç†CPU 1ä¸­çš„cachelineä¿å­˜æœ‰ä»€ä¹ˆæ ·å­çš„æ•°æ®ï¼Œå…¶å®éƒ½æ²¡æœ‰æ„ä¹‰ï¼Œè¿™ä¸ªå€¼éƒ½ä¼šè¢«CPU 0æ–°å†™å…¥çš„å€¼è¦†ç›–çš„ï¼Œæ‰€ä»¥èƒ½ä¸èƒ½ä¸ç­‰å‘¢ï¼Ÿè¿™ä¹Ÿå°±å¼•å‡ºäº†å¦å¤–ä¸€ä¸ªåè¯StoreBufferï¼Œè¿˜æœ‰å¦å¤–ä¸€ä¸ªåè¯å¯¹åº”åˆ·æ–°çš„Invalidate Queue<br></font> <h2 id="Store-Buffer-amp-Invalidate-Queue"><a href="#Store-Buffer-amp-Invalidate-Queue" class="headerlink" title="Store Buffer &amp; Invalidate Queue"></a>Store Buffer &amp; Invalidate Queue</h2><p>åœ¨CPUå’Œcacheä¹‹é—´å¢åŠ store bufferè¿™ä¸ªHW block</p><font color="red">  ä¸ªäººç†è§£æ·»åŠ <br>1. CPU 0 ä¸ç­‰ invalidate ackï¼šå…ˆå†™å…¥ store bufferï¼Œç„¶åç»§ç»­ä½œäº‹ã€‚ä¹‹åæ”¶åˆ° invalidate ack å†æ›´æ–° cache çš„çŠ¶æ€ã€‚å› ä¸ºæœ€æ–°çš„èµ„æ–™å¯èƒ½å­˜åœ¨ store bufferï¼ŒCPU è¯»èµ„æ–™çš„é¡ºåºå˜æˆ store buffer â†’ cache â†’ memoryã€‚<br>2. CPU 1 ç«‹å³å› invalidate ackï¼šæ”¶åˆ° invalidate æ—¶ï¼Œè®°å½•åˆ° invalidate queue é‡Œï¼Œå…ˆå› invalidate ackï¼Œç¨åå†å¤„ç† invalidateã€‚<br>3. ä¸ºå•¥æœ‰äº†store bufferåè¿˜ä¼šå†’å‡ºæ¥ä¸€ä¸ªinvalidate queueï¼Œå› ä¸º store buffer å¾ˆå°ï¼Œstore buffer æ»¡çš„æ—¶å€™ï¼ŒCPU 0 è¿˜æ˜¯å¾—ç­‰ invalidate ackï¼Œæ‰€ä»¥åŠ ä¸Š invalidate queueï¼ŒåŒç®¡é½ä¸‹å‡å°‘ CPU 0 ç­‰å¾…æ—¶é—´<br>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªç»†èŠ‚åé¢ä¼šæåˆ°ï¼Œå¦‚æœæœ‰æ•°æ®åŠ äº†å†™å†…å­˜å±éšœçš„è¯ï¼ŒåŠ å…¥storebufferï¼Œå…¶åé¢çš„å†™æ“ä½œä¸ç®¡æœ‰æ²¡æœ‰å†™å±éšœéƒ½è¦åŠ åˆ°storebufferä¸­ï¼Œè¿™å°±é€ æˆäº†storebufferæ›´å®¹æ˜“æ»¡äº†ï¼Œä¸€æ—¦æ»¡äº†åˆè¦å¼€å§‹ç­‰ackäº†ï¼Œè¿™å°±å¼•å…¥äº†<br>invalidate queueï¼Œåé¢è¿˜ä¼šç»§ç»­è®²å®ƒçš„ä½œç”¨<br>å…¶å®è¿™é‡Œå‡ºç°äº†ä¸€ä¸ªé‡æ’åºçš„â€œç°è±¡â€ï¼Œå°±æ˜¯ä¸€æ—¦æŸä¸€æ¡å†™æŒ‡ä»¤æ”¾åˆ°storebufferä¸­äº†ç»§ç»­åé¢çš„æŒ‡ä»¤æ“ä½œï¼Œè¿™å°±é€ æˆäº†ä¸‹ä¸€æ¡æŒ‡ä»¤è·‘åˆ°è¿™æ¡æŒ‡ä»¤å‰é¢æ‰§è¡Œçš„â€å‡è±¡â€ï¼Œè¿™ç§é‡æ’åºå°±æ˜¯ä¸ºäº†å……åˆ†åˆ©ç”¨cpuçš„æ€§èƒ½é¿å…ç™½ç™½çš„æµªè´¹ç­‰å¾…<br>CPU ä¸ºäº†æå‡æ•ˆç‡è€Œå‡ºç°çš„è¿™ç§â€æ”¹æŒ‡ä»¤â€æ‰§è¡Œçš„é¡ºåºï¼Œåªè¦æœ€åçµæœå’Œ single thread é¢„æœŸçš„çµæœä¸€æ ·å³å¯ã€‚è¿™å¥è¯å¯ä»¥ç»†å“ä¸‹ï¼Œæ‰€ä»¥å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹éœ€è¦æˆ‘ä»¬ç ”å‘äººå‘˜è‡ªå·±æ§åˆ¶<br></font>  <p>æœ‰äº†StoreBufferä»¥åŠInvalidate Queueä¹‹åçš„cpu cacheæ¶æ„å¦‚ä¸‹<br><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/memory-barrier06.png" alt=""></p><p>ä¸‹é¢æ‘˜è‡ªperfbookæ–‡æ¡£å…³äºStoreBufferä»¥åŠInvalidate Queueçš„è§£é‡Š</p><p><code>These store buffers are local to a given CPU or, on systems with hardware multithreading, local to a given core. Either way, a given CPU is permitted to access only the store buffer assigned to it. For example, in Figure C.5, CPU 0 cannot access CPU 1â€™s store buffer and vice versa. This restriction simplifies the hardware by separating concerns: The store buffer improves performance for consecutive writes, while the responsibility for communicating among CPUs (or cores, as the case may be) is fully shouldered by the cache-coherence protocol. However, even given this restriction, there are complications that must be addressed, which are covered in the next two sections.</code></p><p>è¿™äº›store bufferå¯¹äºcpuè€Œè¨€æ˜¯localçš„ï¼Œå¦‚æœç³»ç»Ÿæ˜¯ç¡¬ä»¶å¤šçº¿ç¨‹ï¼Œ é‚£ä¹ˆæ¯ä¸€ä¸ªcpu coreæ‹¥æœ‰è‡ªå·±ç§æœ‰çš„stroe bufferï¼Œä¸€ä¸ªcpuåªèƒ½è®¿é—®è‡ªå·±ç§æœ‰çš„é‚£ä¸ªstore bufferã€‚åœ¨ä¸Šå›¾ä¸­ï¼Œcpu 0ä¸èƒ½è®¿é—®cpu1çš„store bufferï¼Œåä¹‹äº¦ç„¶ã€‚ä¹‹æ‰€ä»¥åšè¿™æ ·çš„é™åˆ¶æ˜¯ä¸ºäº†æ¨¡å—åˆ’åˆ†ï¼ˆå„ä¸ªcpu coreæ¨¡å—å…³å¿ƒè‡ªå·±çš„äº‹æƒ…ï¼Œè®©cacheç³»ç»Ÿç»´æŠ¤è‡ªå·±çš„æ“ä½œï¼‰ï¼Œè®©ç¡¬ä»¶è®¾è®¡å˜å¾—ç®€å•ä¸€äº›ã€‚store bufferå¢åŠ äº†CPUè¿ç»­å†™çš„æ€§èƒ½ï¼ŒåŒæ—¶æŠŠå„ä¸ªCPUä¹‹é—´çš„é€šä¿¡çš„ä»»åŠ¡äº¤ç»™ç»´æŠ¤cacheä¸€è‡´æ€§çš„åè®®ã€‚å³ä¾¿ç»™æ¯ä¸ªCPUåˆ†é…ç§æœ‰çš„store bufferï¼Œä»ç„¶å¼•å…¥äº†ä¸€äº›å¤æ‚æ€§ï¼Œæˆ‘ä»¬ä¼šåœ¨ä¸‹é¢ä¸¤ä¸ªå°èŠ‚ä¸­æè¿°ã€‚</p><p><code>Unfortunately, each store buffer must be relatively small, which means that a CPU executing a modest sequence of stores can fill its store buffer (for example, if all of them result in cache misses). At that point, the CPU must once again wait for invalidations to complete in order to drain its store buffer before it can continue executing. This same situation can arise immediately after a memory barrier, when all subsequent store instructions must wait for invalidations to complete, regardless of whether or not these stores result in cache misses.</code></p><p>ä¸å¹¸çš„æ˜¯ï¼šæ¯ä¸ªcpuçš„store bufferä¸èƒ½å®ç°çš„å¤ªå¤§ï¼Œå…¶entryçš„æ•°ç›®ä¸ä¼šå¤ªå¤šã€‚å½“cpuä»¥ä¸­ç­‰çš„é¢‘ç‡æ‰§è¡Œstoreæ“ä½œçš„æ—¶å€™ï¼ˆå‡è®¾æ‰€æœ‰çš„storeæ“ä½œå¯¼è‡´äº†cache missï¼‰ï¼Œstore bufferä¼šå¾ˆå¿«çš„è¢«å¡«æ»¡ã€‚åœ¨è¿™ç§çŠ¶å†µä¸‹ï¼ŒCPUåªèƒ½åˆè¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°cache lineå®Œæˆinvalidationå’Œackçš„äº¤äº’ä¹‹åï¼Œå¯ä»¥å°†store bufferçš„entryå†™å…¥cachelineï¼Œä»è€Œä¸ºæ–°çš„storeè®©å‡ºç©ºé—´ä¹‹åï¼ŒCPUæ‰å¯ä»¥ç»§ç»­æ‰§è¡Œã€‚è¿™ç§çŠ¶å†µä¹Ÿå¯èƒ½å‘ç”Ÿåœ¨è°ƒç”¨äº†memory barrieræŒ‡ä»¤ä¹‹åï¼Œå› ä¸ºä¸€æ—¦store bufferä¸­çš„æŸä¸ªentryè¢«æ ‡è®°äº†ï¼Œé‚£ä¹ˆéšåçš„storeéƒ½å¿…é¡»ç­‰å¾…invalidationå®Œæˆï¼Œå› æ­¤ä¸ç®¡æ˜¯å¦cache missï¼Œè¿™äº›storeéƒ½å¿…é¡»è¿›å…¥store bufferã€‚</p><p><code>This situation can be improved by making invalidate acknowledge messages arrive more quickly. One way of accomplishing this is to use per-CPU queues of invalidate messages, or â€œinvalidate queuesâ€.</code></p><p>å¼•å…¥invalidate queueså¯ä»¥ç¼“è§£è¿™ä¸ªçŠ¶å†µã€‚store bufferä¹‹æ‰€ä»¥å¾ˆå®¹æ˜“è¢«å¡«å……æ»¡ï¼Œä¸»è¦æ˜¯å…¶ä»–CPUå›åº”invalidate acknowledgeæ¯”è¾ƒæ…¢ï¼Œå¦‚æœèƒ½å¤ŸåŠ å¿«è¿™ä¸ªè¿‡ç¨‹ï¼Œè®©store bufferå°½å¿«è¿›å…¥cachelineï¼Œé‚£ä¹ˆä¹Ÿå°±ä¸ä¼šé‚£ä¹ˆå®¹æ˜“å¡«æ»¡äº†ã€‚</p><p><code>Invalidate QueuesOne reason that invalidate acknowledge messages can take so long is that they must ensure that the correspondingcache line is actually invalidated, and this invalidation can be delayed if the cache is busy, for example, if the CPU is intensively loading and storing data, all of which resides in the cache. In addition, if a large number of invalidate messages arrive in a short time period, a given CPU might fall behind in processing them, thus possibly stalling all the other CPUs.</code></p><p>invalidate acknowledgeä¸èƒ½å°½å¿«å›å¤çš„ä¸»è¦åŸå› æ˜¯invalidate cachelineçš„æ“ä½œæ²¡æœ‰é‚£ä¹ˆå¿«å®Œæˆï¼Œç‰¹åˆ«æ˜¯cacheæ¯”è¾ƒç¹å¿™çš„æ—¶å€™ï¼Œè¿™æ—¶ï¼ŒCPUå¾€å¾€è¿›è¡Œå¯†é›†çš„loadingå’Œstoringçš„æ“ä½œï¼Œè€Œæ¥è‡ªå…¶ä»–CPUçš„ï¼Œå¯¹æœ¬CPU local cachelineçš„æ“ä½œéœ€è¦å’Œæœ¬CPUçš„å¯†é›†çš„cacheæ“ä½œè¿›è¡Œç«äº‰ï¼Œåªè¦å®Œæˆäº†invalidateæ“ä½œä¹‹åï¼Œæœ¬CPUæ‰ä¼šå‘ç”Ÿinvalidate acknowledgeã€‚æ­¤å¤–ï¼Œå¦‚æœçŸ­æ—¶é—´å†…æ”¶åˆ°å¤§é‡çš„invalidateæ¶ˆæ¯ï¼ŒCPUæœ‰å¯èƒ½è·Ÿä¸ä¸Šå¤„ç†ï¼Œä»è€Œå¯¼è‡´å…¶ä»–CPUä¸æ–­çš„ç­‰å¾…ã€‚</p><p><code>However, the CPU need not actually invalidate the cache line before sending the acknowledgement. It could instead queue the invalidate message with the understanding that the message will be processed before the CPU sends any further messages regarding that cache line.</code></p><p>ç„¶è€Œï¼ŒCPUå…¶å®ä¸éœ€è¦å®Œæˆinvalidateæ“ä½œå°±å¯ä»¥å›é€acknowledgementæ¶ˆæ¯ï¼Œè¿™æ ·ï¼Œå°±ä¸ä¼šé˜»æ­¢å‘ç”Ÿinvalidateè¯·æ±‚çš„é‚£ä¸ªCPUè¿›å…¥æ— èŠçš„ç­‰å¾…çŠ¶æ€ã€‚CPUå¯ä»¥bufferè¿™äº›invalidate messageï¼ˆæ”¾å…¥Invalidate Queuesï¼‰ï¼Œç„¶åç›´æ¥å›åº”acknowledgementï¼Œè¡¨ç¤ºè‡ªå·±å·²ç»æ”¶åˆ°è¯·æ±‚ï¼Œéšåä¼šæ…¢æ…¢å¤„ç†ã€‚å½“ç„¶ï¼Œå†æ…¢ä¹Ÿè¦æœ‰ä¸€ä¸ªåº¦ï¼Œä¾‹å¦‚å¯¹aå˜é‡cachelineçš„invalidateå¤„ç†å¿…é¡»åœ¨è¯¥CPUå‘é€ä»»ä½•å…³äºaå˜é‡å¯¹åº”cachelineçš„æ“ä½œåˆ°busä¹‹å‰å®Œæˆã€‚</p><p>æœ‰äº†Invalidate Queueçš„CPUï¼Œåœ¨æ”¶åˆ°invalidateæ¶ˆæ¯çš„æ—¶å€™é¦–å…ˆæŠŠå®ƒæ”¾å…¥Invalidate Queueï¼ŒåŒæ—¶ç«‹åˆ»å›é€acknowledge æ¶ˆæ¯ï¼Œæ— éœ€ç­‰åˆ°è¯¥cachelineè¢«çœŸæ­£invalidateä¹‹åå†å›åº”ã€‚å½“ç„¶ï¼Œå¦‚æœæœ¬CPUæƒ³è¦é’ˆå¯¹æŸä¸ªcachelineå‘æ€»çº¿å‘é€invalidateæ¶ˆæ¯çš„æ—¶å€™ï¼Œé‚£ä¹ˆCPUå¿…é¡»é¦–å…ˆå»Invalidate Queueä¸­çœ‹çœ‹æ˜¯å¦æœ‰ç›¸å…³çš„cachelineï¼Œå¦‚æœæœ‰ï¼Œé‚£ä¹ˆä¸èƒ½ç«‹åˆ»å‘é€ï¼Œéœ€è¦ç­‰åˆ°Invalidate Queueä¸­çš„cachelineè¢«å¤„ç†å®Œä¹‹åå†å‘é€ã€‚</p><p><code>Placing an entry into the invalidate queue is essentially a promise by the CPU to process that entry before transmitting any MESI protocol messages regarding that cache line. As long as the corresponding data structures are not highly contended, the CPU will rarely be inconvenienced by such a promise.</code></p><p>ä¸€æ—¦å°†ä¸€ä¸ªinvalidateï¼ˆä¾‹å¦‚é’ˆå¯¹å˜é‡açš„cachelineï¼‰æ¶ˆæ¯æ”¾å…¥CPUçš„Invalidate Queueï¼Œå®é™…ä¸Šè¯¥CPUå°±ç­‰äºä½œå‡ºè¿™æ ·çš„æ‰¿è¯ºï¼šåœ¨å¤„ç†å®Œè¯¥invalidateæ¶ˆæ¯ä¹‹å‰ï¼Œä¸ä¼šå‘é€ä»»ä½•ç›¸å…³ï¼ˆå³é’ˆå¯¹å˜é‡açš„cachelineï¼‰çš„MESIåè®®æ¶ˆæ¯ã€‚åªè¦æ˜¯å¯¹è¯¥cachelineçš„ç«äº‰ä¸æ˜¯é‚£ä¹ˆå‰§çƒˆï¼ŒCPUè¿˜æ˜¯å¯¹è¿™æ ·çš„æ‰¿è¯ºå¾ˆæœ‰ä¿¡å¿ƒçš„</p><p>å› ä¸ºå¤šäº† store buffer å’Œ invalidate queueï¼Œcache ä¹‹é—´çš„èµ„æ–™å°±æ²¡æœ‰å®Œå…¨ä¸€è‡´äº†</p><h2 id="ä¸€ä¸ªå°æ¡ˆä¾‹"><a href="#ä¸€ä¸ªå°æ¡ˆä¾‹" class="headerlink" title="ä¸€ä¸ªå°æ¡ˆä¾‹"></a>ä¸€ä¸ªå°æ¡ˆä¾‹</h2><p>æœ‰äº†ä¸Šé¢ä¸€è¿ä¸²ç†è®ºçŸ¥è¯†çš„é“ºå«ï¼Œä¸‹é¢çœ‹ä¸€ä¸ªå°ä¾‹å­ï¼Œè¿™ä¸ªä¾‹å­æ˜¯è€æ¼”å‘˜äº†ï¼Œå…¶å®ä¹Ÿæ˜¯æ‘˜è‡ªperfbookä¸­çš„ï¼Œåœ¨æŸ¥é˜…èµ„æ–™è¿‡ç¨‹ä¸­å‘ç°å¾ˆå¤šåšå®¢éƒ½æ˜¯ç”¨çš„è¿™ä¸ªå›¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a = b = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  a = <span class="number">1</span>;</span><br><span class="line">  b = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bar</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (b == <span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">  <span class="keyword">assert</span>(a == <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€ƒè™‘ CPU 0 æ‰§è¡Œ foo()ï¼Œ CPU 1 æ‰§è¡Œ bar()ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„å¤šçº¿ç¨‹ç¯å¢ƒï¼Œå‡è®¾ cache çš„çŠ¶æ€å¦‚ä¸‹:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">        a       b</span><br><span class="line">------------------------</span><br><span class="line">CPU <span class="number">0</span>:  Shared  Modified</span><br><span class="line">CPU <span class="number">1</span>:  Shared  Invalid</span><br></pre></td></tr></table></figure></p><p>å…¶å®å¯ä»¥ç†è§£ä¸ºå‡è®¾ a,b åˆå§‹å€¼ä¸º 0 ï¼Œa è¢« CPU0 å’Œ CPU1 å…±åŒæŒæœ‰ï¼Œb è¢« CPU0 ç‹¬å </p><p>è¯•æƒ³ï¼Œå³ä¾¿åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œfoo å’Œ bar å¦‚è‹¥ä¸¥æ ¼æŒ‰ç…§ç†æƒ³çš„é¡ºåºæ‰§è¡Œï¼Œæ˜¯æ— è®ºå¦‚ä½•éƒ½ä¸ä¼šå‡ºç° assert failed çš„æƒ…å†µçš„ã€‚ä½†å¾€å¾€äº‹ä¸æ„¿è¿ï¼Œè¿™ç§çœ‹ä¼¼å¾ˆè¯¡å¼‚çš„ä¸”æœ‰ä¸€å®šå‡ ç‡å‘ç”Ÿçš„ assert failed ï¼Œç»“åˆä¸Šé¢æ‰€è¯´çš„ Store Buffer å°±ä¸€ç‚¹éƒ½ä¸éš¾ç†è§£äº†<br>æˆ‘ä»¬æ¥è¿˜åŸ assert failed çš„æ•´ä¸ªè¿‡ç¨‹</p><ol><li>CPU0 å¤„ç† a=1 ä¹‹å‰å‘é€ Invalidate æ¶ˆæ¯ç»™ CPU1 ï¼Œå¹¶å°†å…¶æ”¾å…¥ Store Buffer ï¼Œå°šæœªåŠæ—¶åˆ·å…¥ç¼“å­˜ï¼Œæ‰€ä»¥è¿™æ—¶å€™ cache é‡Œaçš„å€¼ä»æ˜¯ 0ï¼›</li><li>CPU 0 è½¬è€Œå¤„ç† b=1 ï¼Œæ³¨æ„è¿™é‡Œæˆ‘ä»¬ä¸Šé¢å‡è®¾çš„æ˜¯æ­¤æ—¶b çš„çŠ¶æ€å·²æ˜¯ Modifiedï¼Œæ‰€ä»¥ b=1 ç›´æ¥è¢«åˆ·å…¥ç¼“å­˜ï¼›</li><li>CPU 1 å‘å‡º Read æ¶ˆæ¯è¯»å– b çš„å€¼ï¼ŒCPU 1 ä» CPU 0 çš„ cache è¯»åˆ° b = 1 ï¼Œè·³å‡º while è¯­å¥ï¼›</li><li>CPU 1 å‘å‡º Read æ¶ˆæ¯è¯»å– a çš„å€¼ï¼Œå‘ç° a å´ä¸ºæ—§å€¼ 0ï¼Œassert failedï¼Œç„¶åæ”¶åˆ° CPU 0 é€æ¥ â€œinvalidate aâ€ çš„è®¯æ¯ï¼Œä½†å·²å¤ªè¿Ÿäº†</li></ol><p>ä¸Šé¢è¿™ä¸ªè¿˜åŸè¿‡ç¨‹æ‘˜è‡ªä¸€ä¸ªå°æ¹¾äººå†™çš„åšå®¢&lt;å¾ç¡¬é«”è§€é»äº†è§£ memory barrier çš„å¯¦ä½œå’Œæ•ˆæœ&gt;<br>ä¸ªäººæ„Ÿè§‰è¿™ä¸ªæè¿°è¿‡ç¨‹ä¸å®Œå…¨å‡†ç¡®ï¼Œæ—¢ç„¶å·²ç»æœ‰äº†Invalidate Queueï¼Œè¿™ä¸ªæ—¶å€™cpu1ç†è®ºä¸Šæ˜¯ç«‹åˆ»ç»™cpu0å‘ackçš„ï¼Œå¯èƒ½ç”±äºå½“å‰è¦å›å¤çš„ackå¾ˆå¤šï¼Œå¯¼è‡´å‘é€ç»™cpu0çš„ackå¹¶æ²¡æœ‰è¾¾åˆ°â€ç«‹åˆ»â€çš„æ•ˆæœ<br>æ‰€ä»¥å‡ºç°ä¸Šé¢æè¿°çš„è¿‡ç¨‹ä¹Ÿæ˜¯æœ‰å¯èƒ½çš„ï¼Œä½†æ˜¯å…¶å®è¿˜æœ‰ä¸€ç§å¯èƒ½ï¼Œå°±æ˜¯è¯»å–açš„æ—¶å€™æœ€æ–°å€¼Invalidate Queueä¸­ï¼Œè¯¦ç»†åœ¨ä¸‹é¢çš„ä¸ªäººç†è§£ç¯èŠ‚ä¸­  </p><font color="red"><br>ä¸ªäººç†è§£å¦‚ä¸‹<br>1. å¤§è‡´æµç¨‹æ˜¯CPU0è¿™ä¸ªæ—¶å€™æƒ³è¦å¯¹aè¿›è¡Œå†™å€¼ï¼Œå‘ç°aå¯¹åº”çš„cachelineå¯¹åº”çš„çŠ¶æ€æ˜¯Sï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œçš„cpu1ä¸Šä¹Ÿæœ‰açš„å€¼ï¼Œæ‰€ä»¥éœ€è¦é€šçŸ¥cpu1ï¼Œé€šè¿‡æ€»çº¿å‘ä¸ªæ¶ˆæ¯å‘ŠçŸ¥cpu1è¿›è¡Œinvalidï¼Œå› ä¸ºæœ‰storebufferè¿™ç©æ„æ‰€ä»¥ç›´æ¥æ”¾åˆ°storebufferï¼Œåˆå› ä¸ºæœ‰invalidate queueçš„å­˜åœ¨<br>2. æ‰€ä»¥CPU1ç«‹åˆ»å›å¤äº†â€œå·²æ›´æ–°â€çš„ackå›å»äº†ï¼Œå…¶å®å¹¶æ²¡æœ‰å®é™…æ›´æ–°ï¼Œåªæ˜¯å…ˆæ”¾åœ¨äº†invalidate queueä¸­å¾…æ›´æ”¹æ ‡è®°ä¸ºinvalidï¼ŒCPU0æ”¶åˆ°è¿™ä¸ªackåå°†æ•°æ®å›å†™åˆ°å†…å­˜ä¸­<br>3. æ­¤æ—¶CPU0å¼€å§‹äº†æ‰§è¡Œä¸‹ä¸€æ¡å¯¹bå†™å€¼ï¼Œå› ä¸ºbæ˜¯MçŠ¶æ€ä¹Ÿæ˜¯è¯´æ˜¯cpu0ç‹¬å çš„ï¼Œæ‰€ä»¥ç›´æ¥å†™åˆ°ç¼“å­˜å°±å®Œäº‹äº†<br>4. å†æ¥åˆ°cpu1è¿™è¾¹çœ‹çœ‹ï¼Œæ­¤æ—¶cpu1è¯»å–bçš„å€¼ï¼Œå› ä¸ºcpu1ä¸Šæ²¡æœ‰å¯¹åº”çš„cachelineï¼Œcpu0ä¸Šbå¯¹åº”çš„cachelineæ˜¯MçŠ¶æ€ï¼Œæ‰€ä»¥æ­¤æ—¶cpu0ä¼šå°†bçš„å€¼å†™å›åˆ°memory,å¹¶ä¸”è¿™ä¸ªæ—¶å€™cpu1è¯»å–åˆ°çš„å€¼æ˜¯æœ€æ–°çš„å’Œmemoryä¸€æ ·ï¼Œæ­¤æ—¶cpu1å’Œcpu0ä¸Šbå¯¹äºçš„cachelineçŠ¶æ€å˜ä¸ºS<br>5. è¿™ä¸ªæ—¶å€™å†çœ‹assert(a == 1);  æ­¤æ—¶CPU1è¯»å–åˆ°çš„æ•°å€¼aä»ç„¶æ˜¯SçŠ¶æ€ï¼Œæ‰€ä»¥ç›´æ¥è¯»å–äº†ï¼Œè¯»å–å‡ºæ¥è‡ªç„¶æ˜¯0ï¼Œå› ä¸ºæ­¤æ—¶å¹¶æ²¡æœ‰å»invalidate queueçœ‹çœ‹æœ‰æ²¡æœ‰å€¼ï¼Œæ‰€ä»¥çœ‹åˆ°çš„å€¼ä¸æ˜¯æœ€æ–°çš„ï¼Œå‡ºç°assert fail<br><br>å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿå¯ä»¥åœ¨fooå‡½æ•°a=1ä¸‹é¢åŠ ä¸€ä¸ªå†™å†…å­˜å±éšœï¼Œè¿™æ ·çš„è¯å½“a=1çš„å€¼æ”¾åˆ°storebufferä¸­åï¼Œå‘ç°åé¢æœ‰ä¸€ä¸ªå†™å†…å­˜å±éšœæŒ‡ä»¤ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šæŠŠåé¢çš„å†™æŒ‡ä»¤éƒ½ä¼šé¡ºåºæ”¾åˆ°storebufferä¸­ã€‚å¦å¤–åœ¨barå‡½æ•°ç¬¬äºŒè¡Œè¯»å–açš„æ—¶å€™éœ€è¦çœ‹ä¸‹invalidqueueä¸­æœ‰æ²¡æœ‰å€¼ï¼Œæœ‰çš„è¯ä¸€å®šè¦å°†å¯¹åº”å€¼å¾—cachelineæ ‡è®°ä¸ºæ— æ•ˆï¼Œç„¶åå»è¯»å–æœ€æ–°å€¼ï¼Œè¿™å°±å¼•å…¥äº†è¯»å†…å­˜å±éšœï¼Œå¼ºåˆ¶æ ‡è®°é˜Ÿåˆ—ä¸­æ‰€æœ‰çš„å€¼å¯¹åº”cachelineä¸ºæ— æ•ˆ<br></font> <p>ä¸Šé¢çš„è¿™ä¸ªç¨‹åºåœ¨å®é™…å¼€å‘ä¸­ä¹Ÿæ˜¯æœ‰å¯èƒ½ä¼šé‡åˆ°çš„ï¼Œäºæ˜¯ CPUæä¾›äº†write memory barrier ä»¥åŠ read memory barrierï¼Œè®©è½¯ä»¶æœ‰æœºä¼šé¿å…è¿™ä¸ªé—®é¢˜</p><h2 id="write-memory-barrier"><a href="#write-memory-barrier" class="headerlink" title="write memory barrier"></a>write memory barrier</h2><p>æ¯”å¦‚åœ¨ä¸Šé¢çš„ foo æ–¹æ³•ä¸­ï¼Œa çš„èµ‹å€¼å’Œ b çš„èµ‹å€¼ä¹‹é—´åŠ ä¸Šè¿™ä¸ªwrite memory barrier<br>ä¼šä½¿å¾— CPU åœ¨åç»­å˜é‡å˜æ›´å†™å…¥ä¹‹å‰ï¼ŒæŠŠ Store Buffer çš„å˜æ›´å†™å…¥ flush åˆ°ç¼“å­˜ï¼›CPU è¦ä¹ˆå°±ç­‰å¾… flush å®Œæˆåå†™å…¥ï¼Œè¦ä¹ˆå°±æŠŠåç»­çš„å†™å…¥å˜æ›´æ”¾åˆ° Store Buffer ä¸­ï¼Œç›´åˆ° Store Buffer æ•°æ®é¡ºåºåˆ·åˆ°ç¼“å­˜ã€‚<br><strong>write memory barrier ç¡®ä¿ä¹‹å‰åœ¨ store buffer é‡Œçš„èµ„æ–™ä¼šå…ˆæ›´æ–°åˆ° cacheï¼Œç„¶åæ‰èƒ½å†™å…¥ barrier ä¹‹åçš„èµ„æ–™åˆ° cacheã€‚</strong></p><p>å‡è®¾æˆ‘ä»¬åœ¨ foo() çš„ a=1 å’Œ b=1 ä¹‹é—´æ’ä¸€ä¸ª write memory barrierï¼Œè¿‡ç¨‹å˜ä¸º</p><ol><li>write memory barrier å…ˆè®¾ store buffer é‡Œçš„èµ„æ–™ä¸º â€œmarkedâ€ (å³ a=1)</li><li>å†™å…¥ b çš„æ—¶å€™ï¼Œå› ä¸ºå‘ç° store buffer é‡Œæœ‰ marked çš„æ ä½ï¼Œæ‰€ä»¥å³ä½¿ b å·²å¤„äº Modifiedï¼Œä»éœ€å†™å…¥ b=1 åˆ° store bufferï¼Œä¸è¿‡çŠ¶æ€æ˜¯ â€œunmarkedâ€</li><li>å¾…æ”¶åˆ° a çš„ invalidate ack åï¼Œcache ä¸­ a çš„çŠ¶æ€æ”¹ä¸º Modifiedï¼Œç„¶åå…ˆå†™å…¥æœ‰ marked æ ä½çš„å€¼åˆ° cacheï¼Œå†å†™å…¥ unmarked æ ä½çš„å€¼åˆ° cacheã€‚</li></ol><p>è¿™æ ·å…¶å®ƒ CPU å°±ä¼šä¾åºçœ‹åˆ° aã€b æ›´æ–°çš„å€¼äº†</p><h2 id="read-memory-barrier"><a href="#read-memory-barrier" class="headerlink" title="read memory barrier"></a>read memory barrier</h2><p>è¿˜æ˜¯ä»¥ä¸Šé¢çš„ä¾‹å­è¯´æ˜ï¼Œå‡è®¾ CPU 1 çš„ cache é‡Œ a å¤„äº Sharedã€‚ CPU 0 å·²æ›´æ–° aã€b åˆ°å®ƒçš„ cacheï¼ŒCPU 1 çš„ invalidate queue é‡Œæœ‰ â€œinvalidate aâ€ï¼Œä½†è¿˜æ²¡å¤„ç†ã€‚<br>è¿™æ—¶ CPU 1 ä¾åºè¯» bã€a çš„å€¼ï¼Œä¼šä» CPU 0 çš„ cache è¯»åˆ° b=1ï¼Œç„¶åä»è‡ªå·±çš„ cache è¯»åˆ° a=0 (å› ä¸ºè¿˜æ²¡ invalidate a)ã€‚å’Œä¸Šé¢çš„å†™å…¥æƒ…å†µæœ¬è´¨ä¸€æ ·çš„ï¼Œinvalidate queueç ´åäº†ç¼“å­˜ä¸€è‡´æ€§<br>invalidate queueæ˜¯æœ€æ–°çš„ï¼Œä½†æ˜¯ a å¤„äº Sharedï¼Œæ‰€ä»¥ä¼šä»cacheä¸­ç›´æ¥æ‹¿ï¼Œæ‹¿å¾—æ˜¯0ï¼Œä¸æ˜¯æœ€æ–°çš„<br>æ‰€ä»¥å³ä¾¿åœ¨fooå‡½æ•°ç»™a,båˆ†åˆ«èµ‹å€¼ä¸­é—´åŠ ä¸Šå†™æ …æ ï¼Œè¿˜æ˜¯ä¸èƒ½å®Œå…¨ä¿è¯å¾—åˆ°çš„ç»“æœæ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œå…¶å®è¿™ä¸ªæ—¶å€™ï¼Œå¯ä»¥çŒœåˆ°éœ€è¦åœ¨assertä¹‹å‰ä¹Ÿå°±æ˜¯è¯»å–aä¹‹å‰åŠ ä¸Šä¸€ä¸ªè¯»æ …æ read memory barrier<br>ç›®çš„å¾ˆæ˜ç¡®ç¡®ä¿å…ˆæ¸…ç©º invalidate queue å†ç»§ç»­è¯»èµ„æ–™ã€‚<br>åœ¨ assert(a==1) ä¹‹å‰æ’å…¥ read memory barrierï¼Œæ‰§è¡Œé¡ºåºå˜æˆè¿™æ ·:</p><ol><li>CPU 1 æ‰§è¡Œ read memory barrier æ—¶ä¼šè®¾ invalidate queue é‡Œçš„èµ„æ–™ä¸º â€œmarkedâ€</li><li>CPU 1 è¯» cache é‡Œ a çš„å€¼æ—¶ï¼Œå‘ç° invalidate queue é‡Œæœ‰æ ‡è®° aï¼Œäºæ˜¯ä¼šå…ˆæ‰§è¡Œ invalidate a å†ç»§ç»­è¯» a çš„å€¼</li><li>æ‰§è¡Œ invalidate a åï¼Œå°±ä¸ä¼šè¯»è‡ªå·± cache çš„å€¼ï¼Œè€Œæ”¹ä» CPU 0 çš„ cache è¯»åˆ°æœ€æ–°çš„å€¼ï¼Œè¾¾åˆ°ã€Œä¾åºè¯» bã€a çš„å€¼ã€çš„æ•ˆæœ</li></ol><h2 id="ç¬¬äºŒä¸ªå°æ¡ˆä¾‹"><a href="#ç¬¬äºŒä¸ªå°æ¡ˆä¾‹" class="headerlink" title="ç¬¬äºŒä¸ªå°æ¡ˆä¾‹"></a>ç¬¬äºŒä¸ªå°æ¡ˆä¾‹</h2><p>å†æ‘˜ä¸€å¥perfbookçš„è¯ï¼Œè¯´çš„æœ‰ç‚¹æ„æ€</p><p><code>Since the standard synchronization primitives preserve the illusion of ordering, your path of least resistance is to stop reading this section and simply use these primitives.However, if you need to implement the synchronization primitives themselves, or if you are simply interested in understanding how memory ordering and memory barriers work, read on!</code></p><p>ä½ ä¹Ÿè®¸é¢å¯¹CPUçš„è¿™ç§out of orderçš„è¡Œä¸ºæœ‰æœ¬èƒ½çš„æŠµæŠ—ï¼Œæ²¡æœ‰å…³ç³»ï¼Œæ”¾è½»æ¾ï¼Œä½ çš„æŠµæŠ—ä¹‹è·¯å¯ä»¥åˆ°æ­¤ç»“æŸï¼Œåªè¦ä½ æ„¿æ„ä½¿ç”¨å„ç§åŒæ­¥åŸè¯­æ¥ä¿æŠ¤ä½ ç¨‹åºä¸­çš„å…±äº«èµ„æºï¼Œå› ä¸ºé€è¿‡è¿™äº›æ ‡å‡†çš„åŒæ­¥åŸè¯­ï¼Œä½ çœ‹åˆ°çš„æ˜¯ä¸€ä¸ªé¡ºåºæ‰§è¡Œçš„ä¸–ç•Œã€‚å½“ç„¶ï¼Œè¿™ä¼šå¼•å…¥ä¸€äº›å°å°çš„é—æ†¾ï¼šä½ ä¸çŸ¥é“åº•å±‚åˆ°åº•æ˜¯å¦‚ä½•æŠŠâ€œä¹±åºâ€å˜æˆâ€œæœ‰åºâ€çš„ã€‚ä¸è¿‡ï¼Œå®ç°åŒæ­¥åŸè¯­çš„é‚£äº›è½¯ä»¶å·¥ç¨‹å¸ˆæ²¡æœ‰è¿™ä¸ªè±å…æƒï¼Œä»–ä»¬å¿…é¡»è¦æ·±å…¥ç†è§£memory orderå’Œmemory barrierã€‚æ­¤å¤–ï¼Œé‚£äº›æƒ³è¦â€œæ‰“ç ´æ²™é”…é—®åˆ°åº•â€ä»¥åŠæƒ³è¦â€œçŸ¥å…¶ç„¶çŸ¥å…¶æ‰€ä»¥ç„¶â€çš„å·¥ç¨‹å¸ˆä¹Ÿå¯ä»¥è·Ÿéšæˆ‘ä»¬ç»§ç»­ã€‚</p><p>å†ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œæ‘˜è‡ª perfbook memory barrierï¼ˆ14.2ç« èŠ‚ï¼‰<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> thread0(<span class="keyword">void</span>)</span><br><span class="line"><span class="number">2</span> &#123;</span><br><span class="line"><span class="number">3</span> A = <span class="number">1</span>;</span><br><span class="line"><span class="number">4</span> smp_wmb();</span><br><span class="line"><span class="number">5</span> B = <span class="number">1</span>;</span><br><span class="line"><span class="number">6</span> &#125;</span><br><span class="line"><span class="number">7</span></span><br><span class="line"><span class="number">8</span> thread1(<span class="keyword">void</span>)</span><br><span class="line"><span class="number">9</span> &#123;</span><br><span class="line"><span class="number">10</span> <span class="keyword">while</span> (B != <span class="number">1</span>)</span><br><span class="line"><span class="number">11</span> <span class="keyword">continue</span>;</span><br><span class="line"><span class="number">12</span> barrier();</span><br><span class="line"><span class="number">13</span> C = <span class="number">1</span>;</span><br><span class="line"><span class="number">14</span> &#125;</span><br><span class="line"><span class="number">15</span></span><br><span class="line"><span class="number">16</span> thread2(<span class="keyword">void</span>)</span><br><span class="line"><span class="number">17</span> &#123;</span><br><span class="line"><span class="number">18</span> <span class="keyword">while</span> (C != <span class="number">1</span>)</span><br><span class="line"><span class="number">19</span> <span class="keyword">continue</span>;</span><br><span class="line"><span class="number">20</span> barrier();</span><br><span class="line"><span class="number">21</span> <span class="keyword">assert</span>(A != <span class="number">0</span>);</span><br><span class="line"><span class="number">22</span> &#125;</span><br></pre></td></tr></table></figure></p><p>å¼€å§‹ï¼Œå˜é‡Aï¼ŒBï¼ŒCçš„åˆå§‹å€¼éƒ½æ˜¯0ã€‚æ ¹æ®ç¨‹åºé€»è¾‘ï¼šthread0ä¸­ï¼ŒAå…ˆäºBèµ‹å€¼ï¼Œthread1ä¸­ï¼Œç¨‹åºé€»è¾‘æ˜¯ä¸€ç›´ç­‰åˆ°Bå˜é‡è¢«èµ‹å€¼ä¸º1ä¹‹åï¼Œå†ç»™Cèµ‹å€¼ã€‚è¿™é‡Œï¼Œäººç±»çš„ç›´è§‰å‘Šè¯‰æˆ‘ä»¬ï¼Œå¦‚æœå˜é‡Cå·²ç»è¢«èµ‹å€¼ä¸º1çš„æ—¶å€™ï¼ˆç¬¬13è¡Œç¨‹åºï¼‰ï¼ŒAä¸€å®šå·²ç»è¢«èµ‹å€¼ä¸º1äº†ã€‚åŒæ ·çš„ï¼Œåœ¨thread2ä¸­ï¼Œç¬¬21è¡Œç¨‹åºçš„assertä¸€å®šæ˜¯ä¸ä¼šè¢«è§¦å‘çš„ã€‚</p><p><code>This line of reasoning, intuitively obvious though it may be, is completely and utterly incorrect. Please note that this is not a theoretical assertion: actually running this code on real-world weakly-ordered hardware (a 1.5GHz 16-CPU POWER 5 system) resulted in the assertion firing 16 times out of 10 million runs. Clearly, anyone who produces code with explicit memory barriers should do some extreme testing â€“ although a proof of correctness might be helpful, the strongly counter-intuitive nature of the behavior of memory barriers should in turn strongly limit oneâ€™s trust in such proofs. The requirement for extreme testing should not be taken lightly, given that a number of dirty hardware-dependent tricks were used to greatly increase the probability of failure in this run.</code></p><p>ä¸Šä¸€èŠ‚çš„æ¨ç†ä»ç›´è§‰ä¸Šçœ‹æ˜¯å¯¹çš„ï¼Œä½†æ˜¯åœ¨å®é™…çš„CPUä¸Šè¿è¡Œçš„ç»“æœç¡®æ˜¯å®Œå…¨é”™è¯¯çš„ã€‚ç‰¹åˆ«éœ€è¦æŒ‡å‡ºçš„æ˜¯è¿™ä¸ªç»“æœä¸æ˜¯ç†è®ºæ¨å¯¼å¾—å‡ºæ¥çš„ï¼Œæ˜¯åœ¨çœŸå®çš„1.5GHz 16æ ¸çš„POWER 5ç³»ç»Ÿï¼ˆè¯¥cpuçš„å†…å­˜æ¨¡å‹å±äºweakly orderï¼‰ä¸Šè§‚æµ‹å¾—åˆ°çš„ï¼Œå¹³å‡æ¯1åƒä¸‡æ¬¡æ‰§è¡Œä¼šæœ‰16æ¬¡åœ¨21è¡Œä»£ç å¤„å‡ºç°assertå¤±è´¥ã€‚å¾ˆæ˜¾ç„¶ï¼Œå½“æˆ‘ä»¬æ’°å†™æ˜¾å¼è°ƒç”¨memory barrierçš„ä»£ç çš„æ—¶å€™ï¼Œå¿…é¡»è¿›è¡Œéå¸¸å¤§é‡çš„å®é™…æµ‹è¯•ã€‚åœ¨ç†è®ºä¸Šè¿›è¡Œæ­£ç¡®æ€§çš„æ¨å¯¼æ˜¯å¦æœ‰æ„ä¹‰å‘¢ï¼Ÿä¹Ÿè®¸æœ‰å¸®åŠ©ï¼Œä½†æ˜¯ï¼Œä½ çŸ¥é“çš„ï¼Œåœ¨ä½¿ç”¨memory barrierçš„æ—¶å€™ä¼šå‘ç”Ÿå¾ˆå¤šå’Œä½ çš„ç›´è§‰ç›¸æ‚–çš„ä¸œè¥¿ï¼Œè¿™è®©ç†è®ºçš„æ¨å¯¼å˜å¾—ä¸é‚£ä¹ˆç¡®å®šã€‚åˆ«å°çœ‹é‚£äº›çœ‹èµ·æ¥æ„šè ¢çš„ã€éå¸¸é‡å¤æ€§çš„å¤§é‡æµ‹è¯•ï¼Œè¦çŸ¥é“ä¸åŒçš„CPUä¼šä½¿ç”¨ä¸åŒçš„ç¡¬ä»¶è®¾è®¡æ–¹æ³•ï¼Œå› æ­¤åœ¨memory orderå’Œmemory barrieræ–¹é¢è¡¨ç°å„ä¸ç›¸åŒï¼Œä½ çš„ç¨‹åºæƒ³è¦åœ¨å„ç§ç¡¬ä»¶ä¸Šï¼Œæ¯æ¬¡éƒ½è¿è¡ŒæˆåŠŸä¸æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹æƒ…ã€‚</p><font color="red"><br>ä¸ªäººç†è§£:<br>åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆè®©ç¨‹åºåœ¨21è¡Œçš„assertä¸Šå¤±è´¥ï¼Ÿæˆ‘ä»¬ä¸€èµ·åˆ†æä¸€ä¸‹ã€‚æˆ‘ä»¬å‡è®¾CPU0ã€CPU1å’ŒCPU2åˆ†åˆ«æ‰§è¡Œthread0ã€thread1å’Œthread2<br>1. å¯¹äºthread 0ï¼Œæˆ‘ä»¬å‡è®¾Aåœ¨CPU0çš„local cacheä¸­ï¼Œä½†æ˜¯çŠ¶æ€æ˜¯sharedï¼Œå› æ­¤å½“æ‰§è¡ŒA=1çš„è¯­å¥çš„æ—¶å€™ï¼Œä¸èƒ½ç«‹åˆ»æ‰§è¡Œï¼Œéœ€è¦å’Œå…¶ä»–CPU cacheè¿›è¡Œæ²Ÿé€šï¼ˆå‘é€invalidate messageå»å…¶ä»–CPUï¼‰ï¼Œå½“ç„¶ï¼Œcpuä¸ä¼šåœä¸‹å…¶è„šæ­¥ï¼Œå°†Açš„æ–°å€¼1æ”¾å…¥store bufferï¼Œç»§ç»­æ‰§è¡Œã€‚<br>2. smp_wmbå¯ä»¥mark store bufferä¸­Aå€¼ï¼Œå¹¶ä¸”é˜»æ­¢åç»­çš„storeæ“ä½œè¿›å…¥cacheï¼Œè¿™æ—¶å€™ï¼Œå³ä¾¿Båœ¨CPU0çš„local cacheä¸­ï¼ŒB=1çš„èµ‹å€¼ä¹Ÿä¸èƒ½æ“ä½œåˆ°cacheï¼Œè€Œæ˜¯è¦è¿›å…¥store bufferï¼Œå½“ç„¶çŠ¶æ€æ˜¯unmarkedã€‚å‰é¢è¯´è¿‡ï¼Œåé¢è¿›cacheçš„è¯æ˜¯markedå…ˆè¿›ç„¶åunmarkedè¿›ï¼Œç”±äºå­˜åœ¨Invalidate Queueè¿™ä¸­ä¸œè¥¿ï¼Œå› æ­¤ï¼ŒCPU 0å¾ˆå¿«å°±å¯ä»¥æ”¶åˆ°æ¥è‡ªå…¶ä»–CPUçš„å“åº”ï¼Œè¿™æ—¶å€™ï¼ŒCPU0å¯ä»¥è¶Šè¿‡write memory barrierï¼Œå®Œæˆå¯¹Bçš„èµ‹å€¼ã€‚æ­¤æ—¶Açš„çŠ¶æ€åˆ‡åˆ°Mï¼Œå›å†™åˆ°cacheä¸­ï¼ŒBä¹Ÿè·Ÿç€å›å†™åˆ°cacheä¸­äº†ã€‚<br>3. å› æ­¤ï¼Œå¯¹äºthread1ï¼Œå¾ˆå¿«å¯ä»¥æ„ŸçŸ¥Bçš„æ–°å€¼â€œ1â€å¹¶æ‰§è¡Œäº†å¯¹Cå˜é‡çš„èµ‹å€¼ã€‚æ¥åˆ°thread2ï¼ŒåŒæ ·çš„ï¼Œå¯¹Cå˜é‡çš„loadæ“ä½œä¹Ÿå¯ä»¥æ„ŸçŸ¥åˆ°thread1ä¸­çš„èµ‹å€¼å› æ­¤è·³å‡ºwhileå¾ªç¯ã€‚<br>4. æœ€å…³é”®çš„æ¥äº†ï¼Œç¬¬20è¡Œçš„barrierè¿™ä¸ªä¼˜åŒ–å±éšœä¸èƒ½é˜»æ­¢CPUå¯¹Aå˜é‡çš„è®¿é—®ï¼Œä½†æ˜¯ï¼Œå¯èƒ½ç”±äºè¿™æ—¶CPU cacheæ“ä½œéå¸¸ç¹å¿™ï¼ŒAå˜é‡çš„invalidate messageè¿˜åœ¨å…¶invalidate queueä¸­ï¼Œå› æ­¤load Aå¾—åˆ°äº†æ—§çš„å€¼0ã€‚<br><br>å½“ç„¶ï¼Œè¦ä¿®æ­£è¿™ä¸ªé—®é¢˜éå¸¸ç®€å•ï¼Œä¿®æ”¹20è¡Œä»£ç ä¸ºsmp_rmbå³å¯ã€‚ä¸€æ—¦æ‰§è¡Œäº†smp_rmbï¼Œå°±ä¼šmark invalidate queueä¸­çš„entryï¼Œè¿™æ—¶å€™ï¼ŒCPUæ‰§è¡Œåç»­çš„loadæ“ä½œéƒ½å¿…é¡»è¦ç­‰åˆ°Invalidate queueä¸­çš„æ‰€æœ‰ç¼“å­˜çš„invalidate messageï¼ˆå½“ç„¶ï¼ŒçŠ¶æ€å¿…é¡»æ˜¯markedï¼‰è¢«å¤„ç†å¹¶ä½“ç°åˆ°cacheä¸­ã€‚å› æ­¤ï¼Œä½¿ç”¨smp_rmbå³å¯ä»¥åœ¨21è¡Œçš„load Aæ“ä½œä¸­æ€»æ˜¯è·å–Açš„æ–°å€¼â€œ1â€ä»è€Œé¿å…äº†assert failã€‚<br>è¿™é‡Œæœ‰ä¸ªç–‘é—®å°±æ˜¯ä¾‹å­ä¸­çš„barrier();è¿™ç©æ„åˆ°åº•åˆ°åº•ä»£è¡¨å•¥æ„æ€ï¼ŒæŒ‰ç…§ä½œè€…æƒ³è¦è¡¨è¾¾çš„æ„æ€æ˜¯barrier()èµ·ä¸åˆ°è¯»å±éšœçš„åŠŸèƒ½ï¼Œè¦æ”¹ä¸ºsmp_rmb<br></font> <h2 id="ç®€è¦å½’çº³"><a href="#ç®€è¦å½’çº³" class="headerlink" title="ç®€è¦å½’çº³"></a>ç®€è¦å½’çº³</h2><p>ç¡¬ä»¶ä¸ºäº†å‡å°‘è¯»å†™ memory è€Œæœ‰ cacheã€‚æœ‰ cache å°±è¦ç¡®ä¿ cache ä¹‹é—´çš„èµ„æ–™ä¸€è‡´ (åŒä¸€æ—¶é—´åŒä¸€ä½ç½®åªæœ‰ä¸€ä¸ªå€¼)ã€‚ä½†ç¡®ä¿ cache èµ„æ–™å®Œå…¨ä¸€è‡´å®¹æ˜“è®© CPU é—²ç½®ï¼Œäºæ˜¯æœ‰äº† store buffer å’Œ invalidate queue é™å°‘ CPU é—²ç½®ã€‚ä»£ä»·æ˜¯åªä¿è¯ CPU è‡ªå·±ä¼šè¯»åˆ°è‡ªå·±å†™å…¥çš„æœ€æ–°æ•°æ®ï¼Œä½†å…¶å®ƒ CPU ä¸ä¸€å®šã€‚<br><strong>ä¸ºäº†è®©å…¶å®ƒ CPU æœ‰éœ€è¦çš„æ—¶å€™ä¹Ÿèƒ½è¯»åˆ°æœ€æ–°çš„èµ„æ–™ï¼Œé’ˆå¯¹ store buffer å’Œ invalidate queue çš„å‰¯ä½œç”¨è®¾è®¡äº† write/read memory barrier</strong><br>äºæ˜¯å†™ç¨‹åºçš„äººåœ¨éœ€è¦çš„æ—¶å€™å¯ä»¥ç”¨ memory barrier ç¡®ä¿å…³é”®çš„æ•°æ®æœ‰ä¾æ­£ç¡®çš„é¡ºåºæ›´æ–° (æ²¡ä¿è¯æ›´æ–°çš„æ—¶é—´)ã€‚ CPU åœ¨å¤šæ•°æƒ…å†µä¸‹ä»èƒ½é¿å…é—²ç½®ã€‚<br>åˆ°æ­¤å¯ä»¥äº†è§£ä¸ºä»€ä¹ˆè¿™ä¸¤ç§æ“ä½œåˆåœ¨ä¸€èµ·æ¯”è¾ƒç¬¦åˆ CPU æ¶æ„ï¼š</p><ul><li>ä¸€ä¸ª thread ã€Œå…ˆ write X åæ‰§è¡Œ write memory barrierã€</li><li>å¦ä¸€ä¸ª thread ã€Œå…ˆæ‰§è¡Œ read memory barrier å read Xã€</li></ul><h1 id="javaå†…å­˜æ¨¡å‹"><a href="#javaå†…å­˜æ¨¡å‹" class="headerlink" title="javaå†…å­˜æ¨¡å‹"></a>javaå†…å­˜æ¨¡å‹</h1><p>è¿™é‡Œå†è°ˆä¸€ä¸‹javaçš„å†…å­˜æ¨¡å‹ï¼Œè¿™ä¸ªæ¨¡å‹æ˜¯æŠ½è±¡å‡ºæ¥çš„ï¼Œä¸‹é¢è¿™ä¸ªå›¾ç½‘ä¸Šæ‰¾çš„ä¹Ÿæ˜¯è€æ¼”å‘˜äº†ï¼Œæœ€åˆæ¥è‡ªæ·±å…¥ç†è§£è™šæ‹Ÿæœºä¸€ä¹¦<br><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/memory-barrier07.png" alt=""></p><font color="red"><br>ä¸ªäººç†è§£:<br>è¿™é‡Œçš„javaçº¿ç¨‹å¯¹åº”ç€cpuï¼Œå·¥ä½œå†…å­˜å…¶å®æ˜¯ä¸å­˜åœ¨çš„ï¼Œå¯ä»¥ç®€å•çš„ç†è§£ä¸ºæ˜¯cpuçš„cacheï¼Œsaveå’Œloadå…¶å®å¯¹åº”çš„æ˜¯ç¼“å­˜ä¸€è‡´æ€§åè®®<br></font> <h2 id="JVM-barrier"><a href="#JVM-barrier" class="headerlink" title="JVM barrier"></a>JVM barrier</h2><ul><li>LoadLoadï¼šä¸¤ä¸ª Load æ“ä½œä¹‹é—´å†…å­˜å±éšœï¼Œsmp_rmb å°±æ˜¯å…¸å‹å®ç°ï¼›</li><li>StoreStoreï¼šä¸¤ä¸ªStore æ“ä½œä¹‹é—´çš„å†…å­˜å±éšœï¼Œsmp_wmb å…¸å‹å®ç°ï¼›</li><li>LoadStoreï¼šåœ¨ Load æ“ä½œå’Œ Store æ“ä½œä¹‹é—´çš„å†…å­˜å±éšœï¼›</li><li>StoreLoadï¼šåœ¨ Store æ“ä½œå’Œ  Load æ“ä½œä¹‹é—´çš„å†…å­˜å±éšœ</li></ul><font color="red"><br>ä¸ªäººç†è§£æ·»åŠ <br>ä»¥StoreLoadä¸ºä¾‹ï¼Œè¿™ä¸ªæ˜¯ä¸Šé¢å››ä¸ªä¸­æœ€é‡çš„ï¼Œæœ€è€—æ€§èƒ½çš„ï¼Œstoreloadå…¶å®èƒ½æ¶µç›–ä¸Šé¢ä¸‰ä¸ªï¼Œå› ä¸ºå®ƒæ—¢ä¿è¯äº†å†™ä¹Ÿä¿è¯äº†è¯»ï¼Œå®ƒå’Œloadstoreçš„ä¾§é‡ç‚¹ä¸ä¸€æ ·ï¼Œloadstoreå¯¹äºåé¢çš„é‚£ä¸ªå†™ä»€ä¹ˆæ—¶å€™èƒ½å†™è¿›å»ä¸æ˜¯éå¸¸è¦æ±‚ï¼Œæ›´ä¾§é‡çš„æ˜¯å‰é¢çš„å†™ã€‚å‰ä¸€ä¸ªæ˜¯å†™åä¸€ä¸ªæ˜¯è¯»ï¼Œåä¸€ä¸ªè¯»å–ä¸èƒ½é‡æ’åˆ°è¿™ä¸ªå†™æ“ä½œä¹‹å‰ï¼Œä¹Ÿå°±æ˜¯loadæ—¶è¦çœ‹åˆ°å‰é¢å†™çš„å€¼ï¼Œè¿™ä¹Ÿå°±è¦ä¿è¯å‰ä¸€ä¸ªå†™çš„å†…å®¹å¦‚æœåœ¨storebufferä¸­å°±ä¸€å®šè¦å†™åˆ°cacheä¸­.<br>ç„¶åloadçš„æ—¶å€™ä¸èƒ½ç›´æ¥å»è¯»cacheçš„å€¼ï¼Œè¦å°†invalidqueueä¸­çš„å€¼å¤„ç†æ‰ï¼Œè¯¥æ ‡è®°æ— æ•ˆçš„éƒ½è¦è¿›è¡Œæ ‡è®°ï¼Œç¡®ä¿è¯»å–å‡ºæ¥çš„æ˜¯æœ€æ–°çš„ã€‚<br></font>   <p>å¯¹äºjavaä¸­çš„volatileé˜²æ­¢é‡æ’ç½‘ä¸Šåšå®¢ä¸€å¤§å †ï¼Œæœ‰äº›æ–‡ç« ä»æ±‡ç¼–è§’åº¦æ¥åˆ†æåŠ äº†volatileå‰åçš„å¯¹æ¯”ï¼Œæœ¬åœ°æµ‹è¯•è¿‡hsdiså¯ä»¥ç”¨æ¥å°†javaè½¬æ¢ä¸ºå¯¹åº”çš„æ±‡ç¼–ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†     </p><p><font color="red"> ä¸ªäººç†è§£<br>volatileæœ€é‡è¦çš„ä½¿å‘½æ˜¯ä¸ºäº†å¯è§æ€§ï¼Œä¸ºäº†è¾¾åˆ°å¯è§æ€§è¿™ä¸ªç›®çš„ä¸å¾—ä¸è®¾è®¡å‡ºé˜²æ­¢æŒ‡ä»¤é‡æ’ï¼Œå› ä¸ºå¦‚æœä¸é™åˆ¶é‡æ’ï¼Œå°±è¾¾ä¸åˆ°å¯è§æ€§è¿™ä¸ªç›®çš„<br>æ‰€ä»¥å¯ä»¥ç†è§£é˜²æ­¢é‡æ’åªæ˜¯è¾¾åˆ°å¯è§æ€§çš„ä¸€ä¸ªä¸å¾—å·²æ‰‹æ®µ<br></font><br><br>   </p><p><strong>å‚è€ƒæ–‡ç« </strong><br><a href="https://www.infoq.com/articles/memory_barriers_jvm_concurrency/" target="_blank" rel="noopener">Memory Barriers and JVM Concurrency</a><br><a href="http://www.wowotech.net/kernel_synchronization/memory-barrier.html" target="_blank" rel="noopener">Linuxå†…æ ¸åŒæ­¥æœºåˆ¶ä¹‹ï¼ˆä¸‰ï¼‰ï¼šmemory barrier</a><br><a href="https://medium.com/fcamels-notes/%E5%BE%9E%E7%A1%AC%E9%AB%94%E8%A7%80%E9%BB%9E%E4%BA%86%E8%A7%A3-memry-barrier-%E7%9A%84%E5%AF%A6%E4%BD%9C%E5%92%8C%E6%95%88%E6%9E%9C-416ff0a64fc1" target="_blank" rel="noopener">å¾ç¡¬é«”è§€é»äº†è§£ memory barrier çš„å¯¦ä½œå’Œæ•ˆæœ</a><br><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2015/p0098r0.pdf" target="_blank" rel="noopener">P0098R0: Towards Implementation and Use ofmemoryorderconsume</a><br><a href="https://createpoint.qti.qualcomm.com/search/contentdocument/stream/35553?refererRoute=search%2FsearchArgs%2Fq%7C%7CMemory%20Barriers%7C%7Crows%7C%7C10%7C%7CsortField%7C%7Cscore%7C%7CsortOrder%7C%7Cdesc&amp;dcn=80-N5603-1&amp;currentPage=1&amp;itemTotalIndex=1" target="_blank" rel="noopener">LINUX MEMORY ORDERING ON SCORPION-MP AND KRAIT APPLICATION PROCESSORS</a><br><a href="https://preshing.com/20120710/memory-barriers-are-like-source-control-operations/" target="_blank" rel="noopener">Memory Barriers Are Like Source Control Operations</a><br><a href="https://mp.weixin.qq.com/s?__biz=MzUzMDk3NjM3Mg==&amp;mid=2247483755&amp;idx=1&amp;sn=50f80e73f46fab04d8a799e8731432c6&amp;chksm=fa48da70cd3f5366d9658277cccd9e36fca540276f580822d41aef7d8af4dda480fc85e3bde4&amp;token=630636109&amp;lang=zh_CN#rd" target="_blank" rel="noopener">ä» Java å†…å­˜æ¨¡å‹çœ‹å†…éƒ¨ç»†èŠ‚</a><br><a href="http://www.4e00.com/blog/java/2018/10/21/inside-java-memory-model.html" target="_blank" rel="noopener">æ·±å…¥ç†è§£ java å†…å­˜æ¨¡å‹</a><br><a href="http://www.wowotech.net/memory_management/458.html" target="_blank" rel="noopener">æµ…è°ˆCache Memory</a><br><a href="http://www.wowotech.net/kernel_synchronization/Why-Memory-Barriers.html" target="_blank" rel="noopener">Why Memory Barriers</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æœ¬ç¯‡æ–‡ç« å¼€å§‹ä¹‹å‰éœ€è¦äº†è§£ä¸€äº›èƒŒæ™¯çŸ¥è¯†&lt;/p&gt;
&lt;h1 id=&quot;Cache-Memory&quot;&gt;&lt;a href=&quot;#Cache-Memory&quot; class=&quot;headerlink&quot; title=&quot;Cache Memory&quot;&gt;&lt;/a&gt;Cache Memory&lt;/h1&gt;&lt;p&gt;æˆ‘ä»¬éƒ½çŸ¥
      
    
    </summary>
    
      <category term="Linux" scheme="http://lihaizhou.top/categories/Linux/"/>
    
    
  </entry>
  
  <entry>
    <title>mmapæœºåˆ¶åˆæ¢</title>
    <link href="http://lihaizhou.top/2020/05/25/mmap%E6%9C%BA%E5%88%B6%E5%88%9D%E6%8E%A2/"/>
    <id>http://lihaizhou.top/2020/05/25/mmapæœºåˆ¶åˆæ¢/</id>
    <published>2020-05-25T11:18:16.000Z</published>
    <updated>2020-06-02T03:37:05.927Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨Unix/Linuxç³»ç»Ÿä¸‹è¯»å†™æ–‡ä»¶ï¼Œä¸€èˆ¬æœ‰ä¸¤ç§æ–¹å¼</p><p><code>ç¬¬ä¸€ç§æ–¹å¼ï¼šä¼ ç»Ÿçš„read/writeæ–¹å¼</code></p><p>å¸¸è§„æ–‡ä»¶ç³»ç»Ÿæ“ä½œçš„è°ƒç”¨è¿‡ç¨‹ï¼š</p><ul><li><p>è¿›ç¨‹å‘èµ·è¯»æ–‡ä»¶è¯·æ±‚</p></li><li><p>å†…æ ¸é€šè¿‡æŸ¥æ‰¾è¿›ç¨‹æ–‡ä»¶ç¬¦è¡¨ï¼Œå®šä½åˆ°å†…æ ¸å·²æ‰“å¼€æ–‡ä»¶é›†ä¸Šçš„æ–‡ä»¶ä¿¡æ¯ï¼Œä»è€Œæ‰¾åˆ°æ­¤æ–‡ä»¶çš„inode</p></li><li><p>inodeåœ¨address_spaceä¸ŠæŸ¥æ‰¾è¦è¯·æ±‚çš„æ–‡ä»¶é¡µæ˜¯å¦å·²ç»ç¼“å­˜åœ¨é¡µç¼“å­˜ä¸­ã€‚å¦‚æœå­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›è¿™ç‰‡æ–‡ä»¶é¡µçš„å†…å®¹ã€‚</p></li><li><p>å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™é€šè¿‡inodeå®šä½åˆ°æ–‡ä»¶ç£ç›˜åœ°å€ï¼Œå°†æ•°æ®ä»ç£ç›˜å¤åˆ¶åˆ°é¡µç¼“å­˜ã€‚ä¹‹åå†æ¬¡å‘èµ·è¯»é¡µé¢è¿‡ç¨‹ï¼Œè¿›è€Œå°†é¡µç¼“å­˜ä¸­çš„æ•°æ®å‘ç»™ç”¨æˆ·è¿›ç¨‹ã€‚</p></li></ul><p>æ€»ç»“æ¥è¯´ï¼Œå¸¸è§„æ–‡ä»¶æ“ä½œä¸ºäº†æé«˜è¯»å†™æ•ˆç‡å’Œä¿æŠ¤ç£ç›˜ï¼Œä½¿ç”¨äº†é¡µç¼“å­˜æœºåˆ¶ã€‚è¿™æ ·é€ æˆè¯»æ–‡ä»¶æ—¶éœ€è¦å…ˆå°†æ–‡ä»¶é¡µä»ç£ç›˜æ‹·è´åˆ°é¡µç¼“å­˜ä¸­ï¼Œç”±äºé¡µç¼“å­˜å¤„åœ¨å†…æ ¸ç©ºé—´ï¼Œä¸èƒ½è¢«ç”¨æˆ·è¿›ç¨‹ç›´æ¥å¯»å€ï¼Œæ‰€ä»¥è¿˜éœ€è¦å°†é¡µç¼“å­˜ä¸­æ•°æ®é¡µå†æ¬¡æ‹·è´åˆ°å†…å­˜å¯¹åº”çš„ç”¨æˆ·ç©ºé—´ä¸­ã€‚è¿™æ ·ï¼Œé€šè¿‡äº†ä¸¤æ¬¡æ•°æ®æ‹·è´è¿‡ç¨‹ï¼Œæ‰èƒ½å®Œæˆè¿›ç¨‹å¯¹æ–‡ä»¶å†…å®¹çš„è·å–ä»»åŠ¡ã€‚å†™æ“ä½œä¹Ÿæ˜¯ä¸€æ ·ï¼Œå¾…å†™å…¥çš„bufferåœ¨å†…æ ¸ç©ºé—´ä¸èƒ½ç›´æ¥è®¿é—®ï¼Œå¿…é¡»è¦å…ˆæ‹·è´è‡³å†…æ ¸ç©ºé—´å¯¹åº”çš„ä¸»å­˜ï¼Œå†å†™å›ç£ç›˜ä¸­ï¼ˆå»¶è¿Ÿå†™å›ï¼‰ï¼Œä¹Ÿæ˜¯éœ€è¦ä¸¤æ¬¡æ•°æ®æ‹·è´ã€‚</p><p>å½“å­˜åœ¨å¤šä¸ªè¿›ç¨‹åŒæ—¶è¯»å–åŒä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œæ¯ä¸€ä¸ªè¿›ç¨‹ä¸­çš„åœ°å€ç©ºé—´éƒ½ä¼šä¿å­˜ä¸€ä»½å‰¯æœ¬ï¼Œè¿™æ ·è‚¯å®šä¸æ˜¯æœ€ä¼˜æ–¹å¼çš„ï¼Œé€ æˆäº†ç‰©ç†å†…å­˜çš„æµªè´¹</p><p><code>ç¬¬äºŒç§æ–¹å¼ï¼šå†…å­˜æ˜ å°„</code></p><p>å…·ä½“æ“ä½œæ–¹å¼æ˜¯ï¼š<br>openä¸€ä¸ªæ–‡ä»¶ï¼Œç„¶åè°ƒç”¨mmapç³»ç»Ÿè°ƒç”¨ï¼Œå°†æ–‡ä»¶çš„å†…å®¹çš„å…¨éƒ¨æˆ–ä¸€éƒ¨åˆ†ç›´æ¥æ˜ å°„åˆ°è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œæ˜ å°„å®Œæˆåï¼Œè¿›ç¨‹å¯ä»¥åƒè®¿é—®æ™®é€šå†…å­˜ä¸€æ ·åšå…¶ä»–çš„æ“ä½œï¼Œæ¯”å¦‚memcpyç­‰ç­‰ã€‚</p><p>mmapå¹¶ä¸åˆ†é…ç‰©ç†åœ°å€ç©ºé—´ï¼Œå®ƒåªæ˜¯å æœ‰è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚è¿™è·Ÿç¬¬ä¸€ç§æ–¹å¼ä¸ä¸€æ ·çš„ï¼Œç¬¬ä¸€ç§æ–¹å¼éœ€è¦é¢„å…ˆåˆ†é…å¥½ç‰©ç†å†…å­˜ï¼Œå†…æ ¸æ‰èƒ½å°†é¡µé«˜é€Ÿç¼“å†²ä¸­çš„æ–‡ä»¶æ•°æ®æ‹·è´åˆ°ç”¨æˆ·è¿›ç¨‹æŒ‡å®šçš„å†…å­˜ç©ºé—´ä¸­ã€‚</p><p>è€Œç¬¬äºŒç§æ–¹å¼ï¼Œå½“å¤šä¸ªè¿›ç¨‹éœ€è¦åŒæ—¶è®¿é—®åŒä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½å°†æ–‡ä»¶æ‰€å­˜å‚¨çš„å†…æ ¸é«˜é€Ÿç¼“å†²æ˜ å°„åˆ°è‡ªå·±çš„è¿›ç¨‹åœ°å€ç©ºé—´ã€‚å½“ç¬¬ä¸€ä¸ªè¿›ç¨‹è®¿é—®å†…æ ¸ä¸­çš„ç¼“å†²åŒºæ—¶å€™ï¼Œå‰é¢è®²è¿‡å¹¶æ²¡æœ‰å®é™…æ‹·è´æ•°æ®ï¼Œè¿™æ—¶MMUåœ¨åœ°å€æ˜ å°„è¡¨ä¸­æ˜¯æ— æ³•æ‰¾åˆ°ä¸åœ°å€ç©ºé—´ç›¸å¯¹åº”çš„ç‰©ç†åœ°å€çš„ï¼Œä¹Ÿå°±æ˜¯MMUå¤±è´¥ï¼Œå°±ä¼šè§¦å‘ç¼ºé¡µä¸­æ–­ã€‚å†…æ ¸å°†æ–‡ä»¶çš„è¿™ä¸€é¡µæ•°æ®è¯»å…¥åˆ°å†…æ ¸é«˜é€Ÿç¼“å†²åŒºä¸­ï¼Œå¹¶æ›´æ–°è¿›ç¨‹çš„é¡µè¡¨ï¼Œä½¿é¡µè¡¨æŒ‡å‘å†…æ ¸ç¼“å†²ä¸­çš„è¿™ä¸€é¡µã€‚ä¹‹åæœ‰å…¶ä»–çš„è¿›ç¨‹å†æ¬¡è®¿é—®è¿™ä¸€é¡µçš„æ—¶å€™ï¼Œè¯¥é¡µå·²ç»åœ¨å†…å­˜ä¸­äº†ï¼Œå†…æ ¸åªéœ€è¦å°†è¿›ç¨‹çš„é¡µè¡¨ç™»è®°å¹¶ä¸”æŒ‡å‘å†…æ ¸çš„é¡µé«˜é€Ÿç¼“å†²åŒºå³å¯</p><p><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/mmap-1-1.jpg" alt=""></p><p>å¼‚æ­¥IO<br><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/mmap-1-2.jpg" alt=""></p><p>mmapå†…å­˜æ˜ å°„å…·ä½“æµç¨‹å¦‚ä¸‹ï¼š</p><p>1ã€ç”¨æˆ·è¿›ç¨‹è°ƒç”¨å†…å­˜æ˜ å°„å‡½æ•°åº“mmapï¼Œå½“å‰è¿›ç¨‹åœ¨è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ï¼Œå¯»æ‰¾ä¸€æ®µç©ºé—²çš„æ»¡è¶³è¦æ±‚çš„è™šæ‹Ÿåœ°å€ã€‚</p><p>2ã€æ­¤æ—¶å†…æ ¸æ”¶åˆ°ç›¸å…³è¯·æ±‚åä¼šè°ƒç”¨å†…æ ¸çš„mmapå‡½æ•°ï¼Œæ³¨æ„ï¼Œä¸åŒäºç”¨æˆ·ç©ºé—´åº“å‡½æ•°ã€‚å†…æ ¸mmapå‡½æ•°é€šè¿‡è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿå®šä½åˆ°æ–‡ä»¶ç£ç›˜ç‰©ç†åœ°å€ï¼Œæ—¢å®ç°äº†æ–‡ä»¶åœ°å€å’Œè™šæ‹Ÿåœ°å€åŒºåŸŸçš„æ˜ å°„å…³ç³»ã€‚ æ­¤æ—¶ï¼Œè¿™ç‰‡è™šæ‹Ÿåœ°å€å¹¶æ²¡æœ‰ä»»ä½•æ•°æ®å…³è”åˆ°ä¸»å­˜ä¸­ã€‚</p><p>æ³¨æ„ï¼Œå‰ä¸¤ä¸ªé˜¶æ®µä»…åœ¨äºåˆ›å»ºè™šæ‹ŸåŒºé—´å¹¶å®Œæˆåœ°å€æ˜ å°„ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å°†ä»»ä½•æ–‡ä»¶æ•°æ®çš„æ‹·è´è‡³ä¸»å­˜ã€‚çœŸæ­£çš„æ–‡ä»¶è¯»å–æ˜¯å½“è¿›ç¨‹å‘èµ·è¯»æˆ–å†™æ“ä½œæ—¶ã€‚</p><p>3ã€è¿›ç¨‹çš„è¯»æˆ–å†™æ“ä½œè®¿é—®è™šæ‹Ÿåœ°å€ç©ºé—´è¿™ä¸€æ®µæ˜ å°„åœ°å€ï¼Œç°è¿™ä¸€æ®µåœ°å€å¹¶ä¸åœ¨ç‰©ç†é¡µé¢ä¸Šã€‚å› ä¸ºç›®å‰åªå»ºç«‹äº†åœ°å€æ˜ å°„ï¼ŒçœŸæ­£çš„ç¡¬ç›˜æ•°æ®è¿˜æ²¡æœ‰æ‹·è´åˆ°å†…å­˜ä¸­ï¼Œå› æ­¤å¼•å‘ç¼ºé¡µä¸­æ–­ã€‚</p><p>4ã€ç”±äºå¼•å‘äº†ç¼ºé¡µä¸­æ–­ï¼Œå†…æ ¸åˆ™è°ƒç”¨nopageå‡½æ•°æŠŠæ‰€ç¼ºçš„é¡µä»ç£ç›˜è£…å…¥åˆ°ä¸»å­˜ä¸­ã€‚</p><p>5ã€ä¹‹åç”¨æˆ·è¿›ç¨‹å³å¯å¯¹è¿™ç‰‡ä¸»å­˜è¿›è¡Œè¯»æˆ–è€…å†™çš„æ“ä½œï¼Œå¦‚æœå†™æ“ä½œæ”¹å˜äº†å…¶å†…å®¹ï¼Œä¸€å®šæ—¶é—´åç³»ç»Ÿä¼šè‡ªåŠ¨å›å†™è„é¡µé¢åˆ°å¯¹åº”ç£ç›˜åœ°å€ï¼Œä¹Ÿå³å®Œæˆäº†å†™å…¥åˆ°æ–‡ä»¶çš„è¿‡ç¨‹ã€‚</p><p>æ³¨æ„ï¼šè¿™é‡Œæ‹·è´ç£ç›˜å†…å®¹åˆ°ä¸»å­˜ï¼Œè¿™é‡Œçš„ä¸»å­˜æ˜¯æŒ‡å¤„äºå†…æ ¸ç©ºé—´çš„Page Cacheï¼Œè€Œä¸æ˜¯ç”¨æˆ·ç©ºé—´çš„å†…å­˜ã€‚ç”¨æˆ·åœ°å€è¦è®¿é—®å†…æ ¸ç©ºé—´ä¸­çš„æ•°æ®ï¼Œéœ€ä½¿ç”¨MMUæŠŠè™šæ‹Ÿåœ°å€æ˜ å°„åˆ°å†…æ ¸çš„å†…å­˜åœ°å€ä¸­ï¼Œå³å¯å¯¹æ•°æ®è¿›è¡Œæ“ä½œã€‚æ•´ä¸ªmmapå·¥ä½œæµç¨‹å¤§ä½“å¦‚ä¸‹ï¼š</p><p><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/mmap-2.png" alt=""></p><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºmmapç³»ç»Ÿè°ƒç”¨ä¸read/writeè°ƒç”¨çš„åŒºåˆ«åœ¨äºï¼š</p><p>mmapåªéœ€è¦ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼ˆä¸€æ¬¡æ‹·è´ï¼‰ï¼Œåç»­æ“ä½œä¸éœ€è¦ç³»ç»Ÿè°ƒç”¨ã€‚è®¿é—®çš„æ•°æ®ä¸éœ€è¦åœ¨page cacheå’Œç”¨æˆ·ç¼“å†²åŒºä¹‹é—´æ‹·è´ã€‚ è®¿é—®çš„æ•°æ®ä¸éœ€è¦åœ¨page cacheå’Œç”¨æˆ·ç¼“å†²åŒºä¹‹é—´æ‹·è´ã€‚<br>ä»ä¸Šæ‰€è¿°ï¼Œå½“é¢‘ç¹å¯¹ä¸€ä¸ªæ–‡ä»¶è¿›è¡Œè¯»å–æ“ä½œæ—¶ï¼Œmmapä¼šæ¯”read/writeæ›´é«˜æ•ˆ</p><p>æ—¢ç„¶å»ºç«‹å†…å­˜æ˜ å°„æ²¡æœ‰è¿›è¡Œå®é™…çš„æ•°æ®æ‹·è´ï¼Œé‚£ä¹ˆè¿›ç¨‹åˆæ€ä¹ˆèƒ½æœ€ç»ˆç›´æ¥é€šè¿‡å†…å­˜æ“ä½œè®¿é—®åˆ°ç¡¬ç›˜ä¸Šçš„æ–‡ä»¶å‘¢ï¼Ÿé‚£å°±è¦çœ‹å†…å­˜æ˜ å°„ä¹‹åçš„å‡ ä¸ªç›¸å…³çš„è¿‡ç¨‹äº†ã€‚</p><p>mmap()ä¼šè¿”å›ä¸€ä¸ªæŒ‡é’ˆptrï¼Œå®ƒæŒ‡å‘è¿›ç¨‹é€»è¾‘åœ°å€ç©ºé—´ä¸­çš„ä¸€ä¸ªåœ°å€ï¼Œè¿™æ ·ä»¥åï¼Œè¿›ç¨‹æ— éœ€å†è°ƒç”¨readæˆ–writeå¯¹æ–‡ä»¶è¿›è¡Œè¯»å†™ï¼Œè€Œåªéœ€è¦é€šè¿‡ptrå°±èƒ½å¤Ÿæ“ä½œæ–‡ä»¶ã€‚ä½†æ˜¯ptræ‰€æŒ‡å‘çš„æ˜¯ä¸€ä¸ªé€»è¾‘åœ°å€ï¼Œè¦æ“ä½œå…¶ä¸­çš„æ•°æ®ï¼Œå¿…é¡»é€šè¿‡MMUå°†é€»è¾‘åœ°å€è½¬æ¢æˆç‰©ç†åœ°å€ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸å†…å­˜æ˜ å°„æ— å…³ã€‚ </p><p>å‰é¢è®²è¿‡ï¼Œå»ºç«‹å†…å­˜æ˜ å°„å¹¶æ²¡æœ‰å®é™…æ‹·è´æ•°æ®ï¼Œè¿™æ—¶ï¼ŒMMUåœ¨åœ°å€æ˜ å°„è¡¨ä¸­æ˜¯æ— æ³•æ‰¾åˆ°ä¸ptrç›¸å¯¹åº”çš„ç‰©ç†åœ°å€çš„ï¼Œä¹Ÿå°±æ˜¯MMUå¤±è´¥ï¼Œå°†äº§ç”Ÿä¸€ä¸ªç¼ºé¡µä¸­æ–­ï¼Œç¼ºé¡µä¸­æ–­çš„ä¸­æ–­å“åº”å‡½æ•°ä¼šåœ¨swapä¸­å¯»æ‰¾ç›¸å¯¹åº”çš„é¡µé¢ï¼Œå¦‚æœæ‰¾ä¸åˆ°ï¼ˆä¹Ÿå°±æ˜¯è¯¥æ–‡ä»¶ä»æ¥æ²¡æœ‰è¢«è¯»å…¥å†…å­˜çš„æƒ…å†µï¼‰ï¼Œåˆ™ä¼šé€šè¿‡mmap()å»ºç«‹çš„æ˜ å°„å…³ç³»ï¼Œä»ç¡¬ç›˜ä¸Šå°†æ–‡ä»¶è¯»å–åˆ°ç‰©ç†å†…å­˜ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸å†…å­˜æ˜ å°„æ— å…³ã€‚</p><p>å¦‚æœåœ¨æ‹·è´æ•°æ®æ—¶ï¼Œå‘ç°ç‰©ç†å†…å­˜ä¸å¤Ÿç”¨ï¼Œåˆ™ä¼šé€šè¿‡è™šæ‹Ÿå†…å­˜æœºåˆ¶ï¼ˆswapï¼‰å°†æš‚æ—¶ä¸ç”¨çš„ç‰©ç†é¡µé¢äº¤æ¢åˆ°ç¡¬ç›˜ä¸Šï¼Œè¿™ä¸ªè¿‡ç¨‹ä¹Ÿä¸å†…å­˜æ˜ å°„æ— å…³ã€‚</p><p>ä½¿ç”¨mmapæ“ä½œæ–‡ä»¶ä¸­ï¼Œåˆ›å»ºæ–°çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸå’Œå»ºç«‹æ–‡ä»¶ç£ç›˜åœ°å€å’Œè™šæ‹Ÿå†…å­˜åŒºåŸŸæ˜ å°„è¿™ä¸¤æ­¥ï¼Œæ²¡æœ‰ä»»ä½•æ–‡ä»¶æ‹·è´æ“ä½œã€‚è€Œä¹‹åè®¿é—®æ•°æ®æ—¶å‘ç°å†…å­˜ä¸­å¹¶æ— æ•°æ®è€Œå‘èµ·çš„ç¼ºé¡µå¼‚å¸¸è¿‡ç¨‹ï¼Œå¯ä»¥é€šè¿‡å·²ç»å»ºç«‹å¥½çš„æ˜ å°„å…³ç³»ï¼Œåªä½¿ç”¨ä¸€æ¬¡æ•°æ®æ‹·è´ï¼Œå°±ä»ç£ç›˜ä¸­å°†æ•°æ®ä¼ å…¥å†…å­˜çš„ç”¨æˆ·ç©ºé—´ä¸­ï¼Œä¾›è¿›ç¨‹ä½¿ç”¨ã€‚</p><p>æ€»è€Œè¨€ä¹‹ï¼Œå¸¸è§„æ–‡ä»¶æ“ä½œéœ€è¦ä»ç£ç›˜åˆ°é¡µç¼“å­˜å†åˆ°ç”¨æˆ·ä¸»å­˜çš„ä¸¤æ¬¡æ•°æ®æ‹·è´ã€‚è€Œmmapæ“æ§æ–‡ä»¶ï¼Œåªéœ€è¦ä»ç£ç›˜åˆ°ç”¨æˆ·ä¸»å­˜çš„ä¸€æ¬¡æ•°æ®æ‹·è´è¿‡ç¨‹ã€‚è¯´ç™½äº†ï¼Œmmapçš„å…³é”®ç‚¹æ˜¯å®ç°äº†ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„æ•°æ®ç›´æ¥äº¤äº’è€Œçœå»äº†ç©ºé—´ä¸åŒæ•°æ®ä¸é€šçš„ç¹çè¿‡ç¨‹ã€‚å› æ­¤mmapæ•ˆç‡æ›´é«˜</p><p>mmapä½¿ç”¨è¿‡ç¨‹ä¸­çš„å‡ ä¸ªç»†èŠ‚ç‚¹ï¼š</p><p>ç»†èŠ‚ç‚¹ä¸€ï¼š mmapæ˜ å°„åŒºåŸŸå¤§å°å¿…é¡»æ˜¯ç‰©ç†é¡µå¤§å°(page_size)çš„æ•´å€æ•°ï¼ˆåœ¨Linuxä¸­å†…å­˜é¡µé€šå¸¸æ˜¯4kï¼‰ã€‚åŸå› æ˜¯ï¼Œå†…å­˜çš„æœ€å°ç²’åº¦æ˜¯é¡µï¼Œè€Œè¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´å’Œå†…å­˜çš„æ˜ å°„ä¹Ÿæ˜¯ä»¥é¡µä¸ºå•ä½ã€‚ä¸ºäº†åŒ¹é…å†…å­˜çš„æ“ä½œï¼Œmmapä»ç£ç›˜åˆ°è™šæ‹Ÿåœ°å€ç©ºé—´çš„æ˜ å°„ä¹Ÿå¿…é¡»æ˜¯é¡µã€‚</p><p>ä¾‹å¦‚ï¼Œæœ‰ä¸€ä¸ªæ–‡ä»¶çš„å¤§å°æ˜¯5Kï¼Œmmapå‡½æ•°ä»æ–‡ä»¶çš„èµ·å§‹ä½ç½®æ˜ å°„5Kåˆ°è™šæ‹Ÿå†…å­˜ä¸­ï¼Œç”±äºå†…å­˜ç‰©ç†é¡µæ˜¯4Kï¼Œè™½ç„¶æ˜ å°„çš„æ–‡ä»¶åªæœ‰5Kï¼Œä½†æ˜¯å®é™…ä¸Šæ˜ å°„åˆ°å†…å­˜åŒºåŸŸçš„å†…å­˜æ˜¯8Kï¼Œä»¥ä¾¿æ»¡è¶³ç‰©ç†é¡µå¤§å°çš„æ•´æ•°å€ã€‚æ˜ å°„åå¯¹5~8Kçš„å†…å­˜åŒºåŸŸç”¨é›¶å¡«å……ï¼Œå¯¹è¿™éƒ¨åˆ†çš„æ“ä½œä¸ä¼šæŠ¥é”™ä¹Ÿä¸ä¼šå†™å…¥åˆ°åŸæ–‡ä»¶ä¸­ã€‚</p><p>ç»†èŠ‚ç‚¹äºŒ ï¼š æ˜ å°„å»ºç«‹ä¹‹åï¼Œå³ä½¿æ–‡ä»¶å…³é—­ï¼Œæ˜ å°„ä¾ç„¶å­˜åœ¨ã€‚å› ä¸ºæ˜ å°„çš„æ˜¯ç£ç›˜çš„åœ°å€ï¼Œä¸æ˜¯æ–‡ä»¶æœ¬èº«ï¼Œå’Œæ–‡ä»¶å¥æŸ„æ— å…³ã€‚åŒæ—¶å¯ç”¨äºè¿›ç¨‹é—´é€šä¿¡çš„æœ‰æ•ˆåœ°å€ç©ºé—´ä¸å®Œå…¨å—é™äºè¢«æ˜ å°„æ–‡ä»¶çš„å¤§å°ï¼Œå› ä¸ºæ˜¯æŒ‰é¡µæ˜ å°„ã€‚</p><p>å¹³æ—¶ä¼šé‡åˆ°åº”ç”¨OOMçš„é—®é¢˜ï¼Œæ—¥å¿—ä¸­æœ‰æ—¶å€™ä¼šæœ‰å¦‚ä¸‹å†…å®¹<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">07</span>-<span class="number">03</span> <span class="number">17</span>:<span class="number">43</span>:<span class="number">55.266</span> <span class="number">10181</span>  <span class="number">4737</span>  <span class="number">6529</span> E filemap : mmap(<span class="number">6078464</span>,<span class="number">299753</span>) failed: Out of memory</span><br></pre></td></tr></table></figure></p><p>å¯¹åº”çš„Code</p><p>system/core/libutils/FileMap.cpp</p><p>è¿™é‡Œè°·æ­Œåœ¨2020.5.7å·æœ‰ä¿®æ”¹ï¼Œä¹‹å‰æ˜¯è°ƒç”¨çš„mmapï¼Œmmapä¸­ç»§è€Œè°ƒç”¨mmap64</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span>* ptr = mmap64(nullptr, adjLength, prot, flags, fd, adjOffset);</span><br><span class="line"><span class="keyword">if</span> (ptr == MAP_FAILED) &#123;</span><br><span class="line">    <span class="keyword">if</span> (errno == EINVAL &amp;&amp; length == <span class="number">0</span>) &#123;</span><br><span class="line">        ptr = nullptr;</span><br><span class="line">        adjust = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ALOGE(<span class="string">"mmap(%lld,%zu) failed: %s\n"</span>, (<span class="keyword">long</span> <span class="keyword">long</span>)adjOffset, adjLength, strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>bionic/libc/bionic/mmap.cpp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span>* mmap64(<span class="keyword">void</span>* addr, size_t size, <span class="keyword">int</span> prot, <span class="keyword">int</span> flags, <span class="keyword">int</span> fd, off64_t offset) &#123;</span><br><span class="line">  <span class="keyword">if</span> (offset &lt; <span class="number">0</span> || (offset &amp; ((<span class="number">1</span>UL &lt;&lt; MMAP2_SHIFT)-<span class="number">1</span>)) != <span class="number">0</span>) &#123;</span><br><span class="line">    errno = EINVAL;</span><br><span class="line">    <span class="keyword">return</span> MAP_FAILED;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// prevent allocations large enough for `end - start` to overflow</span></span><br><span class="line">  size_t rounded = __BIONIC_ALIGN(size, PAGE_SIZE);</span><br><span class="line">  <span class="keyword">if</span> (rounded &lt; size || rounded &gt; PTRDIFF_MAX) &#123;</span><br><span class="line">    errno = ENOMEM;</span><br><span class="line">    <span class="keyword">return</span> MAP_FAILED;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  bool is_private_anonymous =</span><br><span class="line">      (flags &amp; (MAP_PRIVATE | MAP_ANONYMOUS)) == (MAP_PRIVATE | MAP_ANONYMOUS);</span><br><span class="line">  bool is_stack_or_grows_down = (flags &amp; (MAP_STACK | MAP_GROWSDOWN)) != <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">void</span>* result = __mmap2(addr, size, prot, flags, fd, offset &gt;&gt; MMAP2_SHIFT);</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span> (result != MAP_FAILED &amp;&amp; kernel_has_MADV_MERGEABLE &amp;&amp;</span><br><span class="line">      is_private_anonymous &amp;&amp; !is_stack_or_grows_down) &#123;</span><br><span class="line">    ErrnoRestorer errno_restorer;</span><br><span class="line">    <span class="keyword">int</span> rc = madvise(result, size, MADV_MERGEABLE);</span><br><span class="line">    <span class="keyword">if</span> (rc == -<span class="number">1</span> &amp;&amp; errno == EINVAL) &#123;</span><br><span class="line">      kernel_has_MADV_MERGEABLE = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>mmapå¸¸è§çš„é”™è¯¯ç±»å‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">EACCESï¼šè®¿é—®å‡ºé”™</span><br><span class="line">EAGAINï¼šæ–‡ä»¶å·²è¢«é”å®šï¼Œæˆ–è€…å¤ªå¤šçš„å†…å­˜å·²è¢«é”å®š</span><br><span class="line">EBADFï¼šfdä¸æ˜¯æœ‰æ•ˆçš„æ–‡ä»¶æè¿°è¯</span><br><span class="line">EINVALï¼šä¸€ä¸ªæˆ–è€…å¤šä¸ªå‚æ•°æ— æ•ˆ è¿™é‡Œçš„å‚æ•°å¸¸æŒ‡çš„æ˜¯start len offset ä½†æ˜¯æŒ‰ç…§unlinxé«˜çº§ç¯å¢ƒç¼–ç¨‹ä¸­æè¿°ï¼Œstartä¸€èˆ¬ä¼šè¢«å‘½åä¸º<span class="keyword">null</span>çš„ç©ºæŒ‡é’ˆï¼Œè¿™æ ·å‘Šè¯‰å†…æ ¸è‡ªå·±å»é€‰æ‹©èµ·å§‹åœ°å€ï¼Œoffsetä¸€èˆ¬æƒ…å†µä¸‹è®¾ç½®ä¸ºï¼›é‚£ä¹ˆå‡ºç°è¿™ä¸ªé—®é¢˜é€šå¸¸å°±æ˜¯lenå‡ºé”™äº†ï¼Œé‚£ä¹ˆå¯ä»¥ç”¨printfå¤§æ³•æ¥æ‰¾åˆ°å…·ä½“çš„é”™è¯¯ã€‚</span><br><span class="line">ENFILEï¼šå·²è¾¾åˆ°ç³»ç»Ÿå¯¹æ‰“å¼€æ–‡ä»¶çš„é™åˆ¶</span><br><span class="line">ENODEVï¼šæŒ‡å®šæ–‡ä»¶æ‰€åœ¨çš„æ–‡ä»¶ç³»ç»Ÿä¸æ”¯æŒå†…å­˜æ˜ å°„</span><br><span class="line">ENOMEMï¼šå†…å­˜ä¸è¶³ï¼Œæˆ–è€…è¿›ç¨‹å·²è¶…å‡ºæœ€å¤§å†…å­˜æ˜ å°„æ•°é‡</span><br><span class="line">EPERMï¼šæƒèƒ½ä¸è¶³ï¼Œæ“ä½œä¸å…è®¸</span><br><span class="line">ETXTBSYï¼šå·²å†™çš„æ–¹å¼æ‰“å¼€æ–‡ä»¶ï¼ŒåŒæ—¶æŒ‡å®šMAP_DENYWRITEæ ‡å¿—</span><br><span class="line">SIGSEGVï¼šè¯•ç€å‘åªè¯»åŒºå†™å…¥</span><br><span class="line">SIGBUSï¼šè¯•ç€è®¿é—®ä¸å±äºè¿›ç¨‹çš„å†…å­˜åŒº</span><br></pre></td></tr></table></figure><p><strong>mmapä¼˜ç‚¹æ€»ç»“</strong></p><p>ç”±ä¸Šæ–‡è®¨è®ºå¯çŸ¥ï¼Œmmapä¼˜ç‚¹å…±æœ‰ä¸€ä¸‹å‡ ç‚¹ï¼š</p><p>1ã€å¯¹æ–‡ä»¶çš„è¯»å–æ“ä½œè·¨è¿‡äº†é¡µç¼“å­˜ï¼Œå‡å°‘äº†æ•°æ®çš„æ‹·è´æ¬¡æ•°ï¼Œç”¨å†…å­˜è¯»å†™å–ä»£I/Oè¯»å†™ï¼Œæé«˜äº†æ–‡ä»¶è¯»å–æ•ˆç‡ã€‚</p><p>2ã€å®ç°äº†ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„é«˜æ•ˆäº¤äº’æ–¹å¼, ä¸¤ç©ºé—´çš„å„è‡ªä¿®æ”¹æ“ä½œå¯ä»¥ç›´æ¥åæ˜ åœ¨æ˜ å°„çš„åŒºåŸŸå†…ï¼Œä»è€Œè¢«å¯¹æ–¹ç©ºé—´åŠæ—¶æ•æ‰ã€‚</p><p>3ã€æä¾›è¿›ç¨‹é—´å…±äº«å†…å­˜åŠç›¸äº’é€šä¿¡çš„æ–¹å¼ã€‚ä¸ç®¡æ˜¯çˆ¶å­è¿›ç¨‹è¿˜æ˜¯æ— äº²ç¼˜å…³ç³»çš„è¿›ç¨‹ï¼Œéƒ½å¯ä»¥å°†è‡ªèº«ç”¨æˆ·ç©ºé—´æ˜ å°„åˆ°åŒä¸€ä¸ªæ–‡ä»¶æˆ–åŒ¿åæ˜ å°„åˆ°åŒä¸€ç‰‡åŒºåŸŸã€‚ä»è€Œé€šè¿‡å„è‡ªå¯¹æ˜ å°„åŒºåŸŸçš„æ”¹åŠ¨ï¼Œè¾¾åˆ°è¿›ç¨‹é—´é€šä¿¡å’Œè¿›ç¨‹é—´å…±äº«çš„ç›®çš„ã€‚</p><pre><code>åŒæ—¶ï¼Œå¦‚æœè¿›ç¨‹Aå’Œè¿›ç¨‹Béƒ½æ˜ å°„äº†åŒºåŸŸCï¼Œå½“Aç¬¬ä¸€æ¬¡è¯»å–Cæ—¶é€šè¿‡ç¼ºé¡µä»ç£ç›˜å¤åˆ¶æ–‡ä»¶é¡µåˆ°å†…å­˜ä¸­ï¼›ä½†å½“Bå†è¯»Cçš„ç›¸åŒé¡µé¢æ—¶ï¼Œè™½ç„¶ä¹Ÿä¼šäº§ç”Ÿç¼ºé¡µå¼‚å¸¸ï¼Œä½†æ˜¯ä¸å†éœ€è¦ä»ç£ç›˜ä¸­å¤åˆ¶æ–‡ä»¶è¿‡æ¥ï¼Œè€Œå¯ç›´æ¥ä½¿ç”¨å·²ç»ä¿å­˜åœ¨å†…å­˜ä¸­çš„æ–‡ä»¶æ•°æ®ã€‚</code></pre><p>4ã€å¯ç”¨äºå®ç°é«˜æ•ˆçš„å¤§è§„æ¨¡æ•°æ®ä¼ è¾“ã€‚å†…å­˜ç©ºé—´ä¸è¶³ï¼Œæ˜¯åˆ¶çº¦å¤§æ•°æ®æ“ä½œçš„ä¸€ä¸ªæ–¹é¢ï¼Œè§£å†³æ–¹æ¡ˆå¾€å¾€æ˜¯å€ŸåŠ©ç¡¬ç›˜ç©ºé—´ååŠ©æ“ä½œï¼Œè¡¥å……å†…å­˜çš„ä¸è¶³ã€‚ä½†æ˜¯è¿›ä¸€æ­¥ä¼šé€ æˆå¤§é‡çš„æ–‡ä»¶I/Oæ“ä½œï¼Œæå¤§å½±å“æ•ˆç‡ã€‚è¿™ä¸ªé—®é¢˜å¯ä»¥é€šè¿‡mmapæ˜ å°„å¾ˆå¥½çš„è§£å†³ã€‚æ¢å¥è¯è¯´ï¼Œä½†å‡¡æ˜¯éœ€è¦ç”¨ç£ç›˜ç©ºé—´ä»£æ›¿å†…  å­˜çš„æ—¶å€™ï¼Œmmapéƒ½å¯ä»¥å‘æŒ¥å…¶åŠŸæ•ˆ</p><p><strong>mmapä½¿ç”¨ç»†èŠ‚</strong><br>1ã€ä½¿ç”¨mmapéœ€è¦æ³¨æ„çš„ä¸€ä¸ªå…³é”®ç‚¹æ˜¯mmapæ˜ å°„åŒºåŸŸå¤§å°å¿…é¡»æ˜¯ç‰©ç†é¡µå¤§å°(page_size)çš„æ•´å€æ•°ï¼ˆ32ä½ç³»ç»Ÿä¸­é€šå¸¸æ˜¯4kå­—èŠ‚ï¼‰ã€‚åŸå› æ˜¯å†…å­˜çš„æœ€å°ç²’åº¦æ˜¯é¡µï¼Œè€Œè¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´å’Œå†…å­˜çš„æ˜ å°„ä¹Ÿæ˜¯ä»¥é¡µä¸ºå•ä½ã€‚ä¸ºäº†åŒ¹é…å†…å­˜çš„æ“ä½œï¼Œmmapä»ç£ç›˜åˆ°è™šæ‹Ÿåœ°å€ç©ºé—´çš„æ˜ å°„ä¹Ÿå¿…é¡»æ˜¯é¡µã€‚</p><p>2ã€å†…æ ¸å¯ä»¥è·Ÿè¸ªè¢«å†…å­˜æ˜ å°„çš„åº•å±‚å¯¹è±¡ï¼ˆæ–‡ä»¶ï¼‰çš„å¤§å°ï¼Œè¿›ç¨‹å¯ä»¥åˆæ³•çš„è®¿é—®åœ¨å½“å‰æ–‡ä»¶å¤§å°ä»¥å†…åˆåœ¨å†…å­˜æ˜ å°„åŒºä»¥å†…çš„é‚£äº›å­—èŠ‚ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæ–‡ä»¶çš„å¤§å°ä¸€ç›´åœ¨æ‰©å¼ ï¼Œåªè¦åœ¨æ˜ å°„åŒºåŸŸèŒƒå›´å†…çš„æ•°æ®ï¼Œè¿›ç¨‹éƒ½å¯ä»¥åˆæ³•å¾—åˆ°ï¼Œè¿™å’Œæ˜ å°„å»ºç«‹æ—¶æ–‡ä»¶çš„å¤§å°æ— å…³ã€‚</p><p>3ã€æ˜ å°„å»ºç«‹ä¹‹åï¼Œå³ä½¿æ–‡ä»¶å…³é—­ï¼Œæ˜ å°„ä¾ç„¶å­˜åœ¨ã€‚å› ä¸ºæ˜ å°„çš„æ˜¯ç£ç›˜çš„åœ°å€ï¼Œä¸æ˜¯æ–‡ä»¶æœ¬èº«ï¼Œå’Œæ–‡ä»¶å¥æŸ„æ— å…³ã€‚åŒæ—¶å¯ç”¨äºè¿›ç¨‹é—´é€šä¿¡çš„æœ‰æ•ˆåœ°å€ç©ºé—´ä¸å®Œå…¨å—é™äºè¢«æ˜ å°„æ–‡ä»¶çš„å¤§å°ï¼Œå› ä¸ºæ˜¯æŒ‰é¡µæ˜ å°„ã€‚</p><p>åœ¨ä¸Šé¢çš„çŸ¥è¯†å‰æä¸‹ï¼Œæˆ‘ä»¬ä¸‹é¢çœ‹çœ‹å¦‚æœå¤§å°ä¸æ˜¯é¡µçš„æ•´å€æ•°çš„å…·ä½“æƒ…å†µï¼š</p><p>æƒ…å½¢ä¸€ï¼šä¸€ä¸ªæ–‡ä»¶çš„å¤§å°æ˜¯5000å­—èŠ‚ï¼Œmmapå‡½æ•°ä»ä¸€ä¸ªæ–‡ä»¶çš„èµ·å§‹ä½ç½®å¼€å§‹ï¼Œæ˜ å°„5000å­—èŠ‚åˆ°è™šæ‹Ÿå†…å­˜ä¸­ã€‚</p><p>åˆ†æï¼šå› ä¸ºå•ä½ç‰©ç†é¡µé¢çš„å¤§å°æ˜¯4096å­—èŠ‚ï¼Œè™½ç„¶è¢«æ˜ å°„çš„æ–‡ä»¶åªæœ‰5000å­—èŠ‚ï¼Œä½†æ˜¯å¯¹åº”åˆ°è¿›ç¨‹è™šæ‹Ÿåœ°å€åŒºåŸŸçš„å¤§å°éœ€è¦æ»¡è¶³æ•´é¡µå¤§å°ï¼Œå› æ­¤mmapå‡½æ•°æ‰§è¡Œåï¼Œå®é™…æ˜ å°„åˆ°è™šæ‹Ÿå†…å­˜åŒºåŸŸ8192ä¸ª å­—èŠ‚ï¼Œ5000~8191çš„å­—èŠ‚éƒ¨åˆ†ç”¨é›¶å¡«å……ã€‚æ˜ å°„åçš„å¯¹åº”å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/mmap-3.png" alt=""></p><p>æ­¤æ—¶ï¼š</p><p>ï¼ˆ1ï¼‰è¯»/å†™å‰5000ä¸ªå­—èŠ‚ï¼ˆ0~4999ï¼‰ï¼Œä¼šè¿”å›æ“ä½œæ–‡ä»¶å†…å®¹ã€‚</p><p>ï¼ˆ2ï¼‰è¯»å­—èŠ‚5000~8191æ—¶ï¼Œç»“æœå…¨ä¸º0ã€‚å†™5000~8191æ—¶ï¼Œè¿›ç¨‹ä¸ä¼šæŠ¥é”™ï¼Œä½†æ˜¯æ‰€å†™çš„å†…å®¹ä¸ä¼šå†™å…¥åŸæ–‡ä»¶ä¸­ ã€‚</p><p>ï¼ˆ3ï¼‰è¯»/å†™8192ä»¥å¤–çš„ç£ç›˜éƒ¨åˆ†ï¼Œä¼šè¿”å›ä¸€ä¸ªSIGSECVé”™è¯¯ã€‚</p><p>æƒ…å½¢äºŒï¼šä¸€ä¸ªæ–‡ä»¶çš„å¤§å°æ˜¯5000å­—èŠ‚ï¼Œmmapå‡½æ•°ä»ä¸€ä¸ªæ–‡ä»¶çš„èµ·å§‹ä½ç½®å¼€å§‹ï¼Œæ˜ å°„15000å­—èŠ‚åˆ°è™šæ‹Ÿå†…å­˜ä¸­ï¼Œå³æ˜ å°„å¤§å°è¶…è¿‡äº†åŸå§‹æ–‡ä»¶çš„å¤§å°ã€‚</p><p>åˆ†æï¼šç”±äºæ–‡ä»¶çš„å¤§å°æ˜¯5000å­—èŠ‚ï¼Œå’Œæƒ…å½¢ä¸€ä¸€æ ·ï¼Œå…¶å¯¹åº”çš„ä¸¤ä¸ªç‰©ç†é¡µã€‚é‚£ä¹ˆè¿™ä¸¤ä¸ªç‰©ç†é¡µéƒ½æ˜¯åˆæ³•å¯ä»¥è¯»å†™çš„ï¼Œåªæ˜¯è¶…å‡º5000çš„éƒ¨åˆ†ä¸ä¼šä½“ç°åœ¨åŸæ–‡ä»¶ä¸­ã€‚ç”±äºç¨‹åºè¦æ±‚æ˜ å°„15000å­—èŠ‚ï¼Œè€Œæ–‡ä»¶åªå ä¸¤ä¸ªç‰©ç†é¡µï¼Œå› æ­¤8192å­—èŠ‚~15000å­—èŠ‚éƒ½ä¸èƒ½è¯»å†™ï¼Œæ“ä½œæ—¶ä¼šè¿”å›å¼‚å¸¸ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/mmap-4.png" alt=""></p><p>æ­¤æ—¶ï¼š</p><p>ï¼ˆ1ï¼‰è¿›ç¨‹å¯ä»¥æ­£å¸¸è¯»/å†™è¢«æ˜ å°„çš„å‰5000å­—èŠ‚(0~4999)ï¼Œå†™æ“ä½œçš„æ”¹åŠ¨ä¼šåœ¨ä¸€å®šæ—¶é—´ååæ˜ åœ¨åŸæ–‡ä»¶ä¸­ã€‚</p><p>ï¼ˆ2ï¼‰å¯¹äº5000~8191å­—èŠ‚ï¼Œè¿›ç¨‹å¯ä»¥è¿›è¡Œè¯»å†™è¿‡ç¨‹ï¼Œä¸ä¼šæŠ¥é”™ã€‚ä½†æ˜¯å†…å®¹åœ¨å†™å…¥å‰å‡ä¸º0ï¼Œå¦å¤–ï¼Œå†™å…¥åä¸ä¼šåæ˜ åœ¨æ–‡ä»¶ä¸­ã€‚</p><p>ï¼ˆ3ï¼‰å¯¹äº8192~14999å­—èŠ‚ï¼Œè¿›ç¨‹ä¸èƒ½å¯¹å…¶è¿›è¡Œè¯»å†™ï¼Œä¼šæŠ¥SIGBUSé”™è¯¯ã€‚</p><p>ï¼ˆ4ï¼‰å¯¹äº15000ä»¥å¤–çš„å­—èŠ‚ï¼Œè¿›ç¨‹ä¸èƒ½å¯¹å…¶è¯»å†™ï¼Œä¼šå¼•å‘SIGSEGVé”™è¯¯ã€‚</p><p>æƒ…å½¢ä¸‰ï¼šä¸€ä¸ªæ–‡ä»¶åˆå§‹å¤§å°ä¸º0ï¼Œä½¿ç”¨mmapæ“ä½œæ˜ å°„äº†1000*4Kçš„å¤§å°ï¼Œå³1000ä¸ªç‰©ç†é¡µå¤§çº¦4Må­—èŠ‚ç©ºé—´ï¼Œmmapè¿”å›æŒ‡é’ˆptrã€‚</p><p>åˆ†æï¼šå¦‚æœåœ¨æ˜ å°„å»ºç«‹ä¹‹åˆï¼Œå°±å¯¹æ–‡ä»¶è¿›è¡Œè¯»å†™æ“ä½œï¼Œç”±äºæ–‡ä»¶å¤§å°ä¸º0ï¼Œå¹¶æ²¡æœ‰åˆæ³•çš„ç‰©ç†é¡µå¯¹åº”ï¼Œå¦‚åŒæƒ…å½¢äºŒä¸€æ ·ï¼Œä¼šè¿”å›SIGBUSé”™è¯¯ã€‚</p><p>ä½†æ˜¯å¦‚æœï¼Œæ¯æ¬¡æ“ä½œptrè¯»å†™å‰ï¼Œå…ˆå¢åŠ æ–‡ä»¶çš„å¤§å°ï¼Œé‚£ä¹ˆptråœ¨æ–‡ä»¶å¤§å°å†…éƒ¨çš„æ“ä½œå°±æ˜¯åˆæ³•çš„ã€‚ä¾‹å¦‚ï¼Œæ–‡ä»¶æ‰©å……4096å­—èŠ‚ï¼Œptrå°±èƒ½æ“ä½œptr ~ [ (char)ptr + 4095]çš„ç©ºé—´ã€‚åªè¦æ–‡ä»¶æ‰©å……çš„èŒƒå›´åœ¨1000ä¸ªç‰©ç†é¡µï¼ˆæ˜ å°„èŒƒå›´ï¼‰å†…ï¼Œptréƒ½å¯ä»¥å¯¹åº”æ“ä½œç›¸åŒçš„å¤§å°ã€‚</p><p>è¿™æ ·ï¼Œæ–¹ä¾¿éšæ—¶æ‰©å……æ–‡ä»¶ç©ºé—´ï¼Œéšæ—¶å†™å…¥æ–‡ä»¶ï¼Œä¸é€ æˆç©ºé—´æµªè´¹</p><p>Binderè¿›ç¨‹é—´é€šä¿¡ç”¨åˆ°çš„mmap</p><p>Linux ä¸‹çš„ä¼ ç»Ÿ IPC é€šä¿¡åŸç†<br>ä¼ ç»Ÿçš„ IPC æ–¹å¼ä¸­ï¼Œè¿›ç¨‹ä¹‹é—´æ˜¯å¦‚ä½•å®ç°é€šä¿¡çš„ã€‚<br>é€šå¸¸çš„åšæ³•æ˜¯æ¶ˆæ¯å‘é€æ–¹å°†è¦å‘é€çš„æ•°æ®å­˜æ”¾åœ¨å†…å­˜ç¼“å­˜åŒºä¸­ï¼Œé€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸æ€ã€‚ç„¶åå†…æ ¸ç¨‹åºåœ¨å†…æ ¸ç©ºé—´åˆ†é…å†…å­˜ï¼Œå¼€è¾Ÿä¸€å—å†…æ ¸ç¼“å­˜åŒºï¼Œè°ƒç”¨ copyfromuser() å‡½æ•°å°†æ•°æ®ä»ç”¨æˆ·ç©ºé—´çš„å†…å­˜ç¼“å­˜åŒºæ‹·è´åˆ°å†…æ ¸ç©ºé—´çš„å†…æ ¸ç¼“å­˜åŒºä¸­ã€‚åŒæ ·çš„ï¼Œæ¥æ”¶æ–¹è¿›ç¨‹åœ¨æ¥æ”¶æ•°æ®æ—¶åœ¨è‡ªå·±çš„ç”¨æˆ·ç©ºé—´å¼€è¾Ÿä¸€å—å†…å­˜ç¼“å­˜åŒºï¼Œç„¶åå†…æ ¸ç¨‹åºè°ƒç”¨ copytouser() å‡½æ•°å°†æ•°æ®ä»å†…æ ¸ç¼“å­˜åŒºæ‹·è´åˆ°æ¥æ”¶è¿›ç¨‹çš„å†…å­˜ç¼“å­˜åŒºã€‚è¿™æ ·æ•°æ®å‘é€æ–¹è¿›ç¨‹å’Œæ•°æ®æ¥æ”¶æ–¹è¿›ç¨‹å°±å®Œæˆäº†ä¸€æ¬¡æ•°æ®ä¼ è¾“ï¼Œæˆ‘ä»¬ç§°å®Œæˆäº†ä¸€æ¬¡è¿›ç¨‹é—´é€šä¿¡</p><p><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/mmap-5.jpeg" alt=""></p><p>è¿™ç§ä¼ ç»Ÿçš„ IPC é€šä¿¡æ–¹å¼æœ‰ä¸¤ä¸ªé—®é¢˜ï¼š</p><pre><code>1.æ€§èƒ½ä½ä¸‹ï¼Œä¸€æ¬¡æ•°æ®ä¼ é€’éœ€è¦ç»å†ï¼šå†…å­˜ç¼“å­˜åŒº --&gt; å†…æ ¸ç¼“å­˜åŒº --&gt; å†…å­˜ç¼“å­˜åŒºï¼Œéœ€è¦ 2 æ¬¡æ•°æ®æ‹·è´ï¼›2.æ¥æ”¶æ•°æ®çš„ç¼“å­˜åŒºç”±æ•°æ®æ¥æ”¶è¿›ç¨‹æä¾›ï¼Œä½†æ˜¯æ¥æ”¶è¿›ç¨‹å¹¶ä¸çŸ¥é“éœ€è¦å¤šå¤§çš„ç©ºé—´æ¥å­˜æ”¾å°†è¦ä¼ é€’è¿‡æ¥çš„æ•°æ®ï¼Œå› æ­¤åªèƒ½å¼€è¾Ÿå°½å¯èƒ½å¤§çš„å†…å­˜ç©ºé—´æˆ–è€…å…ˆè°ƒç”¨ API æ¥æ”¶æ¶ˆæ¯å¤´æ¥è·å–æ¶ˆæ¯ä½“çš„å¤§å°ï¼Œè¿™ä¸¤ç§åšæ³•ä¸æ˜¯æµªè´¹ç©ºé—´å°±æ˜¯æµªè´¹æ—¶é—´</code></pre><p>Binderé‡‡ç”¨ä¸€ç§å…¨æ–°ç­–ç•¥ï¼šç”±Binderé©±åŠ¨è´Ÿè´£ç®¡ç†æ•°æ®æ¥æ”¶ç¼“å­˜ã€‚æˆ‘ä»¬æ³¨æ„åˆ°Binderé©±åŠ¨å®ç°äº†mmap()ç³»ç»Ÿè°ƒç”¨ï¼Œè¿™å¯¹å­—ç¬¦è®¾å¤‡æ˜¯æ¯”è¾ƒç‰¹æ®Šçš„ï¼Œå› ä¸ºmmap()é€šå¸¸ç”¨åœ¨æœ‰ç‰©ç†å­˜å‚¨ä»‹è´¨çš„æ–‡ä»¶ç³»ç»Ÿä¸Šï¼Œè€Œè±¡Binderè¿™æ ·æ²¡æœ‰ç‰©ç†ä»‹è´¨ï¼Œçº¯ç²¹ç”¨æ¥é€šä¿¡çš„å­—ç¬¦è®¾å¤‡æ²¡å¿…è¦æ”¯æŒmmap()ã€‚Binderé©±åŠ¨å½“ç„¶ä¸æ˜¯ä¸ºäº†åœ¨ç‰©ç†ä»‹è´¨å’Œç”¨æˆ·ç©ºé—´åšæ˜ å°„ï¼Œè€Œæ˜¯ç”¨æ¥åˆ›å»ºæ•°æ®æ¥æ”¶çš„ç¼“å­˜ç©ºé—´ã€‚å…ˆçœ‹mmap()æ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼š<br>fd = open(â€œ/dev/binderâ€, O_RDWR);<br>mmap(NULL, MAP_SIZE, PROT_READ, MAP_PRIVATE, fd, 0);<br>è¿™æ ·Binderçš„æ¥æ”¶æ–¹å°±æœ‰äº†ä¸€ç‰‡å¤§å°ä¸ºMAP_SIZEçš„æ¥æ”¶ç¼“å­˜åŒºã€‚mmap()çš„è¿”å›å€¼æ˜¯å†…å­˜æ˜ å°„åœ¨ç”¨æˆ·ç©ºé—´çš„åœ°å€ï¼Œä¸è¿‡è¿™æ®µç©ºé—´æ˜¯ç”±é©±åŠ¨ç®¡ç†ï¼Œç”¨æˆ·ä¸å¿…ä¹Ÿä¸èƒ½ç›´æ¥è®¿é—®ï¼ˆæ˜ å°„ç±»å‹ä¸ºPROT_READï¼Œåªè¯»æ˜ å°„ï¼‰</p><p>ä¸€æ¬¡å®Œæ•´çš„ Binder IPC é€šä¿¡è¿‡ç¨‹é€šå¸¸æ˜¯è¿™æ ·ï¼š</p><p>1.Serverç«¯åœ¨å¯åŠ¨ä¹‹åï¼Œè°ƒç”¨å¯¹/dev/binderè®¾å¤‡è°ƒç”¨mmap<br>2.å†…æ ¸ä¸­çš„binder_mmapå‡½æ•°è¿›è¡Œå¯¹åº”çš„å¤„ç†ï¼šç”³è¯·ä¸€å—ç‰©ç†å†…å­˜ï¼Œç„¶ååœ¨Serverç«¯çš„ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´åŒæ—¶è¿›è¡Œæ˜ å°„ã€‚å†…æ ¸ä¸­çš„binder_mmapå‡½æ•°è¿›è¡Œå¯¹åº”çš„å¤„ç†ï¼šç”³è¯·ä¸€å—ç‰©ç†å†…å­˜ï¼Œç„¶ååœ¨Serverç«¯çš„ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´åŒæ—¶è¿›è¡Œæ˜ å°„<br>3.Clientå‘é€è¯·æ±‚ï¼Œè¿™ä¸ªè¯·æ±‚å°†å…ˆåˆ°é©±åŠ¨ä¸­ï¼ŒåŒæ—¶éœ€è¦å°†æ•°æ®ä»Clientè¿›ç¨‹çš„ç”¨æˆ·ç©ºé—´æ‹·è´ï¼ˆClientå‘é€è¯·æ±‚ï¼Œè¿™ä¸ªè¯·æ±‚å°†å…ˆåˆ°é©±åŠ¨ä¸­ï¼ŒåŒæ—¶éœ€è¦å°†æ•°æ®ä»Clientè¿›ç¨‹çš„ç”¨æˆ·ç©ºé—´æ‹·è´ï¼ˆcopy_from_userï¼‰åˆ°å†…æ ¸ç©ºé—´<br>4.é©±åŠ¨é€šè¿‡è¯·æ±‚é€šçŸ¥Serverç«¯æœ‰äººå‘å‡ºè¯·æ±‚ï¼ŒServerè¿›è¡Œå¤„ç†ã€‚ç”±äºå†…æ ¸ç©ºé—´å’ŒServerç«¯è¿›ç¨‹çš„ç”¨æˆ·ç©ºé—´å­˜åœ¨å†…å­˜æ˜ å°„ï¼Œå› æ­¤Serverè¿›ç¨‹çš„ä»£ç å¯ä»¥ç›´æ¥è®¿é—®ã€‚è¿™æ ·ä¾¿å®Œæˆäº†ä¸€æ¬¡è¿›ç¨‹é—´çš„é€šä¿¡</p><p><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/mmap-6.png" alt=""></p><p>è€Œä½¿ç”¨mmapæ“ä½œæ–‡ä»¶ä¸­ï¼Œåˆ›å»ºæ–°çš„è™šæ‹Ÿå†…å­˜åŒºåŸŸå’Œå»ºç«‹æ–‡ä»¶ç£ç›˜åœ°å€å’Œè™šæ‹Ÿå†…å­˜åŒºåŸŸæ˜ å°„è¿™ä¸¤æ­¥ï¼Œæ²¡æœ‰ä»»ä½•æ–‡ä»¶æ‹·è´æ“ä½œã€‚è€Œä¹‹åè®¿é—®æ•°æ®æ—¶å‘ç°å†…å­˜ä¸­å¹¶æ— æ•°æ®è€Œå‘èµ·çš„ç¼ºé¡µå¼‚å¸¸è¿‡ç¨‹ï¼Œå¯ä»¥é€šè¿‡å·²ç»å»ºç«‹å¥½çš„æ˜ å°„å…³ç³»ï¼Œåªä½¿ç”¨ä¸€æ¬¡æ•°æ®æ‹·è´ï¼Œå°±ä»ç£ç›˜ä¸­å°†æ•°æ®ä¼ å…¥å†…å­˜çš„ç”¨æˆ·ç©ºé—´ä¸­ï¼Œä¾›è¿›ç¨‹ä½¿ç”¨ã€‚</p><p>æ€»è€Œè¨€ä¹‹ï¼Œå¸¸è§„æ–‡ä»¶æ“ä½œéœ€è¦ä»ç£ç›˜åˆ°é¡µç¼“å­˜å†åˆ°ç”¨æˆ·ä¸»å­˜çš„ä¸¤æ¬¡æ•°æ®æ‹·è´ã€‚è€Œmmapæ“æ§æ–‡ä»¶ï¼Œåªéœ€è¦ä»ç£ç›˜åˆ°ç”¨æˆ·ä¸»å­˜çš„ä¸€æ¬¡æ•°æ®æ‹·è´è¿‡ç¨‹ã€‚è¯´ç™½äº†ï¼Œmmapçš„å…³é”®ç‚¹æ˜¯å®ç°äº†ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„æ•°æ®ç›´æ¥äº¤äº’è€Œçœå»äº†ç©ºé—´ä¸åŒæ•°æ®ä¸é€šçš„ç¹çè¿‡ç¨‹ã€‚å› æ­¤mmapæ•ˆç‡æ›´é«˜</p><p>é€šè¿‡ä¸Šé¢ä»‹ç»å¯ä»¥çœ‹åˆ°ï¼Œé©±åŠ¨ä¸ºæ¥æ”¶æ–¹åˆ†æ‹…äº†æœ€ä¸ºç¹ççš„ä»»åŠ¡ï¼šåˆ†é…/é‡Šæ”¾å¤§å°ä¸ç­‰ï¼Œéš¾ä»¥é¢„æµ‹çš„æœ‰æ•ˆè´Ÿè·ç¼“å­˜åŒºï¼Œè€Œæ¥æ”¶æ–¹åªéœ€è¦æä¾›ç¼“å­˜æ¥å­˜æ”¾å¤§å°å›ºå®šï¼Œæœ€å¤§ç©ºé—´å¯ä»¥é¢„æµ‹çš„æ¶ˆæ¯å¤´å³å¯ã€‚åœ¨æ•ˆç‡ä¸Šï¼Œç”±äºmmap()åˆ†é…çš„å†…å­˜æ˜¯æ˜ å°„åœ¨æ¥æ”¶æ–¹ç”¨æˆ·ç©ºé—´é‡Œçš„ï¼Œæ‰€æœ‰æ€»ä½“æ•ˆæœå°±ç›¸å½“äºå¯¹æœ‰æ•ˆè´Ÿè·æ•°æ®åšäº†ä¸€æ¬¡ä»å‘é€æ–¹ç”¨æˆ·ç©ºé—´åˆ°æ¥æ”¶æ–¹ç”¨æˆ·ç©ºé—´çš„ç›´æ¥æ•°æ®æ‹·è´ï¼Œçœå»äº†å†…æ ¸ä¸­æš‚å­˜è¿™ä¸ªæ­¥éª¤ï¼Œæå‡äº†ä¸€å€çš„æ€§èƒ½ã€‚é¡ºä¾¿å†æä¸€ç‚¹ï¼ŒLinuxå†…æ ¸å®é™…ä¸Šæ²¡æœ‰ä»ä¸€ä¸ªç”¨æˆ·ç©ºé—´åˆ°å¦ä¸€ä¸ªç”¨æˆ·ç©ºé—´ç›´æ¥æ‹·è´çš„å‡½æ•°ï¼Œéœ€è¦å…ˆç”¨copy_from_user()æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼Œå†ç”¨copy_to_user()æ‹·è´åˆ°å¦ä¸€ä¸ªç”¨æˆ·ç©ºé—´ã€‚ä¸ºäº†å®ç°ç”¨æˆ·ç©ºé—´åˆ°ç”¨æˆ·ç©ºé—´çš„æ‹·è´ï¼Œmmap()åˆ†é…çš„å†…å­˜é™¤äº†æ˜ å°„è¿›äº†æ¥æ”¶æ–¹è¿›ç¨‹é‡Œï¼Œè¿˜æ˜ å°„è¿›äº†å†…æ ¸ç©ºé—´ã€‚æ‰€ä»¥è°ƒç”¨copy_from_user()å°†æ•°æ®æ‹·è´è¿›å†…æ ¸ç©ºé—´ä¹Ÿç›¸å½“äºæ‹·è´è¿›äº†æ¥æ”¶æ–¹çš„ç”¨æˆ·ç©ºé—´ï¼Œè¿™å°±æ˜¯Binderåªéœ€ä¸€æ¬¡æ‹·è´çš„â€˜ç§˜å¯†â€™</p><p>Binder å¹¶ä¸å­˜åœ¨ç‰©ç†ä»‹è´¨ï¼Œå› æ­¤ Binder é©±åŠ¨ä½¿ç”¨ mmap() å¹¶ä¸æ˜¯ä¸ºäº†åœ¨ç‰©ç†ä»‹è´¨å’Œç”¨æˆ·ç©ºé—´ä¹‹é—´å»ºç«‹æ˜ å°„ï¼Œè€Œæ˜¯ç”¨æ¥åœ¨å†…æ ¸ç©ºé—´åˆ›å»ºæ•°æ®æ¥æ”¶çš„ç¼“å­˜ç©ºé—´ã€‚</p><p>ä¸€æ¬¡å®Œæ•´çš„ Binder IPC é€šä¿¡è¿‡ç¨‹é€šå¸¸æ˜¯è¿™æ ·ï¼š</p><pre><code>é¦–å…ˆ Binder é©±åŠ¨åœ¨å†…æ ¸ç©ºé—´åˆ›å»ºä¸€ä¸ªæ•°æ®æ¥æ”¶ç¼“å­˜åŒºï¼›æ¥ç€åœ¨å†…æ ¸ç©ºé—´å¼€è¾Ÿä¸€å—å†…æ ¸ç¼“å­˜åŒºï¼Œå»ºç«‹å†…æ ¸ç¼“å­˜åŒºå’Œå†…æ ¸ä¸­æ•°æ®æ¥æ”¶ç¼“å­˜åŒºä¹‹é—´çš„æ˜ å°„å…³ç³»ï¼Œä»¥åŠå†…æ ¸ä¸­æ•°æ®æ¥æ”¶ç¼“å­˜åŒºå’Œæ¥æ”¶è¿›ç¨‹ç”¨æˆ·ç©ºé—´åœ°å€çš„æ˜ å°„å…³ç³»ï¼›å‘é€æ–¹è¿›ç¨‹é€šè¿‡ç³»ç»Ÿè°ƒç”¨ copyfromuser() å°†æ•°æ® copy åˆ°å†…æ ¸ä¸­çš„å†…æ ¸ç¼“å­˜åŒºï¼Œç”±äºå†…æ ¸ç¼“å­˜åŒºå’Œæ¥æ”¶è¿›ç¨‹çš„ç”¨æˆ·ç©ºé—´å­˜åœ¨å†…å­˜æ˜ å°„ï¼Œå› æ­¤ä¹Ÿå°±ç›¸å½“äºæŠŠæ•°æ®å‘é€åˆ°äº†æ¥æ”¶è¿›ç¨‹çš„ç”¨æˆ·ç©ºé—´ï¼Œè¿™æ ·ä¾¿å®Œæˆäº†ä¸€æ¬¡è¿›ç¨‹é—´çš„é€šä¿¡</code></pre><p><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/mmap-7.jpeg" alt=""></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨Unix/Linuxç³»ç»Ÿä¸‹è¯»å†™æ–‡ä»¶ï¼Œä¸€èˆ¬æœ‰ä¸¤ç§æ–¹å¼&lt;/p&gt;
&lt;p&gt;&lt;code&gt;ç¬¬ä¸€ç§æ–¹å¼ï¼šä¼ ç»Ÿçš„read/writeæ–¹å¼&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;å¸¸è§„æ–‡ä»¶ç³»ç»Ÿæ“ä½œçš„è°ƒç”¨è¿‡ç¨‹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;è¿›ç¨‹å‘èµ·è¯»æ–‡ä»¶è¯·æ±‚&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;å†…æ ¸é€š
      
    
    </summary>
    
      <category term="Linux" scheme="http://lihaizhou.top/categories/Linux/"/>
    
    
  </entry>
  
  <entry>
    <title>ä¸ºä½•è¿æ¥wifiåç³»ç»Ÿä¼šå¡é¡¿ä¸€ä¸‹?</title>
    <link href="http://lihaizhou.top/2020/03/05/%E4%B8%BA%E4%BD%95%E8%BF%9E%E6%8E%A5wifi%E5%90%8E%E7%B3%BB%E7%BB%9F%E4%BC%9A%E5%8D%A1%E9%A1%BF%E4%B8%80%E4%B8%8B/"/>
    <id>http://lihaizhou.top/2020/03/05/ä¸ºä½•è¿æ¥wifiåç³»ç»Ÿä¼šå¡é¡¿ä¸€ä¸‹/</id>
    <published>2020-03-05T03:00:05.000Z</published>
    <updated>2020-03-05T07:32:03.153Z</updated>
    
    <content type="html"><![CDATA[<p><strong>é—®é¢˜æè¿°</strong><br>æ•°æ®æµé‡ä½¿ç”¨è¿‡ç¨‹ä¸­åˆ‡æ¢åˆ°wifiè¿æ¥ï¼Œç³»ç»Ÿå…¨å±€ä¼šå¡ä¸€ä¸‹</p><p><strong>åˆæ­¥åˆ†æ</strong><br>æŠ“å–systraceæ—¶æ‰‹æŒ‡åœ¨æ¡Œé¢ä¸åœçš„æ»‘åŠ¨ï¼Œå¯ä»¥çœ‹åˆ°å¾ˆæ˜ç¡®çš„ä¸€æ®µæ²¡æœ‰å¸§ï¼Œä½†æ˜¯è¿™ä¸ªæ—¶é—´æ®µæ‰‹æŒ‡ä¸€ç›´åœ¨æ»‘åŠ¨<br>æˆ‘ä»¬éƒ½çŸ¥é“vsyncæ˜¯APPæœ€ç»ˆé€šè¿‡æ¡†æ¶å±‚è¯·æ±‚ä¸Šæ¥çš„ï¼ŒChoreographeræ”¶åˆ°å›è°ƒåå¼€å§‹æ¸²æŸ“å¸§ã€‚<br>è‡ªç„¶è€Œç„¶å¯¹åº”åˆ°sfä¸­çš„vsync-sfä¹Ÿæ²¡æœ‰å¸§åˆæˆï¼Œæ‰€ä»¥ç•Œé¢ä¸Šè¡¨ç°ä¸ºå¡é¡¿ï¼Œç°è±¡å’Œjankç±»ä¼¼ï¼Œéƒ½æ˜¯å±å¹•ä¸Šæ²¡æœ‰åŠæ—¶æ›´æ–°ç”»é¢<br><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/wifi%E5%88%97%E8%A1%A8%E5%8D%A1%E9%A1%BF4.png" alt=""><br>å…¶å®è¿™ä¸ªæ—¶é—´æ®µå¯ä»¥å‘ç°deliverInputEventä¹Ÿæ²¡æœ‰ï¼Œå…¶å®è¿™ä¸€ç‚¹ä¹Ÿå¯ä»¥ä»Launcherçš„PendingInputEventQueueåŒºåŸŸçœ‹å‡ºæ¥<br>PS: PendingInputEventQueue é‡Œé¢è®°å½•çš„æ˜¯ App éœ€è¦å¤„ç†çš„ Input äº‹ä»¶ï¼Œè¿™ä¸ªé˜¶æ®µå¯¹åº”çš„æ˜¯ç”¨æˆ·è¿›ç¨‹ä¸­äº†<br>å¼€å§‹å¡é¡¿åå³çº¢åœˆåé¢ä¾¿æ²¡æœ‰æ³¢å³°å‡ºç°, è¯´æ˜å‹æ ¹æ²¡æœ‰inputé€åˆ°åº”ç”¨è¿›ç¨‹<br><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/%E5%88%87%E6%8D%A2%E5%88%B0wifi%E5%90%8E%E5%8D%A1%E9%A1%BF-2.png" alt=""></p><p>è¿™ä¸ªæ—¶å€™ï¼Œè‡ªç„¶è€Œç„¶å°±æœ‰ä¸€ä¸ªç–‘é—®:<br>æ—¢ç„¶åº”ç”¨è¿›ç¨‹æ²¡æœ‰æ”¶åˆ°inputäº‹ä»¶ï¼Œé‚£ä¹ˆä¼šä¸ä¼šæ˜¯inputä¸ŠæŠ¥çš„è¿‡ç¨‹ä¸­å“ªä¸ªç¯èŠ‚å‡ºäº†é—®é¢˜å‘¢ï¼Ÿ</p><p>å†ç§‘æ™®ä¸‹inputäº‹ä»¶ä¸ŠæŠ¥çš„å¤§æ¦‚æµç¨‹</p><ol><li>InputReader è¯»å– Input äº‹ä»¶</li><li>InputReader å°†è¯»å–çš„ Input äº‹ä»¶æ”¾åˆ° InboundQueue ä¸­</li><li>InputDispatcher ä» InboundQueue ä¸­å–å‡º Input äº‹ä»¶æ´¾å‘åˆ°å„ä¸ª App(è¿æ¥) çš„ OutBoundQueue<br> åŒæ—¶å°†äº‹ä»¶è®°å½•åˆ°å„ä¸ª App(è¿æ¥) çš„ WaitQueue</li><li>App æ¥æ”¶åˆ° Input äº‹ä»¶ï¼ŒåŒæ—¶è®°å½•åˆ° PaddingQueue ï¼Œç„¶åå¯¹äº‹ä»¶è¿›è¡Œåˆ†å‘å¤„ç†<br> App å¤„ç†å®Œæˆåï¼Œå›è°ƒ InputManagerService å°†è´Ÿè´£ç›‘å¬çš„ WaitQueue ä¸­å¯¹åº”çš„ Input ç§»é™¤</li></ol><p>InputReaderå’ŒInputDispatcheræ˜¯è·‘åœ¨SystemServeré‡Œé¢çš„ä¸¤ä¸ªNativeçº¿ç¨‹ï¼Œè´Ÿè´£è¯»å–å’Œåˆ†å‘Input äº‹ä»¶<br><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/%E5%88%87%E6%8D%A2%E5%88%B0wifi%E5%90%8E%E5%8D%A1%E9%A1%BF-3.png" alt=""><br>åˆ°è¿™é‡Œå¯ä»¥æ˜æ˜¾çœ‹å‡ºï¼Œå¡é¡¿æ—¶é—´æ®µå†…InputReaderåœ¨ä¸æ–­çš„è¯»å–äº‹ä»¶ï¼Œè¯´æ˜driveræ²¡é—®é¢˜ï¼Œæ³¨æ„è¿™ä¸ªæ—¶å€™InputDispatcher æ²¡æœ‰æ”¶åˆ°ä»»ä½•inputäº‹ä»¶å¹¶ä¸”å¤„äºSçŠ¶æ€<br>å…¶å®InputDispatcher æ²¡æœ‰è·å–åˆ°äº‹ä»¶çš„è¯ï¼Œä¸ç”¨è¯´oqåŒºåŸŸå’ŒwqåŒºåŸŸè‚¯å®šä¹Ÿæ˜¯æ²¡æœ‰äº‹ä»¶çš„<br><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/%E5%88%87%E6%8D%A2%E5%88%B0wifi%E5%90%8E%E5%8D%A1%E9%A1%BF-4.png" alt=""><br>æ„æ–™ä¹‹ä¸­ï¼Œç©ºç©ºå¦‚ä¹Ÿï¼Œéš¾æ€ªåº”ç”¨è¿›ç¨‹è‹¦è‹¦ç­‰ä¸æ¥äº‹ä»¶<br>è¿™é‡Œå†ç®€è¦ç§‘æ™®ä¸‹è¿™å‡ ä¸ªæ¦‚å¿µ<br>è¯´æ˜</p><ul><li>InputReader è´Ÿè´£ä» EventHub é‡Œé¢æŠŠ Input äº‹ä»¶è¯»å–å‡ºæ¥ï¼Œç„¶åäº¤ç»™ InputDispatcher è¿›è¡Œäº‹ä»¶åˆ†å‘</li><li>InputDispatcher åœ¨æ‹¿åˆ° InputReader è·å–çš„äº‹ä»¶ä¹‹åï¼Œå¯¹äº‹ä»¶è¿›è¡ŒåŒ…è£…å’Œåˆ†å‘ (ä¹Ÿå°±æ˜¯å‘ç»™å¯¹åº”çš„)<ul><li>OutboundQueue é‡Œé¢æ”¾çš„æ˜¯å³å°†è¦è¢«æ´¾å‘ç»™å¯¹åº” AppConnection çš„äº‹ä»¶</li></ul></li><li>WaitQueue é‡Œé¢è®°å½•çš„æ˜¯å·²ç»æ´¾å‘ç»™ AppConnection ä½†æ˜¯ App è¿˜åœ¨å¤„ç†æ²¡æœ‰è¿”å›å¤„ç†æˆåŠŸçš„äº‹ä»¶</li><li>PendingInputEventQueue é‡Œé¢è®°å½•çš„æ˜¯ App éœ€è¦å¤„ç†çš„ Input äº‹ä»¶ï¼Œè¿™é‡Œå¯ä»¥çœ‹åˆ°å·²ç»åˆ°äº†åº”ç”¨è¿›ç¨‹</li><li>deliverInputEvent æ ‡è¯† App UI Thread è¢« Input äº‹ä»¶å”¤é†’</li><li>InputResponse æ ‡è¯† Input äº‹ä»¶åŒºåŸŸ</li><li>App å“åº” Input äº‹ä»¶ ï¼š è¿™é‡Œæ˜¯æ»‘åŠ¨ç„¶åæ¾æ‰‹ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ç†Ÿæ‚‰çš„æ¡Œé¢æ»‘åŠ¨çš„æ“ä½œï¼Œæ¡Œé¢éšç€æ‰‹æŒ‡çš„æ»‘åŠ¨æ›´æ–°ç”»é¢ï¼Œæ¾æ‰‹åè§¦å‘ Fling ç»§ç»­æ»‘åŠ¨ï¼Œä» Systrace å°±å¯ä»¥çœ‹åˆ°æ•´ä¸ªäº‹ä»¶çš„æµç¨‹</li></ul><p>è¿™ä¸ªæ—¶å€™ï¼Œäº‹ä»¶ä¸ŠæŠ¥å¤§è‡´é—®é¢˜åŒºåŸŸçŸ¥é“äº†ï¼Œå†å›åˆ°InputDispatcher ï¼Œçœ‹ä¸‹æœ€åæ˜¯è¢«1726å”¤é†’çš„<br><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/%E5%88%87%E6%8D%A2%E5%88%B0wifi%E5%90%8E%E5%8D%A1%E9%A1%BF-5.png" alt=""></p><p>è·Ÿåˆ°tid 1726åŒºåŸŸï¼Œå±…ç„¶å®šä½åˆ°äº†systemserveråŒºåŸŸï¼ŒInputDispatcheræ­£å¸¸æ¥è®²éƒ½æ˜¯ç”±InputReader å”¤é†’çš„ï¼Œè¿™é‡Œä¸å…æœ‰äº›å›°æƒ‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//cs.android.com/android/platform/superproject/+/master:frameworks/native/services/inputflinger/dispatcher/InputDispatcher.cpp;l=2719?q=InputDispatcher.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> InputDispatcher::notifyMotion(<span class="keyword">const</span> NotifyMotionArgs* args) &#123;</span><br><span class="line"><span class="comment">//....</span></span><br><span class="line">    bool needWake;</span><br><span class="line">    &#123; <span class="comment">// acquire lock</span></span><br><span class="line">        mLock.lock();</span><br><span class="line">        <span class="keyword">if</span> (shouldSendMotionToInputFilterLocked(args)) &#123;</span><br><span class="line">            mLock.unlock();</span><br><span class="line">            MotionEvent event;</span><br><span class="line">            event.initialize(args-&gt;deviceId, args-&gt;source, args-&gt;displayId, args-&gt;action,</span><br><span class="line">                             args-&gt;actionButton, args-&gt;flags, args-&gt;edgeFlags, args-&gt;metaState,</span><br><span class="line">                             args-&gt;buttonState, args-&gt;classification, <span class="number">0</span>, <span class="number">0</span>, args-&gt;xPrecision,</span><br><span class="line">                             args-&gt;yPrecision, args-&gt;downTime, args-&gt;eventTime, args-&gt;pointerCount,</span><br><span class="line">                             args-&gt;pointerProperties, args-&gt;pointerCoords);</span><br><span class="line">            policyFlags |= POLICY_FLAG_FILTERED;</span><br><span class="line">            <span class="keyword">if</span> (!mPolicy-&gt;filterInputEvent(&amp;event, policyFlags)) &#123;</span><br><span class="line">                <span class="keyword">return</span>; <span class="comment">// event was consumed by the filter</span></span><br><span class="line">            &#125;</span><br><span class="line">            mLock.lock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Just enqueue a new motion event.</span></span><br><span class="line">        MotionEntry* newEntry =</span><br><span class="line">                <span class="keyword">new</span> MotionEntry(args-&gt;sequenceNum, args-&gt;eventTime, args-&gt;deviceId, args-&gt;source,</span><br><span class="line">                                args-&gt;displayId, policyFlags, args-&gt;action, args-&gt;actionButton,</span><br><span class="line">                                args-&gt;flags, args-&gt;metaState, args-&gt;buttonState,</span><br><span class="line">                                args-&gt;classification, args-&gt;edgeFlags, args-&gt;xPrecision,</span><br><span class="line">                                args-&gt;yPrecision, args-&gt;downTime, args-&gt;pointerCount,</span><br><span class="line">                                args-&gt;pointerProperties, args-&gt;pointerCoords, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        needWake = enqueueInboundEventLocked(newEntry);</span><br><span class="line">        mLock.unlock();</span><br><span class="line">    &#125; <span class="comment">// release lock</span></span><br><span class="line">    <span class="keyword">if</span> (needWake) &#123;</span><br><span class="line">        mLooper-&gt;wake();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°é‡Œä¸»è¦åšçš„äº‹æ˜¯è¯»å–çº¿ç¨‹InputReaderThreadåœ¨å¤„ç†äº‹åŠ¡å¹¶å°†è¯»å–çš„äº‹ä»¶æ”¾åˆ°é˜Ÿåˆ—ä¸­<br>å¯ä»¥çœ‹åˆ°æœ€åmLooper-&gt;wake();è¿™é‡Œçš„looperå¯¹åº”çš„æ˜¯InputDispatcherçš„looperï¼Œä¹Ÿå°±æ˜¯æœ€åä¼šå”¤é†’InputDispatcherçº¿ç¨‹<br>è€Œæˆ‘ä»¬è¿™ç¬”é—®é¢˜ä¸­InputDispatcheråœ¨å¡é¡¿æœŸé—´å¤„äºSçŠ¶æ€ï¼Œå¾€ä¸Šçœ‹å“ªé‡Œreturnäº†å¯¼è‡´æ²¡æœ‰æ‰§è¡Œï¼Œå…¶å®åœ¨mPolicy-&gt;filterInputEventå¤„è¿”å›äº†falseå¹¶ä¸”returnäº†ï¼Œè¿™é‡Œçš„ä»£ç å±‚å±‚è¿½è¸ªä¼šè·Ÿåˆ°InputManagerServiceçš„filterInputEvent()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//cs.android.com/android/platform/superproject/+/master:frameworks/base/services/core/java/com/android/server/input/InputManagerService.java;l=1828?q=InputManagerService</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Native callback.</span></span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">filterInputEvent</span><span class="params">(InputEvent event, <span class="keyword">int</span> policyFlags)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mInputFilterLock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mInputFilter != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    mInputFilter.filterInputEvent(event, policyFlags);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                    <span class="comment">/* ignore */</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        event.recycle();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸»è¦æ˜¯åˆ¤æ–­InputFilteræ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œåˆ™ä¼šèµ°åˆ°mInputFilter.filterInputEventï¼Œå¯ä»¥æ³¨æ„ä¸‹ï¼Œè¿™é‡Œå·²ç»ä½äºIMSä¹Ÿå°±æ˜¯systemserverè¿›ç¨‹<br>æˆ‘ä»¬è¿™ä¸ªé—®é¢˜å§‹ç»ˆä¸ä¸ºç©ºï¼ŒåŸå› åœ¨äºå¼€å¯äº†æ‰‹åŠ¿è¯†åˆ«ä¼šè®¾ç½®ä¸€ä¸ªInputFilterå¯¼è‡´è¿™é‡Œä¸ä¸ºç©ºï¼Œä»¥ä¾¿åšè¿›ä¸€æ­¥çš„äº‹ä»¶åŠ å·¥å¤„ç†ï¼ŒInputManagerServiceçš„filterInputEvent()æœ€åè°ƒç”¨åˆ°injectInputEvent()å°†è¿™ä¸ªäº‹ä»¶é€å…¥mInBoundQueueï¼Œå¹¶å”¤é†’InputDispatcherï¼Œä¸æ˜¯æœ¬æ–‡é‡ç‚¹æ‰€ä»¥ä»£ç å°±ä¸å±•å¼€å™è¿°<br>è‡³æ­¤æ˜ç™½äº†ä¸ºä½•InputReaderçš„å”¤é†’æºä¼šè·‘åˆ°systemserver(UIçº¿ç¨‹)ä¸­</p><p>ç»§ç»­çœ‹systemserver(UIçº¿ç¨‹)è¿™æ®µåŒºåŸŸï¼Œåœ¨æ‰§è¡Œä¸€ä¸ªå¹¿æ’­çš„onReceiveä¸­ç­‰é”å¯¼è‡´çš„sleep<br><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/%E5%88%87%E6%8D%A2%E5%88%B0wifi%E5%90%8E%E5%8D%A1%E9%A1%BF-6.png" alt=""></p><p>è¿™é‡Œé¡ºä¾¿å¯¹Contended on monitor with owner NetworkPolicyè¿›è¡Œè§£è¯»:<br>MonitoræŒ‡çš„æ˜¯å½“å‰é”å¯¹è±¡çš„æ± ï¼Œåœ¨Javaä¸­ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½æœ‰ä¸¤ä¸ªæ± ï¼Œé”(monitor)æ± å’Œç­‰å¾…æ± ï¼š</p><p>é”æ± ï¼ˆåŒæ­¥é˜Ÿåˆ— SynchronizedQueue ï¼‰ï¼šå‡è®¾çº¿ç¨‹ A å·²ç»æ‹¥æœ‰äº†æŸä¸ªå¯¹è±¡(æ³¨æ„:ä¸æ˜¯ç±» )çš„é”ï¼Œè€Œå…¶å®ƒçš„çº¿ç¨‹æƒ³è¦è°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„æŸä¸ª synchronized æ–¹æ³•(æˆ–è€… synchronized å—)ï¼Œç”±äºè¿™äº›çº¿ç¨‹åœ¨è¿›å…¥å¯¹è±¡çš„ synchronized æ–¹æ³•ä¹‹å‰å¿…é¡»å…ˆè·å¾—è¯¥å¯¹è±¡çš„é”çš„æ‹¥æœ‰æƒï¼Œä½†æ˜¯è¯¥å¯¹è±¡çš„é”ç›®å‰æ­£è¢«çº¿ç¨‹ A æ‹¥æœ‰ï¼Œæ‰€ä»¥è¿™äº›çº¿ç¨‹å°±è¿›å…¥äº†è¯¥å¯¹è±¡çš„é”æ± ä¸­ã€‚</p><p>è¿™é‡Œç”¨äº†äº‰å¤º(contention)è¿™ä¸ªè¯ï¼Œæ„æ€æ˜¯è¿™é‡Œç”±äºåœ¨å’Œç›®å‰å¯¹è±¡çš„é”æ­£è¢«å…¶ä»–å¯¹è±¡ï¼ˆOwnerï¼‰æ‰€æŒæœ‰ï¼Œæ‰€ä»¥æ²¡æ³•å¾—åˆ°è¯¥å¯¹è±¡çš„é”çš„æ‹¥æœ‰æƒï¼Œæ‰€ä»¥è¿›å…¥è¯¥å¯¹è±¡çš„é”æ± </p><p>Owner : æŒ‡çš„æ˜¯å½“å‰æ‹¥æœ‰è¿™ä¸ªå¯¹è±¡çš„é”çš„å¯¹è±¡ï¼Œè¿™é‡Œæ˜¯NetworkPolicy</p><p>è®²çš„é€šä¿—ä¸€ç‚¹<br>systemserver(UIçº¿ç¨‹)åœ¨æ‰§è¡Œä¸€ä¸ªå¹¿æ’­çš„onReceiveä¸­ç­‰ä¸€ä¸ªé”ï¼Œè¿™ä¸ªé”æ­¤æ—¶è¢«NetworkPolicyæŒæœ‰</p><p>è‡ªç„¶è€Œç„¶ç»§ç»­çœ‹NetworkPolicyåŒºåŸŸ<br><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/%E5%88%87%E6%8D%A2%E5%88%B0wifi%E5%90%8E%E5%8D%A1%E9%A1%BF-7.png" alt=""></p><p>å¯ä»¥çœ‹åˆ°è¿™æ®µæ—¶é—´NetworkPolicyåŸºæœ¬å¤„äºSçŠ¶æ€ï¼Œæ­¤æ—¶netdå¾—åˆ°è°ƒåº¦è¿è¡Œï¼Œè¿™ç‚¹åœ¨cpuåŒºåŸŸä¹Ÿå¯ä»¥å¾—åˆ°è¯å®</p><p>å†çœ‹ä¸‹netdåŒºåŸŸï¼Œå¡é¡¿å¼€å§‹çš„æ—¶å€™ä¹Ÿæ­£æ˜¯netdå¾—åˆ°è°ƒåº¦çš„æ—¶å€™ï¼Œæ˜¯è¢«2835è¿™ä¸ªè¿›ç¨‹å”¤é†’ï¼Œ2835æ­£æ˜¯NetworkPolicy</p><p><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/%E5%88%87%E6%8D%A2%E5%88%B0wifi%E5%90%8E%E5%8D%A1%E9%A1%BF-8.png" alt=""></p><p>åˆ°è¿™é‡Œå¯ä»¥å¤§è‡´æ¢³ç†ä¸€ä¸‹å¡é¡¿æ—¶é—´å†…åšçš„äº‹:<br>1.SystemServerä¸­çš„UIçº¿ç¨‹åœ¨ç­‰ä¸€ä¸ªé”ï¼Œè¿™ä¸ªé”è¢«NetworkPolicyæŒæœ‰ï¼Œæ‰€ä»¥æ²¡æœ‰å‘é€inputäº‹ä»¶ç»™InputDispatcher<br>2.NetworkPolicyä¸ºä½•ä¸€ç›´ä¸é‡Šæ”¾å‘¢ï¼Œæ˜¯å› ä¸ºå…¶è°ƒç”¨äº†netdï¼Œnetdæ‰§è¡Œçš„æ—¶é—´è¾ƒé•¿è€—æ—¶äº†1så·¦å³ï¼Œç­‰netdæ‰§è¡Œç»“æŸåNetworkPolicyå¾—åˆ°è°ƒåº¦ç»§ç»­æ‰§è¡Œå¹¶é‡Šæ”¾é”<br>3.SystemServerä¸­çš„UIçº¿ç¨‹è·å–åˆ°é”ï¼Œç»§ç»­å‘é€inputäº‹ä»¶åˆ°mInBoundQueueå¹¶å”¤é†’InputDispatcher</p><p>ç°åœ¨çš„ç–‘é—®å°±æ˜¯NetworkPolicyå’ŒSystemServer(UIçº¿ç¨‹)ç›‘å¬äº†ä¸€æ ·çš„å¹¿æ’­ï¼Œè¿™ä¸ªå¹¿æ’­çš„æœåŠ¡ç«¯åº”è¯¥æ˜¯åŠ é”äº†å¯¼è‡´äº†æ‰€æœ‰æ³¨å†Œçš„å®¢æˆ·ç«¯é¡ºåºæ‰§è¡Œ<br>å…¶å®æƒ³æƒ³ä¹Ÿèƒ½çŒœåˆ°åº”è¯¥æ˜¯wifiçŠ¶æ€å˜åŒ–æˆ–è€…ç½‘ç»œå˜åŒ–çš„å¹¿æ’­ï¼Œè·Ÿåˆ°NetworkManagerServiceä¸­çœ‹ä¸‹å¾ˆå®¹æ˜“å‘ç°NetworkManagerServiceç›‘å¬äº†ä¸€ä¸ªç½‘ç»œå˜åŒ–å¹¿æ’­CONNECTIVITY_ACTION<br>ä½†æ˜¯SystemServer(UIçº¿ç¨‹)ä¸­æ³¨å†Œå¹¶å›è°ƒæ‰§è¡Œçš„ä»£ç ä½ç½®éœ€è¦å€ŸåŠ©traceviewè¿›ä¸€æ­¥å®šä½ï¼Œè¿™é‡Œæ¯”è¾ƒç®€å•ä¸å±•å¼€è®¨è®º</p><p>è§£å†³æ€è·¯çœ‹çœ‹SystemServer(UIçº¿ç¨‹)ä¸­å…·ä½“ä»£ç å¤„æ˜¯å¦èƒ½å¤Ÿå»æ‰é”æˆ–åå°æ‰§è¡Œï¼Œåªè¦ä¸å µåœ¨UIçº¿ç¨‹å°±è¡Œ</p><p>è¿™ä¸ªé—®é¢˜åªæœ‰å¼€å¯æ‰‹åŠ¿è¯†åˆ«æˆ–æœ‰è®¾ç½®äº†InputFilterçš„æƒ…å†µæ‰ä¼šå‡ºç°ï¼Œæœ€æ–°è°·æ­Œä»£ç ä¸Šå‘ç°ä»£ç å˜åŒ–æ²¡æœ‰æ³¨å†Œç›‘å¬ï¼Œæ•…è¯¥é—®é¢˜åœ¨æ–°ç‰ˆæœ¬ä¸Šä¸ä¼šå­˜åœ¨</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;é—®é¢˜æè¿°&lt;/strong&gt;&lt;br&gt;æ•°æ®æµé‡ä½¿ç”¨è¿‡ç¨‹ä¸­åˆ‡æ¢åˆ°wifiè¿æ¥ï¼Œç³»ç»Ÿå…¨å±€ä¼šå¡ä¸€ä¸‹&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;åˆæ­¥åˆ†æ&lt;/strong&gt;&lt;br&gt;æŠ“å–systraceæ—¶æ‰‹æŒ‡åœ¨æ¡Œé¢ä¸åœçš„æ»‘åŠ¨ï¼Œå¯ä»¥çœ‹åˆ°å¾ˆæ˜ç¡®çš„ä¸€æ®µæ²¡æœ‰å¸§ï¼Œä½†æ˜¯è¿™ä¸ªæ—¶é—´æ®µæ‰‹æŒ‡ä¸€ç›´åœ¨æ»‘åŠ¨&lt;b
      
    
    </summary>
    
      <category term="Android" scheme="http://lihaizhou.top/categories/Android/"/>
    
      <category term="æ€§èƒ½" scheme="http://lihaizhou.top/categories/Android/%E6%80%A7%E8%83%BD/"/>
    
    
  </entry>
  
  <entry>
    <title>è°æ‹–æ…¢äº†åˆ—è¡¨çš„æ»‘åŠ¨é€Ÿåº¦</title>
    <link href="http://lihaizhou.top/2020/03/04/%E8%B0%81%E6%8B%96%E6%85%A2%E4%BA%86%E5%88%97%E8%A1%A8%E7%9A%84%E6%BB%91%E5%8A%A8%E9%80%9F%E5%BA%A6/"/>
    <id>http://lihaizhou.top/2020/03/04/è°æ‹–æ…¢äº†åˆ—è¡¨çš„æ»‘åŠ¨é€Ÿåº¦/</id>
    <published>2020-03-04T13:59:04.000Z</published>
    <updated>2020-06-21T08:25:47.920Z</updated>
    
    <content type="html"><![CDATA[<p><strong>é—®é¢˜æè¿°</strong><br>åœ¨å¼€æœºå‘å¯¼ç•Œé¢æ»‘åŠ¨wifiåˆ—è¡¨ç•Œé¢æ—¶æ¯”è¾ƒå¡é¡¿ï¼Œæ¦‚ç‡ä¸ºå¿…ç°</p><p>æŠ“ä¸€ä»½systraceï¼Œçº¢è‰²å¸§æœ‰å¤šå¤„ï¼Œæ€»ä½“ä¸Šçœ‹æœ‰ä¸å°‘å¤„å‘ç”Ÿæ‰å¸§<br><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/wifi%E5%88%97%E8%A1%A8%E5%8D%A1%E9%A1%BF1.jpg" alt=""></p><p>æŒ‘å…¶ä¸­ä¸€å¤„çº¢è‰²å¸§æ”¾å¤§çœ‹ä¸‹<br><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/wifi%E5%88%97%E8%A1%A8%E5%8D%A1%E9%A1%BF2.png" alt=""><br>è€—æ—¶ä¸­çš„measureæ˜¯å¤§å¤´ï¼Œå…¶ä¸­ä¸€æ¬¡measureæœ‰æ•°åæ¬¡obtainviewï¼Œå¯¹æ¯”å…¶ä»–ç»¿è‰²æ­£å¸¸å¸§ï¼Œå‘ç°æ­£å¸¸çš„æ—¶å€™æ²¡æœ‰measureçš„è¿‡ç¨‹<br>æ”¾å¤§ä¸€æ¬¡obtainviewçš„è¿‡ç¨‹ï¼Œåšçš„å…¶å®æ˜¯inflateä¸€é¡¹itemçš„è¿‡ç¨‹ï¼Œçº¢åœˆå¤„å¯¹åº”äº†wifiä¸€ä¸ªitemçš„å¸ƒå±€<br><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/wifi%E5%88%97%E8%A1%A8%E5%8D%A1%E9%A1%BF3.png" alt=""><br>æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒViewRootImplçš„performTraversalsæ–¹æ³•ä¼šç»è¿‡measureã€layoutå’Œdrawä¸‰ä¸ªæµç¨‹æ‰èƒ½å°†ä¸€å¸§Viewéœ€è¦æ˜¾ç¤ºçš„å†…å®¹ç»˜åˆ¶åˆ°å±å¹•ä¸Š</p><ul><li>performMeasure: ä»æ ¹èŠ‚ç‚¹å‘ä¸‹éå†Viewæ ‘ï¼Œå®Œæˆæ‰€æœ‰ViewGroupå’ŒViewçš„æµ‹é‡å·¥ä½œï¼Œè®¡ç®—å‡ºæ‰€æœ‰ViewGroupå’ŒViewæ˜¾ç¤ºå‡ºæ¥éœ€è¦çš„é«˜åº¦å’Œå®½åº¦</li><li>performLayout()ï¼šä»æ ¹èŠ‚ç‚¹å‘ä¸‹éå†Viewæ ‘ï¼Œå®Œæˆæ‰€æœ‰ViewGroupå’ŒViewçš„å¸ƒå±€è®¡ç®—å·¥ä½œï¼Œæ ¹æ®æµ‹é‡å‡ºæ¥çš„å®½é«˜åŠè‡ªèº«å±æ€§ï¼Œè®¡ç®—å‡ºæ‰€æœ‰ViewGroupå’ŒViewæ˜¾ç¤ºåœ¨å±å¹•ä¸Šçš„åŒºåŸŸï¼›</li><li>performDraw()ï¼šä»æ ¹èŠ‚ç‚¹å‘ä¸‹éå†Viewæ ‘ï¼Œå®Œæˆæ‰€æœ‰ViewGroupå’ŒViewçš„ç»˜åˆ¶å·¥ä½œï¼Œæ ¹æ®å¸ƒå±€è¿‡ç¨‹è®¡ç®—å‡ºçš„æ˜¾ç¤ºåŒºåŸŸï¼Œå°†æ‰€æœ‰Viewçš„å½“å‰éœ€æ˜¾ç¤ºçš„å†…å®¹ç”»åˆ°å±å¹•ä¸Š</li></ul><p>å¯¹åº”åˆ°æˆ‘ä»¬è¿™ä¸ªé—®é¢˜ï¼Œæ­¤æ—¶å¤§æ¦‚å¿ƒé‡Œæœ‰æ•°äº†ï¼Œä¸€å¸§çš„è€—æ—¶å¹¶ä¸æ˜¯è®¡ç®—æ˜¾ç¤ºåœ¨å“ªä¸ªåŒºåŸŸä»¥åŠæœ¬èº«çš„å†…å®¹ç»˜åˆ¶è€—æ—¶ï¼Œè€Œæ˜¯è®¡ç®—éœ€è¦æ˜¾ç¤ºçš„é«˜åº¦æˆ–å®½åº¦è€—æ—¶ï¼Œæ³¨æ„è¿™é‡Œæ˜¯è®¡ç®—è¿™ä¸ªåˆ—è¡¨çš„é«˜åº¦æˆ–å®½åº¦è€—æ—¶äº†ï¼Œå› ä¸ºæ¯æ¬¡measureéƒ½å¯¹åº”äº†æ•°åæ¬¡çš„åŠ è½½itemçš„è¿‡ç¨‹ï¼Œå¾ˆæ˜¾ç„¶éœ€è¦ä¾æ®itemçš„é«˜åº¦æˆ–å®½åº¦æ¥æœ€ç»ˆç¡®å®šåˆ—è¡¨çš„é«˜åº¦æˆ–å®½åº¦</p><p>æ•…çœŸç›¸åªæœ‰ä¸€ä¸ªï¼Œå°±æ˜¯åˆ—è¡¨å¾ˆå¯èƒ½ä½¿ç”¨äº†è‡ªé€‚åº”çš„é«˜åº¦æˆ–å®½åº¦</p><p>çœ‹ä¸‹ä»£ç <br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;LinearLayout</span><br><span class="line">     android:id=<span class="string">"@+id/provision_lyt_content"</span></span><br><span class="line">     android:layout_width=<span class="string">"match_parent"</span></span><br><span class="line">     android:layout_height=<span class="string">"0dip"</span></span><br><span class="line">     android:layout_weight=<span class="string">"1"</span></span><br><span class="line">     android:layout_marginTop=<span class="string">"@dimen/provision_content_top_padding"</span></span><br><span class="line">     android:paddingStart=<span class="string">"@dimen/provision_list_left_padding"</span></span><br><span class="line">     android:paddingEnd=<span class="string">"@dimen/provision_list_right_padding"</span></span><br><span class="line">     android:orientation=<span class="string">"vertical"</span>&gt;</span><br><span class="line">     &lt;ListView</span><br><span class="line">         android:id=<span class="string">"@android:id/list"</span></span><br><span class="line">         android:layout_width=<span class="string">"match_parent"</span></span><br><span class="line">         android:layout_height=<span class="string">"wrap_content"</span> /&gt;</span><br><span class="line"> &lt;/LinearLayout&gt;</span><br></pre></td></tr></table></figure></p><p> æœä¸å…¶ç„¶ï¼Œè¿™é‡Œè®¾ç½®äº†è‡ªé€‚åº”çš„é«˜åº¦ï¼Œä¿®æ”¹ä¸ºmatch_parentåå†æ¬¡æµ‹è¯•å‘ç°å¡é¡¿æ¶ˆå¤±<br>æŠ“å–æ”¹åçš„systrace<br><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/wifi%E5%88%97%E8%A1%A8%E5%8D%A1%E9%A1%BF4.png" alt=""></p><p>åŸºæœ¬ä¸Šæ²¡æœ‰äº†çº¢è‰²å¸§ï¼Œæ¯ä¸€å¸§çš„ç»˜åˆ¶ä¸å†æœ‰measureçš„è¿‡ç¨‹<br>å…¶å®è¿™ä¸ªé—®é¢˜ä¸æŠ“systraceï¼Œçœ‹traceviewåŒæ ·èƒ½å¤Ÿå®šä½ï¼Œåªæ˜¯æ²¡æœ‰systraceç›´è§‚</p><p>åˆ°è¿™é‡Œï¼Œè¿˜æœ‰ä¸€ä¸ªç–‘é—®ï¼Œå½“viewè®¾ç½®äº†è‡ªé€‚åº”é«˜åº¦åï¼Œå®ƒçš„é«˜åº¦ç”±å…¶å­viewçš„é«˜åº¦å†³å®šï¼Œæ•…éœ€è¦è®¡ç®—å®ƒçš„æ‰€æœ‰å­viewé«˜åº¦åæ‰èƒ½ç¡®å®šè‡ªèº«çš„æ˜¾ç¤ºé«˜åº¦<br>è¿™ä¸€ç‚¹å®¹æ˜“ç†è§£ï¼Œä½†æ˜¯å…·ä½“åˆ°onMeasureçš„ä»£ç é‡Œæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/view/ViewRootImpl.java</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performMeasure</span><span class="params">(<span class="keyword">int</span> childWidthMeasureSpec, <span class="keyword">int</span> childHeightMeasureSpec)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mView == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">     <span class="comment">//è¿™é‡Œå¯¹åº”äº†systraceä¸­measure tag</span></span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"measure"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mView.measure(childWidthMeasureSpec, childHeightMeasureSpec);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_VIEW);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><p>å…¶ä¸­çš„mView.measure(childWidthMeasureSpec, childHeightMeasureSpec);é€šè¿‡å‚æ•°å¯ä»¥çœ‹åˆ°ï¼Œviewçš„æ˜¾ç¤ºå®½é«˜ç”¨åˆ°äº†å…¶å­viewçš„å®½é«˜ä½œä¸ºçº¦æŸæ¡ä»¶<br>listviewå¿…å®šä¼šé‡å†™onMeasureï¼Œç›´æ¥è·Ÿåˆ°å…¶æºç ä¸­<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">frameworks/base/core/java/android/widget/ListView.java</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Sets up mListPadding</span></span><br><span class="line">        <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> widthMode = MeasureSpec.getMode(widthMeasureSpec);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> heightMode = MeasureSpec.getMode(heightMeasureSpec);</span><br><span class="line">        <span class="keyword">int</span> widthSize = MeasureSpec.getSize(widthMeasureSpec);</span><br><span class="line">        <span class="keyword">int</span> heightSize = MeasureSpec.getSize(heightMeasureSpec);</span><br><span class="line">          <span class="comment">//....</span></span><br><span class="line">          </span><br><span class="line">          <span class="keyword">if</span> (heightMode == MeasureSpec.AT_MOST) &#123;</span><br><span class="line">              <span class="comment">// <span class="doctag">TODO:</span> after first layout we should maybe start at the first visible position, not 0</span></span><br><span class="line">              heightSize = measureHeightOfChildren(widthMeasureSpec, <span class="number">0</span>, NO_POSITION, heightSize, -<span class="number">1</span>);</span><br><span class="line">          &#125;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">         &#125;</span><br></pre></td></tr></table></figure></p><p>æˆ‘ä»¬éƒ½çŸ¥é“wrap_contentå¯¹åº”çš„modeä¸º<code>MeasureSpec.AT_MOST</code>,è¿™æ—¶å€™è°ƒç”¨åˆ°measureHeightOfChildrenå¼€å§‹è®¡ç®—å…¶å­viewçš„å®½é«˜</p><p>è¿™é‡Œçœ‹æ³¨é‡Šæè¿°ï¼Œå¦‚æœæŒ‡å®šäº†é«˜åº¦ï¼Œåˆ™measureä¼šåœæ­¢<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Measures the height of the given range of children (inclusive) and</span></span><br><span class="line"><span class="comment">     * returns the height with this ListView's padding and divider heights</span></span><br><span class="line"><span class="comment">     * included. If maxHeight is provided, the measuring will stop when the</span></span><br><span class="line"><span class="comment">     * current height reaches maxHeight.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> widthMeasureSpec The width measure spec to be given to a child's</span></span><br><span class="line"><span class="comment">     *            &#123;<span class="doctag">@link</span> View#measure(int, int)&#125;.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> startPosition The position of the first child to be shown.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> endPosition The (inclusive) position of the last child to be</span></span><br><span class="line"><span class="comment">     *            shown. Specify &#123;<span class="doctag">@link</span> #NO_POSITION&#125; if the last child should be</span></span><br><span class="line"><span class="comment">     *            the last available child from the adapter.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> maxHeight The maximum height that will be returned (if all the</span></span><br><span class="line"><span class="comment">     *            children don't fit in this value, this value will be</span></span><br><span class="line"><span class="comment">     *            returned).</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> disallowPartialChildPosition In general, whether the returned</span></span><br><span class="line"><span class="comment">     *            height should only contain entire children. This is more</span></span><br><span class="line"><span class="comment">     *            powerful--it is the first inclusive position at which partial</span></span><br><span class="line"><span class="comment">     *            children will not be allowed. Example: it looks nice to have</span></span><br><span class="line"><span class="comment">     *            at least 3 completely visible children, and in portrait this</span></span><br><span class="line"><span class="comment">     *            will most likely fit; but in landscape there could be times</span></span><br><span class="line"><span class="comment">     *            when even 2 children can not be completely shown, so a value</span></span><br><span class="line"><span class="comment">     *            of 2 (remember, inclusive) would be good (assuming</span></span><br><span class="line"><span class="comment">     *            startPosition is 0).</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> The height of this ListView with the given children.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@UnsupportedAppUsage</span>(maxTargetSdk = Build.VERSION_CODES.P, trackingBug = <span class="number">115609023</span>)</span><br><span class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">measureHeightOfChildren</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> startPosition, <span class="keyword">int</span> endPosition,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> maxHeight, <span class="keyword">int</span> disallowPartialChildPosition)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ListAdapter adapter = mAdapter;</span><br><span class="line">        <span class="keyword">if</span> (adapter == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> mListPadding.top + mListPadding.bottom;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Include the padding of the list</span></span><br><span class="line">        <span class="keyword">int</span> returnedHeight = mListPadding.top + mListPadding.bottom;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> dividerHeight = mDividerHeight;</span><br><span class="line">        <span class="comment">// The previous height value that was less than maxHeight and contained</span></span><br><span class="line">        <span class="comment">// no partial children</span></span><br><span class="line">        <span class="keyword">int</span> prevHeightWithoutPartialChild = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> i;</span><br><span class="line">        View child;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// mItemCount - 1 since endPosition parameter is inclusive</span></span><br><span class="line">        endPosition = (endPosition == NO_POSITION) ? adapter.getCount() - <span class="number">1</span> : endPosition;</span><br><span class="line">        <span class="keyword">final</span> AbsListView.RecycleBin recycleBin = mRecycler;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> recyle = recycleOnMeasure();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span>[] isScrap = mIsScrap;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = startPosition; i &lt;= endPosition; ++i) &#123;</span><br><span class="line">            child = obtainView(i, isScrap);</span><br><span class="line"></span><br><span class="line">            measureScrapChild(child, i, widthMeasureSpec, maxHeight);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// Count the divider for all but one child</span></span><br><span class="line">                returnedHeight += dividerHeight;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Recycle the view before we possibly return from the method</span></span><br><span class="line">            <span class="keyword">if</span> (recyle &amp;&amp; recycleBin.shouldRecycleViewType(</span><br><span class="line">                    ((LayoutParams) child.getLayoutParams()).viewType)) &#123;</span><br><span class="line">                recycleBin.addScrapView(child, -<span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            returnedHeight += child.getMeasuredHeight();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (returnedHeight &gt;= maxHeight) &#123;</span><br><span class="line">                <span class="comment">// We went over, figure out which height to return.  If returnedHeight &gt; maxHeight,</span></span><br><span class="line">                <span class="comment">// then the i'th position did not fit completely.</span></span><br><span class="line">                <span class="keyword">return</span> (disallowPartialChildPosition &gt;= <span class="number">0</span>) <span class="comment">// Disallowing is enabled (&gt; -1)</span></span><br><span class="line">                            &amp;&amp; (i &gt; disallowPartialChildPosition) <span class="comment">// We've past the min pos</span></span><br><span class="line">                            &amp;&amp; (prevHeightWithoutPartialChild &gt; <span class="number">0</span>) <span class="comment">// We have a prev height</span></span><br><span class="line">                            &amp;&amp; (returnedHeight != maxHeight) <span class="comment">// i'th child did not fit completely</span></span><br><span class="line">                        ? prevHeightWithoutPartialChild</span><br><span class="line">                        : maxHeight;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((disallowPartialChildPosition &gt;= <span class="number">0</span>) &amp;&amp; (i &gt;= disallowPartialChildPosition)) &#123;</span><br><span class="line">                prevHeightWithoutPartialChild = returnedHeight;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// At this point, we went through the range of children, and they each</span></span><br><span class="line">        <span class="comment">// completely fit, so return the returnedHeight</span></span><br><span class="line">        <span class="keyword">return</span> returnedHeight;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><p>è¿™é‡Œæœ€å…³é”®çš„ä»£ç : <code>child = obtainView(i, isScrap);</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Gets a view and have it show the data associated with the specified</span></span><br><span class="line"><span class="comment">    * position. This is called when we have already discovered that the view</span></span><br><span class="line"><span class="comment">    * is not available for reuse in the recycle bin. The only choices left are</span></span><br><span class="line"><span class="comment">    * converting an old view or making a new one.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> position the position to display</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> outMetadata an array of at least 1 boolean where the first entry</span></span><br><span class="line"><span class="comment">    *                    will be set &#123;<span class="doctag">@code</span> true&#125; if the view is currently</span></span><br><span class="line"><span class="comment">    *                    attached to the window, &#123;<span class="doctag">@code</span> false&#125; otherwise (e.g.</span></span><br><span class="line"><span class="comment">    *                    newly-inflated or remained scrap for multiple layout</span></span><br><span class="line"><span class="comment">    *                    passes)</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> A view displaying the data associated with the specified position</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function">View <span class="title">obtainView</span><span class="params">(<span class="keyword">int</span> position, <span class="keyword">boolean</span>[] outMetadata)</span> </span>&#123;</span><br><span class="line">       Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"obtainView"</span>);</span><br><span class="line">       <span class="comment">//...</span></span><br><span class="line">       <span class="comment">//obtainViewæ–¹æ³•é‡Œé¢æ ¸å¿ƒçš„ä»£ç å…¶å®å°±ä¸¤è¡Œï¼Œé¦–å…ˆä»å¤ç”¨ç¼“å­˜ä¸­å–å‡ºä¸€ä¸ªå¯ä»¥å¤ç”¨çš„Viewï¼Œç„¶åä½œä¸ºå‚ä¼ å…¥getViewä¸­ï¼Œ</span></span><br><span class="line"><span class="comment">//ä¹Ÿå°±æ˜¯convertViewã€‚è¿™é‡Œä¼šèµ°åˆ°obtainviewï¼Œå­Viewå®ä¾‹éƒ½æ˜¯ç”±obtainViewæ–¹æ³•è¿”å›çš„ï¼Œç„¶åå†è°ƒç”¨å…·ä½“measureScrapChild</span></span><br><span class="line"><span class="comment">//æ¥å…·ä½“æµ‹é‡å­Viewçš„é«˜åº¦.</span></span><br><span class="line">        <span class="comment">//æ­£å¸¸æƒ…å†µä¸‹è¿™é‡Œforå¾ªç¯çš„æ¬¡æ•°å°±ç­‰äºæ‰€æœ‰å­é¡¹çš„ä¸ªæ•°ï¼Œä¸è¿‡ç‰¹æ®Šçš„æ˜¯å·²æµ‹é‡çš„å­Viewé«˜åº¦ä¹‹å’Œå¤§äºmaxHeight</span></span><br><span class="line"> <span class="comment">//å°±ç›´æ¥returnå‡ºå¾ªç¯äº†ã€‚è¿™ç§åšæ³•å…¶å®å¾ˆå¥½ç†è§£ï¼ŒListViewèƒ½æ˜¾ç¤ºçš„æœ€å¤§é«˜åº¦å°±æ˜¯å±å¹•çš„é«˜åº¦ï¼Œå¦‚æœæœ‰1000ä¸ªå­é¡¹</span></span><br><span class="line"> <span class="comment">//å‰é¢10é¡¹å·²ç»å æ»¡äº†ä¸€å±å¹•äº†ï¼Œé‚£åé¢çš„990é¡¹å°±æ²¡å¿…è¦ç»§ç»­æµ‹é‡é«˜åº¦äº†ï¼Œè¿™æ ·å¯ä»¥å¤§å¤§æé«˜æ€§èƒ½</span></span><br><span class="line">      <span class="keyword">final</span> View scrapView = mRecycler.getScrapView(position);</span><br><span class="line">       <span class="keyword">final</span> View child = mAdapter.getView(position, scrapView, <span class="keyword">this</span>);</span><br><span class="line">       <span class="keyword">if</span> (scrapView != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">if</span> (child != scrapView) &#123;</span><br><span class="line">               <span class="comment">// Failed to re-bind the data, return scrap to the heap.</span></span><br><span class="line">               mRecycler.addScrapView(scrapView, position);</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child.isTemporarilyDetached()) &#123;</span><br><span class="line">               outMetadata[<span class="number">0</span>] = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">               <span class="comment">// Finish the temporary detach started in addScrapView().</span></span><br><span class="line">               child.dispatchFinishTemporaryDetach();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//....</span></span><br><span class="line">       setItemViewLayoutParams(child, position);</span><br><span class="line">       Trace.traceEnd(Trace.TRACE_TAG_VIEW);</span><br><span class="line">       <span class="keyword">return</span> child;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>å‡ºç°é—®é¢˜æ—¶æ­£æ˜¯è§¦å‘äº†onMeasureï¼Œå¯¼è‡´éå†å¯è§èŒƒå›´å†…çš„æ•°åä¸ªwifi itemå¹¶è®¡ç®—ä»–ä»¬çš„é«˜åº¦</p><hr><p><strong>ä¸€ç‚¹å°ç»“</strong></p><p>ä¸€ä¸ªViewæœ€ç»ˆæ˜¾ç¤ºåˆ°å±å¹•ä¸Šä¸€å…±åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼šMeasureã€Layoutã€Drawï¼Œè€Œä½¿ç”¨ä¸å½“ä¼šé€ æˆå…¶é‡å¤è°ƒç”¨ï¼Œå°¤å…¶æ˜¯Measureè¿‡ç¨‹æœ€ä¸ºæ•æ„Ÿã€‚<br>å› ä¸ºå½“æ ¹å¸ƒå±€åšmeasureçš„æ—¶å€™ï¼Œéœ€è¦é€çº§measureå­Viewå’Œå­å¸ƒå±€ï¼Œå½“æ‰€æœ‰å­Viewæˆ–å­å¸ƒå±€measureå®Œæˆçš„æ—¶å€™æ‰èƒ½æœ€ç»ˆç¡®å®šæ ¹éƒ¨å±€çš„å¤§å°ï¼Œ<br>æ‰€ä»¥å­å¸ƒå±€çš„measureè°ƒç”¨æ—¶æœºæ˜¯ç”±çˆ¶å¸ƒå±€æ¥å†³å®šçš„ã€‚è€ŒåƒListViewè¿™ç§åœ¨å…¶onMeasureä¸­ç›´æ¥è°ƒç”¨getViewçš„æƒ…å†µï¼Œ<br>å¦‚æœonMeasureè¢«è°ƒç”¨æ¬¡æ•°è¿‡å¤šï¼Œå°†ä¸¥é‡å½±å“æ€§èƒ½ã€‚</p><p>è¿™é‡Œçš„listviewè¿˜å¥½å¤–è¾¹æ²¡æœ‰è£¹ç€RelativeLayoutï¼Œä¸ç„¶ä¼šå¯¼è‡´å­Viewçš„onMeasureé‡å¤è°ƒç”¨ï¼Œå¡é¡¿ä¹Ÿä¼šæ›´åŠ æ˜æ˜¾ï¼Œå‡è®¾RelativeLayoutåµŒå¥—å±‚æ•°ä¸ºnï¼Œå­Viewçš„onMeasureæ¬¡æ•°ä¸º2^ï¼ˆn+1ï¼‰</p><p>ä½¿ç”¨ListViewçš„æ—¶å€™æ³¨æ„å°½é‡ä½¿ç”¨layout_height=â€match_parentâ€ï¼Œå¦‚æœæ— æ³•é¿å…ï¼Œå¤–è¾¹ä¹Ÿä¸èƒ½è£¹ç€RelativeLayout</p><p>æ€»è€Œè¨€ä¹‹: å†™ä»£ç ä¸‰æ€è€Œåè¡Œï¼Œè°¨æ…å†è°¨æ…</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;é—®é¢˜æè¿°&lt;/strong&gt;&lt;br&gt;åœ¨å¼€æœºå‘å¯¼ç•Œé¢æ»‘åŠ¨wifiåˆ—è¡¨ç•Œé¢æ—¶æ¯”è¾ƒå¡é¡¿ï¼Œæ¦‚ç‡ä¸ºå¿…ç°&lt;/p&gt;
&lt;p&gt;æŠ“ä¸€ä»½systraceï¼Œçº¢è‰²å¸§æœ‰å¤šå¤„ï¼Œæ€»ä½“ä¸Šçœ‹æœ‰ä¸å°‘å¤„å‘ç”Ÿæ‰å¸§&lt;br&gt;&lt;img src=&quot;https://raw.githubusercontent.c
      
    
    </summary>
    
      <category term="Android" scheme="http://lihaizhou.top/categories/Android/"/>
    
      <category term="æ€§èƒ½" scheme="http://lihaizhou.top/categories/Android/%E6%80%A7%E8%83%BD/"/>
    
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•å¿«é€Ÿå®šä½kernelé”™è¯¯</title>
    <link href="http://lihaizhou.top/2019/12/26/%E5%A6%82%E4%BD%95%E5%BF%AB%E9%80%9F%E5%AE%9A%E4%BD%8Dkernel%E9%94%99%E8%AF%AF/"/>
    <id>http://lihaizhou.top/2019/12/26/å¦‚ä½•å¿«é€Ÿå®šä½kernelé”™è¯¯/</id>
    <published>2019-12-26T12:08:49.000Z</published>
    <updated>2019-12-28T06:57:16.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ¯”å¦‚åœ¨å®šä½systraceå¡é¡¿é—®é¢˜æ—¶ï¼Œæœ€åè·Ÿåˆ°kernelä¸­<br><img src="https://github.com/hellolihaizhou/saveImg/blob/master/950ffc39-d5dc-47d7-a57b-3e774cae457d.png?raw=true" alt="systraceå¡é¡¿"></p><p>å¯ä»¥çœ‹åˆ°é˜»å¡åœ¨<br>{kernel callsite when blocked:: â€œteei_forward_call+0xac/0xfcâ€}</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mi@mi-OptiPlex<span class="number">-7060</span>:~<span class="regexp">/Code_mi/</span>F7_code/prebuilts/gdb/linux-x86/bin$ ./gdb</span><br><span class="line">GNU gdb (GDB) <span class="number">7.11</span></span><br><span class="line">Copyright (C) <span class="number">2016</span> Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version <span class="number">3</span> or later &lt;http:<span class="comment">//gnu.org/licenses/gpl.html&gt;</span></span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type <span class="string">"show copying"</span></span><br><span class="line">and <span class="string">"show warranty"</span> <span class="keyword">for</span> details.</span><br><span class="line">This GDB was configured <span class="keyword">as</span> <span class="string">"x86_64-linux-gnu"</span>.</span><br><span class="line">Type <span class="string">"show configuration"</span> <span class="keyword">for</span> configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http:<span class="comment">//www.gnu.org/software/gdb/bugs/&gt;.</span></span><br><span class="line">Find the GDB manual and other documentation resources online at:</span><br><span class="line">&lt;http:<span class="comment">//www.gnu.org/software/gdb/documentation/&gt;.</span></span><br><span class="line">For help, type <span class="string">"help"</span>.</span><br><span class="line">Type <span class="string">"apropos word"</span> to search <span class="keyword">for</span> commands related to <span class="string">"word"</span>.</span><br><span class="line">(gdb) file <span class="string">'/home/mi/æ—¥å¿—/vmliux/out/target/product/merlin/obj/KERNEL_OBJ/vmlinux'</span> </span><br><span class="line"><span class="comment">//æ­¤æ—¶è¾“å…¥fileåé¢è·Ÿvmlinuxæ–‡ä»¶ï¼Œvmlinuxåœ¨symbolsä¸­ï¼Œå…·ä½“è·¯å¾„åœ¨out/target/product/libra/obj/KERNEL_OBJ/ä¸‹</span></span><br><span class="line">Reading symbols <span class="keyword">from</span> /home/mi/æ—¥å¿—/vmliux/out/target/product/merlin/obj/KERNEL_OBJ/vmlinux...done.</span><br><span class="line"></span><br><span class="line">(gdb) list*teei_forward_call+<span class="number">0xac</span>  <span class="comment">//list*åé¢è·Ÿä¸Šåç§»ä½</span></span><br><span class="line"><span class="number">0xffffff80087fe9d8</span> is <span class="keyword">in</span> teei_forward_call (<span class="regexp">/home/</span>work/merlin-q-dev-build/kernel<span class="number">-4.14</span>/drivers/misc/mediatek/teei/<span class="number">300</span>/tz_driver/teei_smc_call.c:<span class="number">128</span>).</span><br></pre></td></tr></table></figure><p>è¿™ç§æƒ…å†µé€‚ç”¨äºåƒNEé—®é¢˜æˆ–è€…ä¸€äº›watchdogé—®é¢˜ç­‰</p><p>è¿˜æœ‰ä¸€ç§æƒ…å†µæ˜¯åƒå¦‚ä¸‹å›¾ä¸­</p><p><img src="https://github.com/hellolihaizhou/saveImg/blob/master/7d36fef5-b40b-439b-bd69-fd65e393e8be.png?raw=true" alt="systraceå¡é¡¿2"></p><p>è¿™ç§æƒ…å†µç¨å¾®æœ‰ç‚¹éº»çƒ¦<br>çŸ¥é“åœ°å€è¯¥å¦‚ä½•åå‘å®šä½å‡½æ•°åå’Œåç§»å‘¢, è¿™ä¸ªæ—¶å€™å°±éœ€è¦ç”¨åˆ°objdumpï¼Œ-dåé¢è·Ÿçš„æ˜¯vmlinuxçš„åœ°å€ï¼Œæœ€åä¼šå°†æ±‡ç¼–è¯­è¨€å¯¼å…¥åˆ°vmlinux.txtä¸­ï¼Œæ­¤æ—¶æœç´¢åäº”ä½å³ fb684</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aarch64-linux-android-objdump -d vmlinux &gt; vmlinux.txt</span><br></pre></td></tr></table></figure><p>æœç´¢åˆ°å¦‚ä¸‹ç»“æœ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ffffff80087fb674:    <span class="number">14000004</span>     b    ffffff80087fb684 &lt;teei_forward_call+<span class="number">0xac</span>&gt;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ—¶å€™åœ¨ç”¨gdbé…åˆvmlinuxå®šä½teei_forward_call+0xacå°±å¯ä»¥äº†</p><p>æ±‡æ€»ä¸‹<br>åˆ†æå·¥å…·</p><ul><li>addr2lineï¼šç”¨æ¥åˆ†æå•ä¸ªpcåœ°å€å¯¹åº”çš„æºç è¡Œæ•°ï¼Œæ¯”å¦‚ç¤ºä¾‹logä¸­çš„ç¬¬13è¡Œä¸­çš„#00 pc 0004097cï¼Œ0004097cå°±æ˜¯crashæ—¶pcè°ƒç”¨çš„å †æ ˆåœ°å€ï¼Œç”¨è¿™ä¸ªåœ°å€å°±å¯ä»¥åˆ†æå‡ºå¯¹åº”åœ¨æºç ä¸­çš„è¡Œæ•°ï¼›</li><li>objdumpï¼šç”¨æ¥æŠŠç›¸åº”çš„soå˜æˆæ±‡ç¼–è¯­è¨€çš„asmæ–‡ä»¶ï¼Œç„¶åæ ¹æ®åœ°å€ä¿¡æ¯ï¼ˆæ¯”å¦‚0004097cï¼‰å°±å¯ä»¥æ‰¾åˆ°æ›´åŠ è¯¦ç»†çš„ç›¸å…³å‡½æ•°ä¿¡æ¯ï¼›</li><li>ndk-stackï¼šç”¨æ¥æŠŠlogä¿¡æ¯å…¨éƒ¨ç¿»è¯‘æˆæ›´åŠ è¯¦ç»†çš„å¸¦æºç è¡Œæ•°ä¿¡æ¯çš„logï¼Œç›¸å½“äºæ˜¯åœ¨æ•´ä¸ªcrashå †æ ˆä¿¡æ¯éƒ½æ‰§è¡Œaddr2lineå‘½ä»¤ã€‚</li></ul><p>linuxè‡ªå¸¦addr2lineå‘½ä»¤ã€‚ä½¿ç”¨Windowsçš„ï¼Œåœ¨sdkä¸­å®‰è£…äº†NDKä¹‹åï¼Œåœ¨ndkä¸­å°±å¸¦æœ‰è¿™äº›å·¥å…·ã€‚<br>æ¯”å¦‚addr2lineå·¥å…·åœ¨ï¼šsdk\ndk-bundle\toolchains\arm-linux-androideabi-4.9\prebuilt\windows-x86_64\binä¸‹é¢ï¼ŒåŒæ—¶è¿™ä¸ªbinä¸‹é¢åŒ…å«å¾ˆå¤šå…¶ä»–å·¥å…·ï¼Œæ¯”å¦‚objdumpï¼Œreadelfç­‰ï¼›<br>ndk-stackå·¥å…·åˆ™åœ¨sdk\ndk-bundleä¸‹é¢ï¼›</p><h3 id="ä½¿ç”¨addr2lineæŸ¥æ‰¾ä»£ç ä½ç½®"><a href="#ä½¿ç”¨addr2lineæŸ¥æ‰¾ä»£ç ä½ç½®" class="headerlink" title="ä½¿ç”¨addr2lineæŸ¥æ‰¾ä»£ç ä½ç½®"></a>ä½¿ç”¨addr2lineæŸ¥æ‰¾ä»£ç ä½ç½®</h3><p>æ‰§è¡Œå¦‚ä¸‹çš„å‘½ä»¤ï¼Œå¤šä¸ªæŒ‡é’ˆåœ°å€å¯ä»¥åœ¨<br><img src="https://github.com/hellolihaizhou/saveImg/blob/master/16111918_pm7h.jpg?raw=true" alt=""></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arm-linux-androideabi-addr2line â€“e obj/local/armeabi/libhello-jni.so <span class="number">00004</span>de8 <span class="number">000056</span>c8 <span class="number">00004</span>fb4 <span class="number">00004</span>f58</span><br></pre></td></tr></table></figure><p>PSï¼š</p><ul><li>crash logä¸å¯¹åº”çš„soä¸€å®šè¦å¯¹åº”èµ·æ¥ã€‚å³é”™è¯¯çš„æƒ…å†µæ˜¯ï¼šä½ æ‹¿äº†ä¸€ä»½æ—§çš„logï¼Œç„¶åä½ ä¿®æ”¹äº†soç›¸å…³çš„æºç ï¼Œç„¶åç¼–è¯‘å‡ºæ¥äº†æ–°çš„soï¼Œä½ æ‹¿ç€è¿™ä¸ªæ–°çš„soä»¥åŠæ—§logä¸­çš„åœ°å€å»è®©addr2lineç­‰åˆ†æï¼Œé‚£è‚¯å®šæ˜¯å¾—ä¸åˆ°æ­£ç¡®çš„ç»“æœçš„</li><li>å¸¦symbolsçš„soæ–‡ä»¶<br>å¯¹äºæ¯”å¦‚æ‰‹æœºå…¬å¸çš„å¼€å‘äººå‘˜æ¥è¯´ï¼Œä¸€èˆ¬æ¥è¯´å‡ºé—®é¢˜çš„soå¯¹åº”çš„å¸¦symbolsçš„soéƒ½åœ¨out/target/product/&lt;model_name&gt;/symbols/system/lib/ä¸‹é¢ï¼Œè€Œå¯¹äºå¸¸è§çš„ä½¿ç”¨AndroidStudioå¼€å‘çš„å•ä¸ªåº”ç”¨æ¥è¯´ï¼Œå…¶å¯¹åº”çš„å¸¦symbolsçš„åœ¨&lt;PROJECT_ROOT&gt;\app\src\main\obj\local\<abi>\ä¸‹é¢çš„soï¼Œè€Œä¸èƒ½æ˜¯\app\src\main\libs\<abi>çš„ï¼Œè¿™é‡Œé¢çš„æ˜¯ä¸åŒ…å«symbolsä¿¡æ¯çš„ï¼Œæ‹¿è¿™ä¸ªå»åˆ†æï¼Œè¾“å‡ºçš„ç»“æœå°±æ˜¯â€œ??:?â€ã€‚å…¶å®è¿™ä¸¤ä¸ªsoçš„ä½“ç§¯å¯¹æ¯”ä¹Ÿæ˜¯å¾ˆæ˜æ˜¾çš„çš„ï¼Œåœ¨æˆ‘çš„åº”ç”¨ä¸­ï¼Œå‰ä¸€ä¸ªå¸¦symbolsçš„soçš„ä½“ç§¯ä¸º7Må¤šï¼Œè€Œåä¸€ä¸ªåªæœ‰2M</abi></abi></li></ul><h3 id="ä½¿ç”¨objdumpè·å–å‡½æ•°ä¿¡æ¯"><a href="#ä½¿ç”¨objdumpè·å–å‡½æ•°ä¿¡æ¯" class="headerlink" title="ä½¿ç”¨objdumpè·å–å‡½æ•°ä¿¡æ¯"></a>ä½¿ç”¨objdumpè·å–å‡½æ•°ä¿¡æ¯</h3><p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å¯¼å‡ºå‡½æ•°è¡¨</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arm-linux-androideabi-objdump â€“S obj/local/armeabi/libhello-jni.so &gt; hello.asm</span><br></pre></td></tr></table></figure><p>åœ¨ç”Ÿæˆçš„asmæ–‡ä»¶ä¸­æŸ¥æ‰¾åˆšåˆšæˆ‘ä»¬å®šä½çš„ä¸¤ä¸ªå…³é”®æŒ‡é’ˆ00004fb4å’Œ00004f58ï¼Œæœç´¢åå››ä½<br>å¯ä»¥æ˜¾ç¤ºå¯¹åº”çš„å‡½æ•°åï¼Œè¿™æ ·å†é…åˆaddresslineçš„ç»“æœå ªç§°å®Œç¾ï¼Œå¯ä»¥å¾—åˆ°å¯¹åº”æ–‡ä»¶çš„æŸä¸€è¡Œå¹¶ä¸”çŸ¥é“å¯¹åº”çš„å‡½æ•°å(å…¶å®addr2lineå°±å¤Ÿäº†)</p><p>å‚è€ƒæ–‡ç« :<br><a href="https://www.oschina.net/question/2241352_213433" target="_blank" rel="noopener">å¦‚ä½•å®šä½Android NDKå¼€å‘ä¸­é‡åˆ°çš„é”™è¯¯</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æ¯”å¦‚åœ¨å®šä½systraceå¡é¡¿é—®é¢˜æ—¶ï¼Œæœ€åè·Ÿåˆ°kernelä¸­&lt;br&gt;&lt;img src=&quot;https://github.com/hellolihaizhou/saveImg/blob/master/950ffc39-d5dc-47d7-a57b-3e774cae457d.pn
      
    
    </summary>
    
      <category term="æ€§èƒ½" scheme="http://lihaizhou.top/categories/%E6%80%A7%E8%83%BD/"/>
    
    
  </entry>
  
  <entry>
    <title>ä¸€ä¸ªè¿”å›å¡é¡¿2sé—®é¢˜çš„åˆ†æè§£å†³ä¹‹è·¯</title>
    <link href="http://lihaizhou.top/2019/12/21/%E4%B8%80%E4%B8%AA%E8%BF%94%E5%9B%9E%E5%8D%A1%E9%A1%BF2s%E9%97%AE%E9%A2%98%E7%9A%84%E5%88%86%E6%9E%90%E8%A7%A3%E5%86%B3%E4%B9%8B%E8%B7%AF/"/>
    <id>http://lihaizhou.top/2019/12/21/ä¸€ä¸ªè¿”å›å¡é¡¿2sé—®é¢˜çš„åˆ†æè§£å†³ä¹‹è·¯/</id>
    <published>2019-12-21T09:54:10.000Z</published>
    <updated>2019-12-26T12:10:08.000Z</updated>
    
    <summary type="html">
    
    </summary>
    
      <category term="æ€§èƒ½" scheme="http://lihaizhou.top/categories/%E6%80%A7%E8%83%BD/"/>
    
    
  </entry>
  
  <entry>
    <title>Android-Vsync</title>
    <link href="http://lihaizhou.top/2019/12/15/Android-Vsync/"/>
    <id>http://lihaizhou.top/2019/12/15/Android-Vsync/</id>
    <published>2019-12-15T12:42:18.000Z</published>
    <updated>2019-12-28T07:03:06.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡ç›®çš„åœ¨äºé€šè¿‡äº†è§£Vsyncå·¥ä½œåŸç†åŠ æ·±å¯¹systraceçš„ç†è§£</p><p>åœ¨ Systrace ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒAndroid ç³»ç»Ÿåœ¨ Vsync ä¿¡å·çš„æŒ‡å¼•ä¸‹ï¼Œæœ‰æ¡ä¸ç´Šåœ°è¿›è¡Œè€…æ¯ä¸€å¸§çš„æ¸²æŸ“ã€åˆæˆæ“ä½œï¼Œä½¿æˆ‘ä»¬å¯ä»¥äº«å—ç¨³å®šå¸§ç‡çš„ç”»é¢ã€‚</p><p>Vsyncä½œç”¨-Drawing without Sync<br>Step1. Displayæ˜¾ç¤ºç¬¬0å¸§æ•°æ®ï¼Œæ­¤æ—¶CPUå’ŒGPUæ¸²æŸ“ç¬¬1å¸§ç”»é¢ï¼Œè€Œä¸”èµ¶åœ¨Displayæ˜¾ç¤ºä¸‹ä¸€å¸§å‰å®Œæˆ<br>Step2. å› ä¸ºæ¸²æŸ“åŠæ—¶ï¼ŒDisplayåœ¨ç¬¬0å¸§æ˜¾ç¤ºå®Œæˆåï¼Œä¹Ÿå°±æ˜¯ç¬¬1ä¸ªVSyncåï¼Œæ­£å¸¸æ˜¾ç¤ºç¬¬1å¸§<br>Step3. ç”±äºæŸäº›åŸå› ï¼Œæ¯”å¦‚CPUèµ„æºè¢«å ç”¨ï¼Œç³»ç»Ÿæ²¡æœ‰åŠæ—¶åœ°å¼€å§‹å¤„ç†ç¬¬2å¸§ï¼Œç›´åˆ°ç¬¬2ä¸ªVSyncå¿«æ¥å‰æ‰å¼€å§‹å¤„ç†<br>Step4. ç¬¬2ä¸ªVSyncæ¥æ—¶ï¼Œç”±äºç¬¬2å¸§æ•°æ®è¿˜æ²¡æœ‰å‡†å¤‡å°±ç»ªï¼Œæ˜¾ç¤ºçš„è¿˜æ˜¯ç¬¬1å¸§ã€‚è¿™ç§æƒ…å†µè¢«Androidå¼€å‘ç»„å‘½åä¸ºâ€œJankâ€ã€‚<br>Step5. å½“ç¬¬2å¸§æ•°æ®å‡†å¤‡å®Œæˆåï¼Œå®ƒå¹¶ä¸ä¼šé©¬ä¸Šè¢«æ˜¾ç¤ºï¼Œè€Œæ˜¯è¦ç­‰å¾…ä¸‹ä¸€ä¸ªVSyncã€‚</p><p><img src="https://github.com/hellolihaizhou/saveImg/blob/master/vsync-1.png?raw=true" alt=""></p><p>è¿™ä¸ªå›¾ä¸­è¿˜æœ‰ä¸ªå€¼å¾—æ³¨æ„çš„åœ°æ–¹å°±æ˜¯FramebufferSurface,è¿™ä¸ªä»£è¡¨æœ€ç»ˆåˆæˆçš„æ•°æ®<br>å¯ä»¥çœ‹åˆ°sfåˆæˆåè¿™ä¸ªæ•°å€¼å˜ä¸ºäº†1ï¼Œdisplayæ˜¾ç¤ºåè¿™ä¸ªæ•°å€¼åˆå˜ä¸ºäº†0</p><p>è®©CPU GPUæ¸²æŸ“å·¥ä½œéƒ½åœ¨ä¸€ä¸ªVsyncå‘¨æœŸå·¥ä½œï¼Œä¿è¯ç»˜åˆ¶çš„æ­¥è°ƒå’Œå±å¹•åˆ·æ–°çš„æ­¥è°ƒä¸€è‡´ï¼Œä¸ºæ­¤Androidå¼•å…¥å¦å¤–ä¸¤ä¸ªè½¯ä»¶VSyncä¿¡å·ï¼ŒVSYNC-sfå’ŒVSYNC-appï¼ŒVSYNC-sfç”¨äºè§¦å‘SurfaceFlingeråˆæˆVSYNC-appç”¨äºè§¦å‘app ç»˜åˆ¶è¿™å‡ ä¸ªä¿¡å·å¯é€šè¿‡systraceè§‚å¯Ÿåˆ°<br><img src="https://github.com/hellolihaizhou/saveImg/blob/master/vsync-9.png?raw=true" alt=""></p><p><img src="https://github.com/hellolihaizhou/saveImg/blob/master/vsync-10.png?raw=true" alt=""></p><p><img src="https://github.com/hellolihaizhou/saveImg/blob/master/vsync-11.png?raw=true" alt=""></p><p><img src="https://github.com/hellolihaizhou/saveImg/blob/master/vsync-12.png?raw=true" alt=""></p><p>å› ä¸º VSYNC æ˜¯ç”±ç¡¬ä»¶äº§ç”Ÿçš„ï¼Œä¸€æ—¦äº§ç”Ÿäº†å°±å¿…é¡»å¼€å§‹å¹²æ´»ï¼Œä¸çµæ´»ã€‚å‡è®¾æœ‰è¿™ä¹ˆä¸€ç§éœ€æ±‚ï¼Œæˆ‘å¸Œæœ›åœ¨ VSYNC åç§»ä¸€æ®µæ—¶é—´ä»¥åå†å¹²æ´»ï¼Œé‚£ä¹ˆè¿™ä¸ªæ˜¯ç¡¬ä»¶ VSYNC æä¾›ä¸äº†ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™å°±å¿…é¡»å¼•å…¥è½¯ä»¶æ¨¡å‹ã€‚è€Œ DispSync å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªéœ€æ±‚å¼•å…¥çš„è½¯ä»¶æ¨¡å‹ã€‚<br>DispSync ç±»ä¼¼äºä¸€ä¸ª PLLï¼ˆphase lock loopï¼Œé”ç›¸å›è·¯ï¼‰ï¼Œå®ƒé€šè¿‡æ¥æ”¶ç¡¬ä»¶ VSYNCï¼Œç„¶åç»™å…¶ä»–å…³å¿ƒç¡¬ä»¶ VSYNC çš„ç»„ä»¶ï¼ˆSurfaceFlinger å’Œéœ€è¦æ¸²æŸ“çš„ appï¼‰åœ¨æŒ‡å®šçš„åç§»ä»¥åå‘é€è½¯ä»¶ VSYNCï¼Œå¹¶ä¸”å½“è¯¯å·®åœ¨å¯æ¥å—çš„èŒƒå›´å†…ï¼Œå°†ä¼šå…³é—­ç¡¬ä»¶ VSYNC<br><img src="https://github.com/hellolihaizhou/saveImg/blob/master/vsync-2-dispsync.png?raw=true" alt="dispsync"><br>SurfaceFlingerå°†HWComposeræ”¶åˆ°æ–°çš„Vsync-timestampäº¤ç»™DispSync::addResyncSampleæ¥å†³å®šæ˜¯å¦è¿˜éœ€è¦ç»§ç»­è¾“å…¥HW_VSYNC_0</p><p>ä¸æ­¤åŒæ—¶,DispSyncä¼šæ ¹æ®HWComposerä¼ è¿‡æ¥çš„retire-fence-timestampsæ¥æ£€æŸ¥SW_VSYNC</p><p>Vsyncè™šæ‹ŸåŒ–ï¼ˆVsync App + Vsync SurfaceFlingerï¼‰ï¼š<br>è™½ç„¶vsyncä½¿å¾—CPU/GPU/DisplayåŒæ­¥äº†ï¼Œä½†App UIå’ŒSurfaceFlingerçš„å·¥ä½œæ˜¾ç„¶æ˜¯ä¸€ä¸ªæµæ°´çº¿çš„æ¨¡å‹ã€‚å³å¯¹äºä¸€å¸§å†…å®¹ï¼Œå…ˆç­‰App UIç”»å®Œäº†ï¼ŒSurfaceFlingerå†å‡ºåœºå¯¹å…¶è¿›è¡Œåˆå¹¶æ¸²æŸ“åæ”¾å…¥framebufferï¼Œæœ€åæ•´åˆ°å±å¹•ä¸Šã€‚<br>è€Œç°æœ‰çš„VSyncæ¨¡å‹æ˜¯è®©å¤§å®¶ä¸€èµ·å¼€å§‹å¹²æ´»ï¼Œè¿™æ ·å¯¹äºåŒä¸€å¸§å†…å®¹ï¼Œç¬¬ä¸€ä¸ªVSyncä¿¡å·æ—¶App UIçš„æ•°æ®å¼€å§‹å‡†å¤‡ï¼Œç¬¬äºŒä¸ªVSyncä¿¡å·SurfaceFlingerå·¥ä½œï¼Œç¬¬ä¸‰ä¸ªVSyncä¿¡å·æ—¶ç”¨æˆ·çœ‹åˆ°Displayå†…å®¹ï¼Œè¿™æ ·å°±ä¸¤ä¸ªVSync period(æ¯ä¸ª16ms)è¿‡å»äº†ï¼Œå½±å“ç”¨æˆ·ä½“éªŒã€‚<br>è§£å†³æ€è·¯ï¼šSurfaceFlingeråœ¨App UIå‡†å¤‡å¥½æ•°æ®ååŠæ—¶å¼€å·¥åšåˆæˆã€‚</p><p>Android 4.4(KitKat)å¼•å…¥äº†VSyncçš„è™šæ‹ŸåŒ–ï¼Œå³æŠŠç¡¬ä»¶çš„VSyncä¿¡å·å…ˆåŒæ­¥åˆ°ä¸€ä¸ªæœ¬åœ°VSyncæ¨¡å‹ä¸­ï¼Œå†ä»ä¸­ä¸€åˆ†ä¸ºäºŒï¼Œå¼•å‡ºä¸¤æ¡VSyncæ—¶é—´ä¸ä¹‹æœ‰å›ºå®šåç§»çš„çº¿ç¨‹ã€‚ç¤ºæ„å›¾å¦‚ä¸‹ï¼š<br>  <img src="https://github.com/hellolihaizhou/saveImg/blob/master/vsync-3.png?raw=true" alt=""></p><p>ç¬¬ä¸€é˜¶æ®µï¼š<br>App åœ¨æ”¶åˆ° Vsync-App çš„æ—¶å€™ï¼Œåœ¨ä¸»çº¿ç¨‹è¿›è¡Œ measureã€layoutã€draw(æ„å»º DisplayList , é‡Œé¢åŒ…å« OpenGL æ¸²æŸ“éœ€è¦çš„å‘½ä»¤åŠæ•°æ®) ã€‚è¿™é‡Œå¯¹åº”çš„ Systrace ä¸­çš„ä¸»çº¿ç¨‹ doFrame æ“ä½œ<br>ç¬¬äºŒé˜¶æ®µï¼š<br>CPU å°†æ•°æ®ä¸Šä¼ ï¼ˆå…±äº«æˆ–è€…æ‹·è´ï¼‰ç»™ GPU,ã€€è¿™é‡Œ ARM è®¾å¤‡ å†…å­˜ä¸€èˆ¬æ˜¯ GPU å’Œ CPU å…±äº«å†…å­˜ã€‚è¿™é‡Œå¯¹åº”çš„ Systrace ä¸­çš„æ¸²æŸ“çº¿ç¨‹çš„ flush drawing commands æ“ä½œ<br>ç¬¬ä¸‰é˜¶æ®µï¼š<br>é€šçŸ¥ GPU æ¸²æŸ“ï¼ŒçœŸæœºä¸€èˆ¬ä¸ä¼šé˜»å¡ç­‰å¾… GPU æ¸²æŸ“ç»“æŸï¼ŒCPU é€šçŸ¥ç»“æŸåå°±è¿”å›ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œä½¿ç”¨ Fence æœºåˆ¶è¾…åŠ© GPU CPU è¿›è¡ŒåŒæ­¥æ“ä½œ<br>ç¬¬å›› é˜¶æ®µï¼š<br>swapBuffersï¼Œå¹¶é€šçŸ¥ SurfaceFlinger å›¾å±‚åˆæˆã€‚è¿™é‡Œå¯¹åº”çš„ Systrace ä¸­çš„æ¸²æŸ“çº¿ç¨‹çš„ eglSwapBuffersWithDamageKHR æ“ä½œ<br>ç¬¬äº”é˜¶æ®µï¼š<br>SurfaceFlingerå¼€å§‹åˆæˆå›¾å±‚ï¼Œå¦‚æœä¹‹å‰æäº¤çš„GPUæ¸²æŸ“ä»»åŠ¡æ²¡ç»“æŸï¼Œåˆ™ç­‰å¾…GPUæ¸²æŸ“å®Œæˆï¼Œå†åˆæˆï¼ˆFenceæœºåˆ¶ï¼‰ï¼Œåˆæˆä¾ç„¶æ˜¯ä¾èµ–GPUï¼Œä¸è¿‡è¿™å°±æ˜¯ä¸‹ä¸€ä¸ªä»»åŠ¡äº†.è¿™é‡Œå¯¹åº”çš„Systraceä¸­çš„SurfaceFlingerä¸»çº¿ç¨‹çš„ onMessageReceivedæ“ä½œï¼ˆåŒ…æ‹¬ handleTransactionã€handleMessageInvalidateã€handleMessageRefreshï¼‰SurfaceFlinger åœ¨åˆæˆçš„æ—¶å€™ï¼Œä¼šå°†ä¸€äº›åˆæˆå·¥ä½œå§”æ‰˜ç»™Hardware Composer,ä»è€Œé™ä½æ¥è‡ª OpenGLå’ŒGPUçš„è´Ÿè½½ï¼Œåªæœ‰Hardware Composer æ— æ³•å¤„ç†çš„å›¾å±‚ï¼Œæˆ–è€…æŒ‡å®šç”¨OpenGLå¤„ç†çš„å›¾å±‚ï¼Œå…¶ä»–çš„ å›¾å±‚å¶ä¼šä½¿ç”¨Hardware Composerè¿›è¡Œåˆæˆ<br>ç¬¬å…­é˜¶æ®µ ï¼šæœ€ç»ˆåˆæˆå¥½çš„æ•°æ®æ”¾åˆ°å±å¹•å¯¹åº”çš„Frame Bufferä¸­ï¼Œå›ºå®šåˆ·æ–°çš„æ—¶å€™å°±å¯ä»¥çœ‹åˆ°äº†</p><p>é€šè¿‡systraceçœ‹æ•°æ®æµå‘<br><img src="https://github.com/hellolihaizhou/saveImg/blob/master/vsync-5.jpg?raw=true" alt=""></p><p>ä¸Šå›¾ä¸­ä¸»è¦åŒ…å« SurfaceFlingerã€App å’Œ hwc ä¸‰ä¸ªè¿›ç¨‹ï¼Œä¸‹é¢å°±æ¥ç»“åˆå›¾ä¸­çš„æ ‡å·ï¼Œæ¥è¿›ä¸€æ­¥è¯´æ˜æ•°æ®çš„æµå‘</p><ul><li>ç¬¬ä¸€ä¸ªVsyncä¿¡å·åˆ°æ¥, SurfaceFlingerå’ŒAppåŒæ—¶æ”¶åˆ°Vsyncä¿¡å·</li><li>SurfaceFlingeræ”¶åˆ°Vsync-sfä¿¡å·ï¼Œå¼€å§‹è¿›è¡ŒAppä¸Šä¸€å¸§çš„Bufferçš„åˆæˆ</li><li>Appæ”¶åˆ°Vsyc-appä¿¡å·ï¼Œå¼€å§‹è¿›è¡Œè¿™ä¸€å¸§çš„Bufferçš„æ¸²æŸ“(å¯¹åº”ä¸Šé¢çš„ç¬¬ä¸€ã€äºŒã€ä¸‰ã€å››é˜¶æ®µ)</li><li>ç¬¬äºŒä¸ªVsyncä¿¡å·åˆ°æ¥ ,SurfaceFlingerå’ŒAppåŒæ—¶æ”¶åˆ°Vsyncä¿¡å·ï¼ŒSurfaceFlingerè·å–Appåœ¨ç¬¬äºŒæ­¥é‡Œé¢æ¸²æŸ“çš„Buffer,å¼€å§‹åˆæˆ(å¯¹åº”ä¸Šé¢çš„ç¬¬äº”é˜¶æ®µ),Appæ”¶åˆ°Vsycn-app ä¿¡å·ï¼Œå¼€å§‹æ–°ä¸€å¸§çš„Bufferçš„æ¸²æŸ“(å¯¹åº”ä¸Šé¢çš„ç¬¬ä¸€ã€äºŒã€ä¸‰ã€å››é˜¶æ®µ)</li></ul><h3 id="Vsync-offset"><a href="#Vsync-offset" class="headerlink" title="Vsync offset"></a>Vsync offset</h3><p>æ–‡ç« æœ€å¼€å§‹æœ‰æåˆ°ï¼ŒVsyncä¿¡å·å¯ä»¥ç”±ç¡¬ä»¶äº§ç”Ÿï¼Œä¹Ÿå¯ä»¥ç”¨è½¯ä»¶æ¨¡æ‹Ÿï¼Œä¸è¿‡ç°åœ¨åŸºæœ¬ä¸Šéƒ½æ˜¯ç¡¬ä»¶äº§ç”Ÿï¼Œè´Ÿè´£äº§ç”Ÿç¡¬ä»¶Vsyncçš„æ˜¯HWC,HWC å¯ç”Ÿæˆ VSYNCäº‹ä»¶å¹¶é€šè¿‡å›è°ƒå°†äº‹ä»¶å‘é€åˆ° SurfaceFlinge , DispSyncå°†Vsync ç”Ÿæˆç”±Choreographerå’ŒSurfaceFlingerä½¿ç”¨çš„VSYNC_APP å’Œ VSYNC_SF ä¿¡å·.</p><p><img src="https://github.com/hellolihaizhou/saveImg/blob/master/vsync_6_disp_sync_arch.png?raw=true" alt=""></p><p>æœ‰ä¸€ä¸ªç–‘é—®<br>å› æ­¤å¯ä»¥çœ‹å‡ºSW vsync/App vsync å¹¶ä¸æ˜¯ç›´æ¥ç”±HW vsyncäº§ç”Ÿçš„ï¼Œè€Œæ˜¯ç”±SW vsyncäº§ç”Ÿçš„ï¼ŒHW vsyncä½œä¸ºSW vsyncçš„å‚è€ƒï¼ŒåŠ¨æ€çš„æ›´æ–°SW vsyncé‡Œçš„æ¨¡å‹å‚æ•°ï¼Œè¿™æ ·è®©SW vsyncèƒ½ä¸HW vsyncæ›´åŠ çš„ç²¾ç¡®å§ã€‚</p><p>é‚£ä¹ˆä¸ºä»€ä¹ˆSurfaceFlingerè¦ç”¨SW vsyncè€Œä¸æ˜¯ç›´æ¥ç”¨HW vsyncå‘¢ï¼Ÿ<br>çŒœæƒ³å¯èƒ½æ˜¯å› ä¸ºHW vsyncæ¯éš”å›ºå®šæ—¶é—´ç”±æ˜¾ç¤ºå±äº§ç”Ÿä¸­æ–­ï¼Œç„¶åä¼ ç»™driver, driverå†å›è°ƒç»™SurfaceFlinger, è¿™æ ·ç»è¿‡å±‚å±‚å›è°ƒï¼Œä¼šå¯¹performanceæœ‰å½±å“å§ã€‚è€ŒSW vsyncç›´æ¥ç”±SurfaceFlingeräº§ç”Ÿï¼Œçœç•¥äº†å¾ˆå¤šæ­¥éª¤</p><p>è¿™ä¸ªæ–‡ç«  <a href="https://www.jianshu.com/p/d3e4b1805c92" target="_blank" rel="noopener">https://www.jianshu.com/p/d3e4b1805c92</a> å¾ˆæ£’</p><p>å…¶ä¸­ app å’Œ sf ç›¸å¯¹ hw_vsync_0 éƒ½æœ‰ä¸€ä¸ªåç§»,å³ phase-app å’Œ phase-sfï¼Œå¦‚ä¸‹å›¾<br><img src="https://github.com/hellolihaizhou/saveImg/blob/master/vsync-7.jpg?raw=true" alt=""></p><p>Vsync Offsetæˆ‘ä»¬æŒ‡çš„æ˜¯VSYNC_APPå’ŒVSYNC_SFä¹‹é—´æœ‰ä¸€ä¸ªOffsetï¼Œå³ä¸Šå›¾ä¸­phase-sf - phase-appçš„å€¼ï¼Œè¿™ä¸ªOffsetæ˜¯å‚å•†å¯ä»¥é…ç½®çš„ã€‚å¦‚æœ Offset ä¸ä¸º 0ï¼Œé‚£ä¹ˆæ„å‘³ç€Appå’ŒSurfaceFlingerä¸»è¿›ç¨‹ä¸æ˜¯åŒæ—¶æ”¶åˆ°Vsyncä¿¡å·ï¼Œè€Œæ˜¯é—´éš”Offset(é€šå¸¸åœ¨0 - 16.6msä¹‹é—´)</p><p>ç›®å‰å¤§éƒ¨åˆ†å‚å•†éƒ½æ²¡æœ‰é…ç½®è¿™ä¸ªOffsetï¼Œæ‰€ä»¥Appå’ŒSurfaceFlingeræ˜¯åŒæ—¶æ”¶åˆ°Vsyncä¿¡å·çš„.</p><p>å¯ä»¥é€šè¿‡Dumpsys SurfaceFlingeræ¥æŸ¥çœ‹å¯¹åº”çš„å€¼</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\MI</span><br><span class="line">Î» adb shell dumpsys SurfaceFlinger|grep <span class="string">"app phase"</span></span><br><span class="line">   app phase:   <span class="number">8300000</span> ns      SF phase:   <span class="number">8300000</span> ns</span><br></pre></td></tr></table></figure><p>Offset ä¸º 0<br>é¦–å…ˆè¯´ Offset ä¸º 0 çš„æƒ…å†µï¼Œ æ­¤æ—¶ App å’Œ SurfaceFlinger æ˜¯åŒæ—¶æ”¶åˆ° Vsync ä¿¡å· ï¼Œ å…¶å¯¹åº”çš„ Systrace å›¾å¦‚ä¸‹</p><p><img src="https://github.com/hellolihaizhou/saveImg/blob/master/vsync-8.jpg?raw=true" alt=""><br>è¿™ä¸ªå›¾ä¸Šé¢ä¹Ÿæœ‰è®²è§£ï¼Œè¿™é‡Œå°±ä¸å†è¯¦ç»†è¯´æ˜ï¼Œå¤§å®¶åªéœ€è¦çœ‹åˆ°ï¼ŒApp æ¸²æŸ“å¥½çš„ Bufferï¼Œè¦ç­‰åˆ°ä¸‹ä¸€ä¸ª Vsync-SF æ¥çš„æ—¶å€™æ‰ä¼šè¢« SurfaceFlinger æ‹¿å»åšåˆæˆï¼Œè¿™ä¸ªæ—¶é—´å¤§æ¦‚åœ¨ 16.6 msã€‚è¿™æ—¶å€™å¤§å®¶å¯èƒ½ä¼šæƒ³ï¼Œå¦‚æœ App çš„ Buffer æ¸²æŸ“ç»“æŸï¼ŒSwap åˆ° BufferQueue ä¸­ ï¼Œå°±è§¦å‘ SurfaceFlinger å»åšåˆæˆï¼Œé‚£å²‚ä¸æ˜¯çœäº†ä¸€äº›æ—¶é—´(0-16.6ms )?</p><p>ç­”æ¡ˆæ˜¯å¯è¡Œçš„ï¼Œè¿™ä¹Ÿå°±å¼•å…¥äº† Offset æœºåˆ¶ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒApp å…ˆæ”¶åˆ° Vsync ä¿¡å·ï¼Œè¿›è¡Œä¸€å¸§çš„æ¸²æŸ“å·¥ä½œï¼Œç„¶åè¿‡äº† Offset æ—¶é—´åï¼ŒSurfaceFlinger æ‰æ”¶åˆ° Vsync ä¿¡å·å¼€å§‹åˆæˆï¼Œè¿™æ—¶å€™å¦‚æœ App çš„ Buffer å·²ç» Ready äº†ï¼Œé‚£ä¹ˆ SurfaceFlinger è¿™ä¸€æ¬¡åˆæˆå°±å¯ä»¥åŒ…å« App è¿™ä¸€å¸§ï¼Œç”¨æˆ·ä¹Ÿä¼šæ—©ä¸€ç‚¹çœ‹åˆ°ã€‚</p><p>Offset çš„ä¼˜ç¼ºç‚¹</p><ul><li><p>Offset çš„ä¸€ä¸ªæ¯”è¾ƒéš¾ä»¥ç¡®å®šçš„ç‚¹å°±åœ¨ä¸ Offset çš„æ—¶é—´è¯¥å¦‚ä½•è®¾ç½®ï¼Œè¿™ä¹Ÿæ˜¯ä¼—å¤šå‚å•†é»˜è®¤éƒ½ä¸è¿›è¡Œé…ç½® Offset çš„ä¸€ä¸ªåŸå› ï¼Œå…¶ä¼˜ç¼ºç‚¹æ˜¯åŠ¨æ€çš„ï¼Œä¸æœºå‹çš„æ€§èƒ½å’Œä½¿ç”¨åœºæ™¯æœ‰å¾ˆå¤§çš„å…³ç³»</p></li><li><p>å¦‚æœ Offset é…ç½®è¿‡çŸ­ï¼Œé‚£ä¹ˆå¯èƒ½ App æ”¶åˆ° Vsync-App åè¿˜æ²¡æœ‰æ¸²æŸ“å®Œæˆï¼ŒSurfaceFlinger å°±æ”¶åˆ° Vsync-SF å¼€å§‹åˆæˆï¼Œé‚£ä¹ˆæ­¤æ—¶å¦‚æœ App çš„ BufferQueue ä¸­æ²¡æœ‰ä¹‹å‰ç´¯ç§¯çš„ Bufferï¼Œé‚£ä¹ˆ SurfaceFlinger è¿™æ¬¡åˆæˆå°±ä¸ä¼šæœ‰ App çš„ä¸œè¥¿åœ¨é‡Œé¢ï¼Œéœ€è¦ç­‰åˆ°ä¸‹ä¸€ä¸ª Vsync-SF æ‰èƒ½åˆæˆè¿™æ¬¡ App çš„å†…å®¹ï¼Œæ—¶é—´ç›¸å½“äºå˜æˆäº† Vsync å‘¨æœŸ+Offsetï¼Œè€Œä¸æ˜¯æˆ‘ä»¬æœŸå¾…çš„ Offset<br>å¦‚æœ Offset é…ç½®è¿‡é•¿ï¼Œå°±èµ·ä¸åˆ°ä½œç”¨äº†</p></li></ul><h3 id="HW-Vsync"><a href="#HW-Vsync" class="headerlink" title="HW_Vsync"></a>HW_Vsync</h3><p>è¿™é‡Œéœ€è¦è¯´æ˜çš„æ˜¯ï¼Œä¸æ˜¯æ¯æ¬¡ç”³è¯· Vsync éƒ½ä¼šç”±ç¡¬ä»¶äº§ç”Ÿ Vsyncï¼Œåªæœ‰æ­¤æ¬¡è¯·æ±‚ vsync çš„æ—¶é—´è·ç¦»ä¸Šæ¬¡åˆæˆæ—¶é—´å¤§äº 500msï¼Œæ‰ä¼šé€šçŸ¥ hwcï¼Œè¯·æ±‚ HW_VSYNC</p><p>ä»¥æ¡Œé¢æ»‘åŠ¨ä¸ºä¾‹ï¼Œçœ‹ SurfaceFlinger çš„è¿›ç¨‹ Trace å¯ä»¥çœ‹åˆ° HW_VSYNC çš„çŠ¶æ€</p><p>HW_VSYNC ä¸»è¦æ˜¯åˆ©ç”¨æœ€è¿‘çš„ç¡¬ä»¶ VSYNC æ¥åšé¢„æµ‹,æœ€å°‘è¦ 3 ä¸ª,æœ€å¤šæ˜¯ 32 ä¸ª,å®é™…ä¸Šè¦ç”¨å‡ ä¸ªåˆ™ä¸ä¸€å®š, DispSync æ‹¿åˆ° 6 ä¸ª VSYNC åå°±ä¼šè®¡ç®—å‡º SW_VSYNC,åªè¦æ”¶åˆ°çš„ Present Fence æ²¡æœ‰è¶…è¿‡è¯¯å·®,ç¡¬ä»¶ VSYNC å°±ä¼šå…³æ‰,ä¸ç„¶ä¼šç»§ç»­æ¥æ”¶ç¡¬ä»¶ VSYNC è®¡ç®— SW_VSYNC çš„å€¼,ç›´åˆ°è¯¯å·®å°äº threshold.</p><p>ä¸‹é¢ä»¥AndroidQä¸Šä»£ç ä¸ºä¾‹<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">frameworks/<span class="keyword">native</span>/services/surfaceflinger/SurfaceFlinger.cpp</span><br><span class="line"><span class="keyword">void</span> SurfaceFlinger::onVsyncReceived(int32_t sequenceId, hwc2_display_t hwcDisplayId,</span><br><span class="line">                                     int64_t timestamp) &#123;</span><br><span class="line">    ATRACE_NAME(<span class="string">"SF onVsync"</span>);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    bool periodFlushed = <span class="keyword">false</span>;</span><br><span class="line">    mScheduler-&gt;addResyncSample(timestamp, &amp;periodFlushed);</span><br><span class="line">    <span class="keyword">if</span> (periodFlushed) &#123;</span><br><span class="line">        mVsyncModulator.onRefreshRateChangeCompleted();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> Scheduler::addResyncSample(<span class="keyword">const</span> nsecs_t timestamp, bool* periodFlushed) &#123;</span><br><span class="line">    bool needsHwVsync = <span class="keyword">false</span>;</span><br><span class="line">    *periodFlushed = <span class="keyword">false</span>;</span><br><span class="line">    &#123; <span class="comment">// Scope for the lock</span></span><br><span class="line">        std::lock_guard&lt;std::mutex&gt; lock(mHWVsyncLock);</span><br><span class="line">        <span class="keyword">if</span> (mPrimaryHWVsyncEnabled) &#123;</span><br><span class="line"><span class="comment">//addResyncSampleä¼šæ ¹æ®ç°æœ‰çš„ç¡¬ä»¶Vsyncæ ·æœ¬è®¡ç®—SW Vsyncæ¨¡å‹ï¼Œå¦‚æœè¯¯å·®å·²ç»åœ¨å¯æ¥å—èŒƒå›´å†…</span></span><br><span class="line">   <span class="comment">// å³è®¤ä¸ºä¸å†éœ€è¦ç¡¬ä»¶Vsyncæ ·æœ¬äº†ï¼Œå°±å¾—å…³é—­ç¡¬ä»¶Vsync</span></span><br><span class="line">   <span class="comment">// åä¹‹ï¼Œå¦‚æœè¯¯å·®è¿˜æ¯”è¾ƒå¤§ï¼Œè¿™é‡Œè¿˜éœ€è¦ç»§ç»­åŠ å…¥ç¡¬ä»¶Vsyncæ ·æœ¬ç»§ç»­è®¡ç®—SW Vsyncæ¨¡å‹ </span></span><br><span class="line">            needsHwVsync = mPrimaryDispSync-&gt;addResyncSample(timestamp, periodFlushed);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// enableHardwareVsync/disableHardwareVsyncéƒ½æ˜¯é€šè¿‡EventControlThreadå»æ§åˆ¶ç¡¬ä»¶Vsyncå¼€å…³</span></span><br><span class="line">    <span class="keyword">if</span> (needsHwVsync) &#123;</span><br><span class="line">        enableHardwareVsync();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        disableHardwareVsync(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢é‡ç‚¹çœ‹ç¡¬ä»¶Vsyncæ ·æœ¬æ˜¯å¦‚ä½•è®¡ç®—SW Vsyncæ¨¡å‹ï¼Œè¿™ä¹Ÿæ˜¯æœ€æœ‰è¶£çš„åœ°æ–¹</p><h3 id="addResyncSample"><a href="#addResyncSample" class="headerlink" title="addResyncSample"></a>addResyncSample</h3><p>frameworks/native/services/surfaceflinger/Scheduler/DispSync.cpp<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">enum</span> &#123; MAX_RESYNC_SAMPLES = <span class="number">32</span> &#125;;</span><br><span class="line">    <span class="keyword">enum</span> &#123; MIN_RESYNC_SAMPLES_FOR_UPDATE = <span class="number">6</span> &#125;;</span><br><span class="line">    <span class="keyword">enum</span> &#123; NUM_PRESENT_SAMPLES = <span class="number">8</span> &#125;;</span><br><span class="line">    <span class="keyword">enum</span> &#123; MAX_RESYNC_SAMPLES_WITHOUT_PRESENT = <span class="number">4</span> &#125;;</span><br><span class="line">    <span class="keyword">enum</span> &#123; ACCEPTABLE_ZERO_ERR_SAMPLES_COUNT = <span class="number">64</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> DispSync::addResyncSample(<span class="keyword">nsecs_t</span> timestamp, <span class="keyword">bool</span>* periodFlushed) &#123;</span><br><span class="line">    Mutex::<span class="function">Autolock <span class="title">lock</span><span class="params">(mMutex)</span></span>;</span><br><span class="line"></span><br><span class="line">    ALOGV(<span class="string">"[%s] addResyncSample(%"</span> PRId64 <span class="string">")"</span>, mName, ns2us(timestamp));</span><br><span class="line"></span><br><span class="line">    *periodFlushed = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> idx = (mFirstResyncSample + mNumResyncSamples) % MAX_RESYNC_SAMPLES;</span><br><span class="line"><span class="comment">//// mResyncSamples è®°å½•æ¯ä¸ªç¡¬ä»¶vsyncæ ·æœ¬çš„æ—¶é—´æˆ³ï¼Œåœ¨è®¡ç®—sw vsyncçš„æ¨¡å‹æ—¶æœ‰ç”¨</span></span><br><span class="line">    mResyncSamples[idx] = timestamp;</span><br><span class="line">    <span class="keyword">if</span> (mNumResyncSamples == <span class="number">0</span>) &#123;</span><br><span class="line">        mPhase = <span class="number">0</span>;</span><br><span class="line">        ALOGV(<span class="string">"[%s] First resync sample: mPeriod = %"</span> PRId64 <span class="string">", mPhase = 0, "</span></span><br><span class="line">              <span class="string">"mReferenceTime = %"</span> PRId64,</span><br><span class="line">              mName, ns2us(mPeriod), ns2us(timestamp));</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mPendingPeriod &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// mNumResyncSamples &gt; 0, so priorIdx won't overflow</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">size_t</span> priorIdx = (mFirstResyncSample + mNumResyncSamples - <span class="number">1</span>) % MAX_RESYNC_SAMPLES;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">nsecs_t</span> lastTimestamp = mResyncSamples[priorIdx];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">nsecs_t</span> observedVsync = <span class="built_in">std</span>::<span class="built_in">abs</span>(timestamp - lastTimestamp);</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">std</span>::<span class="built_in">abs</span>(observedVsync - mPendingPeriod) &lt;= <span class="built_in">std</span>::<span class="built_in">abs</span>(observedVsync - mIntendedPeriod)) &#123;</span><br><span class="line">            <span class="comment">// Either the observed vsync is closer to the pending period, (and</span></span><br><span class="line">            <span class="comment">// thus we detected a period change), or the period change will</span></span><br><span class="line">            <span class="comment">// no-op. In either case, reset the model and flush the pending</span></span><br><span class="line">            <span class="comment">// period.</span></span><br><span class="line">            resetLocked();</span><br><span class="line">            mIntendedPeriod = mPendingPeriod;</span><br><span class="line">            mPeriod = mPendingPeriod;</span><br><span class="line">            mPendingPeriod = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (mTraceDetailedInfo) &#123;</span><br><span class="line">                ATRACE_INT(<span class="string">"DispSync:PendingPeriod"</span>, mPendingPeriod);</span><br><span class="line">                ATRACE_INT(<span class="string">"DispSync:IntendedPeriod"</span>, mIntendedPeriod);</span><br><span class="line">            &#125;</span><br><span class="line">            *periodFlushed = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å§‹ç»ˆç”¨æœ€æ–°çš„ç¡¬ä»¶æ—¶é—´æˆ³timestampæ¥æ›´æ–°mReferenceTime.</span></span><br><span class="line">    mReferenceTime = timestamp;</span><br><span class="line">    mThread-&gt;updateModel(mPeriod, mPhase, mReferenceTime);</span><br><span class="line"><span class="comment">//æ›´æ–° mNumResyncSamples æˆ– mFirstResyncSampleçš„å€¼</span></span><br><span class="line">    <span class="keyword">if</span> (mNumResyncSamples &lt; MAX_RESYNC_SAMPLES) &#123;</span><br><span class="line">        mNumResyncSamples++;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mFirstResyncSample = (mFirstResyncSample + <span class="number">1</span>) % MAX_RESYNC_SAMPLES;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¼€å§‹è®¡ç®—æ›´æ–°SW vsync æ¨¡å‹</span></span><br><span class="line">    updateModelLocked();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mNumResyncSamplesSincePresent++ &gt; MAX_RESYNC_SAMPLES_WITHOUT_PRESENT) &#123;</span><br><span class="line">        resetErrorLocked();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mIgnorePresentFences) &#123;</span><br><span class="line">        <span class="comment">// If we're ignoring the present fences we have no way to know whether</span></span><br><span class="line">        <span class="comment">// or not we're synchronized with the HW vsyncs, so we just request</span></span><br><span class="line">        <span class="comment">// that the HW vsync events be turned on.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check against kErrorThreshold / 2 to add some hysteresis before having to</span></span><br><span class="line">    <span class="comment">// resync again</span></span><br><span class="line"><span class="comment">// å¦‚æœæ¨¡å‹æ›´æ–°äº†ï¼Œå¹¶ä¸”äº§ç”Ÿçš„é”™è¯¯å°äº kErrorThreshold/2 è¿™ä¸ªå€¼ (è¿™ä¸ªå€¼æ˜¯é”™è¯¯å®¹å¿åº¦)ï¼Œé‚£ä¹ˆ   modelLockedå°±è¢«ç½®ä¸ºtrue, å³æ¨¡å‹è¢«é”å®šï¼Œæ¨¡å‹è¢«é”å®šçš„å«ä¹‰æ˜¯</span></span><br><span class="line">    <span class="comment">// ç°åœ¨SW vsyncå·¥ä½œçš„å¾ˆå¥½ï¼Œæš‚æ—¶ä¸éœ€è¦ç¡¬ä»¶Vsyncæ¥è¿›è¡Œæ ¡æ­£äº†ï¼Œæœ€åä¼šå°†ç¡¬ä»¶Vsyncç»™disableæ‰</span></span><br><span class="line">    <span class="keyword">bool</span> modelLocked = mModelUpdated &amp;&amp; mError &lt; (kErrorThreshold / <span class="number">2</span>) &amp;&amp; mPendingPeriod == <span class="number">0</span>;</span><br><span class="line">    ALOGV(<span class="string">"[%s] addResyncSample returning %s"</span>, mName, modelLocked ? <span class="string">"locked"</span> : <span class="string">"unlocked"</span>);</span><br><span class="line">    <span class="keyword">if</span> (modelLocked) &#123;</span><br><span class="line">        *periodFlushed = <span class="literal">true</span>;</span><br><span class="line">        mThread-&gt;lockModel();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> !modelLocked;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">å…³äºè¿™ä¸ªå€¼çœ‹ä¸‹å®šä¹‰çš„åœ°æ–¹æ³¨é‡Š</span><br><span class="line"><span class="comment">// This is the threshold used to determine when hardware vsync events are</span></span><br><span class="line"><span class="comment">// needed to re-synchronize the software vsync model with the hardware.  The</span></span><br><span class="line"><span class="comment">// error metric used is the mean of the squared difference between each</span></span><br><span class="line"><span class="comment">// present time and the nearest software-predicted vsync.</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">nsecs_t</span> kErrorThreshold = <span class="number">160000000000</span>; <span class="comment">// 400 usec squared</span></span><br></pre></td></tr></table></figure></p><p>è¿™é‡Œæ ¸å¿ƒæ˜¯updateModelLocked()å³å¦‚ä½•ä¾æ®ç¡¬ä»¶vsyncæ¥æ ¡å‡†çš„ï¼Œç›®å‰çœ‹çš„æœ‰ç‚¹äº‘é‡Œé›¾é‡Œ<br>æœ‰å¾…è¿›ä¸€æ­¥å˜æ¸…</p><h3 id="enableHardwareVsync"><a href="#enableHardwareVsync" class="headerlink" title="enableHardwareVsync"></a>enableHardwareVsync</h3><p>frameworks/native/services/surfaceflinger/Scheduler/Scheduler.cpp<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> Scheduler::enableHardwareVsync() &#123;</span><br><span class="line">    <span class="built_in">std</span>::lock_guard&lt;<span class="built_in">std</span>::mutex&gt; lock(mHWVsyncLock);</span><br><span class="line">    <span class="keyword">if</span> (!mPrimaryHWVsyncEnabled &amp;&amp; mHWVsyncAvailable) &#123;</span><br><span class="line">        mPrimaryDispSync-&gt;beginResync();</span><br><span class="line"><span class="comment">//è°ƒç”¨EventControlThreadå»å¼€å¯ç¡¬ä»¶vsync</span></span><br><span class="line">        mEventControlThread-&gt;setVsyncEnabled(<span class="literal">true</span>);</span><br><span class="line">        mPrimaryHWVsyncEnabled = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å‚è€ƒæ–‡ç« <br><a href="https://source.android.com/devices/graphics/implement-vsync" target="_blank" rel="noopener">è°·æ­ŒVSYNCä»‹ç»</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æœ¬æ–‡ç›®çš„åœ¨äºé€šè¿‡äº†è§£Vsyncå·¥ä½œåŸç†åŠ æ·±å¯¹systraceçš„ç†è§£&lt;/p&gt;
&lt;p&gt;åœ¨ Systrace ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒAndroid ç³»ç»Ÿåœ¨ Vsync ä¿¡å·çš„æŒ‡å¼•ä¸‹ï¼Œæœ‰æ¡ä¸ç´Šåœ°è¿›è¡Œè€…æ¯ä¸€å¸§çš„æ¸²æŸ“ã€åˆæˆæ“ä½œï¼Œä½¿æˆ‘ä»¬å¯ä»¥äº«å—ç¨³å®šå¸§ç‡çš„ç”»é¢ã€‚&lt;/p&gt;
&lt;p&gt;Vsyncä½œç”¨-D
      
    
    </summary>
    
      <category term="Android" scheme="http://lihaizhou.top/categories/Android/"/>
    
    
  </entry>
  
  <entry>
    <title>Android-ä¸¢å¸§åˆ†æ</title>
    <link href="http://lihaizhou.top/2019/12/15/Android-%E4%B8%A2%E5%B8%A7%E5%88%86%E6%9E%90/"/>
    <id>http://lihaizhou.top/2019/12/15/Android-ä¸¢å¸§åˆ†æ/</id>
    <published>2019-12-15T07:39:19.000Z</published>
    <updated>2019-12-28T07:02:52.000Z</updated>
    
    <content type="html"><![CDATA[<p>ç”¨æˆ·æ—¥å¸¸ä½¿ç”¨æ‰‹æœºè¿‡ç¨‹ä¸­æ…¢æˆ–è€…å¡é¡¿ç»Ÿä¸€å½’ç»“ä¸ºä¸¢å¸§é—®é¢˜ï¼Œç®€å•æ€»ç»“ä¸‹ï¼š</p><p>1 å†…å­˜ä¸è¶³<br>2 appä½¿ç”¨çš„ç»˜åˆ¶æ–¹å¼åŒºåˆ«<br>3 appä½¿ç”¨çš„ç¼–è¯‘æ–¹å¼åŒºåˆ«<br>4 appè‡ªèº«é—®é¢˜</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\MI</span><br><span class="line">Î» adb shell cat /proc/meminfo</span><br><span class="line">MemTotal:        <span class="number">5871128</span> kB</span><br><span class="line">MemFree:         <span class="number">1215492</span> kB</span><br><span class="line">MemAvailable:    <span class="number">3631296</span> kB</span><br><span class="line">Buffers:           <span class="number">91956</span> kB</span><br><span class="line">Cached:          <span class="number">2432140</span> kB</span><br></pre></td></tr></table></figure><p>æ¯”è¾ƒå¤šçš„Uninterruptible Sleepï¼Œblock åœ¨__lock_page_or_retry </p><p>å¦å¤–proc/meminfoä¸­ å¯ç”¨å†…å­˜éå¸¸å°‘ã€ä¸”swapç©ºé—´å‡ ä¹è€—å°½ ã€lmké¢‘ç¹æ‰“å°ç­‰ç­‰éƒ½èƒ½ä»ä¾§é¢åæ˜ å†…å­˜åä½</p><p>appä½¿ç”¨çš„ç»˜åˆ¶æ–¹å¼åŒºåˆ«<br>ç›¸åŒappçš„è½¯ä»¶ç»˜åˆ¶ä¸ç¡¬ä»¶ç»˜åˆ¶å¯¹æ¯”ï¼š</p><p>è½¯ä»¶ç»˜åˆ¶ï¼š</p><p>ç¡¬ä»¶åŠ é€Ÿ<br>Android3.0å¼€å§‹æ”¯æŒç¡¬ä»¶åŠ é€Ÿï¼ŒAndroid4.0 é»˜è®¤å¯ç”¨ç¡¬ä»¶åŠ é€Ÿã€‚ä½†æ˜¯appè¿˜æ˜¯èƒ½ä¸»åŠ¨è®¾ç½® hardwareAccelerated æ¥åˆ‡æ¢ä¸¤ç§æ¨¡å¼</p><p>ç¡¬ä»¶ç»˜åˆ¶å°±æ˜¯å°†CPUä¸æ“…é•¿çš„å›¾å½¢è®¡ç®—è½¬æ¢æˆGPUä¸“ç”¨æŒ‡ä»¤ï¼Œç”±GPUå®Œæˆã€‚</p><p>ä¼˜ç‚¹ï¼š</p><p>1ï¼‰æ˜¾è‘—æå‡UIç»˜é€Ÿåº¦</p><p>2ï¼‰ æ›´æ–°UIåªé‡ç»˜è„åŒºåŸŸï¼Œæå‡åˆ·æ–°é€Ÿåº¦</p><p>ç¼ºç‚¹ï¼š</p><p>å†…å­˜å’Œç”µé‡æ¶ˆè€—ä¼šæ¯”è½¯ä»¶ç»˜åˆ¶å¤§</p><p>3 appä½¿ç”¨çš„ç¼–è¯‘æ–¹å¼åŒºåˆ«<br>ç•™æ„æ˜¯å¦æœ‰ç¼–è¯‘æ–¹å¼çš„åŒºåˆ«ï¼š</p><p>è§£é‡Šæ¨¡å¼ç¼–è¯‘.dexæ–‡ä»¶è‚¯å®šæ¯”ç›´æ¥æ‰§è¡Œ.oatæ–‡ä»¶è¦æ¥çš„æ…¢</p><p>4 appè‡ªèº«é—®é¢˜<br>è§†å›¾å¤ªå¤æ‚å±‚çº§å¤ªæ·±ã€ä¸»çº¿ç¨‹æœ‰è€—æ—¶æ–¹æ³•</p><p>DrawFrameè¿‡ç¨‹å¾ˆé•¿ï¼Œä¸”åŸºæœ¬æ˜¯å‡ºäºrunningçŠ¶æ€æ—¶ï¼Œå¯èƒ½è§†å›¾è¿‡äºå¤æ‚</p><p>ä¸»çº¿ç¨‹æ–¹æ³•è€—æ—¶çš„è¯ï¼Œé‚£éœ€è¦é€šè¿‡åŠ trace Labelç¼©å°èŒƒå›´ï¼Œç„¶ååˆ©ç”¨traceViewå¯¹å…·ä½“æ–¹æ³•è¿›è¡Œè€—æ—¶åˆ†æ</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ç”¨æˆ·æ—¥å¸¸ä½¿ç”¨æ‰‹æœºè¿‡ç¨‹ä¸­æ…¢æˆ–è€…å¡é¡¿ç»Ÿä¸€å½’ç»“ä¸ºä¸¢å¸§é—®é¢˜ï¼Œç®€å•æ€»ç»“ä¸‹ï¼š&lt;/p&gt;
&lt;p&gt;1 å†…å­˜ä¸è¶³&lt;br&gt;2 appä½¿ç”¨çš„ç»˜åˆ¶æ–¹å¼åŒºåˆ«&lt;br&gt;3 appä½¿ç”¨çš„ç¼–è¯‘æ–¹å¼åŒºåˆ«&lt;br&gt;4 appè‡ªèº«é—®é¢˜&lt;/p&gt;
&lt;figure class=&quot;highlight javascript&quot;&gt;
      
    
    </summary>
    
      <category term="Android" scheme="http://lihaizhou.top/categories/Android/"/>
    
    
  </entry>
  
  <entry>
    <title>Android inputç³»ç»Ÿ</title>
    <link href="http://lihaizhou.top/2019/12/15/Android%20input%E7%B3%BB%E7%BB%9F/"/>
    <id>http://lihaizhou.top/2019/12/15/Android inputç³»ç»Ÿ/</id>
    <published>2019-12-15T05:31:51.000Z</published>
    <updated>2019-12-28T07:03:28.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸€æ¬¡inputçš„è€—æ—¶æ—¶é—´åˆ†å¸ƒ</p><ul><li>T1 è¡¨ç¤º ç¡¬ä»¶ä¸­æ–­çš„æ—¶é—´</li><li>T2 è¡¨ç¤º InputReader ä» /dev/input/xxx è¯»å‡ºäº‹ä»¶çš„æ—¶é—´</li><li>T3 è¡¨ç¤º InputDispatcher å‘ app è¿›ç¨‹å‘é€äº‹ä»¶çš„æ—¶é—´</li><li>T4 è¡¨ç¤º app ä¸»çº¿ç¨‹å¼€å§‹å¤„ç†è¾“å…¥äº‹ä»¶çš„æ—¶é—´</li><li>T5 è¡¨ç¤º app ä¸»çº¿ç¨‹å®Œæˆå¤„ç†è¾“å…¥äº‹ä»¶çš„æ—¶é—´<br>ä¸€æ¬¡ç”¨æˆ·è¾“å…¥äº‹ä»¶çš„ä¼ é€’è¿‡ç¨‹å¯ä»¥ç®€åŒ–ä¸º: ç¡¬ä»¶ -&gt; kernel -&gt; system_server -&gt; app</li></ul><p>system_server è€—æ—¶: T3 - T2<br>frameworks/native/libs/input/InputTransport.cpp<br>åº”ç”¨å¤„ç†è€—æ—¶: T5 - T4<br>frameworks/base / core/java/android/view/InputEventReceiver.java</p><h3 id="ä»£ç åˆ†å¸ƒ"><a href="#ä»£ç åˆ†å¸ƒ" class="headerlink" title="ä»£ç åˆ†å¸ƒ"></a>ä»£ç åˆ†å¸ƒ</h3><p>frameworks/native/services/inputflinger/</p><ul><li>InputDispatcher.cpp</li><li>InputReader.cpp</li><li>InputManager.cpp</li><li>EventHub.cpp</li><li>InputListener.cpp</li></ul><p>frameworks/native/libs/input/</p><ul><li>InputTransport.cpp</li><li>Input.cpp</li><li>InputDevice.cpp</li><li>Keyboard.cpp</li><li>KeyCharacterMap.cpp</li><li>IInputFlinger.cpp</li></ul><p>frameworks/base/services/core/</p><ul><li>java/com/android/server/input/InputManagerService.java</li><li>jni/com_android_server_input_InputManagerService.cpp</li></ul><p>Inputæ¨¡å—çš„ä¸»è¦ç»„æˆï¼š</p><ul><li>Nativeå±‚çš„InputReaderè´Ÿè´£ä»EventHubå–å‡ºäº‹ä»¶å¹¶å¤„ç†ï¼Œå†äº¤ç»™InputDispatcherï¼›</li><li>Nativeå±‚çš„InputDispatcheræ¥æ”¶æ¥è‡ªInputReaderçš„è¾“å…¥äº‹ä»¶ï¼Œå¹¶è®°å½•WMSçš„çª—å£ä¿¡æ¯ï¼Œç”¨äºæ´¾å‘äº‹ä»¶åˆ°åˆé€‚çš„çª—å£ï¼›</li><li>Javaå±‚çš„InputManagerServiceè·ŸWMSäº¤äº’ï¼ŒWMSè®°å½•æ‰€æœ‰çª—å£ä¿¡æ¯ï¼Œå¹¶åŒæ­¥æ›´æ–°åˆ°IMSï¼Œä¸ºInputDispatcheræ­£ç¡®æ´¾å‘äº‹ä»¶åˆ°ViewRootImplæä¾›ä¿éšœ</li></ul><p><img src="https://github.com/hellolihaizhou/saveImg/blob/master/input(1" alt="inputäº‹ä»¶æµè½¬è·¯çº¿">-Input%E4%BA%8B%E4%BB%B6%E7%AE%A1%E7%90%86.png?raw=true)</p><p>1ã€è¾“å…¥ç¡¬ä»¶<br>è¯´ç™½äº†å°±æ˜¯ä»»ä½•æ¥å—å¤–ç•Œåˆºæ¿€ï¼Œç„¶åå°†åˆºæ¿€è½¬æ¢ä¸ºç”µä¿¡å·ï¼ˆä¾‹å¦‚æœºæ¢°èƒ½ï¼Œä½¿å¾—ç”µè·¯å¯¼é€šåäº§ç”Ÿç”µä¿¡å·ï¼‰çš„è®¾å¤‡ï¼Œç„¶åå‘CPUå‘å‡ºç¡¬ä»¶ä¸­æ–­ï¼Œç„¶åCPUæŸ¥æ‰¾æ“ä½œç³»ç»Ÿçš„ä¸­æ–­å‘é‡è¡¨ä¸­ç›¸å¯¹åº”çš„ä¸­æ–­ç¼–å·ï¼Œè°ƒç”¨æ“ä½œç³»ç»Ÿçš„ç›¸åº”çš„ä»£ç æ®µï¼Œæ­¤å¤„å¦‚æœæœ‰å¯¹åº”çš„é©±åŠ¨ç¨‹åºçš„è¯ï¼Œæ“ä½œç³»ç»Ÿä¼šè°ƒç”¨é©±åŠ¨ç¨‹åºå¯¹è¾“å…¥è®¾å¤‡äº§ç”Ÿçš„ç”µä¿¡å·è¿›è¡Œè§£æå’Œè½¬æ¢æˆæ ‡å‡†çš„linuxå†…æ ¸è§„å®šçš„äº‹ä»¶ä¿¡æ¯ç»“æ„ã€‚</p><p>2ã€è¾“å…¥è®¾å¤‡é©±åŠ¨<br>åœ¨linuxå†…æ ¸å±‚ï¼Œå¤„ç†ç¡¬ä»¶ç”µä¿¡å·ï¼Œå¹¶è½¬æ¢æˆlinuxå†…æ ¸æ ‡å‡†äº‹ä»¶ä¿¡æ¯ç»“æ„ã€‚ç„¶ålinuxä¼šå°†è¿™äº›äº‹ä»¶ä¿¡æ¯å†™å…¥/dev/input/ä¸‹å¯¹åº”çš„è™šæ‹Ÿè®¾å¤‡ä¸­ã€‚</p><p>3ã€/dev/input<br>linuxå†™å…¥è¾“å…¥äº‹ä»¶çš„ä½ç½®ï¼Œè¢«linuxè™šæ‹ŸåŒ–æˆè™šæ‹Ÿè¾“å…¥è®¾å¤‡æ–‡ä»¶ï¼ˆå­—ç¬¦è®¾å¤‡ï¼‰ã€‚</p><p>4ã€EventHub<br>å®‰å“çš„äº‹ä»¶æ ¸å¿ƒã€è´Ÿè´£ä»linuxè™šæ‹ŸåŒ–è¾“å…¥è®¾å¤‡ä¸­è·å–åˆ°æ‰€æœ‰äº‹ä»¶ã€‚</p><p>framework/native/services/inputflinger/EventHub.h</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ä¸€æ¬¡inputçš„è€—æ—¶æ—¶é—´åˆ†å¸ƒ&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;T1 è¡¨ç¤º ç¡¬ä»¶ä¸­æ–­çš„æ—¶é—´&lt;/li&gt;
&lt;li&gt;T2 è¡¨ç¤º InputReader ä» /dev/input/xxx è¯»å‡ºäº‹ä»¶çš„æ—¶é—´&lt;/li&gt;
&lt;li&gt;T3 è¡¨ç¤º InputDispatcher å‘ app è¿›ç¨‹å‘é€äº‹ä»¶
      
    
    </summary>
    
      <category term="Android" scheme="http://lihaizhou.top/categories/Android/"/>
    
    
  </entry>
  
  <entry>
    <title>WFDçš„å­¦ä¹ è®°å½•ç¬”è®°</title>
    <link href="http://lihaizhou.top/2019/09/15/WFD%E7%9A%84%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95%E7%AC%94%E8%AE%B0/"/>
    <id>http://lihaizhou.top/2019/09/15/WFDçš„å­¦ä¹ è®°å½•ç¬”è®°/</id>
    <published>2019-09-15T09:18:25.000Z</published>
    <updated>2019-10-15T13:04:40.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡åªè®¨è®ºmiracastï¼Œå¯¹åº”çš„å³æ˜¯è®¾ç½®ä¸­æŠ•å±çš„æ–¹å¼ï¼Œå…¶ä»–è§†é¢‘æˆ–è€…ç›¸å†Œä¸­èµ°çš„æ˜¯å¦å¤–ä¸€å¥—DLNAåè®®ï¼Œä¸æ˜¯å®æ—¶çš„ï¼Œè¿˜æœ‰ä¸€äº›ä¸‰æ–¹åº”ç”¨å¦‚è…¾è®¯è§†é¢‘çˆ±å¥‡è‰ºæ˜¯è‡ªå·±æäº†ä¸€å¥—dlnaï¼ŒDLNAä¸åœ¨æœ¬æ–‡è®¨è®ºèŒƒå›´å†…</p><h1 id="WFDæ‰«ç›²"><a href="#WFDæ‰«ç›²" class="headerlink" title="WFDæ‰«ç›²"></a>WFDæ‰«ç›²</h1><h2 id="miracastç®€ä»‹"><a href="#miracastç®€ä»‹" class="headerlink" title="miracastç®€ä»‹"></a>miracastç®€ä»‹</h2><h2 id="åº”ç”¨å±‚å¦‚ä½•æ“ä½œWFDï¼Ÿ"><a href="#åº”ç”¨å±‚å¦‚ä½•æ“ä½œWFDï¼Ÿ" class="headerlink" title="åº”ç”¨å±‚å¦‚ä½•æ“ä½œWFDï¼Ÿ"></a>åº”ç”¨å±‚å¦‚ä½•æ“ä½œWFDï¼Ÿ</h2><p>è¿æ¥Miracastè®¾å¤‡<br>API<br>import android.hardware.display.DisplayManager;</p><p>mDisplayManager = (DisplayManager) getSystemService(Context.DISPLAY_SERVICE);</p><p>mDisplayManager.connectWifiDisplay(String deviceMacAddress);</p><p>å¤‡æ³¨<br>ï¼ˆ1ï¼‰éšè—æ¥å£ï¼Œå¯ä»¥é€šè¿‡åå°„è°ƒç”¨ã€‚<br>æƒé™<br>android.permission.CONFIGURE_WIFI_DISPLAY</p><p>æ–­å¼€Miracastè®¾å¤‡<br>API<br>import android.hardware.display.DisplayManager;</p><p>mDisplayManager = (DisplayManager) getSystemService(Context.DISPLAY_SERVICE);</p><p>mDisplayManager.disconnectWifiDisplay();</p><p>å¤‡æ³¨<br>ï¼ˆ1ï¼‰éšè—æ¥å£ï¼Œå¯ä»¥é€šè¿‡åå°„è°ƒç”¨<br>æ‰«æMiracastè®¾å¤‡<br>API<br>import android.hardware.display.DisplayManager;</p><p>mDisplayManager = (DisplayManager) getSystemService(Context.DISPLAY_SERVICE);</p><p>mDisplayManager.startWifiDisplayScan();</p><p>å¤‡æ³¨<br>ï¼ˆ1ï¼‰éšè—æ¥å£ï¼Œå¯ä»¥é€šè¿‡åå°„è°ƒç”¨ã€‚<br>æƒé™<br>android.permission.CONFIGURE_WIFI_DISPLAY<br>ä¸¾ä¸ªmilinkä¸­çš„ä½¿ç”¨ä¾‹å­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * scan wifi display while we can connect</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">startWifiDisplayScan</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == mDisplayManager) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ReflectUtil.callObjectMethod(mDisplayManager, <span class="string">"startWifiDisplayScan"</span>) == <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç”¨çš„æ˜¯åå°„è°ƒç”¨</p><h2 id="èŠ¯ç‰‡å•†åœ¨è°·æ­ŒåŸºç¡€ä¸Šçš„å®šåˆ¶åŒ–"><a href="#èŠ¯ç‰‡å•†åœ¨è°·æ­ŒåŸºç¡€ä¸Šçš„å®šåˆ¶åŒ–" class="headerlink" title="èŠ¯ç‰‡å•†åœ¨è°·æ­ŒåŸºç¡€ä¸Šçš„å®šåˆ¶åŒ–"></a>èŠ¯ç‰‡å•†åœ¨è°·æ­ŒåŸºç¡€ä¸Šçš„å®šåˆ¶åŒ–</h2><h2 id="é«˜é€šWFD"><a href="#é«˜é€šWFD" class="headerlink" title="é«˜é€šWFD"></a>é«˜é€šWFD</h2><p>With Android JB MR1, Google released a WFD solution called Remote Display.<br>ï‚§ Google WFD supports AVC, LPCM, and AAC codecs along with HDCP encryption, but lacks support for content protection. </p><p>ï‚§ It is available to applications as an external WFD using Presentation, MediaRouter, and DisplayManager APIs. </p><p>ï‚§ When compared to the QTI-based Miracast solution, it lacks content protection support and has low performance and higher power consumption numbers. </p><p>ï‚§ QTI created a wrapper to launch the QTI-based Miracast solution using Android APIs; this provides an enhanced Miracast solution to third-party vendors and OEMs who would like to use the Presentation API for Miracast</p><h2 id="WFDçš„åº”ç”¨åœºæ™¯"><a href="#WFDçš„åº”ç”¨åœºæ™¯" class="headerlink" title="WFDçš„åº”ç”¨åœºæ™¯"></a>WFDçš„åº”ç”¨åœºæ™¯</h2><h1 id="é«˜é€šWFDä»£ç ç»“æ„"><a href="#é«˜é€šWFDä»£ç ç»“æ„" class="headerlink" title="é«˜é€šWFDä»£ç ç»“æ„"></a>é«˜é€šWFDä»£ç ç»“æ„</h1><p>SessionManagerService<br>vendor/qcom/proprietary/commonsys/wfd/wdsm/service/src/com/qualcomm/wfd/service/<br>æä¾›äº†å¾ˆå¤šçš„æ¥å£ï¼Œè¯¸å¦‚ï¼š</p><h1 id="RTSPåè®®"><a href="#RTSPåè®®" class="headerlink" title="RTSPåè®®"></a>RTSPåè®®</h1><h1 id="WFDä»£ç è¿æ¥æµç¨‹"><a href="#WFDä»£ç è¿æ¥æµç¨‹" class="headerlink" title="WFDä»£ç è¿æ¥æµç¨‹"></a>WFDä»£ç è¿æ¥æµç¨‹</h1><h1 id="M-Messageæ¶ˆæ¯"><a href="#M-Messageæ¶ˆæ¯" class="headerlink" title="M-Messageæ¶ˆæ¯"></a>M-Messageæ¶ˆæ¯</h1><h1 id="P2Pä»¥åŠRTSPçš„çš„å»ºç«‹"><a href="#P2Pä»¥åŠRTSPçš„çš„å»ºç«‹" class="headerlink" title="P2Pä»¥åŠRTSPçš„çš„å»ºç«‹"></a>P2Pä»¥åŠRTSPçš„çš„å»ºç«‹</h1><h2 id="p2pçš„å»ºç«‹"><a href="#p2pçš„å»ºç«‹" class="headerlink" title="p2pçš„å»ºç«‹"></a>p2pçš„å»ºç«‹</h2><h2 id="RTSPçš„å»ºç«‹"><a href="#RTSPçš„å»ºç«‹" class="headerlink" title="RTSPçš„å»ºç«‹"></a>RTSPçš„å»ºç«‹</h2><h1 id="WFDæ•´ä½“æ¶æ„-source"><a href="#WFDæ•´ä½“æ¶æ„-source" class="headerlink" title="WFDæ•´ä½“æ¶æ„(source)"></a>WFDæ•´ä½“æ¶æ„(source)</h1><h1 id="WFDå¸¸è§é—®é¢˜çš„debugç­–ç•¥"><a href="#WFDå¸¸è§é—®é¢˜çš„debugç­–ç•¥" class="headerlink" title="WFDå¸¸è§é—®é¢˜çš„debugç­–ç•¥"></a>WFDå¸¸è§é—®é¢˜çš„debugç­–ç•¥</h1><h2 id="Wifi-Display-Miracaståˆ†æä¸€èˆ¬éœ€è¦çš„æ—¥å¿—"><a href="#Wifi-Display-Miracaståˆ†æä¸€èˆ¬éœ€è¦çš„æ—¥å¿—" class="headerlink" title="Wifi-Display/Miracaståˆ†æä¸€èˆ¬éœ€è¦çš„æ—¥å¿—"></a>Wifi-Display/Miracaståˆ†æä¸€èˆ¬éœ€è¦çš„æ—¥å¿—</h2><p>å‰ææ¡ä»¶ï¼šrootç‰ˆæœ¬ï¼Œå› ä¸ºæœ‰äº›å‘½ä»¤å¦‚å…³selinuxè¿™äº›å‘½ä»¤éœ€è¦rootæƒé™</p><h3 id="é«˜é€šå¹³å°"><a href="#é«˜é€šå¹³å°" class="headerlink" title="é«˜é€šå¹³å°"></a>é«˜é€šå¹³å°</h3><p>ä½¿èƒ½æ‰€æœ‰WFDæ—¥å¿—çš„å¼€å…³</p><ol><li>Android N ä»¥åŠæ›´æ—©çš„ç‰ˆæœ¬<br>åˆ›å»ºä¸€ä¸ªæ–‡ä»¶åä¸ºmmosal_logmask.cfgï¼Œå†…å®¹å¦‚ä¸‹<br><start><br>LOGMASK = 6013:63<br>LOGMASK = 6015:63<end></end></start></li></ol><p>è¿™ä¸ªæ–‡ä»¶å»ºè®®ä¿å­˜åœ¨æœ¬åœ°ï¼Œåç»­æ–¹ä¾¿æä¾›ç»™æµ‹è¯•æˆ–è€…è‡ªå·±è°ƒè¯•</p><p> push mmosal_logmask.cfgè¿™ä¸ªæ–‡ä»¶åˆ° /data/ folder æˆ–è€… /data/misc/media/ ç›®å½•ä¸‹, æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤<br> adb root<br> adb remount<br> adb push mmosal_logmask.cfg /data/<br> adb push mmosal_logmask.cfg /data/misc/media/<br> adb shell setenforce 0</p><ol start="2"><li><p>Android O ç‰ˆæœ¬<br>adb shell setprop mmosal.debug.config 6015:63:6013:63</p></li><li><p>Android P ç‰ˆæœ¬<br>adb shell setprop vendor.debug.mmosal.config 6015:63:6013:63</p></li><li><p>Android Q ç‰ˆæœ¬<br>push  mmosal_logmask.cfgè¿™ä¸ªæ–‡ä»¶åˆ° /data/ ç›®å½• æˆ–è€… /data/misc/media/ folder æˆ–è€… /data/vendor/ï¼Œç´¢æ€§éƒ½pushäº†<br>adb root<br>adb remount<br>adb push mmosal_logmask.cfg /data/<br>adb push mmosal_logmask.cfg data/misc/media/<br>adb push mmosal_logmask.cfg  /data/vendor/<br>adb shell setenforce 0</p></li></ol><p>æ‰“å¼€å»¶è¿Ÿåˆ†æå±æ€§æ¥åˆ¤æ–­å»¶è¿Ÿå€¼<br>å¯¹äº WFD performance é—®é¢˜, éœ€è¦æ‰“å¼€å»¶è¿Ÿåˆ†æå±æ€§æ¥åˆ¤æ–­å»¶è¿Ÿå€¼<br>Android O<br>adb shell setprop persist.debug.wfd.profile 1</p><p>Android P/Q<br>adb shell setprop persist.vendor.debug.wfd.profile 1</p><p>è·å– TCP dumpï¼Œè¿™ä¸€æ­¥ä¸»è¦ç”¨æ¥åˆ†æä¸¢åŒ…ç‡ä»¥åŠå»ºç«‹RTSPè¿‡ç¨‹ä¸­çš„é—®é¢˜<br>1.adb shell</p><ol start="2"><li>tcpdump -i wlan0 -s 0 -w /data/tcpdump.pcap</li></ol><h3 id="è”å‘ç§‘å¹³å°"><a href="#è”å‘ç§‘å¹³å°" class="headerlink" title="è”å‘ç§‘å¹³å°"></a>è”å‘ç§‘å¹³å°</h3><p>WFDå¡é¡¿å»¶è¿Ÿé—®é¢˜<br> 1.å½“å‘ç°æœ‰å»¶è¿Ÿæˆ–è€…å¡é¡¿ï¼Œå¯ä»¥çœ‹æ˜¯å¦æœ‰å¦‚ä¸‹LOGï¼š<br>212887 07-05 11:13:53.018936 582 24850 I MtkNetworkSession: [WFD_P][video][dummy=0]ts=7663475,in 7663545,out 7664846,LatencyF 91,send 1300,LatencyT 1392<br>212888 07-05 11:13:53.019069 582 24850 I MtkNetworkSession: [WFD_P][audo][dummy=0]ts=7663476,in 7663546,out 7664846,LatencyF 7,send 1300,LatencyT 1307</p><p>//å¦‚ä¸‹çš„æ—¶é—´å•ä½éƒ½æ˜¯æ¯«ç§’<br>LatencyF 91 //ç¼–ç æ‰“åŒ…çš„å»¶è¿Ÿæ—¶é—´<br>send 1300 //å‘é€çš„å»¶è¿Ÿæ—¶é—´<br>LatencyT 1392 //æ€»çš„å»¶è¿Ÿ</p><p>2.å‡å¦‚send æ—¶é—´æ¯”è¾ƒé•¿ï¼ˆä¸€èˆ¬éœ€è¦å¹³å‡1000/25FPS = 40æ¯«ç§’ä»¥å†…æ‰èƒ½ä¿è¯ä¸ä¼šå¡é¡¿ï¼‰é‚£ä¹ˆå¡é¡¿æ˜¯æ­£å¸¸ç°è±¡ï¼Œä¸€èˆ¬æ²¡åŠæ³•æå‡ï¼Œæ¯”å¦‚ç½‘ç»œåŸå› ï¼Œå¦‚ä¸‹LOGï¼ˆ link_scoreå°äº70ï¼‰ï¼Œè¯´æ˜æ˜¯ç½‘ç»œä¿¡å·ä¸å¥½å¡é¡¿å»¶è¿Ÿï¼š<br>39313 07-05 11:13:50.521 <6>[ 7662.347991] (1)[1261:tx_thread][wlan]nicCmdEventQueryStaStatistics:(P2P INFO) link_score=11, rssi=78, rate=81, threshold_cnt=2780,ã€‚</6></p><p>3.å‡å¦‚æ˜¯LatencyF å¤ªé•¿ï¼Œè¯·å¸®å¿™è®¾ç½®å¦‚ä¸‹propertyå¹¶æŠ“LOGå¤ç°ï¼ˆéœ€è¦æä¾›mtklogå’Œnetlogï¼‰ã€‚<br>  adb root<br>  adb shell setenforce 0<br>  //Android Oç‰ˆæœ¬ä»¥åŠä¹‹å‰çš„ç‰ˆæœ¬<br>  adb shell setprop mtk.omx.enable.venc.log 1<br>  //Android Pç‰ˆæœ¬<br>  adb shell setprop vendor.mtk.omx.enable.venc.log 2</p><h2 id="å¦‚ä½•åˆ†æä¸¢åŒ…ç‡"><a href="#å¦‚ä½•åˆ†æä¸¢åŒ…ç‡" class="headerlink" title="å¦‚ä½•åˆ†æä¸¢åŒ…ç‡"></a>å¦‚ä½•åˆ†æä¸¢åŒ…ç‡</h2><h2 id="miracastè¿æ¥è¶…æ—¶é—®é¢˜åˆ†æ"><a href="#miracastè¿æ¥è¶…æ—¶é—®é¢˜åˆ†æ" class="headerlink" title="miracastè¿æ¥è¶…æ—¶é—®é¢˜åˆ†æ"></a>miracastè¿æ¥è¶…æ—¶é—®é¢˜åˆ†æ</h2><h2 id="sinkç«¯æ˜¾ç¤ºé—®é¢˜ä¸€èˆ¬å¤„ç†ç­–ç•¥"><a href="#sinkç«¯æ˜¾ç¤ºé—®é¢˜ä¸€èˆ¬å¤„ç†ç­–ç•¥" class="headerlink" title="sinkç«¯æ˜¾ç¤ºé—®é¢˜ä¸€èˆ¬å¤„ç†ç­–ç•¥"></a>sinkç«¯æ˜¾ç¤ºé—®é¢˜ä¸€èˆ¬å¤„ç†ç­–ç•¥</h2><h3 id="æ’­æ”¾å¡é¡¿çš„å˜æ¸…æ–¹å‘-source"><a href="#æ’­æ”¾å¡é¡¿çš„å˜æ¸…æ–¹å‘-source" class="headerlink" title="æ’­æ”¾å¡é¡¿çš„å˜æ¸…æ–¹å‘(source)"></a>æ’­æ”¾å¡é¡¿çš„å˜æ¸…æ–¹å‘(source)</h3><h3 id="æ’­æ”¾å¡é¡¿çš„å˜æ¸…æ–¹å‘-sink"><a href="#æ’­æ”¾å¡é¡¿çš„å˜æ¸…æ–¹å‘-sink" class="headerlink" title="æ’­æ”¾å¡é¡¿çš„å˜æ¸…æ–¹å‘(sink)"></a>æ’­æ”¾å¡é¡¿çš„å˜æ¸…æ–¹å‘(sink)</h3><p>1 åœ¨æµ‹è¯•ä¹‹å‰ï¼Œéœ€è¦å…ˆåœ¨å±è”½å®¤ä¸­æµ‹è¯•æ‰‹æœºçš„ååé‡ï¼Œçœ‹çœ‹æ˜¯å¦æ­£å¸¸ã€‚</p><p>2  åœ¨æµ‹è¯•ä¹‹å‰ä¹Ÿè¦å…ˆç¡®ä¿ç¡¬ä»¶æ²¡æœ‰é—®é¢˜ï¼Œæ¯”å¦‚æ¥æ”¶çµæ•åº¦ï¼ŒEVMï¼Œå¤©çº¿æ•ˆèƒ½ç­‰ç¡¬ä»¶å› ç´ è¦æ˜¯okçš„ã€‚</p><p>3  æµ‹è¯•æ—¶é¦–å…ˆé€‰æ‹©ä¸€ä¸ªæ¯”è¾ƒå¹²å‡€çš„ç¯å¢ƒè¿›è¡Œæµ‹è¯•ã€‚</p><p>4  ä½¿ç”¨sniffer è®¾å¤‡åœ¨å…¨ä¿¡é“ä¸Šæ‰«æï¼Œçœ‹çœ‹å‘¨å›´APåœ¨å„ä¿¡é“ä¸Šçš„åˆ†å¸ƒ</p><p>5  åœ¨æµ‹è¯•æ—¶ï¼Œæœ€å¥½æ˜¯é€‰æ‹©æ¯”è¾ƒç©ºé—²çš„ä¿¡é“è¿›è¡Œæµ‹è¯•ï¼Œå¯ä»¥è¿™æ ·è®¾ç½®ï¼šå…ˆè®¾ç½®APçš„ä¿¡é“ä¸ºç©ºé—²ä¿¡é“ï¼Œç„¶åæ‰‹æœºè¿æ¥APï¼Œæ‰‹æœºå†è¿æ¥dongleï¼Œæ–­å¼€APï¼Œæ­¤æ—¶WFDçš„è¿æ¥å°±å¤„äºç©ºé—²ä¿¡é“äº†ã€‚</p><p>6  å¦‚æœä¸€å®šè¦åœ¨æ¯”è¾ƒç¹å¿™çš„ä¿¡é“ä¸Šæµ‹è¯•ï¼Œé¦–å…ˆè¦åœ¨è¿™ä¸ªä¿¡é“ä¸Šä½¿ç”¨iperfæ‰“ååé‡ï¼Œå¦‚æœæ•°æ®å¯ä»¥ç¨³å®šåœ¨15Mbpsä»¥ä¸Šï¼Œå°±å¯ä»¥è¿›è¡Œæµ‹è¯•ã€‚</p><p>7  æµ‹è¯•æ—¶ï¼Œè¯·åŒæ—¶æ‹¿å¯¹æ¯”æœºè¿›è¡Œæµ‹è¯•ï¼Œå¦‚æœé‡åˆ°å¡é¡¿ç°è±¡ï¼Œè¯·æ¢ä¸€åªæ‰‹æœºè¿›è¡Œæµ‹è¯•ï¼Œä¹Ÿå¯ä»¥å†æµ‹è¯•ä¸€æ¬¡æ­¤æ—¶çš„ååé‡ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰å˜ã€‚</p><p>8  æµ‹è¯•æ—¶ï¼Œå¯ä»¥åœ¨ç©ºé—²çš„æ—¶æ®µè¿›è¡Œæµ‹è¯•ï¼Œæ¯”å¦‚ä¸‹ç­åï¼Œæˆ–è€…å‘¨æœ«çš„æ—¶é—´ç­‰</p><p>è‹¥åªæ˜¯SINKç«¯å¡é¡¿ï¼Œé€šå¸¸çš„åŸå› æœ‰ï¼š<br>1.mdpåšresizeå’Œrotateæ…¢<br>2.encoderåšè§†é¢‘ç¼–ç æ…¢<br>3.ANetworksessionè°ƒç”¨socketæ¥å£å°†å·²æ‰“å¥½åŒ…çš„rtp a\v dataå‘é€æœ‰å»¶è¿Ÿ<br>4.network wifiç¯å¢ƒé—®é¢˜<br>5.SINKç«¯æœ¬èº«æ‹†åŒ…è§£ç æ…¢</p><p>é€†å‘åˆ†ææ¯”è¾ƒå®¹æ˜“å¿«é€Ÿå˜æ¸…é—®é¢˜ï¼Œè´µå¸å¯ä»¥å…ˆé€šè¿‡mainlogå’Œnetlogå¿«é€Ÿå˜æ¸…æ˜¯å¦æ˜¯ç½‘ç»œæˆ–è€…SINKç«¯æœ¬èº«é—®é¢˜ã€‚<br>é¦–å…ˆè¯·é€šè¿‡mtklogger apkï¼Œå‹¾é€‰moblie logå’Œnet logï¼Œç„¶åå¼€å§‹å¤ç°é—®é¢˜ï¼ŒæŠ“å–åˆ†æèµ„æ–™.<br>å†é€šè¿‡netlogå¯¼å‡ºSOURCEå‘é€ç»™SINKç«¯çš„rtpæ•°æ®ï¼Œå¹¶é€šè¿‡wiresharkå°†rtpåŒ…ç”Ÿæˆtsæ–‡ä»¶,ç›´æ¥åœ¨PCä¸ŠæŸ¥çœ‹æ’­æ”¾è§†é¢‘ï¼ˆå¯ä»¥ç”¨vlcè§†é¢‘æ’­æ”¾å™¨ç›´æ¥æ‰“å¼€ï¼‰ï¼ŒæŸ¥çœ‹è§†é¢‘æ’­æ”¾æ˜¯å¦æœ‰å¡é¡¿ç°è±¡ã€‚<br>è‹¥è§†é¢‘æœ¬èº«åœ¨PCä¸Šæ’­æ”¾å¡é¡¿ï¼Œè¯·æäº¤eserviceï¼Œå¹¶é™„å¸¦mtklogï¼ˆmobile log&amp; net logï¼‰ç­‰æ–‡ä»¶ï¼›<br>è‹¥è§†é¢‘æœ¬èº«åœ¨PCä¸Šæ’­æ”¾ä¸å¡é¡¿ï¼Œåˆ™surface-&gt;mdp-&gt;encoder-&gt;ANetworksession\socketè¿™ä¸€è·¯æ­£å¸¸ï¼Œæ¨èè´µå¸åšä¸‹é¢æµ‹è¯•ï¼š<br>1ï¼‰ç”¨å¯¹æ¯”æœºæµ‹è¯•çœ‹æ˜¯å¦ä¹Ÿæœ‰åŒæ ·é—®é¢˜ï¼›<br>2ï¼‰å¯ä»¥æŠŠé™„ä»¶è§†é¢‘tsæ–‡ä»¶ç›´æ¥é€šè¿‡usbçš„æ–¹å¼ï¼Œåœ¨TVä¸Šæ’­æ”¾ï¼Œè‹¥æ’­æ”¾å¡é¡¿ï¼Œåˆ™æ˜¯5.SINKç«¯æœ¬èº«æ‹†åŒ…è§£ç æ…¢ï¼›<br>3ï¼‰æµ‹è¯•å½“å‰wifiç½‘ç»œç¯å¢ƒï¼Œåœ¨çº¯å‡€wifiç½‘ç»œç¯å¢ƒä¸‹å†è¿›è¡Œæµ‹è¯•ã€‚<br>è‹¥è¿˜æ²¡æœ‰æ‰¾åˆ°åŸå› ï¼Œè¯·æäº¤eserviceï¼Œè¯´æ˜è´µå¸åˆ†æç°çŠ¶ä»¥åŠæµ‹è¯•å®éªŒç»“æœï¼Œå¹¶é™„å¸¦mtklogï¼ˆmobile log&amp; net logï¼‰ç­‰æ–‡ä»¶ã€‚</p><p>é€šå¸¸ç½‘ç»œä¸ç¨³å®šå¯¼è‡´çš„sinkç«¯å¡é¡¿ä¼šæœ‰ä¸‹é¢log<br>1)link_scoreä¸ç¨³å®šç­‰äº100<br>05-31 14:01:09.326144 1238 2086 D WifiP2pService: link_score=10<br>05-31 14:01:11.329835 1238 2086 D WifiP2pService: link_score=8<br>05-31 14:01:13.331112 1238 2086 D WifiP2pService: link_score=10<br>05-31 14:01:15.332513 1238 2086 D WifiP2pService: link_score=10<br>~<br>05-31 14:02:31.387187 1238 2086 D WifiP2pService: link_score=71<br>05-31 14:02:33.391052 1238 2086 D WifiP2pService: link_score=58<br>05-31 14:02:35.390564 1238 2086 D WifiP2pService: link_score=73<br>05-31 14:02:37.393885 1238 2086 D WifiP2pService: link_score=54</p><p>2)Netowrksessionæ‰“å°å‡ºæ¥send costæ—¶é—´è¾ƒé•¿<br>05-31 14:01:35.820162 413 10936 I NetworkSession: [WFD_P][audo][dummy=0]ts=13041028 ms,in 13041053 ms,out 13044779 ms, mLatencyF 24 ms,send cost 3725 ms,LatencyT 3750 ms<br>05-31 14:01:35.820302 413 10936 I NetworkSession: [WFD_P][audo][dummy=0]ts=13041049 ms,in 13041054 ms,out 13044779 ms, mLatencyF 4 ms,send cost 3725 ms,LatencyT 3729 ms</p><h3 id="é«˜é€šå¹³å°çš„èŠ±å±é—®é¢˜ä¸€èˆ¬åˆ†ææ–¹å‘"><a href="#é«˜é€šå¹³å°çš„èŠ±å±é—®é¢˜ä¸€èˆ¬åˆ†ææ–¹å‘" class="headerlink" title="é«˜é€šå¹³å°çš„èŠ±å±é—®é¢˜ä¸€èˆ¬åˆ†ææ–¹å‘"></a>é«˜é€šå¹³å°çš„èŠ±å±é—®é¢˜ä¸€èˆ¬åˆ†ææ–¹å‘</h3><h3 id="MTKå¹³å°çš„èŠ±å±é—®é¢˜ä¸€èˆ¬åˆ†ææ–¹å‘"><a href="#MTKå¹³å°çš„èŠ±å±é—®é¢˜ä¸€èˆ¬åˆ†ææ–¹å‘" class="headerlink" title="MTKå¹³å°çš„èŠ±å±é—®é¢˜ä¸€èˆ¬åˆ†ææ–¹å‘"></a>MTKå¹³å°çš„èŠ±å±é—®é¢˜ä¸€èˆ¬åˆ†ææ–¹å‘</h3><p>å‚è§ï¼š[FAQ21608] WFDå›¾åƒèŠ±å±é—®é¢˜</p><p>step1: ç”¨wiresharkæ‰“å¼€netlogï¼Œå¹¶è¿‡æ»¤å‡ºRTPåŒ…ï¼Œåˆ†æä¸¢åŒ…ç‡</p><p>step2: å‘ç°äº†ä¸¢åŒ…ï¼Œé‚£ä¹ˆè¯´æ˜èŠ±å±æ˜¯æ­£å¸¸çš„ï¼Œå‡å¦‚ä»ç„¶è¦åˆ†æé—®é¢˜ï¼Œå¯ä»¥å»æœç´¢kernel_logé‡Œé¢çš„link_scoreå…³é”®å­—ã€‚å¦‚æœå‡ºç°å¦‚ä¸‹LOGï¼ˆ link_scoreå°äº70ï¼‰ï¼Œè¯´æ˜æ˜¯ç½‘ç»œä¿¡å·ä¸å¥½å¯¼è‡´ä¸¢å¸§ï¼š<br>39313 07-05 11:13:50.521 <6>[ 7662.347991] (1)[1261:tx_thread][wlan]nicCmdEventQueryStaStatistics:(P2P INFO) link_score=11, rssi=78, rate=81, threshold_cnt=2780,</6></p><p>step3:å¦‚æœå‘ç°æ²¡æœ‰ä¸¢åŒ…ï¼Œä½†æ˜¯å‡ºç°äº†èŠ±å±ã€‚å¯ä»¥åœ¨å¦‚ä¸‹ç•Œé¢æŠŠtsæ•°æ®dumpå‡ºæ¥ï¼Œç„¶åæ‹¿PCç«¯çš„æ’­æ”¾å™¨æ’­æ”¾</p><p>step4:å¦‚æœå‘ç°æ’­æ”¾å™¨æ’­æ”¾æ˜¯OKçš„ï¼Œé‚£ä¹ˆè¯´æ˜æ˜¯TVæˆ–è€…å…¶ä»–æ˜¾ç¤ºè®¾å¤‡çš„é—®é¢˜ï¼Œè·Ÿå¹³å°æ— å…³ï¼Œäº²è‡ªè¡Œå»æ‰¾TVå‚å•†æ²Ÿé€š</p><p>step5:å¦‚æœå‘ç°æ’­æ”¾æœ‰é—®é¢˜ï¼Œè¯·å¸®å¿™æä¾›mtklogï¼Œä¸”éœ€è¦æ‰“å¼€netlog</p><h1 id="WFDå‡ ä¸ªå…¸å‹æ¡ˆä¾‹"><a href="#WFDå‡ ä¸ªå…¸å‹æ¡ˆä¾‹" class="headerlink" title="WFDå‡ ä¸ªå…¸å‹æ¡ˆä¾‹"></a>WFDå‡ ä¸ªå…¸å‹æ¡ˆä¾‹</h1><p>å‚è€ƒäº†ï¼š</p><p><a href="https://online.mediatek.com/FAQ#/SW/FAQ21609" target="_blank" rel="noopener">https://online.mediatek.com/FAQ#/SW/FAQ21609</a><br><a href="https://online.mediatek.com/FAQ#/SW/FAQ21608" target="_blank" rel="noopener">https://online.mediatek.com/FAQ#/SW/FAQ21608</a><br><a href="https://online.mediatek.com/FAQ#/SW/FAQ08527" target="_blank" rel="noopener">https://online.mediatek.com/FAQ#/SW/FAQ08527</a><br><a href="https://online.mediatek.com/FAQ#/SW/FAQ21602" target="_blank" rel="noopener">https://online.mediatek.com/FAQ#/SW/FAQ21602</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æœ¬æ–‡åªè®¨è®ºmiracastï¼Œå¯¹åº”çš„å³æ˜¯è®¾ç½®ä¸­æŠ•å±çš„æ–¹å¼ï¼Œå…¶ä»–è§†é¢‘æˆ–è€…ç›¸å†Œä¸­èµ°çš„æ˜¯å¦å¤–ä¸€å¥—DLNAåè®®ï¼Œä¸æ˜¯å®æ—¶çš„ï¼Œè¿˜æœ‰ä¸€äº›ä¸‰æ–¹åº”ç”¨å¦‚è…¾è®¯è§†é¢‘çˆ±å¥‡è‰ºæ˜¯è‡ªå·±æäº†ä¸€å¥—dlnaï¼ŒDLNAä¸åœ¨æœ¬æ–‡è®¨è®ºèŒƒå›´å†…&lt;/p&gt;
&lt;h1 id=&quot;WFDæ‰«ç›²&quot;&gt;&lt;a href=&quot;#WFDæ‰«ç›²&quot; cl
      
    
    </summary>
    
      <category term="WFD" scheme="http://lihaizhou.top/categories/WFD/"/>
    
    
  </entry>
  
  <entry>
    <title>ä¸€ä¸ªSharedPreferenceså†™æ“ä½œå¯¼è‡´çš„ANRé—®é¢˜åˆ†æ</title>
    <link href="http://lihaizhou.top/2019/06/23/%E4%B8%80%E4%B8%AASharedPreferences%E5%86%99%E6%93%8D%E4%BD%9C%E5%AF%BC%E8%87%B4%E7%9A%84ANR%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90/"/>
    <id>http://lihaizhou.top/2019/06/23/ä¸€ä¸ªSharedPreferenceså†™æ“ä½œå¯¼è‡´çš„ANRé—®é¢˜åˆ†æ/</id>
    <published>2019-06-23T12:11:32.000Z</published>
    <updated>2019-12-28T07:00:18.000Z</updated>
    
    <content type="html"><![CDATA[<p><code>é—®é¢˜ç°è±¡</code><br>æ‰‹æœºè¿æ¥WIFIåå‡ºç°è®¾ç½®å¼¹å‡ºæ— å“åº”çš„å¼¹æ¡†<br><code>é—®é¢˜æ¦‚ç‡</code><br>ä»…å‡ºç°ä¸€æ¬¡<br><code>é—®é¢˜å¹³å°</code><br>Andorid P  é«˜é€šå¹³å°</p><p><strong>æ—¥å¿—åˆ†æ</strong><br>æ‹¿åˆ°bugreportï¼Œä½¿ç”¨chkbugreportè§£æä¸‹(å¼€æºå·¥å…·ï¼Œå°†bugreportåºå¤§çš„æ—¥å¿—è¿›è¡Œåˆ†é—¨åˆ«ç±»ï¼Œå¹¶ä»¥ç½‘é¡µå½¢å¼å±•ç°å‡ºæ¥)ï¼Œæ‰“å¼€æµè§ˆå™¨çœ‹ä¸‹eventæ—¥å¿—ä¸­çš„æ—¶é—´ç‚¹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">06</span><span class="number">-19</span> <span class="number">17</span>:<span class="number">53</span>:<span class="number">42.307</span>  <span class="number">1000</span>  <span class="number">1820</span>  <span class="number">1959</span> I am_anr  : [<span class="number">0</span>,<span class="number">3861</span>,com.android.settings,<span class="number">952745541</span>,Input dispatching timed out (com.android.settings/com.android.settings.MainSettings</span><br></pre></td></tr></table></figure><p>è§£å‹åçš„bugreportä¸­æœ‰ä¸€ä»½ANRæ–‡ä»¶ï¼ŒæŸ¥çœ‹å…¶ä¸­çš„trace<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"main"</span> prio=<span class="number">5</span> tid=<span class="number">1</span> Blocked</span><br><span class="line">  | group=<span class="string">"main"</span> sCount=<span class="number">1</span> dsCount=<span class="number">0</span> flags=<span class="number">1</span> obj=<span class="number">0x7923e118</span> self=<span class="number">0x763be14c00</span></span><br><span class="line">  | sysTid=<span class="number">3861</span> nice=<span class="number">-10</span> cgrp=<span class="keyword">default</span> sched=<span class="number">0</span>/<span class="number">0</span> handle=<span class="number">0x76c1e12548</span></span><br><span class="line">  | state=S schedstat=( <span class="number">4685634510</span> <span class="number">1791639950</span> <span class="number">6133</span> ) utm=<span class="number">380</span> stm=<span class="number">88</span> core=<span class="number">3</span> HZ=<span class="number">100</span></span><br><span class="line">  | stack=<span class="number">0x7fe6270000</span><span class="number">-0x7fe6272000</span> stackSize=<span class="number">8</span>MB</span><br><span class="line">  | held mutexes=</span><br><span class="line">  at android.app.QueuedWork.processPendingWork(QueuedWork.java:<span class="number">273</span>)</span><br><span class="line">  - waiting to lock &lt;<span class="number">0x00210110</span>&gt; (a java.lang.Object) held by thread <span class="number">19</span></span><br><span class="line">  at android.app.QueuedWork.waitToFinish(QueuedWork.java:<span class="number">184</span>)</span><br><span class="line">  at android.app.ActivityThread.handleStopActivity(ActivityThread.java:<span class="number">4305</span>)</span><br></pre></td></tr></table></figure></p><p>å¯ä»¥çœ‹å‡ºä¸»çº¿ç¨‹åœ¨ç­‰é”0x00210110ï¼Œè¯¥é”è¢«thread 19æŒæœ‰ï¼Œè¿™é‡Œçœ‹å †æ ˆå¯ä»¥çœ‹å‡ºå¡åœ¨äº†waitToFinishä¸Šï¼Œç•Œé¢å›è°ƒäº†onStopçš„ç”Ÿå‘½å‡½æ•°ï¼Œ<br>æ˜¯ä¸æ˜¯å¯ä»¥ç†è§£ä¸ºå½“æ—¶ç•Œé¢èµ°äº†onStopå‡†å¤‡é€€å‡ºï¼Œå‘ç°æœ‰ä»»åŠ¡æ²¡æœ‰å®Œæˆï¼Œéœ€è¦ç­‰å¾…ï¼ŒçŒœæµ‹å¦‚æ­¤ï¼Œç»§ç»­çœ‹thread 19</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"queued-work-looper"</span> prio=<span class="number">5</span> tid=<span class="number">19</span> Native</span><br><span class="line">  | group=<span class="string">"main"</span> sCount=<span class="number">1</span> dsCount=<span class="number">0</span> flags=<span class="number">1</span> obj=<span class="number">0x130c0958</span> self=<span class="number">0x762df62800</span></span><br><span class="line">  | sysTid=<span class="number">3892</span> nice=<span class="number">-2</span> cgrp=<span class="keyword">default</span> sched=<span class="number">0</span>/<span class="number">0</span> handle=<span class="number">0x76223ff4f0</span></span><br><span class="line">  | state=D schedstat=( <span class="number">8250990</span> <span class="number">10651510</span> <span class="number">31</span> ) utm=<span class="number">0</span> stm=<span class="number">0</span> core=<span class="number">1</span> HZ=<span class="number">100</span></span><br><span class="line">  | stack=<span class="number">0x76222fc000</span><span class="number">-0x76222fe000</span> stackSize=<span class="number">1041</span>KB</span><br><span class="line">  | held mutexes=</span><br><span class="line">  kernel: (couldn<span class="string">'t read /proc/self/task/3892/stack)</span></span><br><span class="line"><span class="string">  native: #00 pc 000000000007b070  /system/lib64/libc.so (fsync+8)</span></span><br><span class="line"><span class="string">  native: #01 pc 0000000000003670  /system/lib64/libopenjdkjvm.so (JVM_Sync+20)</span></span><br><span class="line"><span class="string">  native: #02 pc 000000000001cd54  /system/lib64/libopenjdk.so (FileDescriptor_sync+40)</span></span><br><span class="line"><span class="string">  at java.io.FileDescriptor.sync(Native method)</span></span><br><span class="line"><span class="string">  at android.os.FileUtils.sync(FileUtils.java:197)</span></span><br><span class="line"><span class="string">  at android.app.SharedPreferencesImpl.writeToFile(SharedPreferencesImpl.java:777)</span></span><br><span class="line"><span class="string">  at android.app.SharedPreferencesImpl.access$900(SharedPreferencesImpl.java:54)</span></span><br><span class="line"><span class="string">  at android.app.SharedPreferencesImpl$2.run(SharedPreferencesImpl.java:642)</span></span><br><span class="line"><span class="string">  - locked &lt;0x08e457c5&gt; (a java.lang.Object)</span></span><br><span class="line"><span class="string">  at android.app.QueuedWork.processPendingWork(QueuedWork.java:286)</span></span><br><span class="line"><span class="string">  - locked &lt;0x00210110&gt; (a java.lang.Object)</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„å †æ ˆå¯ä»¥çœ‹å‡ºï¼Œå½“æ—¶åœ¨åšSharedPreferenceçš„IOæ“ä½œï¼Œé”çš„æŒæœ‰å¯¹è±¡å½“æ—¶åœ¨åšprocessPendingWorkï¼Œå¯æ˜¯ä¸ºä»€ä¹ˆActivityçš„onStopè¦ç­‰SharedPreferenceå†™å®Œå‘¢ï¼Ÿ</p><p>å†æ¥çœ‹ä¸‹ä¸»çº¿ç¨‹ä¸­çš„å †æ ˆ</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">at android.app.QueuedWork.waitToFinish(QueuedWork.java:<span class="number">184</span>)</span><br><span class="line">at android.app.ActivityThread.handleStopActivity(ActivityThread.java:<span class="number">4305</span>)</span><br></pre></td></tr></table></figure><p>çœ‹ä¸‹ActivityThread.javaä¸­çš„handleStopActivity</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleStopActivity</span><span class="params">(IBinder token, <span class="keyword">boolean</span> show, <span class="keyword">int</span> configChanges,</span></span></span><br><span class="line"><span class="function"><span class="params">            PendingTransactionActions pendingActions, <span class="keyword">boolean</span> finalStateRequest, String reason)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ActivityClientRecord r = mActivities.get(token);</span><br><span class="line">        r.activity.mConfigChangeFlags |= configChanges;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> StopInfo stopInfo = <span class="keyword">new</span> StopInfo();</span><br><span class="line">        performStopActivityInner(r, stopInfo, show, <span class="keyword">true</span> <span class="comment">/* saveState */</span>, finalStateRequest,</span><br><span class="line">                reason);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (localLOGV) Slog.v(</span><br><span class="line">            TAG, <span class="string">"Finishing stop of "</span> + r + <span class="string">": show="</span> + show</span><br><span class="line">            + <span class="string">" win="</span> + r.window);</span><br><span class="line"></span><br><span class="line">        updateVisibility(r, show);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Make sure any pending writes are now committed.</span></span><br><span class="line">        <span class="keyword">if</span> (!r.isPreHoneycomb()) &#123;</span><br><span class="line">            QueuedWork.waitToFinish();</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure><p>é‡ç‚¹å…³æ³¨å…¶ä¸­çš„waitToFinish()å‡½æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Trigger queued work to be processed immediately. The queued work is processed on a separate</span></span><br><span class="line"><span class="comment">     * thread asynchronous. While doing that run and process all finishers on this thread. The</span></span><br><span class="line"><span class="comment">     * finishers can be implemented in a way to check weather the queued work is finished.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Is called from the Activity base class's onPause(), after BroadcastReceiver's onReceive,</span></span><br><span class="line"><span class="comment">     * after Service command handling, etc. (so async work is never lost)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">waitToFinish</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// xxx ADD</span></span><br><span class="line">        <span class="keyword">boolean</span> interrupt = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">boolean</span> hadMessages = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        Handler handler = getHandler();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (sLock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (handler.hasMessages(QueuedWorkHandler.MSG_RUN)) &#123;</span><br><span class="line">                <span class="comment">// Delayed work will be processed at processPendingWork() below</span></span><br><span class="line">                handler.removeMessages(QueuedWorkHandler.MSG_RUN);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (DEBUG) &#123;</span><br><span class="line">                    hadMessages = <span class="keyword">true</span>;</span><br><span class="line">                    Log.d(LOG_TAG, <span class="string">"waiting"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// We should not delay any work as this might delay the finishers</span></span><br><span class="line">            sCanDelay = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        StrictMode.ThreadPolicy oldPolicy = StrictMode.allowThreadDiskWrites();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// xxx MOD</span></span><br><span class="line">            <span class="comment">// processPendingWork();</span></span><br><span class="line">            interrupt = processPendingWork(<span class="keyword">false</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            StrictMode.setThreadPolicy(oldPolicy);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>ä¾æ®traceï¼Œæ¥ç€çœ‹processPendingWork</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">processPendingWork</span><span class="params">(<span class="keyword">boolean</span> fromMsg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> startTime = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> workNdx = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// if (DEBUG) &#123;</span></span><br><span class="line">        startTime = System.currentTimeMillis();</span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// END</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (sProcessingWork) &#123; <span class="comment">//#273 ä¸»çº¿ç¨‹å¡åœ¨è¿™é‡Œç­‰é”</span></span><br><span class="line">            LinkedList&lt;Runnable&gt; work;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">synchronized</span> (sLock) &#123;</span><br><span class="line">                work = (LinkedList&lt;Runnable&gt;) sWork.clone();</span><br><span class="line">                sWork.clear();     </span><br><span class="line">            <span class="comment">// Remove all msg-s as all work will be processed now</span></span><br><span class="line">           getHandler().removeMessages(QueuedWorkHandler.MSG_RUN);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (work.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Runnable w : work) &#123;</span><br><span class="line">                    w.run(); <span class="comment">//#286 tid19 ä¸€ç›´åœ¨è¿è¡Œè¯¥å¤„</span></span><br><span class="line">                    .....</span><br><span class="line">                    &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡ŒåŸºæœ¬æ˜ç™½äº†æ˜¯æ€ä¹ˆå›äº‹äº†ï¼Œä¸»çº¿ç¨‹åœ¨ç­‰çš„SharedPreferenceçš„å†™æ“ä½œwriteToFileå®Œæˆï¼Œå¦‚æœè¿™ä¸ªé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ²¡æœ‰å®Œæˆï¼ŒSharedPreferenceå°±ä¼šä¸€ç›´æŒæœ‰è¿™ä¸ªé”ï¼Œä¸»çº¿ç¨‹æ‹¿ä¸åˆ°è¿™ä¸ªé”ï¼Œ<br>ä¸€ç›´ç­‰å¾…ï¼Œè¶…è¿‡äº”ç§’åè§¦å‘ANRï¼Œè¿™ç‚¹åœ¨æ—¥å¿—ä¸­ä¹Ÿå¾—åˆ°äº†å°è¯ï¼ŒANRæ—¶é—´ç‚¹å‰åæœ‰ä¸å°‘çš„SharedPreferencesImplç›¸å…³çš„æ—¥å¿—è¾“å‡ºï¼Œå¾€ä¸Šçœ‹å¤§æ¦‚èƒ½çœ‹å‡ºå½“æ—¶æ˜¯åœ¨åšåŒæ­¥æ•°æ®ä¹‹ç±»</p><p>å…¶å®SharedPreferenceæ—¶ä¸è®ºæ˜¯applyè¿˜æ˜¯commitéƒ½ä¼šæœ‰å‡ºç°å†™å…¥ç£ç›˜æ…¢çš„æƒ…å†µå‘ç”Ÿï¼Œç‰¹åˆ«æ˜¯æ•°æ®é‡å¤§ï¼Œæˆ–è€…å¤šçº¿ç¨‹åŒæ—¶è®¿é—®åŒä¸€ä»½xmlï¼Œåˆæˆ–è€…è¿ç»­å¤šæ¬¡commitï¼Œéƒ½ä¼šæœ‰å¯èƒ½é€ æˆwaitToFinishå‡½æ•°è€—æ—¶å˜é•¿ã€‚è™½ç„¶applyæ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œä¸»çº¿ç¨‹ä¾æ—§éœ€è¦ç­‰å®ƒæ‰§è¡Œç»“æŸã€‚è¿™ç‚¹å…¶å®ä¸å¥½è§„é¿ï¼Œæ‰€ä»¥å°½å¯èƒ½çš„å°‘ä½¿ç”¨SharedPreferenceï¼Œç‰¹åˆ«æ˜¯å¯èƒ½å­˜åœ¨å¤šçº¿ç¨‹æ“ä½œåŒä¸€ä»½æ•°æ®è¿™ç§æƒ…å†µï¼Œæ¯•ç«Ÿæœ‰äº†åŠ é”ï¼Œä¼šå¯èƒ½å‡ºç°æ’é˜Ÿçš„æƒ…å†µã€‚</p><p><code>ä¼˜åŒ–æ–¹å¼</code><br>å°½å¯èƒ½ä¼ è¾“çš„æ•°æ®é‡è½»é‡<br>å°½å¯èƒ½å‡å°‘commitæ¬¡æ•°<br>è€ƒè™‘æ–°å¼€çº¿ç¨‹ï¼Œä½†æ˜¯ä¼šæœ‰å†…å­˜å¼€é”€çš„å­˜åœ¨ï¼Œå¦‚æœåŸæœ¬æ˜¯applyï¼Œåˆ™åœ¨æ–°å¼€çš„çº¿ç¨‹æ”¹ä¸ºcommit</p><p>å…¶å®çœ‹å…¬å¸å†…éƒ¨ä»£ç ï¼Œå‘ç°å…¬å¸çš„frameworkåŒäº‹æœ‰ä¿®æ”¹waitToFinishå‡½æ•°ä¸­è°ƒç”¨çš„processPendingWorkå‡½æ•°å†…å®¹ï¼Œå¢åŠ äº†è®°å½•æ—¶é—´ï¼Œ<br>è¶…è¿‡10sç›´æ¥return falseï¼Œè¿™æ˜¯ä¸ªä¸é”™çš„æƒ³æ³•ï¼Œä½†æ˜¯10så¯¹äºå¹¿æ’­ä¸­çš„æƒ…å†µæˆ–è®¸å¯ä»¥coverï¼Œå¯¹åº”Activityä¸­è¶…æ—¶5ç§’å°±ANRçš„è¿™ç§æƒ…å†µä¸èƒ½cover</p><p>é‰´äºè¯¥é—®é¢˜åªå‡ºç°ä¸€æ¬¡ï¼Œä¸åšä¿®æ”¹</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;code&gt;é—®é¢˜ç°è±¡&lt;/code&gt;&lt;br&gt;æ‰‹æœºè¿æ¥WIFIåå‡ºç°è®¾ç½®å¼¹å‡ºæ— å“åº”çš„å¼¹æ¡†&lt;br&gt;&lt;code&gt;é—®é¢˜æ¦‚ç‡&lt;/code&gt;&lt;br&gt;ä»…å‡ºç°ä¸€æ¬¡&lt;br&gt;&lt;code&gt;é—®é¢˜å¹³å°&lt;/code&gt;&lt;br&gt;Andorid P  é«˜é€šå¹³å°&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æ—¥å¿—åˆ†æ&lt;/str
      
    
    </summary>
    
      <category term="Android" scheme="http://lihaizhou.top/categories/Android/"/>
    
    
  </entry>
  
  <entry>
    <title>ANRçš„å¸¸è§ç±»å‹åŠè§£å†³æ€è·¯</title>
    <link href="http://lihaizhou.top/2019/04/13/ANR%E7%9A%84%E5%B8%B8%E8%A7%81%E7%B1%BB%E5%9E%8B%E5%8F%8A%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF/"/>
    <id>http://lihaizhou.top/2019/04/13/ANRçš„å¸¸è§ç±»å‹åŠè§£å†³æ€è·¯/</id>
    <published>2019-04-13T06:46:41.000Z</published>
    <updated>2019-12-28T07:02:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>å‰å¹´åœ¨ç®€ä¹¦ä¸­æ€»ç»“è¿‡ANRçš„ä¸€èˆ¬è§£å†³æ€è·¯ï¼Œè¿™ä¸¤å¤©æ‹¿å‡ºæ¥çœ‹äº†ä¸‹ï¼Œè§‰å¾—æœ‰å¿…è¦é‡æ–°æ¢³ç†ä¸‹ï¼Œæ·»åŠ äº›è¿‘æœŸé‡åˆ°çš„æ¡ˆä¾‹<br>æœ¬æ–‡æ¡ˆä¾‹ä¸»è¦æºäºé¡¹ç›®ä¸Šå®é™…é‡åˆ°çš„é—®é¢˜ï¼Œå¸Œæœ›é€šè¿‡æ¢³ç†ä¹‹åèƒ½å¤Ÿå¯¹ANRé—®é¢˜èƒ½å¤Ÿå¿«é€Ÿå®šä½ï¼Œå‡å°‘æ’æŸ¥æ—¶é—´ï¼ŒåŒæ—¶åœ¨é‡åˆ°æ£˜æ‰‹é—®é¢˜ï¼Œèƒ½å¤Ÿæ›´åŠ ä»å®¹ã€‚</p><p>å…ˆè¯´ä¸‹ä¸‰ç§å¸¸è§ç±»å‹<br>1ï¼š<code>KeyDispatchTimeout</code>(è°·æ­Œdefault 5sï¼ŒMTKå¹³å°ä¸Šæ˜¯8s) â€“ä¸»è¦ç±»å‹<br>æŒ‰é”®æˆ–è§¦æ‘¸äº‹ä»¶åœ¨ç‰¹å®šæ—¶é—´å†…æ— å“åº”<br>2ï¼š<code>BroadcastTimeout</code>(10s)<br>BroadcastReceiveråœ¨ç‰¹å®šæ—¶é—´å†…æ— æ³•å¤„ç†å®Œæˆ<br>3ï¼š<code>ServiceTimeout</code>(20s) â€“å°æ¦‚ç‡ç±»å‹<br>Serviceåœ¨ç‰¹å®šçš„æ—¶é—´å†…æ— æ³•å¤„ç†å®Œæˆ</p><p><strong>ä¸€èˆ¬è§£å†³æ­¥éª¤</strong></p><p><label style="color:red"><strong>Step1:æ—¥å¿—è·å–&amp;æ³¨æ„äº‹é¡¹</strong></label><br>è·å–æ—¥å¿—æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œå‘ç”ŸANRåï¼Œä¸è¦é€‰æ‹©ç»“æŸè¿›ç¨‹ï¼Œå› ä¸ºè¿™æ ·AMSä¼škillæ‰è¯¥è¿›ç¨‹ï¼Œæœ‰äº›ä¿¡æ¯ä¼šæ‰“å°ä¸å‡ºæ¥ï¼ˆæ¯”å¦‚MTKå¹³å°ä¸Šä¼šç”Ÿæˆdb.XX.ANRï¼Œå†™å…¥åˆ°aee_expæ–‡ä»¶å¤¹ä¸‹éœ€è¦æ—¶é—´ï¼‰ï¼Œæœ€å¥½æ˜¯ANRå‘ç”Ÿåç­‰ä¸¤ä¸‰åˆ†é’Ÿå·¦å³ï¼Œå†è·å–æ—¥å¿—</p><p>ä¸€èˆ¬éœ€è¦data/anrä¸‹ç”Ÿæˆçš„traceæ–‡ä»¶ä»¥åŠæ‰‹æœºç³»ç»Ÿæ—¥å¿—(ä¸€èˆ¬åªéœ€è¦mobileæ–‡ä»¶å¤¹)</p><p>ä»¥MTKä¸ºä¾‹ï¼Œéœ€è¦å¦‚ä¸‹æ—¥å¿—ä¿¡æ¯ï¼š<br>1.aee_expæ–‡ä»¶å¤¹(MTKæ—¥å¿—ç›®å½•ä¸‹ï¼Œå‘ç”ŸANRä¼šç”Ÿæˆ)<br>2.MTKç›®å½•ä¸‹çš„mobilelogæ–‡ä»¶å¤¹</p><p>aee_expæ–‡ä»¶å¤¹ä¸€èˆ¬éƒ½æ˜¯éœ€è¦çš„, å¯¹DBè¿›è¡Œdumpè§£æï¼Œå¾—åˆ°ANRå‘ç”Ÿæ—¶åœºæ™¯ä¿¡æ¯ï¼Œæ¯”å¦‚ä¸»çº¿ç¨‹callstackï¼ŒCPUï¼Œmemoryç­‰ï¼Œåœ¨åˆ†æé—®é¢˜æ ¹å› æ—¶å¾ˆå…³é”®</p><p><label style="color:red"><strong>Step2:æ—¥å¿—åˆ†æä¸€èˆ¬æ­¥éª¤</strong></label></p><p><label style="color:red">Step2.1 ç¡®è®¤æ—¶é—´ç‚¹(éå¿…éœ€)</label><br>mobilelogæ–‡ä»¶å¤¹ä¸‹çš„events_log,æœç´¢å…³é”®å­—â€am_anrâ€,è¿™ä¸€æ­¥ç”¨äºç¡®è®¤ANRæ—¶é—´ç‚¹ï¼Œå¯ä»¥æœç´¢åˆ°ç±»ä¼¼å¦‚ä¸‹ä¿¡æ¯<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">04</span>-<span class="number">29</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">57.240</span> <span class="number">1267</span> <span class="number">1341</span> I am_anr : [<span class="number">0</span>,<span class="number">6073</span>,com.android.dialer,<span class="number">952745541</span>,Input dispatching timed out</span><br></pre></td></tr></table></figure></p><p>æ¯”å¦‚ä¸Šé¢è¿™è¡Œè¡¨ç¤ºANRç±»å‹ä¸º<code>Input dispatching timed out</code>, è¿™ç§anrçš„åŸå› çš„æ˜¯åœ¨viewrootimplåˆ†å‘äº‹ä»¶æ—¶ï¼Œå¹¶æ²¡æœ‰æ‰¾åˆ°focuswindowå¯¼è‡´çš„<br>è¿™ä¸€æ­¥ç¡®è®¤æ—¶é—´ç‚¹åœ¨ï¼š10:00:57,è¿›ç¨‹å·:6073</p><p><label style="color:red">Step2.2: æŸ¥çœ‹ANRæ—¶çš„CPUä»¥åŠIOç‡(å¯é€‰)</label><br>è¿™ä¸€æ­¥ä¸€èˆ¬æ¥è¯´èƒ½åŸºæœ¬å®šä½æ˜¯ä»€ä¹ˆé€ æˆäº†ANRï¼Œæ˜¯IOé«˜è¿˜æ˜¯CPUé«˜ï¼Œå¦‚ä¸¤è€…éƒ½ä¸æ˜¯ï¼Œéœ€è¿›å…¥ç¬¬ä¸‰æ­¥traceæ—¥å¿—åˆ†æç¯èŠ‚<br>æŸ¥çœ‹mobilelogæ–‡ä»¶å¤¹ä¸‹çš„main_log,æœç´¢å…³é”®å­—<code>&quot;ANR in&quot;</code>,å¯ä»¥çœ‹åˆ°å½“æ—¶çš„CPUä»¥åŠIOç‡ï¼Œè¿™ä¸€ä¸ªç¯èŠ‚ä¸€èˆ¬æ¥è®²ä¸»è¦æ˜¯çœ‹å‘ç”ŸANRæ—¶çš„CPUæ˜¯å¦åƒç´§<br>è¿˜æœ‰éœ€è¦æ³¨æ„<code>iowait</code>çš„å æœ‰ç‡ï¼Œå¦‚æœå æ¯”æ¯”è¾ƒé«˜ï¼Œåˆ™æ’æŸ¥çš„æ–¹å‘è¦å€¾å‘ä¸è¯»å–æ–‡ä»¶æ“ä½œæœ‰å…³çš„ä¿¡æ¯ï¼Œå¯ä»¥çœ‹traceæ—¥å¿—ä¸­æœ‰æ²¡æœ‰ä¸€äº›è¯»å–æ–‡ä»¶æˆ–è€…æ“ä½œSDå¡çš„åŠ¨ä½œ</p><p><label style="color:red">Step2.3:åˆ†æANRæ—¶çš„å †æ ˆ(å¿…éœ€ï¼Œæœ€é‡è¦çš„ç¯èŠ‚)</label><br>ANRå‘ç”Ÿä¼šåœ¨data/anrä¸‹ç”Ÿæˆtrace.txtï¼ŒtraceåŠ¡å¿…è¦ä¸moileæ—¥å¿—åŒ¹é…ï¼Œä¸€èˆ¬æ¥è®²ç›´æ¥å…ˆçœ‹tid=1çš„å †æ ˆå³å¯¹åº”ä¸»çº¿ç¨‹ï¼Œå› ä¸ºANRéƒ½æ˜¯ä¸»çº¿ç¨‹æ‰§è¡Œè¶…æ—¶å¯¼è‡´</p><p>å…³äºtraceæ—¥å¿—çš„åˆ†ææ˜¯ANRé—®é¢˜åˆ†ææœ€é‡è¦çš„ä¸€ä¸ªç¯èŠ‚ï¼Œä¸‹é¢å°†åˆ—å‡ºå¹³æ—¶é¡¹ç›®ä¸­é‡åˆ°çš„ANRæ¡ˆä¾‹ç±»å‹</p><p><strong>ANRå¸¸è§ç±»å‹å½’çº³</strong></p><p><label style="color:red">1.ä¸»çº¿ç¨‹Binderè°ƒç”¨ç­‰å¾…è¶…æ—¶</label><br>æ¯”å¦‚ä¸‹é¢çš„è¿™æ®µ<br><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/1_binder%E7%AD%89%E5%BE%85%E8%B6%85%E6%97%B6.png" align="left" style=" width:700px;height:300 px"><br><br><br><br><br><br><br><br><br><br><br><br><br><br>å¾ˆæ˜æ˜¾å½“æ—¶åœ¨åšBinderé€šä¿¡ï¼Œå¹¶æ²¡æœ‰waiting to lockç­‰ä»£è¡¨æ­»é”çš„å­—æ ·ï¼Œé‚£ä¹ˆè¯´æ˜è¿™ä¸ªæ¡ˆä¾‹å³æœ‰å¯èƒ½æ˜¯åœ¨ç­‰Binderå¯¹ç«¯å“åº”ï¼Œæˆ‘ä»¬çŸ¥é“Binderé€šä¿¡å¯¹äºå‘èµ·æ–¹æ¥è¯´æ˜¯é˜»å¡ç­‰å¾…å“åº”ï¼Œåªæœ‰æœ‰äº†è¿”å›ç»“æœåæ‰ä¼šç»§ç»­æ‰§è¡Œä¸‹å»<br>æ‰€ä»¥ï¼Œå¦‚ä¸Šè¿™ä¸ªæ¡ˆä¾‹ä¸­éœ€è¦æ‰¾åˆ°å¯¹ç«¯æ˜¯å“ªä¸ªè¿›ç¨‹ï¼Œè¿™ä¸ªè¿›ç¨‹å½“æ—¶åœ¨åšä»€ä¹ˆï¼Œè¿™æ—¶å€™å°±éœ€è¦æ‰¾åˆ°anræ–‡ä»¶å¤¹ä¸‹å¦å¤–ä¸€ä¸ªæ–‡ä»¶binderinfoï¼Œè¿™é‡Œéœ€è¦æ‰¾åˆ°ä¸æˆ‘ä»¬å‘èµ·æ–¹è¿›ç¨‹1461é€šä¿¡çš„æ˜¯å“ªä¸ªè¿›ç¨‹<br><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/2_binder%E7%AD%89%E5%BE%85%E8%B6%85%E6%97%B6.png" align="left" style=" width:700px;height:300 px"><br><br><br><br><br>å¯ä»¥çœ‹åˆ°æ˜¯1666å·è¿™ä¸ªè¿›ç¨‹ï¼Œå†å›åˆ°traceä¸­çœ‹ä¸‹ï¼Œè¿™ä¸ªè¿›ç¨‹å½“æ—¶åœ¨åšä»€ä¹ˆ<br><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/3_binder%E7%AD%89%E5%BE%85%E8%B6%85%E6%97%B6.png" align="left" style=" width:700px;height:150 px"><br><br><br><br><br><br><br><br><br><br><br><br>å¯ä»¥çœ‹åˆ°å½“æ—¶å¯¹ç«¯åœ¨åšæ¶ˆæ¯çš„è¯»å–ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™é‡Œå‡ºäº†é—®é¢˜ï¼Œå¾ˆæ˜æ˜¾è¿™é‡Œæˆ‘ä»¬æ— æ³•ä¿®æ”¹ï¼Œæˆ‘ä»¬è¿™ä¸ªé—®é¢˜åœ¨äºä¸»çº¿ç¨‹æ‰§è¡Œäº†Binderè¯·æ±‚ï¼Œå¯¹ç«¯è¿Ÿè¿Ÿæœªè¿”å›ä¾¿å¾ˆå®¹æ˜“å‡ºç°è¿™ä¸ªé—®é¢˜ï¼Œå½“å‰åšæ³•å¼‚æ­¥ä¸­æ‰§è¡Œ</p><p><label style="color:red">æ¡ˆä¾‹äºŒï¼šä¸»çº¿ç¨‹ç­‰å¾…é”</label><br>æ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¸»çº¿ç¨‹çš„CallStackä¾‹å­ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š<br><img src="https://raw.githubusercontent.com/hellolihaizhou/saveImg/master/4_%E4%B8%BB%E7%BA%BF%E7%A8%8B%E7%AD%89%E5%BE%85%E9%94%81.png" align="left" style=" width:700px;height:700 px"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>è¿™ä¸ªæ¡ˆä¾‹ä¸­galleryçš„main threadåœ¨æ‰§è¡Œ<code>UploaderChimeraService</code>çš„onDestroyæ–¹æ³•æ—¶ï¼Œéœ€è¦lock 0x23f65d8bï¼Œä½†è¿™ä¸ªlockæœ‰è¢«upload_periodic GCM Task æ‹¿ä½ï¼Œè¿™ä¸ªthreadå½“å‰æ˜¯åœ¨åšè¿æ¥ç½‘ç»œçš„åŠ¨ä½œã€‚ä»è¿™æ®µä¿¡æ¯æ¥çœ‹ï¼Œå¾ˆæœ‰å¯èƒ½ä¸æµ‹è¯•æ—¶æ‰‹æœºè¿æ¥çš„ç½‘ç»œæœ‰å…³ï¼Œå½“æ—¶è¿æ¥çš„äº‹googleçš„ç½‘ç»œï¼Œç”±äºå¢™çš„åŸå› ï¼Œæ— æ³•è¿æ¥gmsçš„ç›¸å…³serveræœ‰å…³</p><p>è¿˜æœ‰ä¸€ç§æƒ…å†µå°±æ˜¯æ­»é”ï¼Œå³å½¢æˆäº†å¤´å°¾ç›¸è¿ï¼Œäº’ç›¸ç­‰å¾…çš„æƒ…å†µï¼Œå¯¹äºè¿™ç§é—®é¢˜ä»¥åŠä¸Šé¢æ¡ˆä¾‹çš„è§£å†³ï¼Œä¸€èˆ¬ä¼šå°è¯•å°†é”æ”¹ä¸ºè¶…æ—¶é”ï¼Œæ¯”å¦‚lockçš„trylockï¼Œè¶…æ—¶ä¼šè‡ªåŠ¨é‡Šæ”¾é”ï¼Œä»è€Œé¿å…ä¸€ç›´æŒæœ‰é”çš„æƒ…å†µå‘ç”Ÿ</p><p><label style="color:red">æ¡ˆä¾‹ä¸‰ï¼šå¡åœ¨IOä¸Š</label><br>è¿™ç§æƒ…å†µä¸€èˆ¬æ˜¯å’Œæ–‡ä»¶æ“ä½œç›¸å…³ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯è¿™ç§æƒ…å†µï¼Œå¯ä»¥çœ‹mainlogä¸­æœç´¢å…³é”®å­—â€ANR inâ€,çœ‹è¿™æ®µä¿¡æ¯çš„æœ€ä¸‹è¾¹ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä¿¡æ¯<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ANRManager: <span class="number">100</span>% TOTAL: <span class="number">2</span>% user + <span class="number">2.1</span>% kernel + <span class="number">95</span>% iowait + <span class="number">0.1</span>% softirq</span><br></pre></td></tr></table></figure></p><p>å¾ˆæ˜æ˜¾ï¼ŒIOå æ¯”å¾ˆé«˜ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦æŸ¥çœ‹traceæ—¥å¿—çœ‹å½“æ—¶çš„callstackï¼Œæˆ–è€…åœ¨è¿™æ®µANRç‚¹å¾€å‰çœ‹0~4sï¼Œçœ‹çœ‹å½“æ—¶åšçš„ä»€ä¹ˆæ–‡ä»¶æ“ä½œï¼Œè¿™ç§åœºæ™¯æœ‰é‡åˆ°è¿‡ï¼Œå¸¸è§è§£å†³æ–¹æ³•æ˜¯å¯¹è€—æ—¶æ–‡ä»¶æ“ä½œé‡‡å–å¼‚æ­¥æ“ä½œ</p><p><label style="color:red">æ¡ˆä¾‹å››ï¼šä¸»çº¿ç¨‹æœ‰è€—æ—¶çš„åŠ¨ä½œ</label><br>è¿™ç§æƒ…å†µæ˜¯ANRç±»å‹é—®é¢˜é‡Œé‡åˆ°æœ€å¤šçš„ï¼Œæ¯”å¦‚ç½‘ç»œè®¿é—®ï¼Œè®¿é—®æ•°æ®åº“ä¹‹ç±»çš„ï¼Œéƒ½å¾ˆå®¹æ˜“é€ æˆä¸»çº¿ç¨‹å µå¡<br>è¿™é‡Œä»¥è®¿é—®æ•°æ®åº“æ¥è¯´ï¼Œè¿™ç±»å‹å¼•èµ·çš„ANRï¼Œä¸€èˆ¬æ¥è®²çœ‹å½“æ—¶çš„CPUä½¿ç”¨æƒ…å†µä¼šå‘ç°userå æ¯”è¾ƒé«˜ï¼Œçœ‹traceä¸­ä¸»çº¿ç¨‹å½“æ—¶çš„ä¿¡æ¯ä¼šå‘ç°ä¼šæœ‰ä¸€äº›æ¯”å¦‚queryåƒContentProviderè¿™ç§æ•°æ®åº“çš„åŠ¨ä½œã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œè¿˜å¯ä»¥å»çœ‹eventlogæˆ–è€…mainlogï¼Œåœ¨ANRå‘ç”Ÿå‰åæ‰“å°å‡ºæ¥çš„ä¿¡æ¯ï¼Œæ¯”å¦‚è®¿é—®æ•°æ®åº“è¿™ç§ï¼Œåœ¨eventlogä¸­æœç´¢<code>&quot;am_anr&quot;</code>,ç„¶åçœ‹å‰åç‰‡æ®µï¼Œä¼šå‘ç°å‘ç”ŸANRçš„è¿™ä¸ªè¿›ç¨‹æœ‰å¾ˆå¤šæ•°æ®åº“ç›¸å…³çš„ä¿¡æ¯ï¼Œè¯´æ˜åœ¨å‘ç”ŸANRå‰åä¸»çº¿ç¨‹ä¸€ç›´åœ¨å¿™äºè®¿é—®æ•°æ®åº“ï¼Œè¿™ç±»å‹çš„é—®é¢˜å¸¸è§äºå›¾åº“ï¼Œè”ç³»äººï¼Œå½©çŸ­ä¿¡åº”ç”¨ã€‚<br>æ‰€ä»¥è¿™ç§é—®é¢˜çš„è§£å†³ï¼Œä¸€èˆ¬è€ƒè™‘çš„æ˜¯å¼‚æ­¥è§£å†³ï¼Œå¼‚æ­¥è§£å†³å¹¶ä¸æ˜¯ç®€å•çš„newä¸€ä¸ªçº¿ç¨‹ï¼Œè¦æ ¹æ®ä¸šåŠ¡åœºæ™¯ä»¥åŠé¢‘ç‡æ¥å†³å®šï¼ŒAndroidå¸¸è§çš„å¼‚æ­¥AsyncTask, IntentService, çº¿ç¨‹æ± (å®˜æ–¹å››ç§æˆ–è‡ªå®šä¹‰), new threadç­‰ï¼Œä¸€èˆ¬æ¥è¯´ä¸å»ºè®®ç›´æ¥new thread</p><p><label style="color:red">æ¡ˆä¾‹äº”ï¼šbinderçº¿ç¨‹æ± è¢«å æ»¡</label><br>ç³»ç»Ÿå¯¹æ¯ä¸ªprocessæœ€å¤šåˆ†é…15ä¸ªbinderçº¿ç¨‹ï¼Œè¿™ä¸ªæ˜¯è°·æ­Œçš„è®¾è®¡ï¼ˆ/frameworks/native/libs/binder/ProcessState.cpp)<br>å¦‚æœå¦ä¸€ä¸ªprocesså‘é€å¤ªå¤šé‡å¤binderè¯·æ±‚ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´æ¥æ”¶ç«¯binderçº¿ç¨‹è¢«å æ»¡ï¼Œä»è€Œå¤„ç†ä¸äº†å…¶å®ƒçš„binderè¯·æ±‚<br>è¿™æœ¬èº«å°±æ˜¯ç³»ç»Ÿçš„ä¸€ä¸ªé™åˆ¶ï¼Œå¦‚æœåº”ç”¨æœªæŒ‰ç…§ç³»ç»Ÿçš„è¦æ±‚æ¥å®ç°å¯¹åº”é€»è¾‘ï¼Œé‚£ä¹ˆå°±ä¼šé€ æˆé—®é¢˜ã€‚<br>è€Œç³»ç»Ÿç«¯æ˜¯ä¸ä¼šï¼ˆä¹Ÿä¸å»ºè®®ï¼‰é€šè¿‡ä¿®æ”¹ç³»ç»Ÿè¡Œä¸ºæ¥å…¼å®¹åº”ç”¨é€»è¾‘ï¼Œå¦åˆ™æ›´å®¹æ˜“é€ æˆå…¶å®ƒæ ¹æ®ç³»ç»Ÿéœ€æ±‚æ­£å¸¸ç¼–å†™çš„åº”ç”¨åè€Œå‡ºç°ä¸å¯é¢„æ–™çš„é—®é¢˜ã€‚<br>åˆ¤æ–­Binderæ˜¯å¦ç”¨å®Œï¼Œå¯åœ¨traceä¸­æœå…³é”®å­—â€binder_fâ€ï¼Œå¦‚æœç´¢åˆ°è¡¨ç¤ºå·²ç”¨å®Œï¼Œç„¶åå°±è¦æ‰¾logå…¶ä»–åœ°æ–¹çœ‹æ˜¯è°ä¸€ç›´åœ¨æ¶ˆè€—binderæˆ–è€…æ˜¯æœ‰æ­»é”å‘ç”Ÿ<br>ä¹‹å‰æœ‰é‡åˆ°è¿‡å‹åŠ›æµ‹è¯•æ‰‹ç”µç­’åº”ç”¨ï¼Œå‡ºç°BInderçº¿ç¨‹æ± è¢«å æ»¡æƒ…å†µï¼Œè§£å†³çš„æ€è·¯å°±æ˜¯é™ä½æçŸ­æ—¶é—´å†…å¤§é‡Binderè¯·æ±‚çš„å‘ç”Ÿï¼Œä¿®å¤çš„æ‰‹æ³•æ˜¯å‘é€BInderè¯·æ±‚çš„å‡½æ•°ä¸­åšæ—¶é—´å·®è¿‡æ»¤ï¼Œé™å®šåœ¨500mså†…æœ€å¤šæ‰§è¡Œä¸€æ¬¡</p><p><label style="color:red">æ¡ˆä¾‹å…­ï¼šJEæˆ–è€…NEå¯¼è‡´ANR</label><br>è¿™ç§åœºæ™¯æœ‰é‡åˆ°è¿‡ï¼ŒANRå‰å‡ºç°é¢‘ç¹NEï¼ŒNEæ‰€åœ¨çš„è¿›ç¨‹ä¸ANRçš„è¿›ç¨‹æœ‰äº¤äº’ï¼Œåœ¨è§£å†³äº†NEåï¼ŒANRä¹Ÿä¸å¤å­˜åœ¨ï¼Œå¯¹äºè¿™ç±»åœ¨ANRå‰æœ‰JEæˆ–è€…NEï¼Œä¸€èˆ¬æ€è·¯æ˜¯å…ˆè§£å†³JEæˆ–NEï¼Œå†æ¥çœ‹ANRæ˜¯å¦è¿˜å­˜åœ¨ï¼Œå¦‚æœè¿˜å­˜åœ¨ï¼Œé‚£ä¹ˆå°±çœ‹trace å †æ ˆï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™å¯ä»¥åŸºæœ¬åˆ¤å®šæ˜¯JEæˆ–NEå¯¼è‡´</p><p><label style="color:red">æ¡ˆä¾‹ä¸ƒï¼šåªå­˜åœ¨äºMonkeyæµ‹è¯•ä¸‹</label><br>æœ‰äº›é—®é¢˜æ˜¯åªæœ‰åœ¨Monkeyç¯å¢ƒä¸‹æ‰èƒ½è·‘å‡ºæ¥ï¼Œå¹³æ—¶çš„userç‰ˆæœ¬ç”¨æˆ·ä½¿ç”¨æ˜¯ä¸ä¼šå‡ºç°çš„ï¼Œè¿™ç§é—®é¢˜çš„è¯å°±æ²¡æœ‰æ”¹åŠ¨çš„æ„ä¹‰ã€‚<br>æ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ActivityManager: Not finishing activity because controller resumed</span><br><span class="line"><span class="number">03</span>-<span class="number">18</span> <span class="number">07</span>:<span class="number">25</span>:<span class="number">50.901</span> <span class="number">810</span> <span class="number">870</span> I am_anr : [<span class="number">0</span>,<span class="number">25443</span>,android.process.media,<span class="number">1086897733</span>,<span class="function">Input dispatching timed <span class="title">out</span> <span class="params">(Waiting because no window has focus but there is a focused application that may eventually add a window when it finishes starting up.)</span>]</span></span><br></pre></td></tr></table></figure></p><p>å‘ç”Ÿè¿™ä¸ªANRçš„åŸå› æ˜¯Contollerå°†resumeçš„æ“ä½œç»™æ‹¦æˆªäº†, å¯¼è‡´Focusä¸è¿‡å», ä»è€Œå¯¼è‡´ANRï¼ŒUserç‰ˆæœ¬ä¸ä¼šæœ‰Contoller, æ‰€ä»¥ä¸ä¼šå‡ºç°è¿™ä¸ª ANR. æ‰€ä»¥è¿™ä¸ª ANR å¯ä»¥å¿½ç•¥.</p><hr><font color="#000000" size="2" face="æ¥·ä½“">æ˜¥å’Œæ—¥ä¸½çš„å‘¨æœ«ï¼Œåˆå</font>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;å‰å¹´åœ¨ç®€ä¹¦ä¸­æ€»ç»“è¿‡ANRçš„ä¸€èˆ¬è§£å†³æ€è·¯ï¼Œè¿™ä¸¤å¤©æ‹¿å‡ºæ¥çœ‹äº†ä¸‹ï¼Œè§‰å¾—æœ‰å¿…è¦é‡æ–°æ¢³ç†ä¸‹ï¼Œæ·»åŠ äº›è¿‘æœŸé‡åˆ°çš„æ¡ˆä¾‹&lt;br&gt;æœ¬æ–‡æ¡ˆä¾‹ä¸»è¦æºäºé¡¹ç›®ä¸Šå®é™…é‡åˆ°çš„é—®é¢˜ï¼Œå¸Œæœ›é€šè¿‡æ¢³ç†ä¹‹åèƒ½å¤Ÿå¯¹ANRé—®é¢˜èƒ½å¤Ÿå¿«é€Ÿå®šä½ï¼Œå‡å°‘æ’æŸ¥æ—¶é—´ï¼ŒåŒæ—¶åœ¨é‡åˆ°æ£˜æ‰‹é—®é¢˜ï¼Œèƒ½å¤Ÿæ›´åŠ ä»å®¹ã€‚&lt;/p&gt;
&lt;p&gt;å…ˆè¯´ä¸‹ä¸‰ç§å¸¸è§ç±»
      
    
    </summary>
    
      <category term="Android" scheme="http://lihaizhou.top/categories/Android/"/>
    
    
  </entry>
  
  <entry>
    <title>Launcheråº”ç”¨çš„é‡æ„ä¹‹è·¯</title>
    <link href="http://lihaizhou.top/2019/04/12/Launcher%E5%BA%94%E7%94%A8%E7%9A%84%E9%87%8D%E6%9E%84%E4%B9%8B%E8%B7%AF/"/>
    <id>http://lihaizhou.top/2019/04/12/Launcheråº”ç”¨çš„é‡æ„ä¹‹è·¯/</id>
    <published>2019-04-12T12:19:11.000Z</published>
    <updated>2020-06-21T08:24:02.033Z</updated>
    
    <content type="html"><![CDATA[<p><strong>å½“å‰éœ€æ±‚</strong><br>æ–°é¡¹ç›®éµå¾ªç«å“çš„Launcheræ ·å¼è®¾è®¡<br><strong>å½“å‰è®¡åˆ’</strong><br>é‡æ–°ç¼–å†™Launcherï¼Œå¹¶å°½å¯èƒ½çš„å¼¥è¡¥è€æ¡†æ¶çš„ä¸è¶³</p><p><strong>ä¸ºä»€ä¹ˆéœ€è¦é‡å†™Launcherï¼Ÿ</strong><br>ä»æ ·å¼ä¸Šæ¥çœ‹<br>æ–°ç‰ˆLauncherçš„UIæ˜¾ç¤ºä¸Šä¸è€ç‰ˆæœ¬å·®å¼‚è¾ƒå¤§ï¼Œå·¦å³æ»‘åŠ¨çš„èœå•é¡µå˜åŒ–æœ€å¤§<br>ä»ä»£ç ç»“æ„ä¸Šçœ‹<br>ä¸€. ä¸ç¬¦åˆå•ä¸€åŸåˆ™:  è§†å›¾å±‚æ‰¿æ‹…è¿‡é‡çš„ä¸šåŠ¡æ•°æ®å¤„ç†é€»è¾‘, è€ç‰ˆæœ¬çš„è§†å›¾å±‚ä»£ç é‡æ¯”è¾ƒå¤§ï¼Œä¸»ActivityåŠLauncherServiceå‡è¿‘ä¸¤åƒè¡Œï¼Œæ‰¿æ‹…çš„ä»»åŠ¡è¿‡é‡ã€‚å…¶ä¸­åŒ…å«äº†Viewçš„æ˜¾ç¤ºé€»è¾‘ï¼Œä¹Ÿæœ‰æ•°æ®å¤„ç†çš„é€»è¾‘ï¼Œä¹Ÿæœ‰æ¥æ”¶å¹¿æ’­ç›¸å…³ï¼Œä¹Ÿæœ‰ä¸Fwkçš„ç½‘ç»œæ¥å£äº¤äº’å¤„ç†çš„é€»è¾‘ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–åº”ç”¨éœ€è¦åœ¨è¿”å›Launcheråå¯¹è‡ªèº«çš„ä¸€äº›åˆ¤æ–­é€»è¾‘ç­‰ã€‚<br>äºŒ. ä»æ•´ä¸ªåº”ç”¨çš„è§’åº¦æ¥çœ‹ï¼Œå¾ˆå¤šç•Œé¢å­˜åœ¨é‡å¤çš„å†—ä½™å·¥ä½œï¼Œæ¯”å¦‚åˆ¤æ–­æ¥æ”¶loginå¹¿æ’­ï¼Œåˆ¤æ–­ç”µé‡ï¼Œåˆ¤æ–­æ˜¯å¦é«˜æ¸©ï¼ŒjsonæŠ¥æ–‡çš„è§£æç­‰ï¼Œéœ€è¦æŠ½å–å…¬å…±çš„è¡Œä¸ºå°è£…å¹¶ä¸‹æ²‰ï¼Œå°½å¯èƒ½çš„ä½¿ä¸Šå±‚çš„å¤„ç†ä¼˜é›…ä¸”ç®€å•<br>ä¸‰. é¡µé¢é—´çš„è€¦åˆä¸¥é‡ï¼Œå½¼æ­¤ç›¸äº’æŒæœ‰ï¼Œéš¾ä»¥å‰¥ç¦»å¼€æ¥ï¼Œä¸”é¡¹ç›®ä»£ç ä¸­å¤§å¤šç¼ºå°‘æ³¨é‡Šï¼Œç†è§£ä¸Šå­˜åœ¨éš¾åº¦</p><p>ç»¼åˆè€ƒè™‘è§‰å¾—é‡‡å–é‡å†™æˆ–è®¸ä¼šåˆé€‚äº›</p><p><strong>å‰æœŸç ”ç©¶</strong><br>å½“å‰å¸‚é¢ä¸Šå­˜åœ¨MVP,MVVMç­‰ç­‰æ¶æ„ï¼Œå…ˆå¯¹è¿™äº›æ¶æ„åšç®€å•ä»‹ç»</p><label style="color:red">ä¸€. MVC</label><br>MVCå…¨åæ˜¯<code>Model View Controller</code>ï¼Œæ˜¯æ¨¡å‹(<code>model</code>)ï¼è§†å›¾(<code>view</code>)ï¼æ§åˆ¶å™¨(<code>controller</code>)çš„ç¼©å†™<br>å…¶ä¸­Må±‚å¤„ç†æ•°æ®ï¼Œä¸šåŠ¡é€»è¾‘ç­‰ï¼›Vå±‚å¤„ç†ç•Œé¢çš„æ˜¾ç¤ºç»“æœï¼›Cå±‚èµ·åˆ°æ¡¥æ¢çš„ä½œç”¨ï¼Œæ¥æ§åˆ¶Vå±‚å’ŒMå±‚é€šä¿¡ä»¥æ­¤æ¥è¾¾åˆ°åˆ†ç¦»è§†å›¾æ˜¾ç¤ºå’Œä¸šåŠ¡é€»è¾‘å±‚<br><img src="https://github.com/hellolihaizhou/saveImg/blob/master/1_MVC.png?raw=true" align="left" style=" width:300px;height:100 px"><br><br><br><br><br><br><br><br>è§†å›¾å±‚(<code>View</code>)<br>ä¸€èˆ¬é‡‡ç”¨<code>XML</code>æ–‡ä»¶è¿›è¡Œç•Œé¢çš„æè¿°<br>æ§åˆ¶å±‚(<code>Controller</code>)<br>Androidçš„Controllerå±‚çš„é‡ä»»é€šå¸¸è½åœ¨äº†ä¼—å¤šçš„Activityçš„è‚©ä¸Šï¼Œè¿™ä¹Ÿæ˜¯MVCæ¶æ„çš„ä¸€å¤§å¼Šç—…<br>æ¨¡å‹å±‚(<code>Model</code>)<br>Modelæ˜¯ä¸Viewæ— å…³ï¼Œä¸ä¸šåŠ¡ç›¸å…³çš„ï¼Œå¯¹æ•°æ®åº“çš„æ“ä½œã€å¯¹ç½‘ç»œç­‰çš„æ“ä½œéƒ½åº”è¯¥åœ¨Modelé‡Œé¢å¤„ç†ï¼Œå¯¹ä¸šåŠ¡è®¡ç®—ç­‰æ“ä½œä¹Ÿæ˜¯å¿…é¡»æ”¾åœ¨çš„è¯¥å±‚çš„ã€‚<br>1. Viewæ¥å—ç”¨æˆ·çš„äº¤äº’è¯·æ±‚ï¼›<br>2. Viewå°†è¯·æ±‚è½¬äº¤ç»™Controllerï¼›<br>3. Controllerï¼ˆç”¨æˆ·åšçš„åŠ¨ä½œæ¯”å¦‚ï¼šupdateæ•°æ®ï¼Œåˆ é™¤æŒ‡å®šåå­—çš„å­¦ç”Ÿç­‰ç­‰ï¼‰æ“ä½œModelè¿›è¡Œæ•°æ®æ›´æ–°ï¼ˆæ ¹æ®ç”¨æˆ·æŒ‡ç¤ºï¼Œæ‰§è¡Œåº•å±‚çš„æ•°æ®åŠ¨ä½œç­‰ç­‰ï¼‰ï¼›<br>4. æ•°æ®æ›´æ–°ä¹‹åï¼ŒModelé€šçŸ¥Viewæ•°æ®å˜åŒ–ï¼›<br>5. Viewæ˜¾ç¤ºæ›´æ–°ä¹‹åçš„æ•°æ®ï¼›<br><br>ä¸¾ä¸ªä¾‹å­: Launcherä¸­ä¸‹æ‹‰çŠ¶æ€æ æ˜¾ç¤ºå¤©æ°”çš„åŠ¨ä½œï¼Œå¦‚æœæ˜¯ç”¨<code>MVC</code>çš„æ¶æ„ï¼Œåˆ™å¤§æ¦‚æ˜¯è¿™æ ·çš„ä¸€ä¸ªè¿‡ç¨‹:<br>Viewå³çŠ¶æ€æ æ¥æ”¶åˆ°ç”¨æˆ·ä¸‹æ‹‰çš„åŠ¨ä½œï¼Œæ­¤æ—¶Cå±‚å³Activityå‘Må±‚è¯·æ±‚å¤©æ°”çš„æ•°æ®ï¼ŒMå±‚è·å–å¤©æ°”çš„æ–¹æ³•è¢«è°ƒç”¨åï¼Œè·å–å¤©æ°”æ— è®ºæˆåŠŸæˆ–å¤±è´¥ï¼Œéƒ½ä¼šå°†çŠ¶æ€é€šçŸ¥ç»™ç›‘å¬è€…è¿™é‡Œå³Cå±‚è¿›è¡Œè§†å›¾æ›´æ–°ï¼Œè¿™é‡Œçš„é€šçŸ¥é€šè¿‡æ¥å£å›è°ƒæ–¹å¼ï¼Œå³Cå±‚éœ€è¦å®ç°å¤©æ°”æ˜¯å¦æˆåŠŸçš„æ¥å£æ¯”å¦‚onError, onSuccess<br><br>å¼Šç«¯:<br>ç¬¬ä¸€ï¼ŒViewå±‚å’ŒControllerå±‚æ²¡æœ‰åˆ†ç¦»ï¼Œé€»è¾‘æ¯”è¾ƒæ··ä¹±ï¼›<br>ç¬¬äºŒï¼ŒåŒæ ·å› ä¸º Viewå’Œ Controllerå±‚çš„è€¦åˆï¼Œå¯¼è‡´Activityæˆ–è€…Fragmentå¾ˆè‡ƒè‚¿ï¼Œä»£ç é‡å¾ˆå¤§ã€‚å¦‚æœActivity ä¸­çš„ä¸šåŠ¡é‡å¾ˆå¤§ï¼Œå°±åƒæˆ‘ä»¬çš„è€ç‰ˆLauncherï¼Œé‚£ä¹ˆé—®é¢˜å°±ä¼šä½“ç°å‡ºæ¥ï¼Œä¸€ä¸ªActivityçš„ä»£ç è¡Œæ•°é«˜è¾¾è¿‘2000è¡Œ<br><br><label style="color:red">äºŒ.MVP(å¯¹MVCçš„æ”¹è¿›ç‰ˆ)</label><br><code>Presenter</code>è´Ÿè´£é€»è¾‘çš„å¤„ç†ï¼ŒModelæä¾›æ•°æ®ï¼ŒViewè´Ÿè´£æ˜¾ç¤º<br><img src="https://github.com/hellolihaizhou/saveImg/blob/master/2_MVP.png?raw=true" align="left" style=" width:300px;height:100 px"><br><br><br><br><br><br><br><br><code>MVP</code>æ¡†æ¶ç”±3éƒ¨åˆ†ç»„æˆï¼š<code>View</code>è´Ÿè´£æ˜¾ç¤ºï¼Œ<code>Presenter</code>è´Ÿè´£é€»è¾‘å¤„ç†ï¼Œ<code>Model</code>æä¾›æ•°æ®ã€‚åœ¨MVPæ¨¡å¼é‡Œé€šå¸¸åŒ…å«3ä¸ªè¦ç´ ï¼ˆåŠ ä¸ŠView interfaceæ˜¯4ä¸ªï¼‰ï¼š<br>View:è´Ÿè´£ç»˜åˆ¶UIå…ƒç´ ã€ä¸ç”¨æˆ·è¿›è¡Œäº¤äº’(åœ¨Androidä¸­ä½“ç°ä¸ºActivity)<br><code>Model</code>:è´Ÿè´£å­˜å‚¨ã€æ£€ç´¢ã€æ“çºµæ•°æ®(æœ‰æ—¶ä¹Ÿå®ç°ä¸€ä¸ªModel interfaceç”¨æ¥é™ä½è€¦åˆ)<br><code>Presenter</code>:ä½œä¸ºViewä¸Modeläº¤äº’çš„ä¸­é—´çº½å¸¦ï¼Œå¤„ç†ä¸ç”¨æˆ·äº¤äº’çš„è´Ÿè´£é€»è¾‘ã€‚<br><code>View interface</code>:éœ€è¦Viewå®ç°çš„æ¥å£ï¼ŒViewé€šè¿‡View interfaceä¸Presenterè¿›è¡Œäº¤äº’ï¼Œé™ä½è€¦åˆï¼Œæ–¹ä¾¿è¿›è¡Œå•å…ƒæµ‹è¯•<br><br>æ˜¾è€Œæ˜“è§çš„å˜åŒ–æ—¶å¼•å…¥äº†På±‚ï¼Œæ¥æ‰¿æ‹…ä¹‹å‰Cå±‚çš„å·¥ä½œï¼Œè€ŒActivityçš„è§’è‰²å˜æˆäº†ä»…ä»…æ˜¾ç¤ºçš„Vå±‚ï¼Œä½†æ˜¯è€ƒè™‘åˆ°Vå±‚éœ€è¦å’ŒPå±‚äº¤äº’ï¼Œæ‰€ä»¥è¿™é‡Œå¢åŠ äº†ä¸€å±‚æ¥å£å±‚View interface<br>æ¦‚è¿°ä¸‹æ¥å°±æ˜¯:<br>å½“ View éœ€è¦æ›´æ–°æ•°æ®æ—¶ï¼Œé¦–å…ˆå»æ‰¾ Presenterï¼Œç„¶å Presenter å»æ‰¾ Model è¯·æ±‚æ•°æ®ï¼ŒModel è·å–åˆ°æ•°æ®ä¹‹åé€šçŸ¥ Presenterï¼ŒPresenter å†é€šçŸ¥ View æ›´æ–°æ•°æ®ï¼Œè¿™æ · Model å’Œ View å°±ä¸ä¼šç›´æ¥äº¤äº’äº†ï¼Œæ‰€æœ‰çš„äº¤äº’éƒ½ç”± Presenter è¿›è¡Œï¼ŒPresenter å……å½“äº†æ¡¥æ¢çš„è§’è‰²ã€‚å¾ˆæ˜¾ç„¶ï¼ŒPresenter å¿…é¡»åŒæ—¶æŒæœ‰ View å’Œ Model çš„å¯¹è±¡çš„å¼•ç”¨ï¼Œæ‰èƒ½åœ¨å®ƒä»¬ä¹‹é—´è¿›è¡Œé€šä¿¡<br>å¥½å¤„å¾ˆæ˜æ˜¾: viewä¸modelå®Œå…¨è§£è€¦ï¼Œå®ƒä»¬çš„é€šä¿¡éƒ½è¦ç»è¿‡presenter<br>å¼Šç«¯ä¹Ÿæ˜¾è€Œæ˜“è§: presenterä¼šè¿‡äºå¤æ‚åºå¤§ ,  viewä¸presenteräº¤äº’é¢‘ç¹ï¼Œè€¦åˆåº¦é«˜ , presenteræŒæœ‰activityå¼•ç”¨ï¼Œå¯èƒ½å¼•èµ·å†…å­˜æ³„éœ²ï¼Œéœ€è¦åœ¨Activityé€€å‡ºæ—¶åšé¢å¤–å¤„ç†<br>è¿˜ä»¥æˆ‘ä»¬çš„Launcherä¸‹æ‹‰çŠ¶æ€æ ä¸ºä¾‹ï¼Œå¦‚æœæ˜¯ç”¨MVPçš„æ¶æ„ï¼Œåˆ™å¤§æ¦‚æ˜¯è¿™æ ·çš„ä¸€ä¸ªè¿‡ç¨‹:<br>ä¸‹æ‹‰çŠ¶æ€æ åŠ¨ä½œè§¦å‘åï¼Œè°ƒç”¨Presenterä¸­è¯·æ±‚å¤©æ°”çš„æ¥å£ï¼Œå°†è‡ªèº«ä¼ è¿›å»ï¼ŒPresenterçš„è¯·æ±‚æ–¹æ³•æ‹¿åˆ°Activityçš„å¼•ç”¨ï¼Œå¹¶åœ¨è¯¥è¯·æ±‚æ–¹æ³•ä¸­è°ƒç”¨Modelçš„è¯·æ±‚æ•°æ®æ–¹æ³•ï¼ŒåŒæ ·å°†è‡ªèº«ä¼ è¿›å»ï¼ŒModelå±‚è·å–æ•°æ®åæ— è®ºå¤±è´¥ä¸å¦éƒ½ä¼šå›è°ƒPresenterçš„å¤„ç†ç»“æœæ–¹æ³•ï¼ŒPresenterçš„å¤„ç†ç»“æœæ–¹æ³•ä¼šå›è°ƒViewçš„å¤„ç†ç»“æœæ–¹æ³•ï¼Œè¿™æ ·Viewå±‚æ‹¿åˆ°æ•°æ®å¹¶åšè§†å›¾æ›´æ–°<br>è¿™é‡Œçš„å®ç°å¸¸ç”¨åšæ³•ä¸€èˆ¬ä¼šå°†Presenterå’ŒModelå±‚çš„æ¥å£æŠ½å–å‡ºæ¥ï¼Œå†™å¯¹åº”çš„å®ç°ç±»ï¼Œå±‚æ¬¡ä¸Šçœ‹çš„æ›´åˆ†æ˜äº›<br><br><label style="color:red">ä¸‰.MVVM</label><br><code>MVVM</code>å¯ä»¥ç®—æ˜¯<code>MVP</code>çš„å‡çº§ç‰ˆï¼Œå…¶ä¸­çš„VMæ˜¯<code>ViewModel</code>çš„ç¼©å†™ï¼ŒViewModelå¯ä»¥ç†è§£æˆæ˜¯Viewçš„æ•°æ®æ¨¡å‹å’ŒPresenterçš„åˆä½“ï¼ŒViewModelå’ŒViewä¹‹é—´çš„äº¤äº’é€šè¿‡Data Bindingå®Œæˆï¼Œè€ŒData Bindingå¯ä»¥å®ç°åŒå‘çš„äº¤äº’ï¼Œè¿™å°±ä½¿å¾—è§†å›¾å’Œæ§åˆ¶å±‚ä¹‹é—´çš„è€¦åˆç¨‹åº¦è¿›ä¸€æ­¥é™ä½ï¼Œå…³æ³¨ç‚¹åˆ†ç¦»æ›´ä¸ºå½»åº•ï¼ŒåŒæ—¶å‡è½»äº†Activityçš„å‹åŠ›ã€‚<br><img src="https://github.com/hellolihaizhou/saveImg/blob/master/3_MVVM.png?raw=true" align="left" style=" width:600px;height:200 px"><br><br><br><br><br><br><br>MVVMæ¶æ„é€šè¿‡<code>ViewModel</code>éš”ç¦»äº†UIå±‚å’Œä¸šåŠ¡é€»è¾‘å±‚ï¼Œé™ä½ç¨‹åºçš„è€¦åˆåº¦ã€‚é€šè¿‡<code>DataBinding</code>å®ç°<code>View</code>å’Œ<code>ViewModel</code>ä¹‹é—´çš„ç»‘å®šã€‚<br>å¥½å¤„:<br>åœ¨MVVMä¸­ï¼Œè¿™äº›éƒ½æ˜¯é€šè¿‡æ•°æ®é©±åŠ¨æ¥è‡ªåŠ¨å®Œæˆçš„ï¼Œæ•°æ®å˜åŒ–åä¼šè‡ªåŠ¨æ›´æ–°UIï¼ŒUIçš„æ”¹å˜ä¹Ÿèƒ½è‡ªåŠ¨åé¦ˆåˆ°æ•°æ®å±‚ï¼Œæ•°æ®æˆä¸ºä¸»å¯¼å› ç´ ã€‚è¿™æ ·MVVMå±‚åœ¨ä¸šåŠ¡é€»è¾‘å¤„ç†ä¸­åªè¦å…³å¿ƒæ•°æ®ï¼Œä¸éœ€è¦ç›´æ¥å’ŒUIæ‰“äº¤é“ï¼Œåœ¨ä¸šåŠ¡å¤„ç†è¿‡ç¨‹ä¸­ç®€å•æ–¹ä¾¿å¾ˆå¤š<br>MVVMæ¨¡å¼ä¸­ï¼Œæ•°æ®æ˜¯ç‹¬ç«‹äºUIçš„<br>åœ¨MVVMä¸­ï¼Œæ•°æ®å‘ç”Ÿå˜åŒ–åï¼Œæˆ‘ä»¬åœ¨å·¥ä½œçº¿ç¨‹ç›´æ¥ä¿®æ”¹ï¼ˆåœ¨æ•°æ®æ˜¯çº¿ç¨‹å®‰å…¨çš„æƒ…å†µä¸‹ï¼‰ViewModelçš„æ•°æ®å³å¯ï¼Œä¸ç”¨å†è€ƒè™‘è¦åˆ‡åˆ°ä¸»çº¿ç¨‹æ›´æ–°UIäº†ï¼Œè¿™äº›äº‹æƒ…ç›¸å…³æ¡†æ¶éƒ½å¸®æˆ‘ä»¬åšäº†<br>å…³äºMVVMä¸åšå¤šä»‹ç»ï¼Œæœ€å¤§çš„å˜åŒ–æ— éå°±æ˜¯å¼•å…¥äº†<code>Data Binding</code>ï¼Œä½¿å¾—æ•°æ®æˆä¸ºæ ¸å¿ƒé©±åŠ¨<br><br><code>MVC</code> -&gt; <code>MVP</code> -&gt; <code>MVVM</code> è¿™å‡ ä¸ªè½¯ä»¶è®¾è®¡æ¨¡å¼æ˜¯ä¸€æ­¥æ­¥æ¼”åŒ–å‘å±•çš„ï¼Œ<code>MVVM</code>æ˜¯ä» <code>MVP</code>çš„è¿›ä¸€æ­¥å‘å±•ä¸è§„èŒƒï¼Œ<code>MVP</code> éš”ç¦»äº†<code>MVC</code>ä¸­çš„ M ä¸ V çš„ç›´æ¥è”ç³»åï¼Œé  Presenter æ¥ä¸­è½¬ï¼Œæ‰€ä»¥ä½¿ç”¨<code>MVP</code> æ—¶ P æ˜¯ç›´æ¥è°ƒç”¨ View çš„æ¥å£æ¥å®ç°å¯¹è§†å›¾çš„æ“ä½œçš„ï¼Œè¿™ä¸ª View æ¥å£çš„ä¸œè¥¿ä¸€èˆ¬æ¥è¯´æ˜¯<code>showData</code>ã€<code>showprogress</code>ç­‰ã€‚M ä¸ Vå·²ç»éš”ç¦»äº†ï¼Œæ–¹ä¾¿æµ‹è¯•äº†ï¼Œä½†ä»£ç è¿˜ä¸å¤Ÿä¼˜é›…ç®€æ´ï¼Œæ‰€ä»¥ <code>MVVM</code>å°±å¼¥è¡¥äº†è¿™äº›ç¼ºé™·ã€‚åœ¨ MVVM ä¸­å°±å‡ºç°çš„ <code>Data Binding</code> è¿™ä¸ªæ¦‚å¿µï¼Œæ„æ€å°±æ˜¯ View æ¥å£çš„ showData è¿™äº›å®ç°æ–¹æ³•å¯ä»¥ä¸å†™äº†ï¼Œé€šè¿‡Data Binding æ¥è‡ªåŠ¨å®ç°<br><br>è€ç‰ˆlauncherçš„å¯ä»¥è®¤ä¸ºæ˜¯VCç»“æ„ï¼ŒMçš„æ•°æ®å¤„ç†å†…å®¹å¤šæ”¾åœ¨Cå±‚æˆ–è€…utilåŒ…ä¸­ï¼ŒutilsåŒ…ä¸‹è¿˜æ˜¯ç›´æ¥æŒæœ‰å¼•ç”¨è°ƒç”¨ï¼Œæ‰€ä»¥åªæœ‰ä¸¤å±‚Vå’ŒC<br><br>ç ”ç©¶ä¸‹æ¥ï¼Œè§‰å¾—å¦‚ä¸Šçš„ä¸‰ç§æ¨¡å¼éƒ½ä¸å¤ªé€‚åˆæˆ‘ä»¬çš„é¡¹ç›®ï¼Œç†ç”±å¦‚ä¸‹<br>1. MVCåˆ°æ”¹è¿›ç‰ˆMVPå†åˆ°åæœŸçš„MVVMæ¶æ„ï¼ŒMVCæœ¬è´¨ä¸Šæ˜¯MCæ¶æ„ï¼ŒModelä¸Controlå±‚è€¦åˆä¸¥é‡ï¼ŒMVPåœ¨MVCçš„åŸºç¡€ä¸Šå¢åŠ ä¸€å±‚æ¥å£è§£è€¦ï¼ŒMVVMåœ¨MVPçš„åŸºç¡€ä¸Šåˆå¢åŠ äº†ä¸€å±‚æ¥å£ï¼Œè™½è€¦åˆæ€§è¿›ä¸€æ­¥é™ä½ï¼Œä½†æ˜¯å­˜åœ¨å¾ˆå¤šçš„æ¥å£å®šä¹‰å¯¼è‡´ä»£ç çš„å¯è¯»æ€§é™ä½<br>2. å¯åˆ‡å…¥æ€§ä¸å¼º: ä¸åˆ©äºå›¢é˜ŸåŒäº‹å¿«é€ŸåŠ å…¥é€‚åº”ï¼Œå­˜åœ¨å­¦ä¹ æˆæœ¬<br>3. å¦‚ä¸Šçš„ä¸‰ç§æ¨¡å¼æœ¬è´¨å…¶å®æ˜¯æ€æƒ³çš„æ¼”å˜ï¼Œè¾¹ç•Œå¹¶ä¸æ˜¯å¾ˆæ˜æ˜¾ï¼Œåªè¦èƒ½å¤Ÿå¾ˆå¥½åœ°è§£è€¦å°±æ˜¯æœ€å¥½çš„è§£å†³æ–¹æ³•<br><br><label style="color:red">ç»¼åˆæ¯”è¾ƒä¸‹æ¥ï¼Œå†³å®šæ ¹æ®æˆ‘ä»¬è‡ªèº«ä¸šåŠ¡å®šåˆ¶ï¼Œé‡‡ç”¨Model+View+äº‹ä»¶æ€»çº¿çš„æ–¹å¼</label><p><strong>Step1: åˆ†å±‚ç»“æ„</strong><br><img src="https://github.com/hellolihaizhou/saveImg/blob/master/4_%E5%88%86%E5%B1%82%E7%BB%93%E6%9E%84.png?raw=true" align="left" style=" width:700px;height:200 px"><br><br><br><br><br><br><br><br><br><br>è¿™æ˜¯æˆ‘ä»¬Launcherçš„åˆ†å±‚ç»“æ„<br>ä¸šåŠ¡é€»è¾‘å±‚ï¼š<br>ç”±ä¸šåŠ¡éœ€æ±‚æ¥å†³å®šï¼Œå¦‚äºŒç»´ç å±•ç¤ºï¼Œé€šçŸ¥ï¼ŒSOSï¼Œç»‘å®šè§£ç»‘ç­‰æ¨¡å—ã€‚é€šç”¨åŠŸèƒ½æŠ½å–æˆç‹¬ç«‹äºå…·ä½“ä¸šåŠ¡éœ€æ±‚çš„æ¨¡å—ï¼Œåœ¨æ¨¡å—å†…éƒ¨å®ç°é€šç”¨çš„ä¸šåŠ¡é€»è¾‘ï¼ŒåŒæ—¶å¯¹å¤–æš´éœ²è°ƒç”¨æ¥å£ï¼Œä¸åŒçš„ä¸šåŠ¡åªéœ€è°ƒç”¨é€šç”¨æ¨¡å—å³å¯<br>åŸºç¡€æ¡†æ¶å±‚ï¼š<br>å¾€å¾€æ˜¯æ ¹æ®åŠŸèƒ½æ¥åˆ’åˆ†ï¼Œå¯ç»†åˆ†ä¸ºç½‘ç»œæ”¯æŒåŠŸèƒ½ã€å›¾ç‰‡åº“ã€æ—¥å¿—ç³»ç»Ÿã€æ•°æ®åº“æ”¯æŒç­‰æ¨¡å—<br>è¿™ä¸€å±‚ç›®æ ‡æ˜¯ä¸å…·ä½“ä¸šåŠ¡è§£è€¦å¹¶å¯¹å¤–æä¾›è‰¯å¥½çš„äº¤äº’æ¥å£ï¼Œåç»­çš„ä¿®æ”¹å°½å¯èƒ½ä¸åœ¨åŸæ¥åŸºç¡€ä¸Šä¿®æ”¹è€Œæ˜¯é‡‡ç”¨æ‰©å±•çš„æ–¹å¼ï¼Œéµå¾ªå¼€é—­åŸåˆ™<br>libåº“å±‚ï¼šä¸»è¦æ˜¯ä¸‰æ–¹çš„libåº“ï¼Œè¿™äº›åº“ä¸ºä¸Šå±‚åŠŸèƒ½æ”¯æŒï¼Œå¦‚æˆ‘ä»¬é¡¹ç›®å½“å‰ä½¿ç”¨åˆ°çš„Glide,äºŒç»´ç ç­‰</p><p><strong>Step2: åˆ†å±‚ç»“æ„åŸºç¡€ä¸Šè¿›ä¸€æ­¥ç»†åŒ–</strong><br>ä¸ºè§£å†³å±‚ä¸å±‚ä»¥åŠåŒå±‚ä¹‹é—´çš„é¡µé¢é€šä¿¡é—®é¢˜ï¼Œå¼•å…¥æ•°æ®å¤„ç†æ¡†æ¶<br>æ•°æ®å¤„ç†æ¡†æ¶ç¤ºæ„å›¾:<br><img src="https://github.com/hellolihaizhou/saveImg/blob/master/5_%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E6%A1%86%E6%9E%B6.png?raw=true" align="left" style=" width:550px;height:600 px"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></p><p><label style="color:red">Step2.1 ä¸ºä»€ä¹ˆè¦å¼•å…¥æ•°æ®å¤„ç†æ¨¡å—ï¼Ÿ</label></p><ol><li>æˆ‘ä»¬å½“å‰çš„é¡¹ç›®ä¸­è¯·æ±‚æœåŠ¡ç«¯æ•°æ®æ¯”è¾ƒç›´æ¥ï¼Œç›´æ¥è°ƒç”¨Fwkçš„æ¥å£ï¼Œè™½ç„¶è¯¥æ¥å£æ˜¯æˆ‘ä»¬è‡ªå·±å®ç°åšåœ¨Fwkä¸­å¹¶å·²ç»åšäº†å°è£…ï¼Œä¸è¿‡å› æ¥æ”¶åˆ°è¿”å›æ•°æ®çš„å¤„ç†é€»è¾‘å¾ˆå¤šéƒ½æ˜¯åšåœ¨è§†å›¾å±‚ï¼Œ     ä¸”é¡µé¢é—´çš„æ•°æ®äº¤äº’æ˜¯é€šè¿‡ç›¸äº’æŒæœ‰å®ä¾‹è°ƒç”¨ï¼Œé¡µé¢é—´è€¦åˆä¸¥é‡</li><li>è§†å›¾å±‚æ”¶åˆ°æŠ¥æ–‡åç›´æ¥æ˜¾ç¤ºï¼Œç¼ºå°‘æ ¡éªŒçš„è¿‡ç¨‹ï¼Œè¿™éƒ¨åˆ†é€»è¾‘è‹¥åšåœ¨è§†å›¾å±‚ï¼Œä¼šå¢åŠ ä»£ç é‡ä¸”ä¸ç¬¦åˆå•ä¸€èŒè´£</li><li>å› è”ç½‘åæœ‰å¤šå¤„éœ€è¦è°ƒç”¨Fwkæ¥å£è·å–ç½‘ç»œæ•°æ®ï¼Œæ¯”è¾ƒåˆ†æ•£ï¼Œä¸”å¼€å¤šä¸ªçº¿ç¨‹å ç”¨å†…å­˜è¾ƒå¤šä¸”å’ŒUIçº¿ç¨‹æŠ¢å CPUèµ„æºï¼Œæœ‰æ¦‚ç‡å½±å“UIçº¿ç¨‹è§†å›¾çš„åˆ·æ–°é€Ÿåº¦</li><li>å°†å¤„ç†æ•°æ®å‡æ”¾ç½®åœ¨æ•°æ®å¤„ç†æ¨¡å—ï¼Œä¾¿äºåç»­é—®é¢˜å®šä½ï¼Œæ•°æ®å®šä½æ¨¡å—ç»†åˆ†ä¸ºç½‘ç»œæ•°æ®ä¸Šä¼ ï¼Œç½‘ç»œæ•°æ®æ‹‰å–ï¼ŒæŒä¹…åŒ–æ•°æ®å­˜å‚¨ï¼ŒæŠ¥æ–‡çš„è§£ææ ¡éªŒç­‰</li></ol><p>æ•°æ®å¤„ç†æ¨¡å—åœ¨è¿™é‡Œèµ·åˆ°äº†ä¸€ä¸ªåŠ å·¥æ•°æ®å¹¶ä¸­è½¬çš„è§’è‰²ï¼Œè¿™æ ·è§†å›¾å±‚å’Œç½‘ç»œå±‚å°±è§£è€¦äº†ï¼Œé¿å…äº†è§†å›¾å±‚ç›´æ¥å’Œç½‘ç»œå±‚äº¤äº’ï¼Œåç»­æ‰€æœ‰è§†å›¾å±‚éœ€è¦å’Œç½‘ç»œæ•°æ®äº¤äº’ï¼Œè§†å›¾ç•Œé¢ä¹‹é—´çš„æ•°æ®äº¤äº’å‡é€šè¿‡æ•°æ®å¤„ç†æ¨¡å—ï¼Œè¿™æ ·ä¸€æ¥è¿˜æœ‰ä¸ªå¥½å¤„å°±æ˜¯è§†å›¾å±‚çš„ä»£ç é‡å°†å¤§å¹…å‡å°‘ï¼Œè§†å›¾é¡µé¢é—´çš„è€¦åˆæ€§æ¶ˆé™¤ï¼Œä»£ç çš„å¯è¯»æ€§å¢</p><p><label style="color:red">Step2.2 æ•°æ®å¤„ç†æ¨¡å—æ‰¿æ‹…å“ªäº›å·¥ä½œï¼Ÿ</label><br>å°†æ‰€æœ‰éœ€è¦å’Œç½‘ç»œäº¤äº’çš„æ•°æ®è·å–å’Œä¸Šä¼ ï¼Œä»¥åŠæ•°æ®åº“è¯»å†™ï¼ŒFileæ–‡ä»¶çš„è¯»å†™ï¼Œç½‘ç»œJSONæ•°æ®çš„è§£ææå–å…³é”®ä¿¡æ¯ç­‰æ•°æ®å¤„ç†ç›¸å…³çš„ä»£ç å‡æ”¾ç½®åœ¨æ•°æ®å¤„ç†æ¨¡å—ä¸­</p><p><label style="color:red">ä¸€. å¹¶å‘å¤šä»»åŠ¡æ‰§è¡ŒåŒæ­¥æ“ä½œ</label><br>è€ƒè™‘åˆ°æˆ‘ä»¬çš„Launcheréœ€è¦åœ¨è”ç½‘ååšå¾ˆå¤šåŒæ­¥æœåŠ¡ç«¯çš„æ“ä½œï¼Œæ¯”å¦‚åŒæ­¥æ—¶é—´ï¼ŒåŒæ­¥åŠŸèƒ½æ§åˆ¶ï¼ŒåŒæ­¥å¤©æ°”ç­‰ï¼Œè¿™äº›æ“ä½œå®æ—¶æ€§è¦æ±‚è¾ƒé«˜ï¼Œéœ€è¦å½“è¯·æ±‚åˆ°è¾¾æ—¶ï¼Œå·¥ä½œçº¿ç¨‹å·²ç»å­˜åœ¨ã€‚æ•…é‡‡å–å¼€å¯çº¿ç¨‹æ± ä»¥æ”¯æŒè¿™äº›åŒæ­¥æ“ä½œèƒ½å¤Ÿå¹¶å‘è¿›è¡Œï¼ŒèŠ‚çœäº†åˆ›å»ºçº¿ç¨‹çš„è¿‡ç¨‹ï¼Œå¹¶èƒ½ä¿è¯ä»»åŠ¡è¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æ•°æ—¶èƒ½å¾—åˆ°å¤ç”¨ï¼Œä¸€å®šç¨‹åº¦ä¸ŠèŠ‚çœäº†å†…å­˜å¼€é”€ï¼Œå¦å¤–ä¸€ä¸ªå¥½å¤„æ˜¯æœ€å¤§ç¨‹åº¦ä¸ŠåŠ å¿«è”ç½‘æ•°æ®è·å–ï¼ŒåŒæ—¶çº¿ç¨‹æ± é»˜è®¤backgroundä¼˜å…ˆçº§ï¼Œå°½å¯èƒ½çš„ä¿è¯UIçº¿ç¨‹çš„è§†å›¾ç»˜åˆ¶ä¼˜å…ˆè¿›è¡Œï¼Œè¿™æ ·å¼€æœºåLauncheråŠ è½½æ—¶å°±ä¸å¯èƒ½å‡ºç°è§†å›¾å¡é¡¿çš„ç°è±¡ã€‚<br>çº¿ç¨‹æ± çš„ç†æƒ³å¤§å°å–å†³äºè¢«æäº¤ä»»åŠ¡çš„ç±»å‹ä»¥åŠæœºå™¨çš„å¤„ç†å™¨æ•°é‡ï¼Œçº¿ç¨‹æ± çš„å¤§å°éœ€è¦é¿å…â€œè¿‡å¤§â€å’Œâ€œè¿‡å°â€è¿™ä¸¤ç§æç«¯æƒ…å†µ</p><ol><li>å¦‚æœçº¿ç¨‹æ± è¿‡å¤§ï¼Œé‚£ä¹ˆå¤§é‡çš„çº¿ç¨‹å°†åœ¨ç›¸å¯¹å¾ˆå°‘çš„CPUå’Œå†…å­˜èµ„æºä¸Šå‘ç”Ÿç«äº‰ï¼Œè¿™ä¸ä»…ä¼šå¯¼è‡´æ›´é«˜çš„å†…å­˜ä½¿ç”¨é‡ï¼Œè€Œä¸”è¿˜å¯èƒ½è€—å°½èµ„æºã€‚</li><li>å¦‚æœçº¿ç¨‹æ± è¿‡å°ï¼Œé‚£ä¹ˆå°†å¯¼è‡´è®¸å¤šç©ºé—²çš„å¤„ç†å™¨æ— æ³•æ‰§è¡Œå·¥ä½œï¼Œä»è€Œé™ä½ååç‡<br>ä¸€èˆ¬æ¥è¯´ï¼Œæ ¸å¿ƒçº¿ç¨‹æ•°è®¾ç½®ä¸º2N+1(Nä¸ºæ ¸æ•°)</li></ol><p><label style="color:red">ä¸ºä»€ä¹ˆè¦è‡ªå®šä¹‰çº¿ç¨‹æ± è€Œä¸é‡‡ç”¨è‡ªå¸¦çº¿ç¨‹æ± ï¼Ÿ</label><br>é˜¿é‡Œjavaå¼€å‘æ‰‹å†Œä¸­æœ‰å¦‚ä¸‹è§£é‡Š:<br>ã€å¼ºåˆ¶ã€‘}æ–°å»ºçº¿ç¨‹æ—¶ï¼Œå¿…é¡»é€šè¿‡çº¿ç¨‹æ± æä¾›ï¼ˆAsyncTask æˆ–è€… ThreadPoolExecutor æˆ–è€…å…¶ä»–å½¢å¼è‡ªå®šä¹‰çš„çº¿ç¨‹æ± ï¼‰ï¼Œä¸å…è®¸åœ¨åº”ç”¨ä¸­è‡ªè¡Œæ˜¾å¼åˆ›å»ºçº¿ç¨‹ã€‚ è¯´æ˜ï¼š ä½¿ç”¨çº¿ç¨‹æ± çš„å¥½å¤„æ˜¯å‡å°‘åœ¨åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ä¸Šæ‰€èŠ±çš„æ—¶é—´ä»¥åŠç³»ç»Ÿèµ„æºçš„å¼€é”€ï¼Œè§£ å†³èµ„æºä¸è¶³çš„é—®é¢˜ã€‚å¦‚æœä¸ä½¿ç”¨çº¿ç¨‹æ± ï¼Œæœ‰å¯èƒ½é€ æˆç³»ç»Ÿåˆ›å»ºå¤§é‡åŒç±»çº¿ç¨‹è€Œå¯¼è‡´ æ¶ˆè€—å®Œå†…å­˜æˆ–è€…â€œè¿‡åº¦åˆ‡æ¢â€çš„é—®é¢˜ã€‚å¦å¤–åˆ›å»ºåŒ¿åçº¿ç¨‹ä¸ä¾¿äºåç»­çš„èµ„æºä½¿ç”¨åˆ†æï¼Œ å¯¹æ€§èƒ½åˆ†æç­‰ä¼šé€ æˆå›°æ‰°ã€‚<br>ã€å¼ºåˆ¶ã€‘}çº¿ç¨‹æ± ä¸å…è®¸ä½¿ç”¨ Executors å»åˆ›å»ºï¼Œè€Œæ˜¯é€šè¿‡ ThreadPoolExecutor çš„æ–¹å¼ï¼Œè¿™æ ·çš„å¤„ç†æ–¹å¼è®©å†™çš„åŒå­¦æ›´åŠ æ˜ç¡®çº¿ç¨‹æ± çš„è¿è¡Œè§„åˆ™ï¼Œè§„é¿èµ„æºè€—å°½çš„é£é™©ã€‚ è¯´æ˜ï¼š Executors è¿”å›çš„çº¿ç¨‹æ± å¯¹è±¡çš„å¼Šç«¯å¦‚ä¸‹ï¼š<br><code>FixedThreadPool</code>å’Œ <code>SingleThreadPool</code>ï¼š å… è®¸ çš„ è¯· æ±‚ é˜Ÿ åˆ— é•¿ åº¦ ä¸º <code>Integer.MAX_VALUE</code>ï¼Œå¯èƒ½ä¼šå †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´ OOMï¼›<br><code>CachedThreadPool</code> å’Œ <code>ScheduledThreadPool</code>ï¼š å… è®¸ çš„ åˆ› å»º çº¿ ç¨‹ æ•° é‡ ä¸º <code>Integer.MAX_VALUE</code>ï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤§é‡çš„çº¿ç¨‹ï¼Œä»è€Œå¯¼è‡´ OOMã€‚<br>å½“å‰çš„è‡ªå®šä¹‰çº¿ç¨‹æ± è®¾ç½®äº†æ ¸å¿ƒçº¿ç¨‹æ•°ä¸º5ï¼Œå½“è¯·æ±‚ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œè‹¥æ± ä¸­æš‚æ— å¯ç”¨çº¿ç¨‹ï¼Œåˆ™ä¼šèµ°åˆ°æ‹’ç»ç­–ç•¥ä¸­ï¼Œå°†è¯·æ±‚å­˜åœ¨BlockingQueueä¸­ï¼Œå¾…æœ‰é—²ç½®çº¿ç¨‹åï¼Œåˆ™ç»§ç»­æ‰§è¡Œ<br>å½“å‰å°è£…çš„çº¿ç¨‹æ± æš´éœ²å‡ºä¸€ä¸ªæ¥å£ä¾›Launcherä¸­æ‰€æœ‰éœ€è¦å¼‚æ­¥çš„åœ°æ–¹ä½¿ç”¨ï¼Œå‡å°‘äº†å†…å­˜çš„å¼€é”€å¹¶ä¸”ç»Ÿä¸€ç®¡ç†æ‰€æœ‰å¼‚æ­¥æ“ä½œ</p><p><label style="color:red">äºŒ.  åˆæ³•æ€§æ ¡éªŒ</label><br>è€ƒè™‘åˆ°ä»»ä½•æ•°æ®æºéƒ½æ— æ³•ä¿è¯èƒ½å¤Ÿè¿”å›åˆæ³•çš„æ•°æ®ï¼Œå¦‚æœä¸å¯¹æ•°æ®é”™è¯¯è¿›è¡Œå®¹é”™å¤„ç†ï¼Œç›´æ¥è¿”å›ç»™è§†å›¾å±‚çš„è¯ï¼Œä¼šå¯¼è‡´è§†å›¾å±‚æ— æ•°æ®ç”šè‡³å¼‚å¸¸ã€‚ä¹‹å‰å­˜åœ¨åŠŸèƒ½æ§åˆ¶æ”¶åˆ°çš„æŠ¥æ–‡ä¸­å­˜åœ¨keyå¯¹åº”çš„valueæ˜¯ç©ºçš„æƒ…å†µï¼ŒLauncherç›´æ¥<code>Crash</code>ï¼Œè¿™æ ·å¾ˆä¸å‹å¥½ï¼Œæ‰€ä»¥å®¹é”™å¤„ç†è¿˜æ˜¯éœ€è¦çš„ï¼Œåœ¨æ•°æ®å¤„ç†æ¨¡å—ä¸­åšæ•°æ®çš„æ ¡éªŒå¤„ç†ï¼Œç¡®ä¿è¿”å›ç»™è§†å›¾å±‚çš„æ•°æ®æ˜¯å¦æœ‰æ•ˆä¸çŸ¥é“ï¼Œèµ·ç æ˜¯åˆæ³•çš„ï¼Œä¸ä¼šå‡ºç°ç©ºæ•°æ®çš„æƒ…å†µï¼Œä»¥ä¿è¯è§†å›¾å±‚ä¸ä¼šå´©æºƒæˆ–æ˜¾ç¤ºå¼‚å¸¸ã€‚</p><p><strong>Step2.3 å¦‚ä½•å’Œè§†å›¾å±‚é€šä¿¡ï¼Ÿ</strong><br>å‰æœŸç ”ç©¶<br>å½“å‰å¸‚é¢æ¯”è¾ƒæµè¡Œçš„æ˜¯LiveDataä»¥åŠè¾ƒæ—©çš„EventBus,Ottoç­‰ï¼Œå…¶ä¸­åŸºäºLiveDataçš„äº‹ä»¶æ€»çº¿æœ€ä¸ºè½»é‡ä¸”æ˜¯è°·æ­Œå®˜æ–¹æ”¯æŒï¼Œæ”¯æŒæ„ŸçŸ¥ç»„ä»¶ç”Ÿå‘½å‘¨æœŸï¼Œä¸”ä¸éœ€è¦è§£æ³¨å†Œï¼Œå¯¹å†…å­˜æ³„éœ²éƒ½åšäº†é˜²æ§<br>ä¸ºä½•ä¸é‡‡ç”¨å¸‚é¢æˆç†Ÿçš„äº‹ä»¶æ€»çº¿ï¼Ÿ</p><ol><li>æˆ‘ä»¬çš„å·¥ç¨‹æ˜¯æºç å·¥ç¨‹ä¸æ˜¯gradleå·¥ç¨‹ï¼Œæ— æ³•é€šè¿‡ä¾èµ–æ·»åŠ ï¼Œåªæœ‰é€šè¿‡jaråŒ…å¼•å…¥ï¼Œå¼Šç«¯æ˜¯ä¸æ–¹ä¾¿å‡çº§</li><li>é¡¹ç›®éœ€è¦å‘ä¸‹å…¼å®¹ï¼Œä½ç‰ˆæœ¬ä¸Šå¦‚4.4å­˜åœ¨æ³¨è§£ä¸èƒ½ä½¿ç”¨çš„æƒ…å†µ</li><li><code>LiveData</code>éœ€è¦ä¾èµ–Androidå®˜æ–¹<code>Android Architecture Components</code>ç»„ä»¶çš„<code>LiveData</code>ï¼Œåœ¨<code>gradle</code>å·¥ç¨‹ä¸‹æ¯”è¾ƒæ–¹ä¾¿ï¼Œå¯¹äºæˆ‘ä»¬çš„æºç å·¥ç¨‹ä¸”éœ€è¦æ”¯æŒå¤šå¹³å°ï¼Œéœ€è¦å¼•å…¥è¾ƒå¤šçš„ä¾èµ–æ–‡ä»¶ï¼Œä¸”å­˜åœ¨ä¸€å®šçš„å­¦ä¹ æˆæœ¬</li><li>åŸºäº<code>LiveData</code>çš„äº‹ä»¶æ€»çº¿æ¡†æ¶æˆç†Ÿä¸”åŠŸèƒ½å¼ºå¤§ï¼ŒåŠŸèƒ½è¾ƒå¤šï¼Œå¼•å…¥éœ€æŠ•å…¥æ—¶é—´æˆæœ¬è¿›è¡Œç ”ç©¶ï¼Œä¸ç„¶åç»­è‹¥å‡ºé—®é¢˜æ’æŸ¥ä¼šæ— ä»ä¸‹æ‰‹<br><strong>è‡ªè¡Œè®¾è®¡äº‹ä»¶æ€»çº¿çš„åŸç†</strong><br>å¯¹å¸‚é¢ä¸»æµçš„<code>eventbus</code>åšäº†ç ”ç©¶ï¼Œè€ƒè™‘åˆ°eventbusæ–‡ä»¶æ•°å¤šè¾¾è¿‘äºŒåä¸ªï¼Œè€ƒè™‘åç»­æ–¹ä¾¿ç§»æ¤ä¸”æ–¹ä¾¿å®šä½é—®é¢˜ï¼Œè€ƒè™‘è®¾è®¡ä¸€ä¸ªæ»¡è¶³æˆ‘ä»¬ä¸šåŠ¡éœ€æ±‚çš„ç®€åŒ–ç‰ˆäº‹ä»¶æ€»çº¿<br>å½“å‰è®¾è®¡çš„äº‹ä»¶æ€»çº¿é‡‡ç”¨ç±»ä¼¼è®¢é˜…å‘å¸ƒæœºåˆ¶ï¼Œæ”¯æŒä¸€å¯¹ä¸€ä»¥åŠä¸€å¯¹å¤šé€šä¿¡ï¼Œä¼ é€’çš„æ¶ˆæ¯å®ä½“æ”¯æŒæ³›å‹ï¼Œæ ¸å¿ƒå½“å‰åªæœ‰ä¸¤æ”¯æ–‡ä»¶ï¼Œå½“å‰æµ‹è¯•ä¸‹æ¥åŸºæœ¬æ»¡è¶³éœ€æ±‚ä¸ºæ–¹ä¾¿åº”ç”¨ä½¿ç”¨ï¼Œæš´éœ²çš„æ¥å£å¾ˆç®€å•ï¼Œåªæœ‰ä¸€ä¸ªå‘é€ä»¥åŠè®¢é˜…æ¥å£ï¼Œåç»­æ ¹æ®ä¸šåŠ¡éœ€è¦å†çœ‹æ˜¯å¦éœ€è¦æ‰©å±•</li></ol><p><strong>Step2.4 è§†å›¾æ¡†æ¶è®¾è®¡</strong></p><ol><li>ä¸»ç•Œé¢:<br>è€ƒè™‘ä½¿ç”¨<code>Fragment+ViewPager</code>ï¼Œ<code>Fragment</code>ç”¨æ¥æ‰¿è½½è§†å›¾ï¼Œä¼˜åŠ¿åœ¨äºè½»é‡ï¼ŒåŠ è½½é€Ÿåº¦å¿«<br>èœå•é¡µå‡æ˜¯<code>RecyclerView</code>æˆ–<code>ListView</code>å±•ç¤ºæ•°æ®ï¼Œè€ƒè™‘åˆ°è¿™äº›ListViewå‡éœ€è¦<code>ViewHolder</code>æ¥å¡«å……è§†å›¾ï¼Œéœ€è¦Adapteræ¥å¡«å……æ•°æ®ï¼Œå¦‚æœæ¯ä¸ªéœ€è¦ListViewçš„ç•Œé¢éƒ½ç»´æŠ¤å„è‡ªçš„ä¸€å¥—ViewHolderåŠAdapterï¼Œé‚£ä¹ˆé¡µé¢é€»è¾‘å˜å¾—è‡ƒè‚¿ï¼Œæ•´ä¸ªLauncherçš„ä»£ç é‡ä¹Ÿä¼šæ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥è¿™é‡Œè€ƒè™‘é‡‡ç”¨å¦‚ä¸‹æ–¹å¼:<br>å°è£…ä¸€ä¸ªAdapterå…¬å…±å¤„ç†ç±»ï¼Œæä¾›å¤šç§æ„é€ å‡½æ•°ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªtypeå‚æ•°ï¼Œç”¨æ¥æ ‡æ˜ä½¿ç”¨å“ªä¸ªViewHolderï¼Œåœ¨Adapterçš„getViewæ–¹æ³•ä¸­ï¼Œæ ¹æ®typeå‚æ•°ï¼Œè·å–å…·ä½“çš„ViewHolderå®ç°<br>ç»è¿‡å°è£…ä¹‹åï¼Œè§†å›¾å±‚èœå•é¡µåªéœ€è¦å‘Adapterå…¬å…±å¤„ç†ç±»ä¼ å…¥ä¸€ä¸ªtypeå‚æ•°å³å¯å¾—åˆ°å¯¹åº”çš„Adapterï¼Œç­‰æ•°æ®è¿”å›åˆ°è§†å›¾å±‚åï¼Œå†å°†æ•°æ®ä¼ ç»™Adapterå…¬å…±å¤„ç†ç±»ï¼Œå…¶ä»–ä»€ä¹ˆéƒ½ä¸ç”¨ç®¡ï¼Œå°±å¯ä»¥å±•ç¤ºåˆ—è¡¨æ•°æ®äº†ã€‚è¿™æ ·è®¾è®¡çš„ç›®çš„æ˜¯å°†å…¬å…±çš„è¡Œä¸ºæŠ½å–å‡ºæ¥ï¼Œå¤§å¹…åº¦å‡å°‘èœå•é¡µçš„ä»£ç é‡ï¼Œåç»­å¢åŠ èœå•é¡µä¹Ÿä¼šå˜å¾—å¾ˆç®€å•ã€‚</li><li>ä¸‹æ‹‰æ ç•Œé¢<br>åˆ†ä¸º<code>statusbar</code>ä»¥åŠé€šçŸ¥æ ï¼Œè¿™é‡Œçš„è¯¸å¤šæ•°æ®å‡éœ€è¦è°ƒç”¨ç³»ç»Ÿçš„æ¥å£ï¼Œæ¯”å¦‚ç”µé‡ï¼Œä¿¡å·æ ¼ï¼Œæ•°æ®ç±»å‹ï¼Œå°†è¿™äº›æ¥å£å•ç‹¬æ”¾åœ¨å…¬å…±æ¨¡å—ä¸­ï¼Œä¾¿äºå…¶ä»–é¡µé¢ä¹Ÿèƒ½è°ƒç”¨åˆ°</li><li>è¡¨ç›˜ç•Œé¢<br>å³å¾…æœºç•Œé¢ï¼ŒåŒ…æ‹¬é•¿æŒ‰åè¿›å…¥è¡¨ç›˜æ ·å¼é€‰æ‹©ç•Œé¢ï¼Œè¿™é‡Œå·²ç»åšå¥½äº†åŸºç±»å°è£…å…¬å…±è¡Œä¸ºçš„æ“ä½œï¼Œä½¿å¾—è¡¨ç›˜æ ·å¼çš„æ‰©å±•å˜å¾—å¾ˆå®¹æ˜“ï¼Œåªéœ€è¦ç»§æ‰¿åŸºç±»ï¼Œæ”¹ä¸‹å¸ƒå±€æ–‡ä»¶å³å¯</li></ol><p><strong>Step2.5 ä»£ç ç»“æ„åˆ’åˆ†</strong><br>å½“å‰ä»£ç ç»“æ„åˆ’åˆ†å¦‚ä¸‹:<br><img src="https://github.com/hellolihaizhou/saveImg/blob/master/6_1_%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84.png?raw=true" align="left" style=" width:600px;height:600 px"><br><br><br><br><br><br><img src="https://github.com/hellolihaizhou/saveImg/blob/master/6_2_%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84.png?raw=true" align="left" style=" width:600px;height:600 px"><br><br><br><br><br><br><img src="https://github.com/hellolihaizhou/saveImg/blob/master/6_3_%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84.png?raw=true" align="left" style=" width:600px;height:100 px"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></p><p><strong>è€é¡¹ç›®ä¸Šä¸Šå­˜åœ¨çš„ä»£ç é—®é¢˜</strong></p><ol><li>å­˜åœ¨ä¸å†ä½¿ç”¨çš„åº“æ–‡ä»¶ä½†æ˜¯å¹¶æœªç§»é™¤ï¼Œå¯¹åº“æ–‡ä»¶æ‹¿æ¥ç›´æ¥ç”¨ï¼Œå¯¹äºæ‰€éœ€åŠŸèƒ½è¿‡å¤§è¿‡å…¨ï¼Œç¼ºå°‘è£å‰ªè¿‡ç¨‹ï¼Œä½¿ç”¨ç›´æ¥è°ƒç”¨ï¼Œä¸æœ¬èº«åº”ç”¨ä»£ç è€¦åˆåº¦é«˜ï¼Œå»ºè®®äºŒæ¬¡å°è£…ï¼›</li><li>é‡å¤æ€§ä»£ç è¾ƒå¤šï¼Œå¦‚æ¥æ”¶å¿ƒè·³ï¼Œç›‘æµ‹ç”µé‡ï¼Œç†„ç­å±ç­‰</li><li>å˜é‡åå’Œæ–¹æ³•åå¾ˆéšæ„ï¼Œå»ºè®®é©¼å³°å‘½åï¼Œç¼ºå°‘æ³¨é‡Šï¼Œå¯è¯»æ€§å·®ï¼Œæ·»åŠ ç±»æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ï¼Œåé¢å› ä¸ºç§ç§åŸå› åºŸå¼ƒï¼Œç”±äºç¼ºå°‘æ³¨é‡Šä¸”ä»£ç å¯è¯»æ€§å·®ï¼Œå¯¼è‡´æˆä¸ºåƒµå°¸ä»£ç ï¼Œä¸åˆ©äºåç»­æ¥æ‰‹äººå‘˜ç»´æŠ¤ã€‚</li><li>é€»è¾‘è¿‡äºå†—é•¿çš„æ–¹æ³•ï¼Œä¸€å¤§å †çš„if elseï¼Œå»ºè®®æ‹†åˆ†ä¼˜åŒ–ï¼›</li><li>æ²¡æœ‰è€ƒè™‘ä¸€äº›è¾¹ç•Œæ¡ä»¶ï¼Œæ¯”å¦‚è¯·æ±‚å¤±è´¥ï¼Œæ²¡æœ‰æ•°æ®çš„æƒ…å†µï¼Œç¼ºå°‘å®¹é”™å¤„ç†ï¼›</li><li>ä»£ç å­˜åœ¨å¾ˆå¤šå®¹æ˜“é€ æˆç©ºæŒ‡é’ˆä»£ç ï¼Œæœ€å¸¸è§è°ƒç”¨equalsæ–¹æ³•æ—¶ï¼Œæœªéµå¾ª â€œå¸¸é‡â€.equals(å˜é‡) </li><li>staticæ»¥ç”¨ï¼Œä¸ºå†…å­˜æ³„éœ²åŸ‹ä¸‹ä¼ç¬”</li><li>å¼‚æ­¥çº¿ç¨‹çš„æ»¥ç”¨ï¼Œä½¿ç”¨new Threadæ–¹å¼è¿‡äºç®€å•ç²—æš´ï¼Œä¸€ä¸ªçº¿ç¨‹å ç”¨çº¦1Må†…å­˜ï¼Œè¿‡å¤šçš„å¼€å¯ä¼šè€—ç”¨ä¸å°‘å†…å­˜</li><li>è°ƒç”¨å¤§å¤šé€šè¿‡ç›´æ¥newå¯¹è±¡æ–¹å¼æŒæœ‰å¼•ç”¨ï¼Œå ç”¨å†…å­˜ä¸”å¼ºè€¦åˆï¼Œé’ˆå¯¹ä¸åŒåœºæ™¯è€ƒè™‘å•ä¾‹æˆ–æ¶ˆæ¯æ€»çº¿é€šä¿¡</li><li>ä»£ç ç¾è§‚æ–¹é¢ï¼Œç¼ºå°‘ç¼©è¿›å¯¹é½éšæ„ç©ºè¡Œï¼Œä»£ç ä¸è§„æ•´</li><li>æ–°åŠ å›¾ç‰‡æœªè¿›è¡Œå‹ç¼©ï¼Œå»ºè®®png å›¾ç‰‡ä½¿ç”¨ tinypng æˆ–è€…ç±»ä¼¼å·¥å…·å‹ç¼©å¤„ç†ï¼Œå‡å°‘åŒ…ä½“ç§¯</li><li>å¯¹ä¸»çº¿ç¨‹å­çº¿ç¨‹è¿è¡Œç¯å¢ƒå­˜åœ¨ä½¿ç”¨ä¸å½“ï¼ŒActivityçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ä¸­ï¼Œå¹¿æ’­çš„onreceiveæ–¹æ³•ä»¥åŠæ™®é€šserviceä¸­ï¼Œå­˜åœ¨è€—æ—¶æ“ä½œ</li><li>ä¿®æ”¹å·²æœ‰ç¨³å®šæ–¹æ³•æ¯”è¾ƒéšæ„ï¼Œå¾€å¾€å¡è¿›ä¸€å¤§å †ä»£ç ï¼Œå¸¦æ¥éšæ‚£ï¼Œå»ºè®®è¿›è¡Œæ‰©å±•è€Œä¸æ˜¯ä¿®æ”¹åŸæœ‰è®¾è®¡ï¼Œæˆ–è€…æ–°å¢å•ç‹¬æ¥å£</li><li>å¯¹å¼‚æ­¥ä»»åŠ¡è¢«ä¸­æ–­æƒ…å†µï¼Œç¼ºå°‘èµ„æºæ¸…ç†ï¼Œå¦‚AsyncTaskæˆ–Handlerå¼‚æ­¥æ›´æ–°UIï¼Œå¯¹ä»»åŠ¡æœªå®Œæˆç•Œé¢è¢«é€€å‡ºæƒ…å†µï¼Œéœ€è¦åœ¨ondestoryæˆ–onPauseä¸­è¿›è¡Œä»»åŠ¡æ¸…ç†</li><li>è¿‡åº¦çš„try catchï¼Œç‰¹åˆ«æ˜¯catchäº†Exceptionè¿™ç§åŸºç±»ï¼Œå¯¼è‡´å­˜åœ¨å¼‚å¸¸éƒ½è¢«catchæ‰ï¼Œå°†bugéšè”½èµ·æ¥ï¼Œå¯¼è‡´åæœŸæ’æŸ¥æ¯”è¾ƒå›°éš¾</li><li>ç•Œé¢é—´éšæ„ä¼ é€’ä¸Šä¸‹æ–‡contextï¼Œä¸ºå†…å­˜æ³„æ¼åŸ‹ä¸‹ä¼ç¬”</li></ol><hr><font color="#000000" size="2" face="æ¥·ä½“">good nightï¼</font>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;å½“å‰éœ€æ±‚&lt;/strong&gt;&lt;br&gt;æ–°é¡¹ç›®éµå¾ªç«å“çš„Launcheræ ·å¼è®¾è®¡&lt;br&gt;&lt;strong&gt;å½“å‰è®¡åˆ’&lt;/strong&gt;&lt;br&gt;é‡æ–°ç¼–å†™Launcherï¼Œå¹¶å°½å¯èƒ½çš„å¼¥è¡¥è€æ¡†æ¶çš„ä¸è¶³&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä¸ºä»€ä¹ˆéœ€è¦é‡å†™Launcherï¼Ÿ&lt;/str
      
    
    </summary>
    
      <category term="Android" scheme="http://lihaizhou.top/categories/Android/"/>
    
    
  </entry>
  
  <entry>
    <title>Android ç³»ç»Ÿå±‚æ•æ‰æ‰€æœ‰åº”ç”¨å´©æºƒæƒ…å†µæ¨é€åˆ°é’‰é’‰å®è·µä¹‹è·¯</title>
    <link href="http://lihaizhou.top/2019/03/11/Android-%E7%B3%BB%E7%BB%9F%E5%B1%82%E6%8D%95%E6%8D%89%E6%89%80%E6%9C%89%E5%BA%94%E7%94%A8%E5%B4%A9%E6%BA%83%E6%83%85%E5%86%B5%E6%8E%A8%E9%80%81%E5%88%B0%E9%92%89%E9%92%89%E5%AE%9E%E8%B7%B5%E4%B9%8B%E8%B7%AF/"/>
    <id>http://lihaizhou.top/2019/03/11/Android-ç³»ç»Ÿå±‚æ•æ‰æ‰€æœ‰åº”ç”¨å´©æºƒæƒ…å†µæ¨é€åˆ°é’‰é’‰å®è·µä¹‹è·¯/</id>
    <published>2019-03-11T14:19:11.000Z</published>
    <updated>2019-12-28T07:02:08.000Z</updated>
    
    <content type="html"><![CDATA[<p><strong>é¡¹ç›®ç—›ç‚¹</strong><br>å‡ºç°å¶ç°å´©æºƒæˆ–<code>ANR</code>ï¼Œå› ä¸ºæ²¡æœ‰å¼€å¯æ—¥å¿—å¼€å…³ï¼Œåé¢å°è¯•å¤ç°åˆæ¯”è¾ƒå›°éš¾ï¼Œç ”å‘åŒäº‹æ¯”è¾ƒè‹¦æ¼ï¼Œæ— ä»ä¸‹æ‰‹<br>è¿˜æœ‰ä¸€ä¸ªæµ‹è¯•åŒäº‹æŠ“å–æ—¥å¿—åè¿˜è¦è®°å½•æ—¶é—´ç‚¹ï¼Œå†ä¸Šä¼ åˆ°JIRAä¸Šï¼Œç ”å‘åŒäº‹ä¸‹è½½æ—¥å¿—è¿˜éœ€è¦æœç´¢æŠ¥é”™ç‚¹ï¼Œæ•´ä¸ªæµç¨‹æ¯”è¾ƒè´¹æ—¶</p><p><strong>åˆæ­¥æƒ³æ³•</strong><br>å¯ä¸å¯ä»¥å°†æ‰€æœ‰<code>ANR</code>,<code>Crash</code>ç­‰å‡ºé”™ä¿¡æ¯çš„å…³é”®æ—¥å¿—ç‰‡æ®µç›´æ¥ä¼ ç»™æœåŠ¡å™¨ï¼Œåœ¨åé¢çš„æ‘¸ç´¢è¿‡ç¨‹ä¸­å‘ç°é’‰é’‰å¯ä»¥æä¾›å¯¹å¤–çš„URLæ¥å£ï¼Œè¿™æ ·çš„è¯ç›´æ¥ä¼ ç»™é’‰é’‰å°±å¾ˆæ–¹ä¾¿äº†ï¼Œæ­£å¥½å¹³æ—¶çš„åŠå…¬ç”¨çš„ä¹Ÿæ˜¯è¿™ä¸ªè½¯ä»¶ï¼Œè¿™æ ·ä¸€æ¥å°±çœå»äº†å¾ˆå¤šçš„æ­¥éª¤ï¼Œä¸€æ­¥åˆ°ä½</p><p>ä»¥ä¸‹æ˜¯å®åšçš„æ­¥éª¤è®°å½•ï¼Œåªæ˜¯å®ç°äº†ä¸€ä¸ªåˆç¨¿ï¼Œåé¢è¿˜éœ€è¦ä¸æ–­ä¼˜åŒ–å®Œå–„</p><p><strong>Step1ï¼š è·å–é’‰é’‰çš„<code>Webhook</code>åœ°å€</strong><br>è¿™ä¸ªåœ°å€åé¢ä½œä¸ºæ¨é€çš„ç›®æ ‡åœ°å€</p><p>åœ¨é’‰é’‰ä¸­æ·»åŠ æœºå™¨äººæ¥å£çš„æ­¥éª¤å‚è§å®˜ç½‘æ–‡æ¡£<br><a href="https://open-doc.dingtalk.com/docs/doc.htm?spm=a219a.7629140.0.0.XJQ2yZ&amp;treeId=257&amp;articleId=105735&amp;docType=1" target="_blank" rel="noopener">https://open-doc.dingtalk.com/docs/doc.htm?spm=a219a.7629140.0.0.XJQ2yZ&amp;treeId=257&amp;articleId=105735&amp;docType=1</a></p><p>é€šè¿‡ä»¥ä¸Šæ­¥éª¤æ‹¿åˆ°äº†Laucnherçš„Webhookåœ°å€ï¼Œå¦‚ä¸‹:<br><a href="https://oapi.dingtalk.com/robot/send?access_token=a937a86122149aa52a694dd79fae2cdec1c7e448c62bff31471088ec13e941" target="_blank" rel="noopener">https://oapi.dingtalk.com/robot/send?access_token=a937a86122149aa52a694dd79fae2cdec1c7e448c62bff31471088ec13e941</a></p><p><strong>Step2ï¼šæºç å±‚å¢åŠ ä¸ŠæŠ¥æœºåˆ¶</strong><br>ä¹‹æ‰€ä»¥è€ƒè™‘åœ¨æºç å±‚ä¸­ä¿®æ”¹ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬éœ€è¦ç›‘æµ‹ç³»ç»Ÿä¸­æ‰€æœ‰åº”ç”¨çš„å‡ºé”™æƒ…å†µï¼Œæƒ³åˆ°<code>AMS</code>ä¸­çš„<code>Crash</code>å¼¹æ¡†ï¼ŒçŒœæƒ³å…¶ä¸­ä¸€å®šæœ‰ç›¸å…³çš„å†™å…¥æŠ¥é”™æ—¥å¿—çš„æ“ä½œ</p><p><img src="https://github.com/hellolihaizhou/FrescoDemo/blob/master/handleApplicationCrash.png?raw=true" align="left" style=" width:700px;height:300 px"><br><br><br><br><br><br><br><br></p><p>è¿™é‡Œè°ƒç”¨äº†<code>handleApplicationCrashInner</code>è¿™ä¸ªå‡½æ•°ï¼Œæ¥ç€çœ‹è¿™ä¸ªå‡½æ•°<br><img src="https://github.com/hellolihaizhou/FrescoDemo/blob/master/handleApplicationCrashInner.png?raw=true" align="left" style=" width:700px;height:300 px"><br><br><br><br><br><br><br><br><br><br></p><p>è¿™é‡Œè¿½åŠ äº†ä¸€è¡Œæ—¥å¿—ï¼Œåœ¨åº”ç”¨å±‚æ·»åŠ ä¼šé€ æˆ<code>crash</code>çš„ä»£ç ç‰‡æ®µï¼Œçœ‹çœ‹è¿™è¡Œæ—¥å¿—æ‰“å‡ºçš„ä¿¡æ¯</p><p><img src="https://github.com/hellolihaizhou/FrescoDemo/blob/master/crashLog.png?raw=true" align="left" style=" width:700px;height:300 px"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>è¿™é‡Œä¼šæ‰“å‡º<code>eventtype</code>ç±»å‹ï¼ŒæŠ¥é”™è¿›ç¨‹ï¼Œä»¥åŠå…³é”®çš„å †æ ˆä¿¡æ¯ï¼Œå…¶ä¸­çš„<code>eventtype</code>åŒ…æ‹¬äº†<code>watchdog</code>ã€<code>anr</code>ã€<code>wtf</code>ã€<code>lowmem</code>ã€<code>native_crash</code>ã€<code>crash</code><br>å®Œå…¨æ»¡è¶³æˆ‘ä»¬çš„è¦æ±‚ï¼Œæ¥ä¸‹æ¥å°±æ˜¯å¦‚ä½•æŠŠè¿™æ®µå‘ç»™é’‰é’‰äº†<br>åœ¨<code>handleApplicationCrashInner</code>ä¸­å¢åŠ æ¥å£<code>reportAllErrorToXunDingTalk</code></p><p><img src="https://github.com/hellolihaizhou/FrescoDemo/blob/master/AddReportFunction.png?raw=true" align="left" style=" width:700px;height:300 px"><br><br><br><br><br><br><br></p><p><code>reportAllErrorToXunDingTalk</code>æ¥å£å¦‚ä¸‹ï¼š<br><img src="https://github.com/hellolihaizhou/FrescoDemo/blob/master/report1.png?raw=true" align="left" style=" width:700px;height:300 px"><br><img src="https://github.com/hellolihaizhou/FrescoDemo/blob/master/report2.png?raw=true" align="left" style=" width:700px;height:300 px"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></p><p>è¿™ä¸ªæ—¶å€™åº”ç”¨ç«¯æŠ¥é”™çš„è¯è¯ï¼Œé’‰é’‰ç¾¤ä¼šæ”¶åˆ°æ¶ˆæ¯<br><img src="https://github.com/hellolihaizhou/FrescoDemo/blob/master/dingding.png?raw=true" align="left" style=" width:700px;height:300 px"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></p><hr><font color="#000000" size="2" face="æ¥·ä½“">good night!</font>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;strong&gt;é¡¹ç›®ç—›ç‚¹&lt;/strong&gt;&lt;br&gt;å‡ºç°å¶ç°å´©æºƒæˆ–&lt;code&gt;ANR&lt;/code&gt;ï¼Œå› ä¸ºæ²¡æœ‰å¼€å¯æ—¥å¿—å¼€å…³ï¼Œåé¢å°è¯•å¤ç°åˆæ¯”è¾ƒå›°éš¾ï¼Œç ”å‘åŒäº‹æ¯”è¾ƒè‹¦æ¼ï¼Œæ— ä»ä¸‹æ‰‹&lt;br&gt;è¿˜æœ‰ä¸€ä¸ªæµ‹è¯•åŒäº‹æŠ“å–æ—¥å¿—åè¿˜è¦è®°å½•æ—¶é—´ç‚¹ï¼Œå†ä¸Šä¼ åˆ°JIRAä¸Šï¼Œç ”å‘åŒäº‹ä¸‹è½½æ—¥å¿—è¿˜éœ€è¦æœç´¢æŠ¥é”™ç‚¹ï¼Œ
      
    
    </summary>
    
      <category term="Android" scheme="http://lihaizhou.top/categories/Android/"/>
    
    
  </entry>
  
  <entry>
    <title>Androidè¾“å…¥ç³»ç»Ÿç³»åˆ—(4)----åˆ†å‘è¾“å…¥æ¶ˆæ¯</title>
    <link href="http://lihaizhou.top/2018/07/03/Android%E8%BE%93%E5%85%A5%E7%B3%BB%E7%BB%9F%E7%B3%BB%E5%88%97-4-%E5%88%86%E5%8F%91%E8%BE%93%E5%85%A5%E6%B6%88%E6%81%AF/"/>
    <id>http://lihaizhou.top/2018/07/03/Androidè¾“å…¥ç³»ç»Ÿç³»åˆ—-4-åˆ†å‘è¾“å…¥æ¶ˆæ¯/</id>
    <published>2018-07-03T15:14:08.000Z</published>
    <updated>2019-12-28T07:02:14.000Z</updated>
    
    <content type="html"><![CDATA[<p>å‰é¢è®²è¿‡C++ä¸­èµ·æ¥çš„çº¿ç¨‹å¾ªç¯å‡½æ•°æ˜¯threadLoopï¼Œä¸‹é¢çœ‹çœ‹InputDispatcherThreadè¿™ä¸€åˆ†å‘æ¶ˆæ¯çš„çº¿ç¨‹çš„å¾ªç¯ä½“</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bool InputDispatcherThread::threadLoop() &#123;</span><br><span class="line">    mDispatcher-&gt;dispatchOnce();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåªæ˜¯ç®€å•çš„è°ƒç”¨äº†InputDispatcherçš„dispatchOnce()<br>æ¥ç€çœ‹è¿™ä¸ªå‡½æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> InputDispatcher::dispatchOnce() &#123;</span><br><span class="line">    nsecs_t nextWakeupTime = LONG_LONG_MAX;</span><br><span class="line">    &#123; <span class="comment">// acquire lock</span></span><br><span class="line">        <span class="function">AutoMutex <span class="title">_l</span><span class="params">(mLock)</span></span>;</span><br><span class="line">        mDispatcherIsAliveCondition.broadcast();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Run a dispatch loop if there are no pending commands.</span></span><br><span class="line">        <span class="comment">// The dispatch loop might enqueue commands to run afterwards.</span></span><br><span class="line">        <span class="keyword">if</span> (!haveCommandsLocked()) &#123;</span><br><span class="line">            dispatchOnceInnerLocked(&amp;nextWakeupTime);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//çœç•¥éƒ¨åˆ†ä»£ç </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ ¸å¿ƒçš„ä»£ç åªæœ‰ä¸€è¡ŒdispatchOnceInnerLockedï¼ŒæŸ¥çœ‹haveCommandsLocked()ä»£ç å¾—çŸ¥å½“mCommandQueueä¸ä¸ºç©ºæ—¶ï¼Œ<br>ä¾¿ä¼šè°ƒç”¨dispatchOnceInnerLockedå‡½æ•°æ¥è¿›è¡Œåˆ†å‘æ¶ˆæ¯</p><p>ä¸‹é¢æ¥ç€çœ‹dispatchOnceInnerLockedè¿™ä¸ªå‡½æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> InputDispatcher::dispatchOnceInnerLocked(nsecs_t* nextWakeupTime) &#123;</span><br><span class="line">    <span class="comment">//çœç•¥éƒ¨åˆ†ä»£ç </span></span><br><span class="line">    <span class="comment">// Ready to start a new event.</span></span><br><span class="line">    <span class="comment">// If we don't already have a pending event, go grab one.</span></span><br><span class="line">    <span class="keyword">if</span> (! mPendingEvent) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mInboundQueue.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">//çœç•¥éƒ¨åˆ†ä»£ç </span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Inbound queue has at least one entry.</span></span><br><span class="line">            <span class="comment">//é˜Ÿåˆ—ä¸ä¸ºç©ºçš„è¯ï¼Œä»é˜Ÿåˆ—ä¸­å–æ¶ˆæ¯</span></span><br><span class="line">            mPendingEvent = mInboundQueue.dequeueAtHead();</span><br><span class="line">            traceInboundQueueLengthLocked();</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">//çœç•¥éƒ¨åˆ†ä»£ç    </span></span><br><span class="line">   </span><br><span class="line">    <span class="keyword">switch</span> (mPendingEvent-&gt;type) &#123;</span><br><span class="line">     <span class="comment">//çœç•¥éƒ¨åˆ†ä»£ç </span></span><br><span class="line">    <span class="comment">//æ¶ˆæ¯ç±»å‹æ˜¯æŒ‰é”®æ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">case</span> EventEntry::TYPE_KEY: &#123;</span><br><span class="line">        KeyEntry* typedEntry = static_cast&lt;KeyEntry*&gt;(mPendingEvent);</span><br><span class="line">        <span class="keyword">if</span> (isAppSwitchDue) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isAppSwitchKeyEventLocked(typedEntry)) &#123;</span><br><span class="line">                resetPendingAppSwitchLocked(<span class="keyword">true</span>);</span><br><span class="line">                isAppSwitchDue = <span class="keyword">false</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dropReason == DROP_REASON_NOT_DROPPED) &#123;</span><br><span class="line">                dropReason = DROP_REASON_APP_SWITCH;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (dropReason == DROP_REASON_NOT_DROPPED</span><br><span class="line">                &amp;&amp; isStaleEventLocked(currentTime, typedEntry)) &#123;</span><br><span class="line">            dropReason = DROP_REASON_STALE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (dropReason == DROP_REASON_NOT_DROPPED &amp;&amp; mNextUnblockedEvent) &#123;</span><br><span class="line">            dropReason = DROP_REASON_BLOCKED;</span><br><span class="line">        &#125;</span><br><span class="line">        done = dispatchKeyLocked(currentTime, typedEntry, &amp;dropReason, nextWakeupTime);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">   <span class="comment">//çœç•¥éƒ¨åˆ†ä»£ç </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°ä¸»è¦å·¥ä½œå…ˆæ˜¯ä»mInboundQueueä¸­å–æ¶ˆæ¯ï¼Œè¿™ä¸ªmInboundQueueæ˜¯ä¸æ˜¯å¾ˆçœ¼ç†Ÿï¼Œå°±æ˜¯ä¸Šç¯‡æ–‡ç« ä¸­è®²è¿°çš„è¯»å–æ¶ˆæ¯æœ€åå­˜æ”¾åˆ°mInboundQueueä¸­ï¼Œè¯»å–åˆ°æ¶ˆæ¯åå‘¢ï¼Œæ ¹æ®æ¶ˆæ¯çš„ç±»å‹è¿›è¡Œå¤„ç†ï¼Œè¿™é‡Œè¿˜æ˜¯ä»¥Keyæ¶ˆæ¯ä¸ºä¾‹ï¼Œè°ƒç”¨åˆ°äº†dispatchKeyLockedè¿™ä¸€å‡½æ•°ï¼Œè¿™é‡Œå°±æ­£å¼å¼€å§‹äº†æ¶ˆæ¯åˆ†å‘ä¹‹æ—…äº†</p><p>åé¢ä¾¿æ˜¯å±‚å±‚è°ƒç”¨åˆ†å‘ï¼Œå†ç¨‹è¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œè¿™é‡Œå°±ä¸ç»†ç»†åˆ†è§£ï¼Œç»˜åˆ¶äº†ä¸€å¼ æµç¨‹å›¾å¦‚ä¸‹</p><p><img src="https://github.com/hellolihaizhou/hellolihaizhou.github.io/blob/master/2018/07/03/Android%E8%BE%93%E5%85%A5%E7%B3%BB%E7%BB%9F%E7%B3%BB%E5%88%97-4-%E5%88%86%E5%8F%91%E8%BE%93%E5%85%A5%E6%B6%88%E6%81%AF/%E6%B5%81%E7%A8%8B%E5%9B%BE.png?raw=true" align="left" style=" width:300px;height:150 px"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></p><hr><font color="#000000" size="2" face="æ¥·ä½“">ä½æ‰€ï¼Œæ™šä¸Šï¼Œæ±—è¡«ï¼Œç”µè„‘å‰ï¼Œçœ‹ç€ä¸–ç•Œæ¯ç‘å£«å¯¹é˜µç‘å…¸é˜Ÿ</font>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;å‰é¢è®²è¿‡C++ä¸­èµ·æ¥çš„çº¿ç¨‹å¾ªç¯å‡½æ•°æ˜¯threadLoopï¼Œä¸‹é¢çœ‹çœ‹InputDispatcherThreadè¿™ä¸€åˆ†å‘æ¶ˆæ¯çš„çº¿ç¨‹çš„å¾ªç¯ä½“&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre
      
    
    </summary>
    
      <category term="Android" scheme="http://lihaizhou.top/categories/Android/"/>
    
    
  </entry>
  
  <entry>
    <title>Androidè¾“å…¥ç³»ç»Ÿç³»åˆ—(3)----è¯»å–RawEvent</title>
    <link href="http://lihaizhou.top/2018/07/03/Android%E8%BE%93%E5%85%A5%E7%B3%BB%E7%BB%9F%E7%B3%BB%E5%88%97-3-%E8%AF%BB%E5%8F%96RawEvent/"/>
    <id>http://lihaizhou.top/2018/07/03/Androidè¾“å…¥ç³»ç»Ÿç³»åˆ—-3-è¯»å–RawEvent/</id>
    <published>2018-07-03T14:10:50.000Z</published>
    <updated>2019-12-28T07:02:20.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹‹å‰ç³»åˆ—æ–‡ç« (1)ä¸­æåˆ°InputManagerä¸­çš„startæ–¹æ³•é‡Œè°ƒç”¨äº†ReaderThread-&gt;runï¼Œå¯æ˜¯æˆ‘ä»¬åœ¨InputReaderä¸­æ²¡æœ‰çœ‹åˆ°runæ–¹æ³•<br>è¿™ä¸€ç‚¹å’Œjavaä¸­çš„çº¿ç¨‹è¿è¡Œæ–¹å¼æœ‰ç‚¹åŒºåˆ«ï¼ŒCä¸‹çš„çº¿ç¨‹è¿è¡Œæ˜¯threadLoopè¿™ä¸ªæ–¹æ³•ï¼Œè¿™æ˜¯ä¸ªè™šå‡½æ•°ï¼Œè¿½æº¯åˆ°çˆ¶ç±»çº¿ç¨‹ä¸­æ˜¯æœ‰runè¿™ä¸ªæ–¹æ³•<br>å±‚å±‚å¾€ä¸‹è·Ÿå°±ä¼šè·Ÿåˆ°threadLoopæ–¹æ³•ï¼Œå¦‚æœthreadLoopè¿”å›falseåˆ™ä¼šé€€å‡ºå¾ªç¯</p><p>ä¸‹é¢çœ‹ä¸‹InputReaderçš„threadLoopæ–¹æ³•ï¼Œå¯è§è¿™é‡Œè¿”å›trueï¼Œè¯´æ˜æ˜¯åå¤å¾ªç¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">frameworks\<span class="keyword">native</span>\services\inputflinger\InputReader.cpp</span><br><span class="line">bool InputReaderThread::threadLoop() &#123;</span><br><span class="line">    mReader-&gt;loopOnce();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢ç€é‡çœ‹ä¸‹è¿™é‡Œçš„loopOnceå‡½æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">frameworks\<span class="keyword">native</span>\services\inputflinger\InputReader.cpp</span><br><span class="line"><span class="keyword">void</span> InputReader::loopOnce() &#123;</span><br><span class="line">    <span class="comment">//çœç•¥éƒ¨åˆ†ä»£ç </span></span><br><span class="line">    <span class="comment">//ä¸Šæ–‡ä¸­è®²è¿‡æ­¤å¤„çš„getEventsï¼Œä½œç”¨æ˜¯è·å–Eventï¼Œè¯»å–åˆ°çš„Eventä¿å­˜åœ¨mEventBufferä¸­ï¼Œå¹¶è¿”å›Eventçš„æ•°é‡</span></span><br><span class="line">    size_t count = mEventHub-&gt;getEvents(timeoutMillis, mEventBuffer, EVENT_BUFFER_SIZE);</span><br><span class="line"></span><br><span class="line">    &#123; <span class="comment">// acquire lock</span></span><br><span class="line">        <span class="function">AutoMutex <span class="title">_l</span><span class="params">(mLock)</span></span>;</span><br><span class="line">        mReaderIsAliveCondition.broadcast();</span><br><span class="line">        <span class="comment">//åˆ¤æ–­è¯»å–åˆ°çš„eventæ•°é‡ï¼Œå¤§äº0åˆ™è¿›å…¥processEventsLockedå¤„ç†</span></span><br><span class="line">        <span class="keyword">if</span> (count) &#123;</span><br><span class="line">            processEventsLocked(mEventBuffer, count);</span><br><span class="line">        &#125;</span><br><span class="line">         <span class="comment">//çœç•¥éƒ¨åˆ†ä»£ç </span></span><br><span class="line">    &#125; <span class="comment">// release lock</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Send out a message that the describes the changed input devices.</span></span><br><span class="line">    <span class="keyword">if</span> (inputDevicesChanged) &#123;</span><br><span class="line">        mPolicy-&gt;notifyInputDevicesChanged(inputDevices);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Flush queued events out to the listener.</span></span><br><span class="line">    <span class="comment">// This must happen outside of the lock because the listener could potentially call</span></span><br><span class="line">    <span class="comment">// back into the InputReader's methods, such as getScanCodeState, or become blocked</span></span><br><span class="line">    <span class="comment">// on another thread similarly waiting to acquire the InputReader lock thereby</span></span><br><span class="line">    <span class="comment">// resulting in a deadlock.  This situation is actually quite plausible because the</span></span><br><span class="line">    <span class="comment">// listener is actually the input dispatcher, which calls into the window manager,</span></span><br><span class="line">    <span class="comment">// which occasionally calls into the input reader.</span></span><br><span class="line">    mQueuedListener-&gt;flush();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šæ–‡ä»‹ç»è¿‡EventHubçš„getEventçš„å¤§ä½“æµç¨‹å°±æ˜¯:<br>è¯»å–æ¯ä¸ªè®¾å¤‡çš„æ•°æ®ï¼Œå½¢æˆRawEventç»“æ„åæ”¾åˆ°readBufferä¸­ï¼Œå¦‚æœæ²¡æœ‰è¾“å…¥äº‹ä»¶ï¼Œå°†è°ƒç”¨epoll_wait()å‡½æ•°é˜»å¡ç­‰å¾…</p><p>æ‰€ä»¥InputReaderThreadçº¿ç¨‹å¤§éƒ¨åˆ†æ—¶é—´éƒ½æ˜¯åœ¨epoll_wait()ä¸Šç­‰å¾…ï¼Œå¦‚æœæŸä¸ªè®¾å¤‡ä¸Šæœ‰äº‹ä»¶ä¸Šæ¥ï¼Œåˆ™å”¤é†’çº¿ç¨‹ï¼Œä»è®¾å¤‡ä¸­è¯»å–æ•°æ®ï¼Œè¯»å–åˆ°çš„æ•°æ®å½¢æˆRawEventå½¢å¼ï¼Œå­˜æ”¾åœ¨mEventBufferä¸­ï¼Œç„¶åè°ƒç”¨processEventsLockedè¿›è¡Œå¤„ç†</p><p>ä¸‹é¢æ¥çœ‹çœ‹processEventsLockedè¿™ä¸€å‡½æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> InputReader::processEventsLocked(<span class="keyword">const</span> RawEvent* rawEvents, size_t count) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> RawEvent* rawEvent = rawEvents; count;) &#123;</span><br><span class="line">        int32_t type = rawEvent-&gt;type;</span><br><span class="line">        size_t batchSize = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (type &lt; EventHubInterface::FIRST_SYNTHETIC_EVENT) &#123;</span><br><span class="line">            int32_t deviceId = rawEvent-&gt;deviceId;</span><br><span class="line">            <span class="keyword">while</span> (batchSize &lt; count) &#123;</span><br><span class="line">                <span class="keyword">if</span> (rawEvent[batchSize].type &gt;= EventHubInterface::FIRST_SYNTHETIC_EVENT</span><br><span class="line">                        || rawEvent[batchSize].deviceId != deviceId) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                batchSize += <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">#if DEBUG_RAW_EVENTS</span><br><span class="line">            ALOGD(<span class="string">"BatchSize: %d Count: %d"</span>, batchSize, count);</span><br><span class="line">#endif</span><br><span class="line">            processEventsForDeviceLocked(deviceId, rawEvent, batchSize);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> (rawEvent-&gt;type) &#123;</span><br><span class="line">            <span class="keyword">case</span> EventHubInterface::DEVICE_ADDED:</span><br><span class="line">                addDeviceLocked(rawEvent-&gt;when, rawEvent-&gt;deviceId);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> EventHubInterface::DEVICE_REMOVED:</span><br><span class="line">                removeDeviceLocked(rawEvent-&gt;when, rawEvent-&gt;deviceId);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> EventHubInterface::FINISHED_DEVICE_SCAN:</span><br><span class="line">                handleConfigurationChangedLocked(rawEvent-&gt;when);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                ALOG_ASSERT(<span class="keyword">false</span>); <span class="comment">// can't happen</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        count -= batchSize;</span><br><span class="line">        rawEvent += batchSize;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„RawEventåˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ç±»æ˜¯è®¾å¤‡å‘ç”Ÿå˜åŒ–çš„Eventï¼ŒåŒ…æ‹¬æ·»åŠ è®¾å¤‡ï¼Œç§»é™¤è®¾å¤‡å’Œæ‰«æè®¾å¤‡ã€‚å¦ä¸€ç±»æ˜¯è®¾å¤‡è‡ªèº«äº§ç”Ÿçš„Eventï¼Œä¾‹å¦‚é”®ç›˜çš„æŒ‰é”®Eventï¼Œå¯¹äºè¿™ä¸€ç±»Eventï¼Œä¼šä»RawEventæ•°ç»„ä¸­å–å‡ºè¿ç»­çš„åŒç±»Eventï¼Œé€šè¿‡processEventsForDeviceLockedå‡½æ•°è¿›è¡Œä¸€å¹¶å¤„ç†ï¼Œè¿™ä¹Ÿæ˜¯æ¥ä¸‹æ¥è®¨è®ºçš„é‡ç‚¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> InputReader::processEventsForDeviceLocked(int32_t deviceId,</span><br><span class="line">        <span class="keyword">const</span> RawEvent* rawEvents, size_t count) &#123;</span><br><span class="line">    ssize_t deviceIndex = mDevices.indexOfKey(deviceId);</span><br><span class="line">    <span class="keyword">if</span> (deviceIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGW(<span class="string">"Discarding event for unknown deviceId %d."</span>, deviceId);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    InputDevice* device = mDevices.valueAt(deviceIndex);</span><br><span class="line">    <span class="keyword">if</span> (device-&gt;isIgnored()) &#123;</span><br><span class="line">        <span class="comment">//ALOGD("Discarding event for ignored deviceId %d.", deviceId);</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    device-&gt;process(rawEvents, count);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ ¹æ®ä¼ è¿›æ¥çš„deviceIdç”ŸæˆInputDeviceå¯¹è±¡ï¼Œå…³é”®ä»£ç åœ¨æœ€åä¸€å¥ï¼Œè¿™é‡Œè°ƒç”¨äº†InputDeviceçš„processå‡½æ•°<br>frameworks\native\services\inputflinger\InputReader.cpp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> InputDevice::process(<span class="keyword">const</span> RawEvent* rawEvents, size_t count) &#123;</span><br><span class="line">    <span class="comment">// Process all of the events in order for each mapper.</span></span><br><span class="line">    <span class="comment">// We cannot simply ask each mapper to process them in bulk because mappers may</span></span><br><span class="line">    <span class="comment">// have side-effects that must be interleaved.  For example, joystick movement events and</span></span><br><span class="line">    <span class="comment">// gamepad button presses are handled by different mappers but they should be dispatched</span></span><br><span class="line">    <span class="comment">// in the order received.</span></span><br><span class="line">    size_t numMappers = mMappers.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> RawEvent* rawEvent = rawEvents; count--; rawEvent++) &#123;</span><br><span class="line">#if DEBUG_RAW_EVENTS</span><br><span class="line">        ALOGD(<span class="string">"Input event: device=%d type=0x%04x code=0x%04x value=0x%08x when=%lld"</span>,</span><br><span class="line">                rawEvent-&gt;deviceId, rawEvent-&gt;type, rawEvent-&gt;code, rawEvent-&gt;value,</span><br><span class="line">                rawEvent-&gt;when);</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mDropUntilNextSync) &#123;</span><br><span class="line">            <span class="keyword">if</span> (rawEvent-&gt;type == EV_SYN &amp;&amp; rawEvent-&gt;code == SYN_REPORT) &#123;</span><br><span class="line">                mDropUntilNextSync = <span class="keyword">false</span>;</span><br><span class="line">#if DEBUG_RAW_EVENTS</span><br><span class="line">                ALOGD(<span class="string">"Recovered from input event buffer overrun."</span>);</span><br><span class="line">#endif</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">#if DEBUG_RAW_EVENTS</span><br><span class="line">                ALOGD(<span class="string">"Dropped input event while waiting for next input sync."</span>);</span><br><span class="line">#endif</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rawEvent-&gt;type == EV_SYN &amp;&amp; rawEvent-&gt;code == SYN_DROPPED) &#123;</span><br><span class="line">            ALOGI(<span class="string">"Detected input event buffer overrun for device %s."</span>, getName().string());</span><br><span class="line">            mDropUntilNextSync = <span class="keyword">true</span>;</span><br><span class="line">            reset(rawEvent-&gt;when);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (size_t i = <span class="number">0</span>; i &lt; numMappers; i++) &#123;</span><br><span class="line">                InputMapper* mapper = mMappers[i];</span><br><span class="line">                mapper-&gt;process(rawEvent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹è¿™ä¸ªå‡½æ•°å¼€å¤´çš„ä¸€æ®µæ³¨è§£ï¼Œå¤§æ„å°±æ˜¯æ ¹æ®ä¸åŒçš„Inputè®¾å¤‡æ¶ˆæ¯è°ƒç”¨ä¸åŒçš„inputMapper,å› ä¸ºInputè®¾å¤‡æœ‰å¾ˆå¤šç§ï¼Œæ‰€ä»¥Inputmapperä¹Ÿæœ‰å¾ˆå¤šç§ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯æ ¹æ®ä¸åŒçš„Inputè®¾å¤‡è°ƒç”¨å¯¹åº”çš„InputMapperçš„processæ¥å¤„ç†<br>InputReader.cppè¿™æ”¯æ–‡ä»¶ä¸­æœ‰å¾ˆå¤šä¸åŒç±»å‹çš„InputMapperï¼Œè¿™é‡Œä¾‹ä¸¾å…¶ä¸­çš„KeyboardInputMapperè¿›è¡Œè¯´æ˜<br>frameworks\native\services\inputflinger\InputReader.cpp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> KeyboardInputMapper::process(<span class="keyword">const</span> RawEvent* rawEvent) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (rawEvent-&gt;type) &#123;</span><br><span class="line">    <span class="keyword">case</span> EV_KEY: &#123; <span class="comment">//æŒ‰é”®æ¶ˆæ¯</span></span><br><span class="line">        int32_t scanCode = rawEvent-&gt;code;</span><br><span class="line">        int32_t usageCode = mCurrentHidUsage;</span><br><span class="line">        mCurrentHidUsage = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isKeyboardOrGamepadKey(scanCode)) &#123;</span><br><span class="line">            processKey(rawEvent-&gt;when, rawEvent-&gt;value != <span class="number">0</span>, scanCode, usageCode);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//çœç•¥éƒ¨åˆ†ä»£ç </span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€çœ‹processKeyè¿™ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ¯”è¾ƒé•¿</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> KeyboardInputMapper::processKey(nsecs_t when, bool down, int32_t scanCode,</span><br><span class="line">        int32_t usageCode) &#123;</span><br><span class="line">    <span class="comment">//çœç•¥éƒ¨åˆ†ä»£ç </span></span><br><span class="line">    <span class="function">NotifyKeyArgs <span class="title">args</span><span class="params">(when, getDeviceId()</span>, mSource, policyFlags,</span></span><br><span class="line"><span class="function">            down ? AKEY_EVENT_ACTION_DOWN : AKEY_EVENT_ACTION_UP,</span></span><br><span class="line"><span class="function">            AKEY_EVENT_FLAG_FROM_SYSTEM, keyCode, scanCode, keyMetaState, downTime)</span>;</span><br><span class="line">    getListener()-&gt;notifyKey(&amp;args);</span><br><span class="line">    <span class="comment">//çœç•¥éƒ¨åˆ†ä»£ç </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°ä¸»è¦å·¥ä½œæ˜¯å°†æ‰«æç è½¬æ¢ä¸ºé”®ç›˜ç ï¼Œç„¶åè°ƒç”¨äº†getListener()-&gt;notifyKey(&amp;args); </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">InputListenerInterface* InputReader::ContextImpl::getListener() &#123;</span><br><span class="line">    <span class="keyword">return</span> mReader-&gt;mQueuedListener.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€çœ‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> QueuedInputListener::notifyKey(<span class="keyword">const</span> NotifyKeyArgs* args) &#123;</span><br><span class="line">    mArgsQueue.push(<span class="keyword">new</span> NotifyKeyArgs(*args));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåªæ˜¯å°†argså‚æ•°æ”¾åˆ°äº†mArgsQueueä¸­</p><p>å¾€ä¸Šçœ‹æœ€å¼€å§‹çš„InputReader::loopOnce()ä¸­mQueuedListener-&gt;flush();</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> QueuedInputListener::flush() &#123;</span><br><span class="line">    size_t count = mArgsQueue.size();</span><br><span class="line">    <span class="keyword">for</span> (size_t i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        NotifyArgs* args = mArgsQueue[i];</span><br><span class="line">        args-&gt;notify(mInnerListener);</span><br><span class="line">        delete args;</span><br><span class="line">    &#125;</span><br><span class="line">    mArgsQueue.clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå’ŒmArgsQueueç‰µæ‰¯ä¸Šäº†ï¼Œè¿™é‡Œçš„flush()å‡½æ•°ä½œç”¨æ˜¯å°†mArgsQueueä¸­çš„NotifyArgséƒ½æ‹¿å‡ºæ¥ï¼Œè°ƒç”¨å®ƒä»¬çš„notifyå‡½æ•°<br>è¿™é‡Œè¿˜æ˜¯ä»¥Keyä¸ºä¾‹ï¼Œå®é™…çš„å¯¹è±¡ç±»å‹æ˜¯NotifyKeyArgs</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> NotifyKeyArgs::notify(<span class="keyword">const</span> sp&lt;InputListenerInterface&gt;&amp; listener) <span class="keyword">const</span> &#123;</span><br><span class="line">    listener-&gt;notifyKey(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„listeneræŒ‡é’ˆåœ¨æ„é€ InputReaderæ˜¯ä½œä¸ºå‚æ•°çš„ï¼Œè¿½è¸ªæºç å¾—çŸ¥è¿™ä¸€listenerå®é™…æ˜¯æŒ‡å‘InputDispatcherçš„æŒ‡é’ˆ</p><p>æ¥ç€çœ‹InputDispatcherçš„notifyKey<br>\frameworks\native\services\inputflinger\InputDispatcher.cpp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> InputDispatcher::notifyKey(<span class="keyword">const</span> NotifyKeyArgs* args) &#123;</span><br><span class="line"><span class="comment">//çœç•¥éƒ¨åˆ†ä»£ç </span></span><br><span class="line">    KeyEvent event;</span><br><span class="line">    event.initialize(args-&gt;deviceId, args-&gt;source, args-&gt;action,</span><br><span class="line">            flags, keyCode, args-&gt;scanCode, metaState, <span class="number">0</span>,</span><br><span class="line">            args-&gt;downTime, args-&gt;eventTime);</span><br><span class="line"></span><br><span class="line">    mPolicy-&gt;interceptKeyBeforeQueueing(&amp;event, <span class="comment">/*byref*/</span> policyFlags);</span><br><span class="line"></span><br><span class="line">    bool needWake;</span><br><span class="line">    &#123; <span class="comment">// acquire lock</span></span><br><span class="line">        mLock.lock();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (shouldSendKeyToInputFilterLocked(args)) &#123;</span><br><span class="line">            mLock.unlock();</span><br><span class="line"></span><br><span class="line">            policyFlags |= POLICY_FLAG_FILTERED;</span><br><span class="line">            <span class="keyword">if</span> (!mPolicy-&gt;filterInputEvent(&amp;event, policyFlags)) &#123;</span><br><span class="line">                <span class="keyword">return</span>; <span class="comment">// event was consumed by the filter</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            mLock.lock();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        int32_t repeatCount = <span class="number">0</span>;</span><br><span class="line">        KeyEntry* newEntry = <span class="keyword">new</span> KeyEntry(args-&gt;eventTime,</span><br><span class="line">                args-&gt;deviceId, args-&gt;source, policyFlags,</span><br><span class="line">                args-&gt;action, flags, keyCode, args-&gt;scanCode,</span><br><span class="line">                metaState, repeatCount, args-&gt;downTime);</span><br><span class="line"></span><br><span class="line">        needWake = enqueueInboundEventLocked(newEntry);</span><br><span class="line">        mLock.unlock();</span><br><span class="line">    &#125; <span class="comment">// release lock</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (needWake) &#123;</span><br><span class="line">        mLooper-&gt;wake();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåˆ©ç”¨å‡½æ•°çš„å‚æ•°NotifyKeyArgsåˆ›å»ºäº†KeyEntryå¯¹è±¡ï¼Œç„¶åè°ƒç”¨å‡½æ•°enqueueInboundEventLockedå°†åˆ›å»ºå¥½çš„KeyEntryå¯¹è±¡åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œè¿™é‡Œé¡ºä¾¿çœ‹ä¸‹enqueueInboundEventLockedå‡½æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bool InputDispatcher::enqueueInboundEventLocked(EventEntry* entry) &#123;</span><br><span class="line">    bool needWake = mInboundQueue.isEmpty();</span><br><span class="line">    mInboundQueue.enqueueAtTail(entry);</span><br><span class="line">    traceInboundQueueLengthLocked();</span><br><span class="line">    <span class="comment">//çœç•¥éƒ¨åˆ†ä»£ç </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°åˆ›å»ºå¥½çš„KeyEntryå¯¹è±¡æ˜¯è¢«åŠ å…¥åˆ°äº†mInboundQueueé˜Ÿåˆ—ä¸­å»äº†</p><p>è‡ªæ­¤ï¼Œè¯»å–æ¶ˆæ¯æµç¨‹åˆ†æç»“æŸ</p><hr><font color="#000000" size="2" face="æ¥·ä½“">ä½æ‰€ï¼Œç”µè„‘å‰ï¼Œæ±—è¡«ï¼Œå¬ç€æ­Œï¼Œæœ€è¿‘æœ‰ç‚¹ä¸§</font>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ä¹‹å‰ç³»åˆ—æ–‡ç« (1)ä¸­æåˆ°InputManagerä¸­çš„startæ–¹æ³•é‡Œè°ƒç”¨äº†ReaderThread-&amp;gt;runï¼Œå¯æ˜¯æˆ‘ä»¬åœ¨InputReaderä¸­æ²¡æœ‰çœ‹åˆ°runæ–¹æ³•&lt;br&gt;è¿™ä¸€ç‚¹å’Œjavaä¸­çš„çº¿ç¨‹è¿è¡Œæ–¹å¼æœ‰ç‚¹åŒºåˆ«ï¼ŒCä¸‹çš„çº¿ç¨‹è¿è¡Œæ˜¯threadLoopè¿™ä¸ªæ–¹æ³•ï¼Œè¿™æ˜¯ä¸ªè™šå‡½
      
    
    </summary>
    
      <category term="Android" scheme="http://lihaizhou.top/categories/Android/"/>
    
    
  </entry>
  
  <entry>
    <title>Androidè¾“å…¥ç³»ç»Ÿç³»åˆ—(2)----EventHub</title>
    <link href="http://lihaizhou.top/2018/06/12/Android%E8%BE%93%E5%85%A5%E7%B3%BB%E7%BB%9F%E7%B3%BB%E5%88%97-2-EventHub/"/>
    <id>http://lihaizhou.top/2018/06/12/Androidè¾“å…¥ç³»ç»Ÿç³»åˆ—-2-EventHub/</id>
    <published>2018-06-12T14:11:02.000Z</published>
    <updated>2019-12-28T07:02:26.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸Šç¯‡æ–‡ç« ä¸­è¯´åˆ°eventhubæ˜¯åœ¨NativeInputManagerçš„æ„é€ å‡½æ•°newå‡ºæ¥</p><p>ä¸€å°ç§»åŠ¨è®¾å¤‡èƒ½äº§ç”Ÿè¾“å…¥æ¶ˆæ¯çš„éƒ¨ä»¶å¾ˆå¤šï¼ŒåŒ…æ‹¬é”®ç›˜ï¼Œè§¦æ‘¸å±ï¼ŒæŒ‰é”®ç­‰ã€‚EventHubçš„ä½œç”¨å°±æ˜¯æŠŠæ‰€æœ‰è¿™äº›è®¾å¤‡äº§ç”Ÿçš„æ¶ˆæ¯ç»Ÿä¸€æˆä¸€ç§æ ¼å¼ï¼Œå†å‘å¾€ä¸Šå±‚è¿›è¡Œå¤„ç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">EventHub::EventHub(<span class="keyword">void</span>) :</span><br><span class="line">        mBuiltInKeyboardId(NO_BUILT_IN_KEYBOARD), mNextDeviceId(<span class="number">1</span>), mControllerNumbers(),</span><br><span class="line">        mOpeningDevices(<span class="number">0</span>), mClosingDevices(<span class="number">0</span>),</span><br><span class="line">        mNeedToSendFinishedDeviceScan(<span class="keyword">false</span>),</span><br><span class="line">        mNeedToReopenDevices(<span class="keyword">false</span>), mNeedToScanDevices(<span class="keyword">true</span>),</span><br><span class="line">        mPendingEventCount(<span class="number">0</span>), mPendingEventIndex(<span class="number">0</span>), mPendingINotify(<span class="keyword">false</span>) &#123;</span><br><span class="line">    acquire_wake_lock(PARTIAL_WAKE_LOCK, WAKE_LOCK_ID);</span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªepollå¥æŸ„</span></span><br><span class="line">    mEpollFd = epoll_create(EPOLL_SIZE_HINT);</span><br><span class="line">    LOG_ALWAYS_FATAL_IF(mEpollFd &lt; <span class="number">0</span>, <span class="string">"Could not create epoll instance.  errno=%d"</span>, errno);</span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªInotifyå¯¹è±¡</span></span><br><span class="line">    mINotifyFd = inotify_init();</span><br><span class="line">    <span class="comment">//ç›‘è§†/dev/inputç›®å½•å˜åŒ–</span></span><br><span class="line">    <span class="keyword">int</span> result = inotify_add_watch(mINotifyFd, DEVICE_PATH, IN_DELETE | IN_CREATE);</span><br><span class="line">    LOG_ALWAYS_FATAL_IF(result &lt; <span class="number">0</span>, <span class="string">"Could not register INotify for %s.  errno=%d"</span>,</span><br><span class="line">            DEVICE_PATH, errno);</span><br><span class="line"></span><br><span class="line">    struct epoll_event eventItem;</span><br><span class="line">    memset(&amp;eventItem, <span class="number">0</span>, sizeof(eventItem));</span><br><span class="line">    eventItem.events = EPOLLIN;</span><br><span class="line">    eventItem.data.u32 = EPOLL_ID_INOTIFY;</span><br><span class="line">    <span class="comment">//å°†inotifyçš„å¥æŸ„åŠ å…¥åˆ°epollçš„ç›‘æµ‹ä¸­</span></span><br><span class="line">    result = epoll_ctl(mEpollFd, EPOLL_CTL_ADD, mINotifyFd, &amp;eventItem);</span><br><span class="line">    LOG_ALWAYS_FATAL_IF(result != <span class="number">0</span>, <span class="string">"Could not add INotify to epoll instance.  errno=%d"</span>, errno);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> wakeFds[<span class="number">2</span>];</span><br><span class="line">    <span class="comment">//åˆ›å»ºåŒ¿åç®¡é“</span></span><br><span class="line">    result = pipe(wakeFds);</span><br><span class="line">    LOG_ALWAYS_FATAL_IF(result != <span class="number">0</span>, <span class="string">"Could not create wake pipe.  errno=%d"</span>, errno);</span><br><span class="line"></span><br><span class="line">    mWakeReadPipeFd = wakeFds[<span class="number">0</span>];</span><br><span class="line">    mWakeWritePipeFd = wakeFds[<span class="number">1</span>];</span><br><span class="line">    <span class="comment">//å°†ç®¡é“è¯»ç«¯å’Œå†™ç«¯è®¾æˆéé˜»å¡æ¨¡å¼</span></span><br><span class="line">    result = fcntl(mWakeReadPipeFd, F_SETFL, O_NONBLOCK);</span><br><span class="line">    result = fcntl(mWakeWritePipeFd, F_SETFL, O_NONBLOCK);</span><br><span class="line">    <span class="comment">//çœç•¥éƒ¨åˆ†ä»£ç </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>EventHubçš„æ„é€ å‡½æ•°é¦–å…ˆåˆ›å»ºäº†epollå¥æŸ„ï¼Œç„¶ååˆ›å»ºäº†ä¸€ä¸ªinotifyå¥æŸ„å’Œä¸€ä¸ªåŒ¿åç®¡é“ï¼Œå¹¶å°†inotifyçš„å¥æŸ„å’Œç®¡é“çš„â€è¯»ç«¯â€å¥æŸ„éƒ½åŠ å…¥åˆ°epollçš„ç›‘æµ‹ä¸­ã€‚</p><p>è¿™é‡Œè¯´æ˜ä¸‹inotifyçš„ä½œç”¨<br>inotifyæ˜¯Linuxä¸­ç›‘è§†ç›®å½•å’Œæ–‡ä»¶å˜åŒ–çš„ä¸€ç§æœºåˆ¶ï¼Œè¿™é‡Œç›‘è§†çš„æ˜¯/dev/inputï¼ŒAndoridä¸­çš„FileObserverå°±æ˜¯å°è£…çš„inotifyï¼Œå¯ä»¥ç›´æ¥åœ¨javaä¸­ä½¿ç”¨</p><p>æ—¢ç„¶EventHubæœ€ç»ˆéœ€è¦å°†æ¶ˆæ¯ä¼ ç»™ä¸Šå±‚ï¼Œé‚£ä¹ˆEventHubä¸­çš„æ¶ˆæ¯åˆæ˜¯å¦‚ä½•è·å–çš„å‘¢ï¼Ÿä»å®ƒçš„æ„é€ å‡½æ•°æ¥çœ‹ï¼Œå¹¶æ²¡æœ‰çœ‹åˆ°ä¸è®¾å¤‡å…³è”çš„åŠ¨ä½œã€‚å…¶å®æ˜¯é€šè¿‡EventHubçš„getEvents()å‡½æ•°  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">size_t EventHub::getEvents(<span class="keyword">int</span> timeoutMillis, RawEvent* buffer, size_t bufferSize) &#123;</span><br><span class="line">       <span class="comment">//çœç•¥éƒ¨åˆ†ä»£ç </span></span><br><span class="line">       <span class="keyword">if</span> (mNeedToScanDevices) &#123;</span><br><span class="line">            mNeedToScanDevices = <span class="keyword">false</span>;</span><br><span class="line">            scanDevicesLocked();</span><br><span class="line">            mNeedToSendFinishedDeviceScan = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//çœç•¥éƒ¨åˆ†ä»£ç </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé€šè¿‡mNeedToScanDeviceså˜é‡æ§åˆ¶æ¥åˆ¤æ–­æ‰«ææ˜¯å¦å®Œæˆ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> EventHub::scanDevicesLocked() &#123;</span><br><span class="line">    status_t res = scanDirLocked(DEVICE_PATH);</span><br><span class="line">    <span class="keyword">if</span>(res &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"scan dir failed for %s\n"</span>, DEVICE_PATH);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mDevices.indexOfKey(VIRTUAL_KEYBOARD_ID) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        createVirtualKeyboardLocked();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè°ƒç”¨äº†scanDirLockedå‡½æ•°ï¼Œæ¥ç€çœ‹è¿™ä¸ªå‡½æ•°åšäº†ä»€ä¹ˆ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">status_t EventHub::scanDirLocked(<span class="keyword">const</span> <span class="keyword">char</span> *dirname)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span> devname[PATH_MAX];</span><br><span class="line">    <span class="keyword">char</span> *filename;</span><br><span class="line">    DIR *dir;</span><br><span class="line">    struct dirent *de;</span><br><span class="line">    dir = opendir(dirname);</span><br><span class="line">    <span class="keyword">if</span>(dir == NULL)</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    strcpy(devname, dirname);</span><br><span class="line">    filename = devname + strlen(devname);</span><br><span class="line">    *filename++ = <span class="string">'/'</span>;</span><br><span class="line">    <span class="keyword">while</span>((de = readdir(dir))) &#123;</span><br><span class="line">        <span class="keyword">if</span>(de-&gt;d_name[<span class="number">0</span>] == <span class="string">'.'</span> &amp;&amp;</span><br><span class="line">          (de-&gt;d_name[<span class="number">1</span>] == <span class="string">'\0'</span> ||</span><br><span class="line">            (de-&gt;d_name[<span class="number">1</span>] == <span class="string">'.'</span> &amp;&amp; de-&gt;d_name[<span class="number">2</span>] == <span class="string">'\0'</span>)))</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        strcpy(filename, de-&gt;d_name);</span><br><span class="line">        openDeviceLocked(devname);</span><br><span class="line">    &#125;</span><br><span class="line">    closedir(dir);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„å‚æ•°dirnameå¯¹åº”çš„æ˜¯DEVICE_PATHï¼Œå®šä¹‰å¦‚ä¸‹<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> *DEVICE_PATH = <span class="string">"/dev/input"</span>;</span><br></pre></td></tr></table></figure></p><p>ç”±æ­¤å¯çŸ¥ï¼ŒscanDirLockedå‡½æ•°çš„ä½œç”¨æ˜¯æ‰«æ/dev/inputç›®å½•</p><p>æˆ‘æ‰‹é‡Œçš„æ‰‹æœºä¸Š/dev/inputç›®å½•å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/dev/input # ls</span><br><span class="line">event0 event1 event2 event3 event4 event5 event6</span><br></pre></td></tr></table></figure><p>åœ¨dev/inputä¸‹å­˜æ”¾çš„å¹¶ä¸æ˜¯è®¾å¤‡ï¼Œè€Œæ˜¯eventæ–‡ä»¶ï¼Œè¿™äº›eventæ–‡ä»¶å¯¹åº”çš„è®¾å¤‡ä¿¡æ¯åœ¨æ–‡ä»¶proc/bus/input/devicesä¸­å¯ä»¥æŸ¥åˆ°<br>è¿™é‡Œè´´å‡ºå…¶ä¸­ä¸€ä¸ªæ‰“å°ç‰‡æ®µ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">I: Bus=<span class="number">0019</span> Vendor=<span class="number">2454</span> Product=<span class="number">6500</span> Version=<span class="number">0010</span></span><br><span class="line">N: Name=<span class="string">"mtk-kpd"</span></span><br><span class="line">P: Phys=</span><br><span class="line">S: Sysfs=/devices/platform/<span class="number">10010000</span>.kp/input/input1</span><br><span class="line">U: Uniq=</span><br><span class="line">H: Handlers=gpufreq_ib event1</span><br><span class="line">B: PROP=<span class="number">0</span></span><br><span class="line">B: EV=<span class="number">3</span></span><br><span class="line">B: KEY=<span class="number">140000</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><p>scanDirLockedå‡½æ•°æ‰“å¼€/dev/inputç›®å½•åï¼Œå¯¹ç›®å½•ä¸‹çš„æ¯ä¸ªæ–‡ä»¶éƒ½è°ƒç”¨openDeviceLocked()å‡½æ•°<br>çœ‹ä¸‹è¿™ä¸ªå‡½æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">status_t EventHub::openDeviceLocked(<span class="keyword">const</span> <span class="keyword">char</span> *devicePath) &#123;</span><br><span class="line">    <span class="comment">//çœç•¥éƒ¨åˆ†ä»£ç </span></span><br><span class="line">    <span class="comment">// Get device name.</span></span><br><span class="line">    <span class="keyword">if</span>(ioctl(fd, EVIOCGNAME(sizeof(buffer) - <span class="number">1</span>), &amp;buffer) &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">//fprintf(stderr, "could not get device name for %s, %s\n", devicePath, strerror(errno));</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        buffer[sizeof(buffer) - <span class="number">1</span>] = <span class="string">'\0'</span>;</span><br><span class="line">        identifier.name.setTo(buffer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check to see if the device is on our excluded list</span></span><br><span class="line">    <span class="keyword">for</span> (size_t i = <span class="number">0</span>; i &lt; mExcludedDevices.size(); i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> String8&amp; item = mExcludedDevices.itemAt(i);</span><br><span class="line">        <span class="keyword">if</span> (identifier.name == item) &#123;</span><br><span class="line">            ALOGI(<span class="string">"ignoring event id %s driver %s\n"</span>, devicePath, item.string());</span><br><span class="line">            close(fd);</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get device driver version.</span></span><br><span class="line">    <span class="keyword">int</span> driverVersion;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(fd, EVIOCGVERSION, &amp;driverVersion)) &#123;</span><br><span class="line">        ALOGE(<span class="string">"could not get driver version for %s, %s\n"</span>, devicePath, strerror(errno));</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get device identifier.</span></span><br><span class="line">    struct input_id inputId;</span><br><span class="line">    <span class="keyword">if</span>(ioctl(fd, EVIOCGID, &amp;inputId)) &#123;</span><br><span class="line">        ALOGE(<span class="string">"could not get device input id for %s, %s\n"</span>, devicePath, strerror(errno));</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    identifier.bus = inputId.bustype;</span><br><span class="line">    identifier.product = inputId.product;</span><br><span class="line">    identifier.vendor = inputId.vendor;</span><br><span class="line">    identifier.version = inputId.version;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get device physical location.</span></span><br><span class="line">    <span class="keyword">if</span>(ioctl(fd, EVIOCGPHYS(sizeof(buffer) - <span class="number">1</span>), &amp;buffer) &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">//fprintf(stderr, "could not get location for %s, %s\n", devicePath, strerror(errno));</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        buffer[sizeof(buffer) - <span class="number">1</span>] = <span class="string">'\0'</span>;</span><br><span class="line">        identifier.location.setTo(buffer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get device unique id.</span></span><br><span class="line">    <span class="keyword">if</span>(ioctl(fd, EVIOCGUNIQ(sizeof(buffer) - <span class="number">1</span>), &amp;buffer) &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">//fprintf(stderr, "could not get idstring for %s, %s\n", devicePath, strerror(errno));</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        buffer[sizeof(buffer) - <span class="number">1</span>] = <span class="string">'\0'</span>;</span><br><span class="line">        identifier.uniqueId.setTo(buffer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//çœç•¥éƒ¨åˆ†ä»£ç </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°éå¸¸é•¿ï¼Œåšçš„äº‹æƒ…ä¸»è¦æ˜¯æ‰“å¼€è®¾å¤‡ï¼Œè·å–è®¾å¤‡çš„ä¿¡æ¯åŒ…æ‹¬è®¾å¤‡åç§°ï¼Œidç­‰ã€‚ç„¶åæ ¹æ®è¿™äº›ä¿¡æ¯åˆ¤æ–­è®¾å¤‡çš„ç±»å‹ï¼Œå¹¶æ ¹æ®è®¾å¤‡çš„ä¸åŒï¼Œè¿›è¡Œä¸åŒçš„åˆå§‹åŒ–ï¼Œæ¥ç€ä¸ºè®¾å¤‡åˆ›å»ºä¸€ä¸ªDeviceå¯¹è±¡ã€‚å¹¶å°†è®¾å¤‡å¯¹è±¡çš„å¥æŸ„åŠ å…¥åˆ°epollçš„ç›‘æ§ä¸­ã€‚æœ€åè°ƒç”¨addDeviceLockedï¼ˆï¼‰å‡½æ•°æŠŠDeviceå¯¹è±¡æ·»åŠ åˆ°EventHubçš„mDevicesåˆ—è¡¨ä¸­</p><hr><font color="#000000" size="2" face="æ¥·ä½“">ä½æ‰€ï¼Œç”µè„‘å‰ï¼Œæ±—è¡«ï¼Œå¬ç€é£˜æ´‹è¿‡æµ·æ¥çœ‹ä½ </font>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ä¸Šç¯‡æ–‡ç« ä¸­è¯´åˆ°eventhubæ˜¯åœ¨NativeInputManagerçš„æ„é€ å‡½æ•°newå‡ºæ¥&lt;/p&gt;
&lt;p&gt;ä¸€å°ç§»åŠ¨è®¾å¤‡èƒ½äº§ç”Ÿè¾“å…¥æ¶ˆæ¯çš„éƒ¨ä»¶å¾ˆå¤šï¼ŒåŒ…æ‹¬é”®ç›˜ï¼Œè§¦æ‘¸å±ï¼ŒæŒ‰é”®ç­‰ã€‚EventHubçš„ä½œç”¨å°±æ˜¯æŠŠæ‰€æœ‰è¿™äº›è®¾å¤‡äº§ç”Ÿçš„æ¶ˆæ¯ç»Ÿä¸€æˆä¸€ç§æ ¼å¼ï¼Œå†å‘å¾€ä¸Šå±‚è¿›è¡Œå¤„ç†&lt;/p&gt;
&lt;figu
      
    
    </summary>
    
      <category term="Android" scheme="http://lihaizhou.top/categories/Android/"/>
    
    
  </entry>
  
</feed>
